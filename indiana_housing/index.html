<!DOCTYPE html>
<html data-wf-page="60ad049143fb2539268f7d05" data-wf-site="60ad049043fb256ced8f7cd5">
<head>
  <meta charset="utf-8">
  <title>Indiana Housing Dashboard</title>
  <meta content="[Description]" name="description">
  <meta content="Indiana Housing Dashboard" property="og:title">
  <meta content="[Description]" property="og:description">
  <!--<meta content="https://uploads-ssl.webflow.com/5cbc1cadfad96c3229989372/5d0e38fde5d1e7c2d43129f9_opengraph_flowbase.png" property="og:image"> -->
  <meta content="Indiana Housing Dashboard" property="twitter:title">
  <meta content="[Description]" property="twitter:description">
  <!--<meta content="https://uploads-ssl.webflow.com/5cbc1cadfad96c3229989372/5d0e38fde5d1e7c2d43129f9_opengraph_flowbase.png" property="twitter:image"> -->
  <meta property="og:type" content="website">
  <meta content="summary_large_image" name="twitter:card">
  <meta content="width=device-width, initial-scale=1" name="viewport">
  <link href="css/normalize.css" rel="stylesheet" type="text/css">
  <link href="css/webflow.css" rel="stylesheet" type="text/css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Turf.js/0.0.124/turf.min.js" integrity="sha512-jpnZ8xGKbS7L9S6d5fk/zDVgF6OoVKLMoEliLxf24BRX+orWhxqJuUcoM+vGmOaozS9dD9ABjQZKAgjjcwTndA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://d3js.org/d3.v4.js"></script>
  <script src="https://d3js.org/d3-geo-projection.v1.min.js"></script>
  <script src="https://d3js.org/d3-array.v1.min.js"></script>
  <script src="https://d3js.org/d3-format.v2.min.js"></script>
  <script src="https://d3js.org/d3-geo.v1.min.js"></script>
  <link href="css/indiana-a6357d.webflow.css" rel="stylesheet" type="text/css">
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.1.1/mapbox-gl.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.1/papaparse.min.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.1.1/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.5.1/mapbox-gl-geocoder.min.js"></script>
  <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.5.1/mapbox-gl-geocoder.css" type="text/css" />
  <script src="https://ajax.googleapis.com/ajax/libs/webfont/1.6.26/webfont.js" type="text/javascript"></script>
  <script type="text/javascript">WebFont.load({  google: {    families: ["Varela Round:400","Cabin:regular,500,500italic,600,600italic,700"]  }});</script>
  <!-- [if lt IE 9]><script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.min.js" type="text/javascript"></script><![endif] -->
  <script type="text/javascript">!function(o,c){var n=c.documentElement,t=" w-mod-";n.className+=t+"js",("ontouchstart"in o||o.DocumentTouch&&c instanceof DocumentTouch)&&(n.className+=t+"touch")}(window,document);</script>
  <link href="images/favicon.png" rel="shortcut icon" type="image/x-icon">
  <link href="images/webclip.png" rel="apple-touch-icon">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/microplugin/0.0.3/microplugin.min.js" integrity="sha512-7amIsiQ/hxbdPNawBZwmWBWPiwQRNEJlxTj6eVO+xmWd71fs79Iydr4rYARHwDf0rKHpysFxWbj64fjPRHbqfA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script> 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.13.3/js/selectize.min.js" integrity="sha512-JiDSvppkBtWM1f9nPRajthdgTCZV3wtyngKUqVHlAs0d5q72n5zpM3QMOLmuNws2vkYmmLn4r1KfnPzgC/73Mw==" crossorigin="anonymous" referrerpolicy="no-referrer" defer></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<script src="https://kit.fontawesome.com/7a4305c6cb.js" crossorigin="anonymous"></script>
  <style type="text/css">

    td{
      padding: 6px;
      border-top: 1px solid #fff;
      border-bottom: 1px solid #fff;
      color: #fff;
      text-align: right;
    }

    th{
          padding: 6px;
    /* border: 1px solid #ccc; */
    text-align: right;
    color: #fff;
    border-bottom: 3px solid #fff;
    }

    select{
      color: #000;
      background: #d6ddff;
    }

    #table {
          display: block;
    margin-top: 10px;
    margin-right: 0px;
    margin-left: 0px;
    padding: 20px;
    -webkit-box-flex: 1;
    -webkit-flex: 1;
    -ms-flex: 1;
    flex: 1;
    border-radius: 8px;
    background-color: #003768;
    }
      .mapboxgl-ctrl-icon{
        position: static !important;
      }
      .mapboxgl-ctrl-logo{
        display:none !important;
        }
      .mapboxgl-ctrl-bottom-right{
        display:none !important;
        }
      .mapboxgl-ctrl-bottom-left{
        display:none !important;
        }
      .css-9emwa5{
        display:none !important;
        }
      .deck-tooltip {
        font-family: Helvetica, Arial, sans-serif;
        padding: 6px !important;
        margin: 8px;
        max-width: 300px;
        font-size: 10px;
        }
      .line {
        fill: none;
        stroke: #ffab00;
        stroke-width: 2;
        }
      .tick line{
        visibility:hidden;
        }
      .overlay {
        fill: none;
        pointer-events: all;
        }
      .dot {
        fill: #ffab00;
        stroke: #fff;
        }
      .focus circle {
        fill: none;
        stroke: steelblue;
        }
      div.tooltip2 { 
        position: absolute;     
        text-align: center;               
        padding: 10px;       
        font: 12px sans-serif;    
        background: #fff;
        border: 2px solid #000;   
        border-radius: 5px;     
        pointer-events: none;
        -moz-border-radius:5px;
        color: black
        z-index: 10;     
        }
      span {
        position: absolute;
        }
      table{
        width: -webkit-fill-available;
        text-align: center;
        }

        @media screen and (max-width: 600px) {
  #menu, #logo {
    visibility: hidden;
  }
}
    #menu a {
        text-decoration: none
    }
    #menu a:link {
        color: #51b3c9;
    }
    #menu a:visited {
        color: #51b3c9;
    }
    #menu a:active {
        color: #51b3c9;
    }
    #menu #logo {
        position: absolute;
        z-index: 1;
        bottom: 20px;
        right: 20px;
        background: rgba(255, 255, 255, 0.6);
    }

    #menu {
        background: white;
        font-family: 'Nunito', sans-serif;
        font-size: 15px;
        position: relative;
        z-index: 1;
        top: 10px;
        left: 10px;
        width: 2.75em;
        display: inline-block;
        color: #fff;
        box-shadow: 1.5px 1.5px 2px rgba(0, 0, 0, 0.2);
        -moz-box-shadow: 1.5px 1.5px 2px rgba(0, 0, 0, 0.2);
        -webkit-box-shadow: 1.5px 1.5px 2px rgba(0, 0, 0, 0.2)
    }

    #menu p{
      margin-block-start: .1em;
    margin-block-end: .5em;
    margin-inline-start: .25em;
    height: 1em;
    }
    #menu .on {
        background: white;
        background-origin: content-box;
        background-size: 18px 18px;
        display: block;
        margin: 0;
        padding: 10px;
        color: black;
        border-bottom: 1px solid #d5dcde;
    }
#menu #population{border-top: 1px solid #8D9192;}
    #menu .on:hover {
        cursor: pointer;
    }
    #menu .off {
        background: #e2e2e2;
        background-origin: content-box;
        background-size: 18px 18px;
        color: #949494;
        display: block;
        margin: 0;
        padding: 0;
        padding: 10px;
        border-bottom: 1px solid #d5dcde;
    }

    #menu.off img{
        opacity: 30%;
    }

    #menu .legend {
        padding: 10px;
        background: #fff;
        color: #C7354D;
        vertical-align:middle;
    }
    #menu .row {
        display: table-row;
    }
    #menu .noborder {
        border-bottom: 0px solid white;
    }

    #infowindow {
           position: absolute;
            bottom:111px;
            width: 90%;
            height: 74%;
            margin-left: 5%;
            background-color: rgba(255, 255, 255, 1);
            box-shadow: 0 1px 5px rgba(0, 0, 0, .4);
            color:#666;
            padding:10px 10px 8px 10px;
            font-family: sans-serif;
            cursor: pointer;
            font-size:14px;
            text-decoration:none;
            z-index:1002;
        }
        #header {
        position: absolute;
            top:10px;
            width:98%;
            font-size:15px;
            z-index:-4;
            font-family: sans-serif;
            text-transform: uppercase;
            text-decoration:none;
            color: #003E7A;
            cursor: pointer;
            padding-bottom: 5px;
            border-bottom: 1px solid #e5e5e5;
        }
        #assumptions {
            position: absolute;
            top:39px;
            height: 90%;
            width: 98.5%;
            overflow: auto;
        }
        #closewindow {
        position: absolute;
            top:1.5%;
            right:1.5%;
            font-size:15px;
            z-index:1002;
            font-family: sans-serif;
            text-transform: uppercase;
            text-decoration:none;
            color: #003E7A;
            cursor: pointer;
        }
        #isolate {
        position: absolute;
            width:100%;
            height:100%;
            z-index:1001;
            background-color: #000;
            opacity:.75;
        }

.settings .info {
  background: rgba(0, 62, 122, 1);
  height: 30px;
  font-size: 1.2rem;
  top: 8px;
  left: 20px;
  border-top-right-radius: 3px;
  border-top-left-radius: 3px;
  padding: 5px 10px;
  cursor: pointer;
  margin: 5px;
}
  </style>
</head>
<body class="lnd_body">
  <div id=isolate> </div><div id=infowindow><div id=header> <b>      User Guide </b></div><div id=closewindow> <i class="far fa-times-circle"></i> </div><div id=assumptions><p style="margin:0in;font-size:15px;">Welcome to the IHCDA Housing Dashboard...<br><br><strong>To Use:</strong></p></div></div>
    <div class="tab03">
    <div class="tab03_container">
      <div data-duration-in="300" data-duration-out="100" class="tab03_tabs w-tabs">
        <div class="tab03_menu w-tab-menu">
          <div class="container w-container">
            <div class="text-block-42">
              What is the state of 
              <select class="js-example-basic-single" name="state" id="topic">
                <option value="population">the population</option>
                <option value="housing">housing</option>
                <option value="housingafford">housing affordability</option>
                <option value="jobs">jobs</option>
              </select>
               in 
              <select class="js-example-basic-single" id="geography">
                <option value="Indiana">Indiana</option>
              </select> ?
            </div>
          </div>
          <a data-w-tab="Tab 4" class="tab03_tab_link w-inline-block w-tab-link w--current">
          <div class="tab03_icon_wrap"><img src="images/map_icon.svg" alt="" class="tab03_icon"></div>
          <div class="tab03_title">Map</div>
          </a>
          <a data-w-tab="Tab 5" class="tab03_tab_link w-inline-block w-tab-link">
            <div class="tab03_icon_wrap"><img src="images/compare_icon.svg" alt="" class="tab03_icon"></div>
            <div class="tab03_title">Compare</div>
          </a>
          </a>
          <a class="tab03_tab_link w-inline-block w-tab-link" onclick="NewTab()">
            <div class="tab03_icon_wrap"><img src="images/download.svg" alt="" class="tab03_icon"></div>
            <div class="tab03_title">Export</div>
          </a>
          <a class="tab03_tab_link w-inline-block w-tab-link" >
            <div class="tab03_icon_wrap info"><img src="images/info.svg" alt="" class="tab03_icon"></div>
            <div class="tab03_title">Info</div>
          </a>
        </div>
        <div class="tab03_content w-tab-content">
          <div data-w-tab="Tab 4" class="tab03_pane w-tab-pane w--tab-active">
            <div class="tab03_tab_content">
              <div class="tab03_block_left">
                <div class="w-layout-grid grid">
                  <div id='chart1'><b><span id='label1'>Population</span></b></div>
                  <div id='chart2'><b><span id='label2'>Median Income</span></b></div>
                  <div id='chart3'><b><span id='label3'>Household Income Distribution</span></b></div>
                  <div id='chart4'><b><span id='label4'>Family Poverty Rate</span></b></div>
                  <div id='chart5'><b><span id='label5'>Tenure</span></b></div>
                  <div id='chart6'><b><span id='label6'>Racial Composition</span></b></div>
                </div>
              </div>
              <div class="tab03_block_right">
                <div class="div-block-124" id = 'map'>
                  <div id="menu" class="mobilehide">
                    <p onclick="toggleMenu()"><span style="font-size: 2em; color: black;"><i class="fas fa-layer-group"></i></span></p></p>
                    <div id="menu-box" style="display: none">
                      <div class="on"><input type="checkbox" id="population"><!--<img src="style/office.svg" height="20px" width="20px" style="vertical-align:middle">-->  Population Growth</div>
                      <div class="on"><input type="checkbox" id="race"><!--<img src="style/office.svg" height="20px" width="20px" style="vertical-align:middle">-->  <font color="lightgrey">Racial Composition</font></div>
                      <div class="on"><input type="checkbox" id="income"><!--<img src="style/office.svg" height="20px" width="20px" style="vertical-align:middle">-->  Median Household Income</div>
                      <div class="on"><input type="checkbox" id="tenure"><!--<img src="style/office.svg" height="20px" width="20px" style="vertical-align:middle">-->  Tenure (% Owner Occupied)</div>
                      <div class="on"><input type="checkbox" id="affordability"><!--<img src="style/office.svg" height="20px" width="20px" style="vertical-align:middle">-->  Affordable Housing Units</div>
                      <div class="on"><input type="checkbox" id="multifamily"><!--<img src="style/office.svg" height="20px" width="20px" style="vertical-align:middle">-->  Multifamily Housing Units</div>
                      <div class="on"><input type="checkbox" id="transit"><!--<img src="style/office.svg" height="20px" width="20px" style="vertical-align:middle">-->  <font color="lightgrey">Public Transit</font></div>
                      <div class="on"><input type="checkbox" id="broadband"><!--<img src="style/office.svg" height="20px" width="20px" style="vertical-align:middle">-->  <font color="lightgrey">Broadband</font></div>
                      <div class="on"><input type="checkbox" id="schools"><!--<img src="style/office.svg" height="20px" width="20px" style="vertical-align:middle">-->  <font color="lightgrey">Schools</font></div>
                      <div class="on"><input type="checkbox" id="parks"><!--<img src="style/office.svg" height="20px" width="20px" style="vertical-align:middle">-->  <font color="lightgrey">Parks</font></div>

                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div data-w-tab="Tab 5" class="tab03_pane w-tab-pane">
            <div class="tab03_tab_content">
              <div class="columns w-row">

                <div class="column-3 w-col w-col-11" id='table'></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="section"><img src='images/logo.png' style='padding-left: 10vw;
    padding-top: 4vh;'></img></div>
  <script src="https://d3e54v103j8qbb.cloudfront.net/js/jquery-3.5.1.min.dc5e7f18c8.js?site=60ad049043fb256ced8f7cd5" type="text/javascript" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
  <script src="js/webflow.js" type="text/javascript"></script>
  <script src="js/turf.min.js"></script>
  <script src="js/venn.js"></script>
  <!-- [if lte IE 9]><script src="https://cdnjs.cloudflare.com/ajax/libs/placeholders/3.0.2/placeholders.min.js"></script><![endif] -->
</body>
<script>

  function sum(input){
             
 if (toString.call(input) !== "[object Array]")
    return false;
      
            var total =  0;
            for(var i=0;i<input.length;i++)
              {                  
                if(isNaN(input[i])){
                continue;
                 }
                  total += Number(input[i]);
               }
             return total;
            }

function NewTab() {
    window.open(
      "DRAFT Indiana Housing Dashboard Report 2021.06.10.pdf", "_blank");
}

function csvJSON(csv){

  var lines=csv.split("\n");

  var result = [];

  // NOTE: If your columns contain commas in their values, you'll need
  // to deal with those before doing the next step 
  // (you might convert them to &&& or something, then covert them back later)
  // jsfiddle showing the issue https://jsfiddle.net/
  var headers=lines[0].split(",");

  for(var i=1;i<lines.length;i++){

      var obj = {};
      var currentline=lines[i].split(",");

      for(var j=0;j<headers.length;j++){
          obj[headers[j]] = currentline[j];
      }

      result.push(obj);

  }

  //return result; //JavaScript object
  return JSON.stringify(result); //JSON
}


function toggleMenu() {
  var menuBox = document.getElementById('menu-box');
  var menu = document.getElementById('menu');    
  if(menuBox.style.display == "block") { // if is menuBox displayed, hide it
    menuBox.style.display = "none";
    menu.style.width = '2.75em';
  }
  else { // if is menuBox hidden, display it
    menuBox.style.display = "block";
    menu.style.width = '275px';
  }
}

  $('.info').bind('click', function() {

      document.getElementById('infowindow').style.zIndex ='1002';
        document.getElementById('closewindow').style.zIndex ='1002';
        document.getElementById('isolate').style.zIndex ='1001';
        document.getElementById('isolate').style.backgroundColor ='#000';
        document.getElementById('isolate').style.opacity ='.75';

  });

  $('#closewindow').bind('click', function() {

        document.getElementById('infowindow').style.zIndex ='-4';
                  document.getElementById('closewindow').style.zIndex ='-4';
                  document.getElementById('isolate').style.zIndex ='-1';
                  document.getElementById('isolate').style.backgroundColor ='#ffffff';
              document.getElementById('isolate').style.opacity ='1';

    });





</script>
<script>

//Define Labels
span = ['#label1','#label2','#label3','#label4','#label5','#label6']
population = ['Population','Median Income','Household Income Distribution','Family Poverty Rate','Tenure','Racial Composition']
housing = ['Housing Units by Typology','Housing Units by Decade Built','Median Listing Price','Median Rent','Housing Starts','Affordable Housing Starts']
housingafford = ['Cost Burdened Households','Cost Burden by Tenure','Cost Burden by Income','Rental Housing Gap','Home Value Affordable to Median Household','']
jobs = ['Unemployment Rate','Net New Jobs','Top 5 Industries by Jobs','Median Salary','Inflow/Outflow','']

//Function to relabel spans when topic is changed
reLabel = function(spans,labels){
  spans.forEach(function(d,i){
    document.querySelector(d).innerHTML = labels[i]
    } )
  } 


//Make Tooltip
var tip = d3.select("body").append("div") 
    .attr("class", "tooltip2")
    .style("position","absolute")       
    .style("opacity", 0);

//Define diminisons of chart modules based on the initial div dimensions of the first chart
var margin = {top: 30, right: 30, bottom: 30, left: 30}
var divs = d3.select('#chart1')
element = divs.node();
width = element.getBoundingClientRect().width  - margin.left - margin.right,
height = element.getBoundingClientRect().height - margin.top - margin.bottom;


//Select the Topic Select Box
const topic = document.querySelector('#topic')

//Define a method to dynamically resize the select box based on selected text length; Initialize based on starting text.
//The second argument is True (1) if the resize is performed on initial page load or False (0) upon new selection
function selectResize(id,initial){
  const select = document.querySelector(id) 

  //We need to make temporary selections with only one options to grab the DOM evaluated width of the container 
  let tempSelect = document.createElement('select'),
      tempOption = document.createElement('option');

  if (initial == 1){
    tempOption.textContent = select.getElementsByTagName("option")[0].text;
    value = select.value;
    }else{
    tempOption.textContent = event.target.options[event.target.selectedIndex].text;
    value = event.target.options[event.target.selectedIndex].value;
    }

  tempSelect.style.cssText += `
    visibility: hidden;
    position: fixed;
    `;
  tempSelect.appendChild(tempOption);

  if (initial == 1){
    select.after(tempSelect)
    width = tempSelect.getBoundingClientRect().width
    select.style.width = `${width}px`;
    }else{
    event.target.after(tempSelect)
    width = tempSelect.getBoundingClientRect().width
    event.target.style.width = `${width}px`;
    }
  tempSelect.remove()

  return value
  }

//Perform initial resize
selectResize('#topic',1)


var geography = d3.select("#geography")
window.addEventListener("load", function(){


  //Build Charts
  //Chart 1
  years = [2010,2011,2012,2013,2014,2015,2016,2017,2018,2019]


  //Define functions to get min and max value of items in a dictionary 
  function getYs(data,value){
    return data.map(d => eval('d.' + value));
    }
  function getMinY(data,value){
    return Math.min(...getYs(data,value));
    }
  function getMaxY(data,value){
    return Math.max(...getYs(data,value));
    }

  function findDomain(year){
    if (year === "terminal"){
      domain = [2010,2019]
    }else if (year === 'latest'){
      domain = [2019]
    }else if (year === 'all'){
      domain = []
      for (var i = 2010; i <= 2019; i++) {
         domain.push(i);
      } 
    }
  return domain
  }

  function makeLineChart(dataset,divs,value,format,transform,year){

    domain = findDomain(year)


    code = []
    value.forEach(d => code.push(d.code))
    
    codename = divs.replace('#','') + "_code"

    if (transform != undefined){


      dataset.map(function(d){
        d['newkey'] = eval(transform.calc)
        d['codename'] = codename
        return d
      });

      code = ["newkey"]

    }else{
      dataset.map(function(d){
        d['codename'] = codename
        return d
      });
    }

    window[codename] = code

    var div = d3.select(divs)


    // 5. X scale will use the index of our data
    var xScale = d3.scaleLinear()
        .domain([2010,2019]) // input
        .range([0, width]); // output

    // 6. Y scale will use the randomly generate number 
    var yScale = d3.scaleLinear()
        .domain([getMinY(dataset,code), getMaxY(dataset,code)]) // input 
        .range([height, 0]); // output 

    // 7. d3's line generator
    var line = d3.line()
        .x(function(d, i) { return xScale(years[i]); }) // set the x values for the line generator
        .y(function(d) { return yScale(d[code]); }) // set the y values for the line generator 
        .curve(d3.curveMonotoneX) // apply smoothing to the line

    // 8. An array of objects of length N. Each object has key -> value pair, the key being "y" and the value is a random number
    //var dataset = d3.range(n).map(function(d) { return {"y": d3.randomUniform(1)() } })

    // 1. Add the SVG to the page and employ #2


    svg = div.append("svg")
        .attr("class","vis")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    // 3. Call the x axis in a group tag
    svg.append("g")
        .attr("class", "x axis")
        .attr("transform", "translate(0," + height  + ")")
        .call(d3.axisBottom(xScale)
             .tickFormat(d3.format("d"))
             .tickValues([2010,2019]))
        .call(g => g.select(".domain").remove())
        
      
    // Create an axis component with d3.axisBottom

    // 4. Call the y axis in a group tag
    svg.append("g")
        .attr("class", "y axis")
        .call(d3.axisLeft(yScale)
             .tickValues([]))
        .call(g => g.select(".domain").remove()); // Create an axis component with d3.axisLeft

    // 9. Append the path, bind the data, and call the line generator 
    svg.append("path")
        .datum(dataset) // 10. Binds data to the line 
        .attr("class", "line") // Assign a class for styling 
        .attr("d", line); // 11. Calls the line generator 

    // 12. Appends a circle for each datapoint 

    svg.selectAll(".dot")
        .data(dataset)
        .enter().append("circle") // Uses the enter().append() method
        .attr("class", "dot") // Assign a class for styling
        .attr("cx", function(d, i) { return xScale(years[i]) })
        .attr("cy", function(d) { return yScale(d[code]) })
        .attr("r", 5)
        .on("mouseover", function(d,i) {
                tip      
                    .transition()   
                    .duration(200)
                    .style("opacity", 1);    
                tip .html("<b>"+ years[i] +'</b>: '+ d3.format(format)(d[eval(d['codename'])[0]]))  
                    .style("left", (d3.event.pageX) + "px")   
                    .style("top", (d3.event.pageY - 28) + "px");  
                })          
        .on("mouseout", function(d) {   
                tip.transition()    
                    .duration(500)   
                    .style("opacity", 0); 
            });
    }

   function makeDonutChart(dataset,divs,value,format,transform,year){

    domain = findDomain(year)


    code = []
    value.forEach(d => code.push(d.code))

     dataset.map(function(d){

      keys = Object.keys(d)

      filtered = keys
        .filter(key => code.includes(key))
        .reduce((obj, key) => {
          obj[key] = d[key];
          return obj;
        }, {});

      values = Object.values(filtered)
      sums = sum(values)

      code.forEach(function(t,i){
        d[t] = values[i]/sums
      })

    return d

    })


    
    var keys = code

    dataset.forEach((d,i) => d['Year'] = years[i])
    dataset = dataset.filter(d => domain.includes(d.Year))[0]


    margint = 10

    var radius = Math.min(width, height ) / 2 - margint
    
    var div = d3.select(divs)

    svg = div.append("svg")
        .attr("class","vis")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", "translate(" + width / 2 + "," + (height + margin.top + margin.bottom)/ 2 + ")");

    var color = d3.scaleLinear()
      .range(["#15534C","#1A5D51","#216755","#297159","#337B5C","#3D855E","#498F60","#569861","#64A261","#73AC61","#83B561","#94BE61","#A6C760","#B9D060","#CDD861","#E2E062"])
      .domain(d3.ticks(0, keys.length, 16));

    var pie = d3.pie()
      .value(function(d) {return d.value; })

    var filtered = Object.keys(dataset)
        .filter(key => code.includes(key))
        .reduce((obj, key) => {
          obj[key] = dataset[key];
          return obj;
        }, {});

    var data_ready = pie(d3.entries(filtered))

    // Build the pie chart: Basically, each part of the pie is a path that we build using the arc function.
    svg
      .selectAll('whatever')
      .data(data_ready)
      .enter()
      .append('path')
      .attr('d', d3.arc()
        .innerRadius(10)         // This is the size of the donut hole
        .outerRadius(radius)
      )
       .on("mouseover", function(d,i) {
                
                tip      
                    .transition()   
                    .duration(200)
                    .style("opacity", 1);    
                tip .html("<b>"+ value.filter(r => r.code == d.data.key)[0].name + '</b>: ' + d3.format(format)(d.data.value) )  
                    .style("left", (d3.event.pageX) + "px")   
                    .style("top", (d3.event.pageY - 28) + "px");  
                })          
        .on("mouseout", function(d) {   
                tip.transition()    
                    .duration(500)   
                    .style("opacity", 0); 
            })
      .attr('fill', function(d){ return(color(keys.indexOf(d.data.key))) })
      .attr("stroke", "black")
      .style("stroke-width", ".5px")
      .style("opacity", 0.7)


  }

  function makeVennChart(dataset,divs,value,format,transform){


    var sets = [ {sets: ['Employed'], size: 12}, 
             {sets: ['Residents'], size: 12},
             {sets: ['Employed','Residents'], size: 2}];

    var div = d3.select(divs)

    var chart = venn.VennDiagram()
     .width(width + margin.left + margin.right)
    .height(height + margin.top + margin.bottom);
    div.datum(sets).call(chart);


    var tooltip = d3.select("body").append("div")
    .attr("class", "venntooltip");

// add listeners to all the groups to display tooltip on mouseover
div.selectAll("g")
    .on("mouseover", function(d,i) {
                tip      
                    .transition()   
                    .duration(200)
                    .style("opacity", 1);    
                tip .html(d.size)  
                    .style("left", (d3.event.pageX) + "px")   
                    .style("top", (d3.event.pageY - 28) + "px");  
                })          
        .on("mouseout", function(d) {   
                tip.transition()    
                    .duration(500)   
                    .style("opacity", 0); 
            })
  }

  function makeIndicator(dataset,divs,value,format,transform,year){

    q = 3000

    let div = document.querySelector(divs);
    div.innerHTML += '<p style ="color: #000; text-align: center; font-size: 40px;font-weight: 700; position: relative; top: 50%;">' + d3.format("(,.2r")(q) + '</p>'

  }

  function makeTable(dataset,divs,value,format,transform,year){


    let div = document.querySelector(divs);
    div.innerHTML += '<p style ="color: #000; text-align: center; font-size: 40px;font-weight: 700; position: relative; top: 50%;">' + '<ul><li>Xxxxx</li><li>Xxxxx</li><li>Xxxx</li></ul>' + '</p>'
    
  }

  function makeStackedBarChart(dataset,divs,value,format,transform,year){

    domain = findDomain(year)

    code = []
    value.forEach(d => code.push(d.code))

    dataset.map(function(d){

      keys = Object.keys(d)

      filtered = keys
        .filter(key => code.includes(key))
        .reduce((obj, key) => {
          obj[key] = d[key];
          return obj;
        }, {});

      values = Object.values(filtered)
      sums = sum(values)

      code.forEach(function(t,i){
        d[t] = values[i]/sums
      })

    return d

    })

    var keys = code

    dataset.forEach((d,i) => d['Year'] = years[i])
    dataset = dataset.filter(d => domain.includes(d.Year))

    var year   = [...new Set(dataset.map(d => d.state))]
    var states = [...new Set(dataset.map(d => d.Year))]
  
    var div = d3.select(divs)

    svg = div.append("svg")
        .attr("class","vis")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");


    var y = d3.scaleBand()
    .range([margin.top, height - margin.bottom])
    .padding(0.1)
    .paddingOuter(0.2)
    .paddingInner(0.2)

    var x = d3.scaleLinear()
      .range([margin.left, width - margin.right])

    var yAxis = svg.append("g")
      .attr("transform", `translate(${margin.left},0)`)
      .attr("class", "y-axis")

    var xAxis = svg.append("g")
      .attr("transform", `translate(0,${margin.top})`)
      .attr("class", "x-axis")


    var z = d3.scaleLinear()
      .range(["#15534C","#1A5D51","#216755","#297159","#337B5C","#3D855E","#498F60","#569861","#64A261","#73AC61","#83B561","#94BE61","#A6C760","#B9D060","#CDD861","#E2E062"])
      .domain(d3.ticks(0, keys.length, 16));

    update(dataset,18, 0,value)

    function update(dataset,input, speed, value) {

      var data = dataset.filter(f => f.state == input)

      data.forEach(function(d) {
        d.total = d3.sum(keys, k => +d[k])
        return d
      })

      x.domain([0, d3.max(data, d => d.total)]).nice();

      svg.selectAll(".x-axis").transition().duration(speed)
        .call(d3.axisTop(x).ticks(null, "s").tickValues([]))
        .call(g => g.select(".domain").remove())

      data.sort((a, b) => states.indexOf(a.Year) - states.indexOf(b.Year))

      y.domain(data.map(d => d.Year));

      svg.selectAll(".y-axis").transition().duration(speed)
        .call(d3.axisLeft(y).tickSizeOuter(0))

      var group = svg.selectAll("g.layer")
        .data(d3.stack().keys(keys)(data), d => d.key, (d,i) => i)

      group.exit().remove()

      group.enter().insert("g", ".y-axis").append("g")
      .on("mouseover", function(d,i) {
                tip      
                    .transition()   
                    .duration(200)
                    .style("opacity", 1);    
                tip .html("<b>"+ value.filter(r => r.code == d.key)[0].name + '</b>: ' + d3.format(format)(d[1][1]-d[1][0]) )  
                    .style("left", (d3.event.pageX) + "px")   
                    .style("top", (d3.event.pageY - 28) + "px");  
                })          
        .on("mouseout", function(d) {   
                tip.transition()    
                    .duration(500)   
                    .style("opacity", 0); 
            })
        .classed("layer", true)
        .attr("fill", d => z(keys.indexOf(d.key)));

      var bars = svg.selectAll("g.layer").selectAll("rect")
        .data(d => d, e => e.data.Year);

      bars.exit().remove()

      function getKeyByValue(object, value) {
        return Object.keys(object).find(key => object[key] === code);
      }

      bars.enter().append("rect")
        .attr("height", y.bandwidth())
        .merge(bars)
        
      .transition().duration(speed)
        .attr("y", d => y(d.data.Year))
        .attr("x", d => x(d[0]))
        .attr("width", d => x(d[1]) - x(d[0]))
        
    }
    }
  //charttypes = [makeLineChart,makeLineChart,makeStackedBarChart,makeLineChart,makeLineChart,makeLineChart]
  function assignData(data,manifest,fetchIndex){

       
      charts = manifest.divs

      //("county" in temp1)

      data.forEach(function(d,i){
        d.slice(1,d.length).forEach(function(h,o){
          var dict = new Object();
          d[0].forEach(function(b,l){
            dict[b] = d[o+1][l]
          })
          data[i][o+1] = dict
        })
      })

      newdata = []
      fetchIndex.forEach(function(d,i){
        newdata[i] = Object.assign({},d,data[i])
      })

      

      acs = JSON.parse(JSON.stringify(newdata.filter(r => r["source"] == "ACS")))

      console.log(acs)

      chart_data = acs.filter(r => r["use"] == "charts")

      county_charts = chart_data.filter(r => r["geo"] == "county")
      state_charts = chart_data.filter(r => r["geo"] == "state")



      counties = []
      county_charts.forEach(function(d){
        delete d.geo
        delete d.use
        delete d.year
        delete d.source
        values = Object.values(d)
        counties.push(values)
      })

      states = []
      state_charts.forEach(function(d){
        delete d.geo
        delete d.use
        delete d.year
        delete d.source
        values = Object.values(d)
        values = values.slice(1,values.length)
        values = values[0]
        values['county'] = "999"
        states.push(values)
      })


      var geos = new Object();
      counties[0].slice(1,counties[0].length).map(function(x){
        geos[x['county']] = []
      })

      for (i=10;i<20;i++){
        for (object in geos){
          geos[object].push(data[i].filter(r => r['county'] == object)[0])
        }
      }


      

      geos['999'] = states

      dataset = geos['999']

  

      option = manifest.topic.population

      charts.forEach(function(d,i){

        eval(manifest.chartfunctions.filter(d => d.type == option[i].type)[0].function)(dataset,d,option[i].variables,option[i].format,option[i].transform,option[i].year)

        //makeLineChart(dataset,d,variables[i])
      })

    function updateGraph(fips,vars,div,topicselect){
    //Remove existing charts
        d3.selectAll(".vis").remove()
        data = geos[fips]

        option = eval('manifest.topic.' + topicselect)

        charts.forEach(function(d,i){

        eval(manifest.chartfunctions.filter(d => d.type == option[i].type)[0].function)(data,d,option[i].variables,option[i].format,option[i].transform,option[i].year)

      })
        }


      

      
function mapData(json){

      console.log(geos)
      console.log(manifest)

      columns = Object.keys(geos)
      columns = columns.map(d => geos[d][9]['NAME'])
      columns - columns.sort()
      indicators = ['B01001_001E','B19013_001E','B19001_002E']

      indicators = [{'label':'Population','variable':'B01001_001E','format':",.0f"},{'label':'Median Household Income','variable':'B19013_001E','format':"$,.0f"},{'label':'Family Poverty Rate','variable':'family_poverty','format':",.1%"},{'label':'Tenure (% Owner Occupied)','variable':'tenure','format':",.1%"}]



      var table = d3.select('#table').append("table");
          var thead = table.append("thead");
          var tbody = table.append("tbody");

      lab = ['Indicator']
      
      first = thead.append("tr")
      first
        .selectAll("th")
        .data(lab)
        .enter()
        .append("th")
        .text(x => x);

      selects = []
      for(i=0;i<3;i++){

        select = first.append("th")
              .append("select")
              .attr('id','select-' + String(i))

        selects.push('select-' + String(i))

        select
        .selectAll("option")
        .data(columns)
        .enter()
        .append("option")
        .attr("value", function(d){
          return d;
        })
        .text(function(d){
          return d;
        })

      }

      latest = []
      for(i=0;i<Object.keys(geos).length;i++){
        latest.push(geos[Object.keys(geos)[i]][9])
      }

      latest.forEach(function(d){
        d['family_poverty'] = d.B17013_002E / d.B17013_001E;

        d['tenure_households'] = parseFloat(d.B25003_002E) + parseFloat(d.B25003_003E);

        d['tenure'] = (d.B25003_002E / d.tenure_households)
      })

      console.log(latest)

      selects.forEach(function(select){
        item = document.getElementById(select)

        item.addEventListener('change', function(){
          updateTable(0)
        })

        console.log(manifest)

      })


      function updateTable(initial){

     
      selection = []
      selects.forEach(function(select){
        selection.push(document.getElementById(select).value)
      })
     
      key = []
      indicators.forEach(function(value){
        temp = new Object();
        selection.forEach(function(column){
        temp[column] = d3.format(value.format)(latest.filter(d => d.NAME == column)[0][value.variable])
      })
      temp['label'] = value.label
      key.push(temp)
      })


      columns = ['label'].concat(selection)

      
      if (initial == 1){
      tbody.selectAll("tr")
        .data(key)
        .enter()
        .append("tr")
        .selectAll("td")
        .data(function(row) {
          return columns.map(function(column) {
            return {
              column: column,
              value: row[column]
            };
          });
        })
        .enter()
        .append("td")
        .text(function(d) { return d.value; })
        
      }else{
        tbody.selectAll("tr")
        .data(key)
        .selectAll("td")
        .data(function(row) {
          return columns.map(function(column) {
            return {
              column: column,
              value: row[column]
            };
          });
        })
        .text(function(d) { return d.value; })
      }
           
      }
      updateTable(1)






      foo = json[0]
      //Create a new object reorienting the shapefile using the geography name as the key
      var nest = d3.nest()
      .key(function(d){
        return d.properties.NAMELSAD;
      })
      .entries(foo.features)

      nest = nest.sort((a, b) => (a.key > b.key) ? 1 : -1)

      nest.unshift({
          "key": "Indiana"
      })

      topic.addEventListener('change', (event) => {
        
        //Relabel Spans
        label = eval(event.target.options[event.target.selectedIndex].value)
        reLabel(span,label)

        topic_option = selectResize('#topic',0)

        option = selectResize('#geography',1)
        if(option === 'Indiana'){
          countyfip = "999"
        }else{

          index = foo.features.findIndex(data => data.properties.NAMELSAD === option)
          value = foo.features[index]
          
          ////NEED TO ADD IN INDIANA LOGIC
          countyfip = value.properties.COUNTYFP

        }
        

        

        charts = ['#chart1','#chart2','#chart3','#chart4','#chart5','#chart6']
        variables = ["B01001_001E","B17010_003E",["B19001_002E","B19001_003E","B19001_004E","B19001_005E","B19001_006E","B19001_007E","B19001_008E","B19001_009E","B19001_010E","B19001_011E","B19001_012E","B19001_013E","B19001_014E","B19001_015E","B19001_016E","B19001_017E"],"B01001_001E","B01003_001E","B17010_003E"]

        updateGraph(countyfip,variables,charts,topic_option)

        });

      //Build Geography Selector Change Logic
      const geographies = document.querySelector('#geography')

      geographies.addEventListener('change', (event) => {

        //Resize box
        option = selectResize('#geography',0)
        topic_option = selectResize('#topic',1)

        if(option === 'Indiana'){
          countyfip = "999"

          map.flyTo({
            center: [-86.158017, 39.897451],
            zoom: 5.75
            });
        }else{
          //Zoom in on map
        index = foo.features.findIndex(data => data.properties.NAMELSAD === option)
        bounds = turf.bbox(foo.features[index])

        value = foo.features[index]

        map.fitBounds([
        bounds.slice(0,2), // southwestern corner of the bounds
        bounds.slice(2,4) // northeastern corner of the bounds
        ]);

        countyfip = value.properties.COUNTYFP

        }
  
        


         
        map.setFilter('indiana-highlighted', ['in', 'COUNTYFP',countyfip]);
        
        charts = ['#chart1','#chart2','#chart3','#chart4','#chart5','#chart6']
        variables = ["B01001_001E","B17010_003E",["B19001_002E","B19001_003E","B19001_004E","B19001_005E","B19001_006E","B19001_007E","B19001_008E","B19001_009E","B19001_010E","B19001_011E","B19001_012E","B19001_013E","B19001_014E","B19001_015E","B19001_016E","B19001_017E"],"B01001_001E","B01003_001E","B17010_003E"]
        
        //Update Charts
        updateGraph(countyfip,variables,charts,topic_option)


        });

      //Initial Resize for Geographies
      selectResize('#geography',1)

      geography
      .selectAll("option")
      .data(nest)
      .enter()
      .append("option")
      .attr("value", function(d){
        return d.key;
      })
      .text(function(d){
        return d.key;
      })

      mapboxgl.accessToken = 'pk.eyJ1Ijoia3BjbHluZSIsImEiOiJjanN3MzlpY2EwZGpjM3lsaGNhb3NqY3JmIn0._sGjIhmL5Xt08WIMWRsSsg';
      var map = new mapboxgl.Map({
        container: 'map'
        , style: 'mapbox://styles/mapbox/light-v10'
        , center: [-86.158017, 39.897451]
        , zoom: 5.75
        , pitch: 0
        , bearing: 0
        , maxPitch: 85,
      });   

      map.scrollZoom.disable();
      map.addControl(new mapboxgl.NavigationControl());
      map.dragRotate.disable();

      //Heat Map - B19013_001E
      tractsgeo = json[1]
      nhpd = json[2] 
      tractspop = data[20]
      tractsgeo.features.forEach(function(feature){
        pop = {"population": parseInt(tractspop.filter(d => (d.tract == feature.properties.TRACTCE) && (d.county == feature.properties.COUNTYFP))[0].B01001_001E), 
        "mhi": parseInt(tractspop.filter(d => (d.tract == feature.properties.TRACTCE) && (d.county == feature.properties.COUNTYFP))[0].B19013_001E),
        "owner": parseInt(tractspop.filter(d => (d.tract == feature.properties.TRACTCE) && (d.county == feature.properties.COUNTYFP))[0].B25003_002E)/(parseInt(tractspop.filter(d => (d.tract == feature.properties.TRACTCE) && (d.county == feature.properties.COUNTYFP))[0].B25003_002E) + parseInt(tractspop.filter(d => (d.tract == feature.properties.TRACTCE) && (d.county == feature.properties.COUNTYFP))[0].B25003_003E)),
        "multifamily": (parseInt(tractspop.filter(d => (d.tract == feature.properties.TRACTCE) && (d.county == feature.properties.COUNTYFP))[0].B25024_006E)+parseInt(tractspop.filter(d => (d.tract == feature.properties.TRACTCE) && (d.county == feature.properties.COUNTYFP))[0].B25024_007E) + parseInt(tractspop.filter(d => (d.tract == feature.properties.TRACTCE) && (d.county == feature.properties.COUNTYFP))[0].B25024_008E) + parseInt(tractspop.filter(d => (d.tract == feature.properties.TRACTCE) && (d.county == feature.properties.COUNTYFP))[0].B25024_009E))/(parseInt(tractspop.filter(d => (d.tract == feature.properties.TRACTCE) && (d.county == feature.properties.COUNTYFP))[0].B25024_006E)+parseInt(tractspop.filter(d => (d.tract == feature.properties.TRACTCE) && (d.county == feature.properties.COUNTYFP))[0].B25024_007E) + parseInt(tractspop.filter(d => (d.tract == feature.properties.TRACTCE) && (d.county == feature.properties.COUNTYFP))[0].B25024_008E) + parseInt(tractspop.filter(d => (d.tract == feature.properties.TRACTCE) && (d.county == feature.properties.COUNTYFP))[0].B25024_009E) + parseInt(tractspop.filter(d => (d.tract == feature.properties.TRACTCE) && (d.county == feature.properties.COUNTYFP))[0].B25024_002E) + parseInt(tractspop.filter(d => (d.tract == feature.properties.TRACTCE) && (d.county == feature.properties.COUNTYFP))[0].B25024_003E) + parseInt(tractspop.filter(d => (d.tract == feature.properties.TRACTCE) && (d.county == feature.properties.COUNTYFP))[0].B25024_004E) + parseInt(tractspop.filter(d => (d.tract == feature.properties.TRACTCE) && (d.county == feature.properties.COUNTYFP))[0].B25024_005E) + parseInt(tractspop.filter(d => (d.tract == feature.properties.TRACTCE) && (d.county == feature.properties.COUNTYFP))[0].B25024_010E) + parseInt(tractspop.filter(d => (d.tract == feature.properties.TRACTCE) && (d.county == feature.properties.COUNTYFP))[0].B25024_011E))
         }
        feature.properties = Object.assign({},feature.properties,pop)

      })
      //

  

      map.on('load', function () {

        function menuToggle(div,layer){
          var toggle = document.getElementById(div);


          toggle.addEventListener('click', function () {
          if (toggle.checked === false) {
              //toggle.setAttribute('class', 'off');
              map.setLayoutProperty(layer, 'visibility', 'none');
              map.setLayoutProperty(layer, 'visibility', 'none');
              //toggle.className = 'off';
          }
          else {
              //toggle.setAttribute('class', 'on bordertop');
              map.setLayoutProperty(layer, 'visibility', 'visible');
              map.setLayoutProperty(layer, 'visibility', 'visible');
              //toggle.className = 'on';
              }
            });
          }
        //Add functions to toggles
        // population, race, income, tenure, affordability, multifamily, transit, broadband, schools, parks
        menuitems =[{'div':'population','layer':'population'},{'div':'race','layer':'null'},{'div':'income','layer':'income'},{'div':'tenure','layer':'owner'},{'div':'affordability','layer':'nhpd'},{'div':'multifamily','layer':'multifamily'}]
        menuitems.forEach(d => menuToggle(d.div,d.layer))
        //Add geojson file as data source
        map.addSource('indiana', {
          'type': 'geojson',
          'data': foo
          });

        map.addSource('tracts', {
          'type': 'geojson',
          'data': tractsgeo
          });

        map.addSource('nhpd', {
          'type': 'geojson',
          'data': nhpd
          });
        //Add fill layer to map 
        
        map.addLayer({
          'id': 'indiana',
          'type': 'fill',
          'source': 'indiana',
          'paint': {
            'fill-color': 'rgba(0,55,104,.2)',
          }
        }, 'road-primary')

        map.addLayer(
          {
          'id': 'indiana-highlighted',
          'type': 'fill',
          'source': 'indiana',
          'paint': {
          'fill-outline-color': '#484896',
          'fill-color': '#6e599f',
          'fill-opacity': 0.3
          },
          'filter': ['in', 'COUNTYFP', '']
          },
          'road-primary',
          );

        map.on('click', 'indiana', function (e) {

            $('#geography option:contains(' + e.features[0].properties.NAMELSAD + ')').prop({selected: true});

            if ("createEvent" in document) {
                var evt = document.createEvent("HTMLEvents");
                evt.initEvent("change", false, true);
                geographies.dispatchEvent(evt);
            }
            else
                geographies.fireEvent("onchange");

            var bbox = [
              [e.point.x - 1, e.point.y - 1],
              [e.point.x + 1, e.point.y + 1]
              ];
              var features = map.queryRenderedFeatures(bbox, {
              layers: ['indiana']
              });
               
              // Run through the selected features and set a filter
              // to match features with unique FIPS codes to activate
              // the `counties-highlighted` layer.
              var filter = features.reduce(
              function (memo, feature) {
              memo.push(feature.properties.COUNTYFP);
              return memo;
              },
              ['in', 'COUNTYFP']
              );
               
              map.setFilter('indiana-highlighted', filter);

          });

        map.on('mouseenter', 'indiana', function () {
          map.getCanvas().style.cursor = 'pointer';
          });
           
          // Change the cursor back to a pointer
          // when it leaves the states layer.
          map.on('mouseleave', 'indiana', function () {
          map.getCanvas().style.cursor = '';
          });

        map.addLayer({
          'id': 'nhpd',
          'type': 'circle',
          'source': 'nhpd',
          'layout': {
            'visibility': 'none'
            },
          'paint': {
            'circle-radius': 2,
            'circle-color': '#F84C4C' // red color
            }
        },'indiana')

        map.on('click', 'nhpd', function (e) {
        var coordinates = e.features[0].geometry.coordinates.slice();
        var description = e.features[0].properties.PropertyAddress;
         
        // Ensure that if the map is zoomed out such that multiple
        // copies of the feature are visible, the popup appears
        // over the copy being pointed to.
        while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
        coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
        }
         
        new mapboxgl.Popup()
        .setLngLat(coordinates)
        .setHTML(description)
        .addTo(map);
        });
         
        // Change the cursor to a pointer when the mouse is over the places layer.
        map.on('mouseenter', 'buildings', function () {
        map.getCanvas().style.cursor = 'pointer';
        });
         
        // Change it back to a pointer when it leaves.
        map.on('mouseleave', 'buildings', function () {
        map.getCanvas().style.cursor = '';
        });

        minpop = getMinY(tractsgeo.features,'properties.population')
        maxpop = getMaxY(tractsgeo.features,'properties.population')
        map.addLayer({
          'id': 'population',
          'source': 'tracts',
          'type': 'fill',
          'layout': {
            'visibility': 'none'
            },
          'paint': {
              'fill-color': [
                  'interpolate',
                  ['linear'],
                  ['get', 'population'],
                  minpop,'white',
                  maxpop,'red'
                  ],
              'fill-opacity': 0.75
          }
        })

     
        minincome = 0
        maxincome = getMaxY(tractsgeo.features,'properties.mhi')

        map.addLayer({
          'id': 'income',
          'source': 'tracts',
          'type': 'fill',
          'layout': {
            'visibility': 'none'
            },
          'paint': {
              'fill-color': [
                  'interpolate',
                  ['linear'],
                  ['get', 'mhi'],
                  minincome,'white',
                  maxincome,'red'
                  ],
              'fill-opacity': 0.75
          }
        })

        minowner = 0
        maxowner = 1

        map.addLayer({
          'id': 'owner',
          'source': 'tracts',
          'type': 'fill',
          'layout': {
            'visibility': 'none'
            },
          'paint': {
              'fill-color': [
                  'interpolate',
                  ['linear'],
                  ['get', 'owner'],
                  minowner,'white',
                  maxowner,'red'
                  ],
              'fill-opacity': 0.75
          }
        })

        minmultifamily = 0
        maxmultifamily = 1

        map.addLayer({
          'id': 'multifamily',
          'source': 'tracts',
          'type': 'fill',
          'layout': {
            'visibility': 'none'
            },
          'paint': {
              'fill-color': [
                  'interpolate',
                  ['linear'],
                  ['get', 'multifamily'],
                  minmultifamily,'white',
                  maxmultifamily,'red'
                  ],
              'fill-opacity': 0.75
          }
        })

        //Add seperate stroke layer
        map.addLayer({
          'id': 'indiana-stroke',
          'type': 'line',
          'source': 'indiana',
          'paint': {
            'line-color': 'rgba(0, 55, 104, 1)',
            'line-width': 1
          }
        }
        , 'road-primary'
        )

      })
    }
    
    var files = ["gis/counties.geojson", "gis/tracts2.geojson", "gis/nhpd.geojson"];
      var promises = [];

      files.forEach(function(url) {
          promises.push(fetch(url))
      });

      Promise.all(promises)
        .then(function (responses) {
          // Get a JSON object from each of the responses and merge into one object
          return Promise.all(responses.map(function (response) {
            console.log(response)
            return response.json();
          }));
        })
        .then(function (data) {
          // Assign data
          mapData(data)
        })
        .catch(function (error) {
          // if there's an error, log it
          console.log(error);
        });

      
      
      

  }
  
  
  function collectData(fips,manifest){

    //variable,div
    fetches = Array()
    fetchIndex = []
    vars = []
    for (let [key, value] of Object.entries(manifest.topic)){
      d = value.filter(d => d.dataset == 'ACS')
      for (let [key, value] of Object.entries(d)){
        value.variables.forEach(d => vars.push(d.code))
      }
    }
    let uniqueVars = [...new Set(vars)]

    manifest.sources.forEach(function(x){
      vars = []
      state = '18'
      county = '*'

      for (let [key, value] of Object.entries(manifest.topic)){
        d = value.filter(d => d.dataset == x.name)
        for (let [key, value] of Object.entries(d)){
          value.variables.forEach(d => vars.push(d.code))
        }}

      let uniqueVars = [...new Set(vars)]
      variables = uniqueVars.join()
      
      x.endpoints.forEach(function(endpoint,i){
      
      years.forEach(function(year){
        newurl = endpoint.url
        m = newurl.split("{}").length - 1;
        for (t=0; t<m; t++){
        newurl = newurl.replace("{}",eval(endpoint.sub[t]))
        }
       
      fetches.push(fetch(newurl))
      fetchIndex.push({"geo":manifest.geographies[i],"year":year, 'source': x.name, 'use':'charts'})
      })



      })      
  
  
    })

    /*

        fetches = Array()
    allyears = []
    for (i=2010; i <= 2019; i++){
      allyears.push(i)
    }

    allyears.forEach(function(year){
      manifest.sources.forEach(function(x){
        vars = []
        state = '18'
        county = '*'

        for (let [key, value] of Object.entries(manifest.topic)){
          d = value.filter(d => d.dataset == x.name && findDomain(d.year).includes(year))
          for (let [key, value] of Object.entries(d)){
            value.variables.forEach(d => vars.push(d.code))
          }}

        let uniqueVars = [...new Set(vars)]
        variables = uniqueVars.join()

        x.endpoints.forEach(function(endpoint){
           newurl = endpoint.url
            m = newurl.split("{}").length - 1;
            for (t=0; t<m; t++){
            newurl = newurl.replace("{}",eval(endpoint.sub[t]))
            }
          //fetches.push(fetch(newurl))
          console.log(newurl)
          })

        })

    })

    */

    fetches.push(fetch("https://api.census.gov/data/2019/acs/acs5?get=NAME,B01001_001E,B19013_001E,B25003_002E,B25003_003E,B25024_002E,B25024_003E,B25024_004E,B25024_005E,B25024_006E,B25024_007E,B25024_008E,B25024_009E,B25024_010E,B25024_011E&for=tract:*&in=state:18&key=dd33b0475c26275920fe5c32a030d1a3310e899f"))
    fetchIndex.push({"geo":'tracts',"year":2019, 'source': 'ACS', 'use':'maps'})




    ////ENDTEST

    /*vars = []
    temp1.sources.forEach(function(d){
      list = temp1.topic.filter(d =>   )
      })*/
    
    //Concatenate the variables into a comma seperated string for use in the API call
    
    
    //Since the API has a seperate endpoint for each year, we need to create an array of promises to pull them all
    /*
    fetches = Array()
    years.forEach(year => fetches.push(fetch('https://api.census.gov/data/' + String(year) + '/acs/acs5?get=NAME,'+variables+'&for=county:'+ fips +'&in=state:18&key=dd33b0475c26275920fe5c32a030d1a3310e899f')))*/

    //When all of the promises have resolved assign the data to their appropriate charts
    Promise.all(fetches)
    .then(function (responses) {
      // Get a JSON object from each of the responses and merge into one object
      return Promise.all(responses.map(function (response) {
        return response.json();
      }));
    })
    .then(function (data) {
      // Assign data
      assignData(data,manifest,fetchIndex)
    })
    .catch(function (error) {
      // if there's an error, log it
      console.log(error);
    });

  }


  //Make Initial Charts
  
  fetch('manifest.json')
    .then(response => response.json())
    .then(function(json){
      charts = ['#chart1','#chart2','#chart3','#chart4','#chart5','#chart6']




    //variables = ["B01001_001E","B01003_001E","B17010_003E","B01001_001E","B01003_001E","B17010_003E"]
      variables = ["B01001_001E","B17010_003E",["B19001_002E","B19001_003E","B19001_004E","B19001_005E","B19001_006E","B19001_007E","B19001_008E","B19001_009E","B19001_010E","B19001_011E","B19001_012E","B19001_013E","B19001_014E","B19001_015E","B19001_016E","B19001_017E"],"B01001_001E","B01003_001E","B17010_003E"]
      collectData("*",json)

    });


  

  //Define Method to Update Charts - Remove Existing and Replace (Should update to be dynamic)





});



    /////table

   
</script>
</html>


