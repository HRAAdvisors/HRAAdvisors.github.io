<!DOCTYPE html><!--  This site was created in Webflow. http://www.webflow.com  -->
<!--  Last Published: Wed Sep 22 2021 17:26:40 GMT+0000 (Coordinated Universal Time)  -->
<html data-wf-page="610026e87169194d1bbaa82e" data-wf-site="610026e8716919e35abaa7fd">
<head>
  <meta charset="utf-8">
 
  <link href="css/normalize.css" rel="stylesheet" type="text/css">
  <link href="css/webflow.css" rel="stylesheet" type="text/css">
  <link href="css/abhi-41a04e.webflow.css" rel="stylesheet" type="text/css">
  <script src="https://ajax.googleapis.com/ajax/libs/webfont/1.6.26/webfont.js" type="text/javascript"></script>
  <script type="text/javascript">WebFont.load({  google: {    families: ["Varela Round:400","Cabin:regular,500,500italic,600,600italic,700"]  }});</script>
  <!-- [if lt IE 9]><script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.min.js" type="text/javascript"></script><![endif] -->
  <script type="text/javascript">!function(o,c){var n=c.documentElement,t=" w-mod-";n.className+=t+"js",("ontouchstart"in o||o.DocumentTouch&&c instanceof DocumentTouch)&&(n.className+=t+"touch")}(window,document);</script>
  <link href="images/favicon.png" rel="shortcut icon" type="image/x-icon">
  <link href="images/webclip.png" rel="apple-touch-icon">

 <!-- HR&A Scripts -->
   <script src="https://cdnjs.cloudflare.com/ajax/libs/Turf.js/0.0.124/turf.min.js" integrity="sha512-jpnZ8xGKbS7L9S6d5fk/zDVgF6OoVKLMoEliLxf24BRX+orWhxqJuUcoM+vGmOaozS9dD9ABjQZKAgjjcwTndA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://d3js.org/d3.v4.js"></script>
  <script src="https://d3js.org/d3-geo-projection.v1.min.js"></script>
  <script src="https://d3js.org/d3-array.v1.min.js"></script>
  <script src="https://d3js.org/d3-format.v2.min.js"></script>
  <script src="https://d3js.org/d3-geo.v1.min.js"></script>
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.5.1/mapbox-gl.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.1/papaparse.min.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.5.1/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.5.1/mapbox-gl-geocoder.min.js"></script>
  <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.5.1/mapbox-gl-geocoder.css" type="text/css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/microplugin/0.0.3/microplugin.min.js" integrity="sha512-7amIsiQ/hxbdPNawBZwmWBWPiwQRNEJlxTj6eVO+xmWd71fs79Iydr4rYARHwDf0rKHpysFxWbj64fjPRHbqfA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script> 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.13.3/js/selectize.min.js" integrity="sha512-JiDSvppkBtWM1f9nPRajthdgTCZV3wtyngKUqVHlAs0d5q72n5zpM3QMOLmuNws2vkYmmLn4r1KfnPzgC/73Mw==" crossorigin="anonymous" referrerpolicy="no-referrer" defer></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <script src="https://kit.fontawesome.com/7a4305c6cb.js" crossorigin="anonymous"></script>

   <script src="https://d3e54v103j8qbb.cloudfront.net/js/jquery-3.5.1.min.dc5e7f18c8.js?site=60ad049043fb256ced8f7cd5" type="text/javascript" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
  <script src="js/webflow.js" type="text/javascript"></script>
  <script src="js/turf.min.js"></script>
  <script src="js/venn.js"></script>
  <script src="index.umd.min.js"></script>
  <link href="index.umd.min.css" rel="stylesheet" />
  <link href="https://netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css" rel="stylesheet">

    <!-- Bootstrap core CSS -->
<link href="/docs/5.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-F3w7mX95PdgyTmZZMECAngseQB83DfGTowi0iMjiWaeVhAn4FJkqJByhZMI3AhiU" crossorigin="anonymous">



  <!-- HIGHCHARTS -->
  <script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/modules/series-label.js"></script>
<script src="https://code.highcharts.com/modules/exporting.js"></script>
<script src="https://code.highcharts.com/modules/export-data.js"></script>
<script src="https://code.highcharts.com/modules/accessibility.js"></script>
<script src="https://code.highcharts.com/modules/venn.js"></script>

<style>

   .bd-placeholder-img {
        font-size: 1.125rem;
        text-anchor: middle;
        -webkit-user-select: none;
        -moz-user-select: none;
        user-select: none;
      }

      @media (min-width: 768px) {
        .bd-placeholder-img-lg {
          font-size: 3.5rem;
        }
      }

      /*! CSS Used from: https://getbootstrap.com/docs/5.1/dist/css/bootstrap.min.css */
:root{--bs-blue:#0d6efd;--bs-indigo:#6610f2;--bs-purple:#6f42c1;--bs-pink:#d63384;--bs-red:#dc3545;--bs-orange:#fd7e14;--bs-yellow:#ffc107;--bs-green:#198754;--bs-teal:#20c997;--bs-cyan:#0dcaf0;--bs-white:#fff;--bs-gray:#6c757d;--bs-gray-dark:#343a40;--bs-gray-100:#f8f9fa;--bs-gray-200:#e9ecef;--bs-gray-300:#dee2e6;--bs-gray-400:#ced4da;--bs-gray-500:#adb5bd;--bs-gray-600:#6c757d;--bs-gray-700:#495057;--bs-gray-800:#343a40;--bs-gray-900:#212529;--bs-primary:#0d6efd;--bs-secondary:#6c757d;--bs-success:#198754;--bs-info:#0dcaf0;--bs-warning:#ffc107;--bs-danger:#dc3545;--bs-light:#f8f9fa;--bs-dark:#212529;--bs-primary-rgb:13,110,253;--bs-secondary-rgb:108,117,125;--bs-success-rgb:25,135,84;--bs-info-rgb:13,202,240;--bs-warning-rgb:255,193,7;--bs-danger-rgb:220,53,69;--bs-light-rgb:248,249,250;--bs-dark-rgb:33,37,41;--bs-white-rgb:255,255,255;--bs-black-rgb:0,0,0;--bs-body-color-rgb:33,37,41;--bs-body-bg-rgb:255,255,255;--bs-font-sans-serif:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";--bs-font-monospace:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;--bs-gradient:linear-gradient(180deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0));--bs-body-font-family:var(--bs-font-sans-serif);--bs-body-font-size:1rem;--bs-body-font-weight:400;--bs-body-line-height:1.5;--bs-body-color:#212529;--bs-body-bg:#fff;}
*,::after,::before{box-sizing:border-box;}
@media (prefers-reduced-motion:no-preference){
:root{scroll-behavior:smooth;}
}
body{margin:0;font-family:var(--bs-body-font-family);font-size:var(--bs-body-font-size);font-weight:var(--bs-body-font-weight);line-height:var(--bs-body-line-height);color:var(--bs-body-color);text-align:var(--bs-body-text-align);background-color:var(--bs-body-bg);-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent;}
h1{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2;}
h1{font-size:calc(1.375rem + 1.5vw);}
@media (min-width:1200px){
h1{font-size:2.5rem;}
}
ul{padding-left:2rem;}
ul{margin-top:0;margin-bottom:1rem;}
a{color:#0d6efd;text-decoration:underline;}
a:hover{color:#0a58ca;}
svg{vertical-align:middle;}
button{border-radius:0;}
button:focus:not(:focus-visible){outline:0;}
button,input{margin:0;font-family:inherit;font-size:inherit;line-height:inherit;}
button{text-transform:none;}
[type=button],button{-webkit-appearance:button;}
::-moz-focus-inner{padding:0;border-style:none;}
[type=search]{outline-offset:-2px;-webkit-appearance:textfield;}
.container{width:100%;padding-right:var(--bs-gutter-x,.75rem);padding-left:var(--bs-gutter-x,.70rem);font-size:.9vw !important;}

.col-12{flex:0 0 auto;width:100%;}
@media (min-width:992px){
.col-lg-auto{flex:0 0 auto;width:auto;}
}
.form-control{display:block;width:100%;padding:.375rem .75rem;font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;background-clip:padding-box;border:1px solid #ced4da;-webkit-appearance:none;-moz-appearance:none;appearance:none;border-radius:.25rem;transition:border-color .15s ease-in-out,box-shadow .15s ease-in-out;}
@media (prefers-reduced-motion:reduce){
.form-control{transition:none;}
}
.form-control:focus{color:#212529;background-color:#fff;border-color:#86b7fe;outline:0;box-shadow:0 0 0 .25rem rgba(13,110,253,.25);}
.form-control::-moz-placeholder{color:#6c757d;opacity:1;}
.form-control::placeholder{color:#6c757d;opacity:1;}
.form-control:disabled{background-color:#e9ecef;opacity:1;}
.btn{display:inline-block;font-weight:400;line-height:1.5;color:#212529;text-align:center;text-decoration:none;vertical-align:middle;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;user-select:none;background-color:transparent;border:1px solid transparent;padding:.375rem .75rem;border-radius:.25rem;transition:color .15s ease-in-out,background-color .15s ease-in-out,border-color .15s ease-in-out,box-shadow .15s ease-in-out;}
@media (prefers-reduced-motion:reduce){
.btn{transition:none;}
}
.btn:hover{color:#212529;}
.btn:focus{outline:0;box-shadow:0 0 0 .25rem rgba(13,110,253,.25);}
.btn:disabled{pointer-events:none;opacity:.65;}
.btn-warning{color:#000;background-color:#B8C11C}
.btn-warning:hover{color:#000;background-color:#ffca2c;border-color:#ffc720;}
.btn-warning:focus{color:#000;background-color:#ffca2c;border-color:#ffc720;box-shadow:0 0 0 .25rem rgba(217,164,6,.5);}
.btn-warning:active{color:#000;background-color:#ffcd39;border-color:#ffc720;}
.btn-warning:active:focus{box-shadow:0 0 0 .25rem rgba(217,164,6,.5);}
.btn-warning:disabled{color:#000;background-color:#ffc107;border-color:#ffc107;}
.btn-outline-light{color:#f8f9fa;border-color:#f8f9fa;}
.btn-outline-light:hover{color:#000;background-color:#f8f9fa;border-color:#f8f9fa;}
.btn-outline-light:focus{box-shadow:0 0 0 .25rem rgba(248,249,250,.5);}
.btn-outline-light:active{color:#000;background-color:#f8f9fa;border-color:#f8f9fa;}
.btn-outline-light:active:focus{box-shadow:0 0 0 .25rem rgba(248,249,250,.5);}
.btn-outline-light:disabled{color:#f8f9fa;background-color:transparent;}
.nav{display:flex;flex-wrap:wrap;padding-left:0;margin-bottom:0;list-style:none;}
.nav-link{display:block;padding:.5rem 1rem;color:#0d6efd;text-decoration:none;transition:color .15s ease-in-out,background-color .15s ease-in-out,border-color .15s ease-in-out;}
@media (prefers-reduced-motion:reduce){
.nav-link{transition:none;}
}
.nav-link.selected{
  color:#B8C11C !important;
}
.nav-link:hover{color:#000000 !important;}
.visually-hidden{position:absolute!important;width:1px!important;height:1px!important;padding:0!important;margin:-1px!important;overflow:hidden!important;clip:rect(0,0,0,0)!important;white-space:nowrap!important;border:0!important;}
.d-flex{display:flex!important;}
.justify-content-center{justify-content:center!important;}
.align-items-center{align-items:center!important;}
.me-2{margin-right:.5rem!important;}
.mb-2{margin-bottom:.5rem!important;}
.mb-3{margin-bottom:1rem!important;}
.p-3{padding:1rem!important;}
.px-2{padding-right:.5rem!important;padding-left:.5rem!important;}
.text-end{text-align:right!important;}
.text-decoration-none{text-decoration:none!important;}
.text-secondary{--bs-text-opacity:1;color:rgba(var(--bs-secondary-rgb),var(--bs-text-opacity))!important;}
.text-white{--bs-text-opacity:1;color:rgba(var(--bs-white-rgb),var(--bs-text-opacity))!important;}
.bg-dark{--bs-bg-opacity:1;background-color:rgba(var(--bs-dark-rgb),var(--bs-bg-opacity))!important;}
@media (min-width:768px){
.mb-md-0{margin-bottom:0!important;}
}
@media (min-width:992px){
.justify-content-lg-start{justify-content:flex-start!important;}
.me-lg-3{margin-right:1rem!important;}
.me-lg-auto{margin-right:auto!important;}
.mb-lg-0{margin-bottom:0!important;}
}
/*! CSS Used from: https://getbootstrap.com/docs/5.1/examples/headers/headers.css */
.form-control-dark{color:#fff;background-color:var(--bs-white);border-color:var(--bs-gray);}
.form-control-dark:focus{color:#fff;background-color:var(--bs-dark);border-color:#fff;box-shadow:0 0 0 .25rem rgba(255, 255, 255, .25);}
.bi{vertical-align:-.125em;fill:currentColor;}

    td{
      padding: 6px !important;
      border-top: 1px solid #fff;
      border-bottom: 1px solid #fff;
      color: #fff !important;
      text-align: right !important;
    }

    th{
          padding: 6px !important;
    /* border: 1px solid #ccc; */
    text-align: right !important;
    color: #fff !important;
    border-bottom: 3px solid #fff;
    }

    select{
      margin: .5rem 1rem;
      /*background: #d6ddff !important;*/
    }

      .selector{
      margin: .5rem 0rem;
      color: white;
      /*background: #d6ddff !important;*/
    }

    #table select{
      color:black;
    }

    .bubbles{
      display:none;
    }

    .highcharts-title{
      font-size: 1vw !important
    }

    .highcharts-subtitle{
      font-size: .75vw
    }


    #table {
    display: block;
    margin-top: .5%;
    margin-right: .5%;
    margin-left: .5%;
    margin-bottom: .5%;
    padding: 20px;
    -webkit-box-flex: 1;
    -webkit-flex: 1;
    -ms-flex: 1;
    flex: 1;
    border-radius: 8px;
    background-color: #003768;
    }
      .mapboxgl-ctrl-icon{
        position: static !important;
      }
      .mapboxgl-ctrl-logo{
        display:none !important;
        }
      .mapboxgl-ctrl-bottom-right{
        display:none !important;
        }
      .mapboxgl-ctrl-bottom-left{
        /*display:none !important;*/
        }
      .css-9emwa5{
        display:none !important;
        }
      .deck-tooltip {
        font-family: Helvetica, Arial, sans-serif;
        padding: 6px !important;
        margin: 8px;
        max-width: 300px;
        font-size: 10px;
        }
      .line {
        fill: none;
        stroke: #ffab00;
        stroke-width: 2;
        }
      .tick line{
        visibility:hidden;
        }
      .overlay {
        fill: none;
        pointer-events: all;
        }
      .dot {
        fill: #ffab00;
        stroke: #fff;
        }
      .focus circle {
        fill: none;
        stroke: steelblue;
        }
      div.tooltip2 { 
        position: absolute;     
        text-align: center;               
        padding: 10px;       
        font: 12px sans-serif;    
        background: #fff;
        border: 2px solid #000;   
        border-radius: 5px;     
        pointer-events: none;
        -moz-border-radius:5px;
        color: black
        z-index: 10;     
        }
      span {
        position: absolute;
        }
      table{
        width: -webkit-fill-available;
        text-align: center;
        }

        .mapboxgl-canvas-container {

    width: 100%;

}
#menu a {
        text-decoration: none
    }
    #menu a:link {
        color: #51b3c9;
    }
    #menu a:visited {
        color: #51b3c9;
    }
    #menu a:active {
        color: #51b3c9;
    }
    #menu #logo {
        position: absolute;
        z-index: 1;
        bottom: 20px;
        right: 20px;
        background: rgba(255, 255, 255, 0.6);
    }

    #container, #container > .highcharts-container {
  overflow: visible!important;
}

    #menu {
        background: white;
        font-family: 'Nunito', sans-serif;
        font-size: 15px;
        position: relative;
        z-index: 1;
        top: 10px;
        left: 10px;
        width: 2.75em;
        display: inline-block;
        color: #fff;
        box-shadow: 1.5px 1.5px 2px rgba(0, 0, 0, 0.2);
        -moz-box-shadow: 1.5px 1.5px 2px rgba(0, 0, 0, 0.2);
        -webkit-box-shadow: 1.5px 1.5px 2px rgba(0, 0, 0, 0.2)
    }

    #menu p{
      margin-block-start: .1em;
    margin-block-end: .5em;
    margin-inline-start: .25em;
    height: 1em;
    }
    #menu .on {
        background: white;
        background-origin: content-box;
        background-size: 18px 18px;
        display: block;
        margin: 0;
        padding: 10px;
        color: black;
        border-bottom: 1px solid #d5dcde;
    }
#menu #population{border-top: 1px solid #8D9192;}
    #menu .on:hover {
        cursor: pointer;
    }
    #menu .off {
        background: #e2e2e2;
        background-origin: content-box;
        background-size: 18px 18px;
        color: #949494;
        display: block;
        margin: 0;
        padding: 0;
        padding: 10px;
        border-bottom: 1px solid #d5dcde;
    }

    #menu.off img{
        opacity: 30%;
    }

    #menu .legend {
        padding: 10px;
        background: #fff;
        color: #C7354D;
        vertical-align:middle;
    }
    #menu .row {
        display: table-row;
    }
    #menu .noborder {
        border-bottom: 0px solid white;
    }
 #infowindow {
           position: absolute;
            width: 50%;
            margin-left: 25%;
            background-color: rgba(255, 255, 255, 1);
            box-shadow: 0 1px 5px rgba(0, 0, 0, .4);
            color:#666;
            padding:10px 10px 8px 10px;
            font-family: sans-serif;
            cursor: pointer;
            font-size:14px;
            text-decoration:none;
            z-index:1002;
        }
        #header {
        display:block;
            top:10px;
            width:98%;
            font-size:15px;
            z-index:-4;
            font-family: sans-serif;
            text-transform: uppercase;
            text-decoration:none;
            color: #003E7A;
            cursor: pointer;
            padding-bottom: 5px;
            border-bottom: 1px solid #e5e5e5;
        }
        #assumptions {
            display: block;
            top:39px;
            height: 90%;
            width: 98.5%;
            overflow: auto;
        }
        #closewindow {
        position: absolute;
            top:1.5%;
            right:1.5%;
            font-size:15px;
            z-index:1002;
            font-family: sans-serif;
            text-transform: uppercase;
            text-decoration:none;
            color: #003E7A;
            cursor: pointer;
        }
        #isolate {
        position: fixed;
        top:0px;
            width:100%;
            height:-webkit-fill-available;
            z-index:1001;
            background-color: #000;
            opacity:.75;
        }



.settings .source {
  background: rgba(0, 62, 122, 1);
  height: 30px;
  font-size: 1.2rem;
  top: 8px;
  left: 20px;
  border-top-right-radius: 3px !important;
  border-top-left-radius: 3px !important;
  padding: 5px 10px;
  cursor: pointer;
  margin: 5px;
}

* {
  transition: all .2s ease;
}

rect{
  transition:none !important;
}
.extra-source {
  display: none;
  line-height: 19px;
  font-size: 12px;
  position: absolute;
  top: 0;
  left: 25px;
  
  z-index: 100;
}

.source:hover .extra-source {
  display: block;
}

.source {
  font-size: 13px;
  padding-left: 5px;
  width: auto;
  border-radius: 15px !important;
  position: absolute;
  bottom: 0px;
  border-collapse: separate;
  overflow: hidden;
  z-index: 100;
}

.source:hover {
  background-color: lightgrey;
  padding: 0 0 0 5px;
  width: 315px;
  text-align: left !important;
}

.chartarea {
  position: relative;
  margin-left:5%;
  margin-right:5%;
  margin-top:3%;

}

.chart .labeler {
  fill: black;
  /*font: 14px sans-serif;*/
  text-anchor: end;
}

.nav{
padding-top: 0px !important;
padding-bottom: 0px !important;
}

.nav li{
  margin-bottom: 0px !important;
}
.venn-area .label{
  font-size: .5em;
}

/*  Toggle Switch  */

.toggleSwitch span span {
  display: none;
}  
  
.toggleSwitch {
  display: inline-block;
  height: 18px;
  position: relative;
  overflow: visible;
  padding: 0;
  cursor: pointer;
  width: 12em;
  margin: 0rem .5rem;
  background-color: #fafafa;
  border: 1px solid #ccc;
  border-radius:5px;
  height:34px;
}
.toggleSwitch * {
  -webkit-box-sizing: border-box;
  -moz-box-sizing: border-box;
  box-sizing: border-box;
}
.toggleSwitch label,
.toggleSwitch > span {
  line-height: 20px;
  height: 20px;
  vertical-align: middle;
}
.toggleSwitch input:focus ~ a,
.toggleSwitch input:focus + label {
  outline: none;
}
.toggleSwitch label {
  position: relative;
  z-index: 3;
  display: block;
  width: 100%;
}
.toggleSwitch input {
  position: absolute;
  opacity: 0;
  z-index: 5;
}
.toggleSwitch > span {
  position: absolute;
  left: 0;
  width: calc(100% - 6px);
  margin: 0;
  text-align: left;
  white-space: nowrap;
  margin:0 3px;
}
.toggleSwitch > span span {
  position: absolute;
  top: 0;
  left: 0;
  z-index: 5;
  display: block;
  width: 50%;
  margin-left: 50px;
  text-align: left;
  width: auto;
  left: 0;
  top: -1px;
  opacity: 1;
  width:40%;
  text-align: center;
  line-height:34px;
}
.toggleSwitch a {
  position: absolute;
  right: 50%;
  z-index: 4;
  display: block;
  top: 3px;
  bottom: 3px;
  padding: 0;
  left: 3px;
  width: 50%;
  background-color: #B8C11C;
  border-radius: 4px;
  -webkit-transition: all 0.2s ease-out;
  -moz-transition: all 0.2s ease-out;
  transition: all 0.2s ease-out;
  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
}
.toggleSwitch > span span:first-of-type {
  color: #FFF;
  opacity: 1;
  left: 0;
  margin: 0;
    width: 50%;
}
.toggleSwitch > span span:last-of-type {
  left:auto;
  right:0;
  color: black;
  margin: 0;
    width: 50%;
}
.toggleSwitch > span:before {
  content: '';
  display: block;
  width: 100%;
  height: 100%;
  position: absolute;
  left: 0;
  top: -2px;
  /* background-color: #fafafa;
  border: 1px solid #ccc; */
  border-radius: 30px;
  -webkit-transition: all 0.2s ease-out;
  -moz-transition: all 0.2s ease-out;
  transition: all 0.2s ease-out;
}
.toggleSwitch input:checked ~ a {
  left: calc(50% - 3px);
}
.toggleSwitch input:checked ~ span:before {
  /* border-color: #0097D1;
  box-shadow: inset 0 0 0 30px #0097D1; */
}
.toggleSwitch input:checked ~ span span:first-of-type {
  left:0;
  color: black;
}
.toggleSwitch input:checked ~ span span:last-of-type {
  /* opacity: 1;
  color: #fff;   */
  color:#FFF;
}
/* Switch Sizes */
.toggleSwitch.large {
  width: 60px;
  height: 27px;
}
.toggleSwitch.large a {
  width: 27px;
}
.toggleSwitch.large > span {
  height: 29px;
  line-height: 28px;
}
.toggleSwitch.large input:checked ~ a {
  left: 41px;
}
.toggleSwitch.large > span span {
  font-size: 1.1em;
}
.toggleSwitch.large > span span:first-of-type {
  left: 50%;
}
.toggleSwitch.xlarge {
  width: 80px;
  height: 36px;
}
.toggleSwitch.xlarge a {
  width: 36px;
}
.toggleSwitch.xlarge > span {
  height: 38px;
  line-height: 37px;
}
.toggleSwitch.xlarge input:checked ~ a {
  left: 52px;
}
.toggleSwitch.xlarge > span span {
  font-size: 1.4em;
}
.toggleSwitch.xlarge > span span:first-of-type {
  left: 50%;
}


.highcharts-figure, .highcharts-data-table table {
    min-width: 320px; 
    max-width: 800px;
    margin: 1em auto;
}

.highcharts-data-table table {
  font-family: Verdana, sans-serif;
  border-collapse: collapse;
  border: 1px solid #EBEBEB;
  margin: 10px auto;
  text-align: center;
  width: 100%;
  max-width: 500px;
}
.highcharts-data-table caption {
    padding: 1em 0;
    font-size: 1.2em;
    color: #555;
}
.highcharts-data-table th {
  font-weight: 600;
    padding: 0.5em;
}
.highcharts-data-table td, .highcharts-data-table th, .highcharts-data-table caption {
    padding: 0.5em;
}
.highcharts-data-table thead tr, .highcharts-data-table tr:nth-child(even) {
    background: #f8f8f8;
}
.highcharts-data-table tr:hover {
    background: #f1f7ff;
}

.hra {
  display: inline-block;
  max-width: 128px;
}

/* line 802, scss/components/_calc.scss */
.calc__credit {
  font-size: .79rem;
  text-align: center;
  margin-top: .75rem;
}

/* line 807, scss/components/_calc.scss */
.calc__credit p {
  margin-bottom: .25rem;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
}

/* line 814, scss/components/_calc.scss */
.calc__credit p img {
  flex: 1;
  margin-left: .75rem;
}

@media screen and (min-width: 1000px) {
  /* line 802, scss/components/_calc.scss */
  .calc__credit {
    font-size: .7rem;
    text-align: left;
  }
}

input[type="number"] {
  min-width: 50px;
}

  /*  End Toggle Switch  */

</style>
</head>
<body position="relative" class="lnd_body">
  <div id=isolate> </div><div id=infowindow><div id=header> <b>      User Guide </b></div><div id=closewindow> <i class="far fa-times-circle"></i> </div><div id=assumptions><p style="margin:0in;font-size:15px;">Welcome to the Indiana State Housing Dashboard, a platform for you to track demographic and housing trends across the state at a county-by-county level. This dashboard was sponsored by the Indiana Housing and Community Development Agency (IHCDA) and guided by a Housing Working Group comprised of a broad range of housing stakeholders from across the state.  <br><br><strong>To Use:</strong></p><br><p style="margin:0in;font-size:15px;">This dashboard allows you to see a data snapshot for each county in the state, to compare data points across different counties, and to export a Housing Needs Assessment with detailed housing and demographic analysis for each county. Select the topic and geography from the two drop-down menus at the top of the homepage to change the information that you see.  

To see how housing and demographic trends vary geospatially, select the layers button in the top left-hand corner of the map.  

To compare data points for up to three counties, select the COMPARE button in the top right of the home page. To export a full housing needs assessment report for your selected county, select the EXPORT button.<br><br>If you are looking for affordable housing, please visit <a href="https://www.indianahousingnow.org/">Indiana Housing Now</a>, the State's free online resource for renters and property managers.</p><br><font size=small>Â©2021 IHCDA</font></div></div>
             <div class="tab02_title">MAP<div style="display:none;"><select class="js-example-basic-single" name="state" id="topic">
                <option value="population">the population</option>
                <option value="housing">housing</option>
                <option value="housingafford">housing affordability</option>
                <option value="jobs">jobs</option>
              </select></div></div>

 <header class="p-3 bs-gray-dark text-white" style="background:#003768">
    <div class="container">
      <div class="d-flex flex-wrap align-items-center justify-content-center justify-content-lg-start">
        <a href="/" class="d-flex align-items-center mb-2 mb-lg-0 text-white text-decoration-none">
          <img src="images/logo-white.svg" height="50"></img>
        </a>

        <ul class="nav col-12 col-lg-auto me-lg-auto mb-2 justify-content-center mb-md-0">
          <li><a href="#" class="nav-link px-2 text-white selected" style="margin-left:2vw;" value="population">Population</a></li>
          <li><a href="#" class="nav-link px-2 text-white" value="housing">Housing</a></li>
          <li><a href="#" class="nav-link px-2 text-white" value="housingafford">Housing Affordability</a></li>
          <li><a href="#" class="nav-link px-2 text-white" value="jobs">Jobs</a></li>
          <li style="margin-left: 1vw;
    margin-right: 1vw;
    border-left: solid #ffffff;
    border-width:1px;"></li>
          <li class="selector">Select Geography: </li><li><select class="js-example-basic-single" id="geography">
                <option value="Indiana">Indiana</option>
              </select></li>
               <li style="margin-left: 1vw;
    margin-right: 1vw;
    border-left: solid #ffffff;
    border-width:1px;"></li>
    <li class="selector">
      Select View: </li><li> 
      <label class="toggleSwitch nolabel" onclick="">
                      <input type="checkbox" class="toggler" unchecked >
                      <a></a>
                      <span>
                        <span class="left-span">Dashboard</span>
                        <span class="right-span">Compare</span>
                      </span>                     
                    </label>
    </li>
        </ul>

        <div class="text-end">
          <button type="button" class="btn btn-outline-light info" style="margin-right:1vw;">Info</button>
          <button type="button" class="btn btn-warning" onclick="NewTab()">Export Full Report</button>
        </div>
      </div>
    </div>
  </header>

  <div class="tab02">

        <div class="tab02_mask-copy3 w-tab-content">
          <div data-w-tab="Tab 1" class="tab02_tab w-tab-pane w--tab-active" id="tab1">
            <div class="tab02_content">
              <div class="w-layout-grid grid-2">
                <div id="w-node-f9b27b36-ece7-1795-db46-88ca30434f4f-1bbaa82e" class="div-block-127">

                  <div class="w-layout-grid grid">
                    <div id='chart1' class="chartarea"><b><span id='label1'>Population</span></b><div class="source" id='source1'>
      <i class="icon-info-sign" ></i>

      <span class="extra-source" id='chart1source'>
        American Community Survey; 5-Year Estimates
      </span>
    </div></div>
                  <div id='chart2' class="chartarea"><b><span id='label2'>Median Income</span></b><div class="source" id='source2'>
      <i class="icon-info-sign"></i>

      <span class="extra-source" id='chart2source'>
        
      </span>
    </div></div>
                  <div id='chart3' class="chartarea"><div id='tempcover' style=' display: none;
    color: white;
    text-align: center;
    background: blue;
    width: 100%;
    height: 100%;
    z-index: 100;'>Median Listing Price in Progress</div><b><span id='label3'>Household Income Distribution</span></b><div class="source" id='source3'>
      <i class="icon-info-sign" id='info3'></i>

      <span class="extra-source" id='chart3source'>
        
      </span>
    </div></div>
                  <div id='chart4' class="chartarea"><b><span id='label4'>Family Poverty Rate</span></b><div class="source" id='source4'>
      <i class="icon-info-sign"></i>

      <span class="extra-source" id='chart4source'>
        
      </span>
    </div></div>
                  <div id='chart5' class="chartarea"><b><span id='label5'>Tenure</span></b><div class="source" id='source5'>
      <i class="icon-info-sign"></i>

      <span class="extra-source" id='chart5source'>
        
      </span>
    </div></div>
                  <div id='chart6' class="chartarea"><b><span id='label6'>Racial Composition</span></b><div class="source" id='source6'>
      <i class="icon-info-sign"></i>

      <span class="extra-source" id='chart6source'>
        
      </span>
    </div></div>
                  </div>
                </div>
                <div class="div-block-128" id = 'map'>

                </div>
              </div>
            </div>
          </div>
          <div data-w-tab="Tab 3" class="tab02_tab w-tab-pane" id="tab2">
            <div class="tab02_content"><div class="column-3 w-col w-col-11" id='table'></div></div>
          </div>
        </div>
      </div>
      <div class="lnd_footer">
        <div style = "font-size: xx-large;
    font-weight: 900;
    float: left;margin-top: .25em;
    padding-left: 1em;">Indiana Housing Dashboard</div>
        <div style="float: right;
    padding: 1rem 1rem;"><p>Developed in partnership with <a href="https://www.hraadvisors.com/" target="_blank"><img src="https://www.upforgrowth.org/themes/bricklett/img/HRA.png" alt="" class="hra"></a></p></div>
      </div>
    </div>
  </div>
  <script src="https://d3e54v103j8qbb.cloudfront.net/js/jquery-3.5.1.min.dc5e7f18c8.js?site=610026e8716919e35abaa7fd" type="text/javascript" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
  <script src="js/webflow.js" type="text/javascript"></script>
  <!-- [if lte IE 9]><script src="https://cdnjs.cloudflare.com/ajax/libs/placeholders/3.0.2/placeholders.min.js"></script><![endif] -->
</body>
<script>

$('.toggler').on('click', function(){
          if (document.querySelector('.toggler').checked == 0){
            $('#tab2').removeClass('w--tab-active');  $('#tab1').addClass('w--tab-active');
          }else{
            $('#tab1').removeClass('w--tab-active');  $('#tab2').addClass('w--tab-active');}
        
        })



function sum(input){
             
 if (toString.call(input) !== "[object Array]")
    return false;
      
            var total =  0;
            for(var i=0;i<input.length;i++)
              {                  
                if(isNaN(input[i])){
                continue;
                 }
                  total += Number(input[i]);
               }
             return total;
            }
window.exportloc = "https://hraadvisors.github.io/Indiana_092221/reports/Indiana_State_Report.pdf"

function NewTab() {
    window.open(
      window.exportloc, "_blank");
}

function removeAllChildNodes(parent) {
    while (parent.firstChild) {
        parent.removeChild(parent.firstChild);
    }
}

function toggleMenu() {
  var menuBox = document.getElementById('menu-box');
  var menu = document.getElementById('menu');    
  if(menuBox.style.display == "block") { // if is menuBox displayed, hide it
    menuBox.style.display = "none";
    menu.style.width = '2.75em';
  }
  else { // if is menuBox hidden, display it
    menuBox.style.display = "block";
    menu.style.width = '275px';
  }
}

  $('.info').bind('click', function() {

      document.getElementById('infowindow').style.zIndex ='1002';
        document.getElementById('closewindow').style.zIndex ='1002';
        document.getElementById('isolate').style.zIndex ='1001';
        document.getElementById('isolate').style.backgroundColor ='#000';
        document.getElementById('isolate').style.opacity ='.75';

  });

  $('#closewindow').bind('click', function() {

        document.getElementById('infowindow').style.zIndex ='-4';
                  document.getElementById('closewindow').style.zIndex ='-4';
                  document.getElementById('isolate').style.zIndex ='-1';
                  document.getElementById('isolate').style.backgroundColor ='#ffffff';
              document.getElementById('isolate').style.opacity ='1';

    });


    function hide(){
  document.querySelector('#tempcover').style.display = 'block';
      document.querySelector('#label3').style.display = 'none';
      document.querySelector('#info3').style.display = 'none';
       if (document.querySelector('#chart3 svg') != null){
        document.querySelector('#chart3 svg').style.display = 'none'
      }
}

function show(){
      document.querySelector('#tempcover').style.display = 'none';
      document.querySelector('#label3').style.display = 'block';
      document.querySelector('#info3').style.display = 'block';

      if (document.querySelector('#chart3 svg') != null){
        document.querySelector('#chart3 svg').style.display = 'block'
      }
      
}


function hidecheck(divs,code){
  if(divs == '#chart3'){
  if(code.includes('mlp')){
      hide()
    }else{
      show()
    }}


}

//Define Labels
span = ['#label1','#label2','#label3','#label4','#label5','#label6']
population = ['Population','Median Income','Household Income Distribution','Family Poverty Rate','Tenure','Racial Composition']
housing = ['Housing Units by Typology','Housing Units by Decade Built','Median Listing Price','Median Rent','Housing Starts','']
housingafford = ['Cost Burdened Households','Cost Burden by Tenure','Cost Burden by Income','Rental Housing Gap','Home Value Affordable to Median Household','']
jobs = ['Unemployment Rate','Top 5 Employers by Jobs','Median Salary','Inflow/Outflow','','']

//Function to relabel spans when topic is changed
reLabel = function(spans,labels){
  spans.forEach(function(d,i){
    document.querySelector(d).innerHTML = labels[i]
    } )
  } 


//Make Tooltip
var tip = d3.select("body").append("div") 
    .attr("class", "tooltip2")
    .style("position","absolute")       
    .style("opacity", 0);

//Define diminisons of chart modules based on the initial div dimensions of the first chart
var margin = {top: 30, right: 30, bottom: 30, left: 30}
var divs = d3.select('#chart1')
element = divs.node();
width = (element.getBoundingClientRect().width*.8) - margin.left - margin.right,
height = (element.getBoundingClientRect().height*.8) - margin.top - margin.bottom;


//Select the Topic Select Box
const topic = document.querySelector('#topic')

//Define a method to dynamically resize the select box based on selected text length; Initialize based on starting text.
//The second argument is True (1) if the resize is performed on initial page load or False (0) upon new selection
function selectResize(id,initial,eval){
  const select = document.querySelector(id) 

  //We need to make temporary selections with only one options to grab the DOM evaluated width of the container 
  let tempSelect = document.createElement('select'),
      tempOption = document.createElement('option');

  if (initial == 1){
    if (eval == 1){
      tempOption.textContent = select.options[select.selectedIndex].text;
    }else{
      tempOption.textContent = select.getElementsByTagName("option")[0].text + "t";
    }
    value = select.value;
    }else{
    tempOption.textContent = event.target.options[event.target.selectedIndex].text;
    value = event.target.options[event.target.selectedIndex].value;
    }

  tempSelect.style.cssText += `
    visibility: hidden;
    position: fixed;
    `;
  tempSelect.appendChild(tempOption);

  if (initial == 1){
    select.after(tempSelect)
    widthselect = tempSelect.getBoundingClientRect().width
    select.style.width = `${widthselect}px`;
    }else{
    event.target.after(tempSelect)
    widthselect = tempSelect.getBoundingClientRect().width
    event.target.style.width = `${widthselect}px`;
    }
  tempSelect.remove()

  return value
  }

//Perform initial resize
selectResize('#topic',1)


var geography = d3.select("#geography")
window.addEventListener("load", function(){


  //Build Charts
  //Chart 1
  years = [2010,2011,2012,2013,2014,2015,2016,2017,2018,2019]


  //Define functions to get min and max value of items in a dictionary 
  function getYs(data,value){
    return data.map(d => eval('d.' + value));
    }
  function getMinY(data,value){
    return Math.min(...getYs(data,value));
    }
  function getMaxY(data,value){
    return Math.max(...getYs(data,value));
    }

  function findDomain(year){
    if (year === "terminal"){
      domain = [2010,2019]
    }else if (year === 'latest'){
      domain = [2019]
    }else if (year === 'all'){
      domain = []
      for (var i = 2010; i <= 2019; i++) {
         domain.push(i);
      } 
    }
  return domain
  }

  function makeLineChart(dataset,divs,value,format,transform,year,title,description,source){

    

    divs = divs.replace("#","")

    domain = findDomain(year)


    margin.left = 65
    code = []
    value.forEach(d => code.push(d.code))
    
    codename = divs.replace('#','') + "_code"

    if (transform != undefined){


      dataset.map(function(d){
        d['newkey'] = eval(transform.calc)
        d['codename'] = codename
        return d
      });

      code = ["newkey"]

    }else{
      dataset.map(function(d){
        d['codename'] = codename
        return d
      });
    }

    data = []
    dataset.forEach(d => data.push(parseFloat(d[code])))


    window[codename] = code


    if (format.suffix == "%"){
      data = data.map(function(x) { return x * 100; })
      decimal = 1
    }else{
      decimal = 0
    }


    /////////////////HIGHCHARTS/////////////


      Highcharts.wrap(Highcharts.Chart.prototype, 'contextMenu', function(proceed) {
  proceed.apply(this, Array.prototype.slice.call(arguments, 1));

  // Correct for chart position
  var pos = Highcharts.offset(this.container);
  var defaultPadding = 5 * 2; // default from menuStyle option: https://api.highcharts.com/highcharts/navigation.menuStyle
  this.exportContextMenu.style.top = (pos.top ) + 'px';
  this.exportContextMenu.style.left = (pos.left + this.chartWidth - this.exportMenuWidth) + 'px';
  this.exportContextMenu.style.width = this.exportMenuWidth + 'px';

  // Move it to the body
  Highcharts.doc.body.appendChild(this.exportContextMenu);
});

      Highcharts.setOptions({
        colors: ['#073863'],
          lang: {
            thousandsSep: ','
          }
        })

        new Highcharts.chart(divs, {

          title: {
            text: title,
            align: 'left'
          },
          
          subtitle: {
            text: description,
            align: 'left',
            verticalAlign:'top'
          },

          yAxis: {
            gridLineWidth: 0,
            title: {
              text: undefined
            },
            labels: {
                formatter: function() {
                    var ret,
                        numericSymbols = ['k', 'M', 'G', 'T', 'P', 'E'],
                        i = 6;
                    if(this.value >=1000) {
                        while (i-- && ret === undefined) {
                            multi = Math.pow(1000, i + 1);
                            if (this.value >= multi && numericSymbols[i] !== null) {
                                ret = (this.value / multi) + numericSymbols[i];
                            }
                        }
                    }
                    return format.prefix + (ret ? ret : this.value) + format.suffix;
                }
            }
           
          },

          xAxis: {
            accessibility: {
              rangeDescription: 'Range: 2010 to 2019'
            }
          },

          tooltip: {
            valueDecimals: decimal,
            valuePrefix: format.prefix,
            valueSuffix: format.suffix
          },

          legend: {
            layout: 'vertical',
            align: 'right',
            verticalAlign: 'middle',
            enabled:false
          },

          plotOptions: {
            
            series: {
              dataLabels: {
                        enabled: true,
                        format: format.prefix + '{point.y:'+ format.formatter + '}' + format.suffix,
                filter: {
                            property: 'y',
                            operator: '===',
                            value: data[data.length-1]
                        }
                    },
              label: {
                enabled:false
              },
              pointStart: 2010
            }
          },
          
          credits:{
            text: 'Source: ' + source
          },

          series: [{
            name: title,
            data: data
          }],

          responsive: {
            rules: [{
              condition: {
                maxWidth: 500
              },
              chartOptions: {
                legend: {
                  layout: 'horizontal',
                  align: 'center',
                  verticalAlign: 'bottom'
                }
              }
            }]
          }

        }, function(chart) {
    var arr = chart.options.exporting.buttons.contextButton.menuItems;
    var index = arr.indexOf("viewData");
    if (index !== -1) arr.splice(index, 1);
    var index = arr.indexOf("viewFullscreen");
    if (index !== -1) arr.splice(index, 1);

});




    ////////////////////////////////////////

    /*
    var div = d3.select(divs)


    // 5. X scale will use the index of our data
    var xScale = d3.scaleLinear()
        .domain([2010,2019]) // input
        .range([0, width]); // output

    // 6. Y scale will use the randomly generate number 
    var yScale = d3.scaleLinear()
        .domain([getMinY(dataset,code), getMaxY(dataset,code)]) // input 
        .range([height, 0]); // output 

    // 7. d3's line generator
    var line = d3.line()
        .x(function(d, i) { return xScale(years[i]); }) // set the x values for the line generator
        .y(function(d) { return yScale(d[code]); }) // set the y values for the line generator 
        .curve(d3.curveMonotoneX) // apply smoothing to the line

    // 8. An array of objects of length N. Each object has key -> value pair, the key being "y" and the value is a random number
    //var dataset = d3.range(n).map(function(d) { return {"y": d3.randomUniform(1)() } })

    // 1. Add the SVG to the page and employ #2


    svg = div.append("svg")
        .attr("class","vis")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", "translate(" + margin.left  + "," + margin.top + ")");

    hidecheck(divs,code)
    // 3. Call the x axis in a group tag
    svg.append("g")
        .attr("class", "x axis")
        .attr("transform", "translate(0," + height  + ")")
        .call(d3.axisBottom(xScale)
             .tickFormat(d3.format("d"))
             .tickValues([2010,2019]))
        .call(g => g.select(".domain").remove())

    svg
    .append("g")
    .attr("transform", "translate(-10,0)")      // This controls the vertical position of the Axis
    .call(d3.axisLeft(yScale)
      .tickFormat(d3.format(format))
      .tickValues([getMinY(dataset,code),getMaxY(dataset,code)]))
    //.call(g => g.select(".domain").remove())
        
      
    // Create an axis component with d3.axisBottom

    // 4. Call the y axis in a group tag
    svg.append("g")
        .attr("class", "y axis")
        .call(d3.axisLeft(yScale)
             .tickValues([]))
        .call(g => g.select(".domain").remove()); // Create an axis component with d3.axisLeft

    // 9. Append the path, bind the data, and call the line generator 
    svg.append("path")
        .datum(dataset) // 10. Binds data to the line 
        .attr("class", "line") // Assign a class for styling 
        .attr("d", line); // 11. Calls the line generator 

    // 12. Appends a circle for each datapoint 

    svg.selectAll(".dot")
        .data(dataset)
        .enter().append("circle") // Uses the enter().append() method
        .attr("class", "dot") // Assign a class for styling
        .attr("cx", function(d, i) { return xScale(years[i]) })
        .attr("cy", function(d) { return yScale(d[code]) })
        .attr("id",code)
        .attr("r", 5)
        .on("mouseover", function(d,i) {
          var self  = d3.select(this),
                c   = self.attr('id')
                tip      
                    .transition()   
                    .duration(200)
                    .style("opacity", 1);    
                tip .html("<b>"+ years[i] +'</b>: '+ d3.format(format)(d[c]))  
                    .style("left", (d3.event.pageX) + "px")   
                    .style("top", (d3.event.pageY - 28) + "px");  
                })          
        .on("mouseout", function(d) {   
                tip.transition()    
                    .duration(500)   
                    .style("opacity", 0); 
            });*/
    }

   function makeDonutChart(dataset,divs,value,format,transform,year,title,description,source){

    divs = divs.replace("#","")


    domain = findDomain(year)


    code = []
    value.forEach(d => code.push(d.code))

    //hidecheck(divs,code)

     /*dataset.map(function(d){

      keys = Object.keys(d)

      filtered = keys
        .filter(key => code.includes(key))
        .reduce((obj, key) => {
          obj[key] = d[key];
          return obj;
        }, {});

      values = Object.values(filtered)

      code.forEach(function(t,i){
        d[t] = values[i]
      })

    return d

    })*/

    dataset.map(function(d){

      keys = Object.keys(d)

      filtered = keys
        .filter(key => code.includes(key))
        .reduce((obj, key) => {
          obj[key] = d[key];
          return obj;
        }, {});

      values = Object.values(filtered)
      sums = sum(values)

      code.forEach(function(t,i){
        d[t] = values[i]/sums
      })

    return d

    })



    var keys = code

    dataset.forEach((d,i) => d['year'] = years[i])
    dataset = dataset.filter(d => domain.includes(d.year))[0]



    var radius = (height+ margin.bottom) / 2.2


    var filtered = Object.keys(dataset)
        .filter(key => code.includes(key))
        .reduce((obj, key) => {
          obj[key] = dataset[key];
          return obj;
        }, {});


     /*dataset = []
     Object.values(filtered).forEach(function(d,i){
      code = Object.keys(filtered)[i]
      console.log(code)
      label = values.filter(r => r.code == code)[0].name
      console.log(label)
      data.push([label,d])
     })*/


     vals = Object.entries(filtered)
     vals.forEach(function(d,i){vals[i][0] = value.filter(r => r.code == d[0])[0]['name']})

     vals = vals.reverse()

     /*vals = vals.sort(function(a, b) {
      return a[1] - b[1];
      });*/


    /*var data_ready = pie(d3.entries(filtered))

    // Build the pie chart: Basically, each part of the pie is a path that we build using the arc function.
    svg
      .selectAll('whatever')
      .data(data_ready)
      .enter()
      .append('path')
      .attr('d', d3.arc()
        .innerRadius(10)         // This is the size of the donut hole
        .outerRadius(radius)
      )
       .on("mouseover", function(d,i) {
                tip      
                    .transition()   
                    .duration(200)
                    .style("opacity", 1);    
                tip .html("<b>"+ value.filter(r => r.code == d.data.key)[0].name + '</b>: ' + d3.format(format)(d.data.value) )  
                    .style("left", (d3.event.pageX) + "px")   
                    .style("top", (d3.event.pageY - 28) + "px");  
                })          
        .on("mouseout", function(d) {   
                tip.transition()    
                    .duration(500)   
                    .style("opacity", 0); 
            })
      .attr('fill', function(d){ return(color(keys.indexOf(d.data.key))) })
      .attr("stroke", "black")
      .style("stroke-width", ".5px")
      .style("opacity", 0.7)

      */

      //////////////HIGHCHARTS

         Highcharts.wrap(Highcharts.Chart.prototype, 'contextMenu', function(proceed) {
  proceed.apply(this, Array.prototype.slice.call(arguments, 1));

  // Correct for chart position
  var pos = Highcharts.offset(this.container);
  var defaultPadding = 5 * 2; // default from menuStyle option: https://api.highcharts.com/highcharts/navigation.menuStyle
  this.exportContextMenu.style.top = (pos.top ) + 'px';
  this.exportContextMenu.style.left = (pos.left + this.chartWidth - this.exportMenuWidth) + 'px';
  this.exportContextMenu.style.width = this.exportMenuWidth + 'px';

  // Move it to the body
      Highcharts.doc.body.appendChild(this.exportContextMenu);
    });

     Highcharts.setOptions({
              colors: ['#073863', '#A9AD00', '#A41D00', '#FF6D00', '#B45F04', '#1055CC', '#F5BD06', '#FFF263', '#6AF9C4','#EE9B00','#94D2BD'],
              lang: {
                thousandsSep: ','
              }
            })

    Highcharts.chart(divs, {
        chart: {
            plotBackgroundColor: null,
            plotBorderWidth: 0,
            plotShadow: false
        },
        title: {
                text: title,
                align: 'left'
              },
              
        subtitle: {
                text: description,
                align: 'left',
                verticalAlign:'top'
              },
        tooltip: {
            pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
        },
        accessibility: {
            point: {
                valueSuffix: '%'
            }
        },
        
        plotOptions: {
            pie: {
                dataLabels: {
                    enabled: true,
                    style: {
                        fontWeight: 'bold',
                        color: '#000000',
                        stroke: 0
                    },
                    filter: {
                    property: 'percentage',
                    operator: '>',
                    value: 10
                }
                },
                startAngle: -90,
                endAngle: 90,
                center: ['50%', '75%'],
                size: '110%'
            }
        },
         credits:{
                text: 'Source: ' + source
              },
        series: [{
            name: format.label,
            type: 'pie',
            innerSize: '50%',
            data: vals
        }]
    }, function(chart) {
        var arr = chart.options.exporting.buttons.contextButton.menuItems;
        var index = arr.indexOf("viewData");
        if (index !== -1) arr.splice(index, 1);
        var index = arr.indexOf("viewFullscreen");
        if (index !== -1) arr.splice(index, 1);

    });


  }

  function makeVennChart(dataset,divs,value,format,transform,year,title,description,source){

    divs = divs.replace("#","")
   

    newdata = dataset.filter(d => d.year == 2019)[0]

    //hidecheck(divs,[])


    var sets = [ {sets: ['Employed'], value: Number(newdata[value[2].code]), name: 'Employed in County'}, 
             {sets: ['Residents'], value: Number(newdata[value[1].code]), name: 'Working Residents in County'},
             {sets: ['Employed','Residents'], value: Number(newdata[value[0].code]), name: 'Working Residents Employed in County'}];


  /////HIGHCHARTS

    Highcharts.wrap(Highcharts.Chart.prototype, 'contextMenu', function(proceed) {
  proceed.apply(this, Array.prototype.slice.call(arguments, 1));

  // Correct for chart position
  var pos = Highcharts.offset(this.container);
  var defaultPadding = 5 * 2; // default from menuStyle option: https://api.highcharts.com/highcharts/navigation.menuStyle
  this.exportContextMenu.style.top = (pos.top ) + 'px';
  this.exportContextMenu.style.left = (pos.left + this.chartWidth - this.exportMenuWidth) + 'px';
  this.exportContextMenu.style.width = this.exportMenuWidth + 'px';

  // Move it to the body
      Highcharts.doc.body.appendChild(this.exportContextMenu);
    });

     Highcharts.setOptions({
        colors: ['#073863', '#A9AD00', '#A41D00', '#FF6D00', '#B45F04', '#1055CC', '#F5BD06', '#FFF263', '#6AF9C4','#EE9B00','#94D2BD'],
              lang: {
                thousandsSep: ','
              }
            })

  Highcharts.chart(divs, {
    accessibility: {
        point: {
            descriptionFormatter: function (point) {
                var intersection = point.sets.join(', '),
                    name = point.name,
                    ix = point.index + 1,
                    val = point.value;
                return ix + '. Intersection: ' + intersection + '. ' +
                    (point.sets.length > 1 ? name + '. ' : '') + 'Value ' + val + '.';
            }
        }
    },
    series: [{
        type: 'venn',
        name: format.label,
        data: sets
    }],
   title: {
    text: title,
    align: 'left',
    verticalAlign:'top'
  },
  
    subtitle: {
    text: description,
    align: 'left',
    verticalAlign:'top'
  },
   tooltip: {
            valueDecimals: 0,
            valuePrefix: format.prefix,
            valueSuffix: format.suffix
          },
   credits:{
    text: source
  },
}, function(chart) {
        var arr = chart.options.exporting.buttons.contextButton.menuItems;
        var index = arr.indexOf("viewData");
        if (index !== -1) arr.splice(index, 1);
        var index = arr.indexOf("viewFullscreen");
        if (index !== -1) arr.splice(index, 1);

    });


   /* var div = d3.select(divs)

    var chart = venn.VennDiagram()
     .width(width + margin.left + margin.right)
    .height(height + margin.top + margin.bottom)
    div.datum(sets).call(chart);


    var tooltip = d3.select("body").append("div")
    .attr("class", "venntooltip");

// add listeners to all the groups to display tooltip on mouseover
div.selectAll("g")
    .on("mouseover", function(d,i) {
                tip      
                    .transition()   
                    .duration(200)
                    .style("opacity", 1);    
                tip .html(d.labeler + ': ' + d3.format(format)(d.size))  
                    .style("left", (d3.event.pageX) + "px")   
                    .style("top", (d3.event.pageY - 28) + "px");  
                })          
        .on("mouseout", function(d) {   
                tip.transition()    
                    .duration(500)   
                    .style("opacity", 0); 
            })*/
  }

  function makeIndicator(dataset,divs,value,format,transform,year,title,description,source){

    divs = divs.replace("#","")
    //hidecheck(divs,[])

    newdata = dataset.filter(d => d.year == 2019)[0]
    q = newdata[value[0].code]



    Highcharts.chart(divs, {

  chart: {
    type: 'bar',
    marginLeft: width/2
  },

 title: {
    text: title,
    align: 'left',
    verticalAlign:'top'
  },
  
    subtitle: {
    text: description,
    align: 'left',
    verticalAlign:'top'
  },

  credits:{
    text: source
  },
  
  yAxis:{
  visible:false
  },

  xAxis: {
    categories: [d3.format(format)(q)],
    labels: {
      align: 'left',
      style: {
                color: 'black',
                fontSize: "3em"
            }
    },
    lineWidth: 0,
   minorGridLineWidth: 0,
   lineColor: 'transparent',
  },

  plotOptions: {
    series: {
      opacity:0,
      dataLabels: {
        enabled: false,
      }
    }
  },
  
   tooltip: {
            enabled:false
          },

  legend: {
    enabled: false
  },
  exporting: {
    enabled: false
  },

  series: [{
    data: [{
      y: 5,
      color: "#00FF00"
    }]
  }]

});


   //div.innerHTML += '<p class="temp" style ="color: #000; text-align: center; font-size: 2em;font-weight: 700; position: relative; top: 50%;">' + d3.format(format)(q) + '</p>'

  }

  function makeTable(dataset,divs,value,format,transform,year,title,description,source){

    divs = divs.replace("#","")

    newdata = dataset.filter(d => d.year == 2019)[0]
    q = newdata[value[0].code].split("; ")
    
    b = []
    r = []
    newstring = new String()
    q.forEach(function(d,i){
      b.push({'y':i})
      r.push(String(i+1) + '. ' + d)
    })

    Highcharts.chart(divs, {

  chart: {
    type: 'bar',
    marginLeft: width/10
  },

   labels:
  {style: {"color": "#FFFFFF", "position": "absolute","whiteSpace": 'nowrap'}},

 title: {
    text: title,
    align: 'left',
    verticalAlign:'top'
  },

  exporting: {
    enabled: false
  },
  
    subtitle: {
    text: description,
    align: 'left',
    verticalAlign:'top'
  },

  credits:{
    text: source
  },
  
  yAxis:{
  visible:false
  },

  xAxis: {
    categories: r,
    labels: {
      align: 'left',
      style: {
                color: 'black',
                width:width
            }
    },
    lineWidth: 0,
   minorGridLineWidth: 0,
   lineColor: 'transparent',
  },

  plotOptions: {
    series: {
      opacity:0,
      dataLabels: {
        enabled: false,
        format: '{y} %'
      }
    }
  },
  
   tooltip: {
            enabled:false
          },

  legend: {
    enabled: false
  },

  series: [{
    data:b
  }]

});



    //let div = document.querySelector(divs);
    //div.innerHTML += '<div class="temp"><p style ="color: #000; text-align: center; font-weight: 700; position: relative; top: 50%;">' + '<ul>' + newstring + '</ul>' + '</p></div>'
    
  }

  function makeGrouped(dataset,divs,value,format,transform,year,title,description,source){

    divs = divs.replace("#","")



    code = []
    transform.forEach(d => code.push(d.category))
    code = [...new Set(code)]

    labels = []
    transform.forEach(d => labels.push(d.name))
    labels = [...new Set(labels)]

    dataset = dataset.filter(d => d.year == 2019 )[0]


    series = []
    code.forEach(function(c){
      array = []
      labels.forEach(function(l){
        code = transform.filter(d => d.name == l && d.category == c)[0].code
        x = dataset[code]
        array.push(Number(x))
      })
      val = {'name':c, 'data':array}
      series.push(val)
    })

    var data = {'labels':labels,'series':series}


    ///HIGHCHARTS

     Highcharts.wrap(Highcharts.Chart.prototype, 'contextMenu', function(proceed) {
  proceed.apply(this, Array.prototype.slice.call(arguments, 1));

  // Correct for chart position
  var pos = Highcharts.offset(this.container);
  var defaultPadding = 5 * 2; // default from menuStyle option: https://api.highcharts.com/highcharts/navigation.menuStyle
  this.exportContextMenu.style.top = (pos.top ) + 'px';
  this.exportContextMenu.style.left = (pos.left + this.chartWidth - this.exportMenuWidth) + 'px';
  this.exportContextMenu.style.width = this.exportMenuWidth + 'px';

  // Move it to the body
      Highcharts.doc.body.appendChild(this.exportContextMenu);
    });

     Highcharts.setOptions({
              lang: {
                thousandsSep: ','
              }
            })

    Highcharts.chart(divs, {
    chart: {
        type: 'bar'
    },
    title: {
    text:  title,
    align: 'left',
    verticalAlign:'top'
  },
  
    subtitle: {
    text: description,
    align: 'left',
    verticalAlign:'top'
  },
    xAxis: {
        categories: data.labels,
        title: {
            text: null
        },
        labels:{
          style: {
            fontSize: '9px'
          }
        }
    },
    yAxis: {
        min: 0,
        title: {
            text:undefined,
            align: 'high'
        },
        labels: {
            overflow: 'justify'
        }
    },
     tooltip: {
            valueDecimals: 0,
            valuePrefix: format.prefix,
            valueSuffix: format.suffix
          },
    plotOptions: {
        bar: {
            dataLabels: {
                enabled: false
            }
        }
    },
    legend: {
          reversed: true,
          itemStyle: {"color": "#333333", "cursor": "pointer", "fontSize": "9px", "fontWeight": "normal", "textOverflow": "ellipsis"}
        },
    credits:{
    text: source
  },
    series: data.series
}, function(chart) {
        var arr = chart.options.exporting.buttons.contextButton.menuItems;
        var index = arr.indexOf("viewData");
        if (index !== -1) arr.splice(index, 1);
        var index = arr.indexOf("viewFullscreen");
        if (index !== -1) arr.splice(index, 1);

    });


    /*
    /*var data = {
  labels: [
    '$35,000', '$35,000'
  ],
  series: [
    {
      label: '2012',
      values: [4, 8]
    },
    {
      label: '2013',
      values: [12, 43]
    }]
};

function wrap(text, width) {
  text.each(function() {
    var text = d3.select(this),
        words = text.text().split(/\s+/).reverse(),
        word,
        line = [],
        lineNumber = 0,
        lineHeight = .5, // ems
        y = text.attr("y"),
        dy = parseFloat(text.attr("dy")),
        tspan = text.text(null).append("tspan").attr("x", - width*2).attr("y", y).attr("dy", dy + "em")
    while (word = words.pop()) {
      line.push(word)
      tspan.text(line.join(" "))
      if (tspan.node().getComputedTextLength() > width) {
        line.pop()
        tspan.text(line.join(" "))
        line = [word]
        tspan = text.append("tspan").attr("x", - width*2).attr("y", y).attr("dy", `${++lineNumber * lineHeight + dy}em`).text(word)
      }
    }
    })
}

var chartWidth       = width,
    gapBetweenGroups = width/30,
    spaceForLabels   = width/10;
    spaceForLegend   = width/15

// Zip the series data together (first values, second values, etc.)
var zippedData = [];
for (var i=0; i<data.labels.length; i++) {
  for (var j=0; j<data.series.length; j++) {
    zippedData.push(data.series[j].values[i]);
  }
}

console.log(zippedData)


function toIntArray(arr) {
    for (var i = 0; i < arr.length; i++) { 
        arr[i] = +arr[i]; 
    } 
    return arr;
}


    barHeight = (height - (gapBetweenGroups * data.labels.length))/ zippedData.length
    groupHeight = barHeight * data.series.length;

// Color scale
var color = d3.scaleOrdinal(d3.schemeCategory20);

var x = d3.scaleLinear()
    .domain([0, d3.max(toIntArray(zippedData))])
    .range([0, chartWidth - margin.right - spaceForLegend]);

var y = d3.scaleLinear()
    .range([height, margin.top]);

var yAxis = d3.axisLeft()
.scale(y)
.tickFormat('')
.tickSize(0)

// Specify the chart area and dimensions
 chart = div.append("svg")
        .attr("class","vis")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", "translate(" + margin.left  + "," + margin.top + ")");

// Create bars
var bar = chart.selectAll("g")
    .data(zippedData)
    .enter().append("g")
    .attr("transform", function(d, i) {
      return "translate(" + spaceForLabels + "," + (i * barHeight + gapBetweenGroups * (0.5 + Math.floor(i/data.series.length))) + ")";
    });

// Create rectangles of the correct width
bar.append("rect")
    .attr("fill", function(d,i) { return color(i % data.series.length); })
    .attr("class", "bar")
    .attr("width", d => x(d) - x(0))
    .attr("height", barHeight - 1);

      function roundUsing(func, number, prec) {
      var tempnumber = number * Math.pow(10, prec);
      tempnumber = func(tempnumber);
      return tempnumber / Math.pow(10, prec);
  }

      function getKeyByValue(object, value) {
        return Object.keys(object).find(key => roundUsing(Math.ceil,parseFloat(object[key]),10) == roundUsing(Math.ceil,value,10));
      }



// Draw labels
bar.append("text")
    .attr("class", "labeler")
    .attr("x", function(d) { return - (spaceForLabels*2); })
    .attr("y", groupHeight / 2)
    .attr("dy", ".35em")
    .style("font-size", ".75em")
    .text(function(d,i) {
      if (i % data.series.length === 0)
        return data.labels[Math.floor(i/data.series.length)];
      else
        return ""});

chart.selectAll("text")
.call(wrap,spaceForLabels)



bar.append("text")
    .attr("x", function(d) { return x(d) + 10; })
    .attr("y", barHeight / 2)
    .style("font-size", ".75em")
    .attr("dy", ".35em")
    .text(function(d) { 
      return transform.filter(r => r.code == getKeyByValue(dataset,d))[0].category });

bar.on("mouseover", function(d,i) {
                tip      
                    .transition()   
                    .duration(200)
                    .style("opacity", 1);    
                tip .html(d3.format(format)(d))  
                    .style("left", (d3.event.pageX) + "px")   
                    .style("top", (d3.event.pageY - 28) + "px");  
                })          
        .on("mouseout", function(d) {   
                tip.transition()    
                    .duration(500)   
                    .style("opacity", 0); 
            })

/*chart.append("g")
      .attr("class", "y axis")
      .attr("transform", "translate(" + spaceForLabels + ", " + -gapBetweenGroups/2 + ")")
      .call(yAxis);*/

    

  }

  function makeHBarchart(dataset,divs,value,format,transform,year,title,description,source){

    divs = divs.replace("#","")


    newdata = dataset.filter(d => d.year == 2019)[0]

    newest = []
    cats = []
    value.forEach(function(d,i){
      cats.push(d.name)
      reframe = {'name':d.name,'y':Number(newdata[d.code])}
      newest.push(reframe)

    })

    /////HIGHCHARTS

     Highcharts.wrap(Highcharts.Chart.prototype, 'contextMenu', function(proceed) {
  proceed.apply(this, Array.prototype.slice.call(arguments, 1));

  // Correct for chart position
  var pos = Highcharts.offset(this.container);
  var defaultPadding = 5 * 2; // default from menuStyle option: https://api.highcharts.com/highcharts/navigation.menuStyle
  this.exportContextMenu.style.top = (pos.top ) + 'px';
  this.exportContextMenu.style.left = (pos.left + this.chartWidth - this.exportMenuWidth) + 'px';
  this.exportContextMenu.style.width = this.exportMenuWidth + 'px';

  // Move it to the body
      Highcharts.doc.body.appendChild(this.exportContextMenu);
    });

     Highcharts.setOptions({
      colors: ['#073863', '#A9AD00', '#A41D00', '#FF6D00', '#B45F04', '#1055CC', '#F5BD06', '#FFF263', '#6AF9C4','#EE9B00','#94D2BD'],
              lang: {
                thousandsSep: ','
              }
            })

    Highcharts.chart(divs, {
    chart: {
        type: 'bar'
    },
    title: {
    text:  title,
    align: 'left',
    verticalAlign:'top'
  },
  
    subtitle: {
    text: description,
    align: 'left',
    verticalAlign:'top'
  },
    xAxis: {
        categories: cats,
        title: {
            text: null
        },
        labels:{
          padding: 0,
          width: 200,
          overflow: 'justify',
          style: {
            fontSize: '9px'
          }

        }
    },
    yAxis: {
        min: 0,
        title: {
            text:undefined,
            align: 'high'
        },
        labels: {
            padding: 0,
            width: 50,
            overflow: 'justify'
        }
    },
     tooltip: {
            valueDecimals: 0,
            valuePrefix: format.prefix,
            valueSuffix: format.suffix
          },
    plotOptions: {
        bar: {
            dataLabels: {
                enabled: false,
                format: format.prefix + '{point.y:'+ format.formatter + '}' + format.suffix,
            }
        },
        series: {
            pointPadding: 0,
            groupPadding: 0
        }
    },
    legend: {
          reversed: true,
          enabled: false,
          itemStyle: {"color": "#333333", "cursor": "pointer", "fontSize": "9px", "fontWeight": "normal", "textOverflow": "ellipsis"}
        },
    credits:{
    text: source
  },
    series: [{
        name: format.label,
        data:  newest
    }]

}, function(chart) {
        var arr = chart.options.exporting.buttons.contextButton.menuItems;
        var index = arr.indexOf("viewData");
        if (index !== -1) arr.splice(index, 1);
        var index = arr.indexOf("viewFullscreen");
        if (index !== -1) arr.splice(index, 1);

    });

    /*

    var div = d3.select(divs)

    var y = d3.scaleBand()
          .range([height, 0])
          .padding(0.1);

    var x = d3.scaleLinear()
            .range([0, width]);

    svg = div.append("svg")
        .attr("class","vis")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", "translate(" + margin.left  + "," + margin.top + ")");


    x.domain([0, getMaxY(newest,'value')])
    y.domain(newest.map(function(d) { return d.name; }));
    //y.domain([0, d3.max(data, function(d) { return d.sales; })]);

    // append the rectangles for the bar chart
    svg.selectAll(".bar")
        .data(newest)
      .enter().append("rect")
        .attr("class", "bar")
        //.attr("x", function(d) { return x(d.sales); })
        .attr("width", function(d) {return x(d.value); } )
        .attr("y", function(d) { return y(d.name); })
        .attr("height", y.bandwidth())
        .attr("fill", '#003768')
        .on("mouseover", function(d,i) {
                tip      
                    .transition()   
                    .duration(200)
                    .style("opacity", 1);    
                tip .html(d3.format(format)(d.value) + " " + label)  
                    .style("left", (d3.event.pageX) + "px")   
                    .style("top", (d3.event.pageY - 28) + "px");  
                })          
        .on("mouseout", function(d) {   
                tip.transition()    
                    .duration(500)   
                    .style("opacity", 0); 
            })

    // add the y Axis
    svg.append("g")
        .call(d3.axisLeft(y));

        */

  }


  function makeVBarchart(dataset,divs,value,format,transform,year,title,description,source){

    divs = divs.replace("#","")


     newdata = dataset.filter(d => d.year == 2019)[0]

    newest = []
    value.forEach(function(d,i){
      reframe = {'name':d.name,'y':Number(newdata[d.code])}
      newest.push(reframe)

    })

    var div = d3.select(divs)



    ////HIGHCHARTS

  Highcharts.wrap(Highcharts.Chart.prototype, 'contextMenu', function(proceed) {
  proceed.apply(this, Array.prototype.slice.call(arguments, 1));

  // Correct for chart position
  var pos = Highcharts.offset(this.container);
  var defaultPadding = 5 * 2; // default from menuStyle option: https://api.highcharts.com/highcharts/navigation.menuStyle
  this.exportContextMenu.style.top = (pos.top ) + 'px';
  this.exportContextMenu.style.left = (pos.left + this.chartWidth - this.exportMenuWidth) + 'px';
  this.exportContextMenu.style.width = this.exportMenuWidth + 'px';

  // Move it to the body
  Highcharts.doc.body.appendChild(this.exportContextMenu);
});


    // Create the chart
Highcharts.setOptions({
  colors: ['#073863', '#A9AD00', '#A41D00', '#FF6D00', '#B45F04', '#1055CC', '#F5BD06', '#FFF263', '#6AF9C4','#EE9B00','#94D2BD'],
  lang: {
    thousandsSep: ','
  }
})


Highcharts.chart(divs, {

  exporting:{
    menuItemDefinitions:{"printChart": {}, "separator": {}, "downloadPNG": {}, "downloadJPEG": {}, "downloadPDF": {}, "downloadSVG": {}}
  },
  
    chart: {
        type: 'column'
    },
   title: {
    text: title,
    align: 'left',
    verticalAlign:'top'
  },
  
    subtitle: {
    text: description,
    align: 'left',
    verticalAlign:'top'
  },
  

    xAxis: {
        type: 'category'
    },
    yAxis: {
    title:undefined
      

    },
    legend: {
        enabled: false
    },
    plotOptions: {
        series: {
            borderWidth: 0,
            dataLabels: {
                enabled: true,
                format: format.prefix + '{point.y:'+ format.formatter + '}' + format.suffix,
            }
        }
    },

  tooltip: {
            valueDecimals: 0,
            valuePrefix: format.prefix,
            valueSuffix: format.suffix
          },
          
   credits:{
    text: source
  },

    series: [
        {
            name: format.label,
            colorByPoint: true,
            data: newest
        }
    ]
}, function(chart) {
    var arr = chart.options.exporting.buttons.contextButton.menuItems;
    var index = arr.indexOf("viewData");
    if (index !== -1) arr.splice(index, 1);
    var index = arr.indexOf("viewFullscreen");
    if (index !== -1) arr.splice(index, 1);
});




    /*

    svg = div.append("svg")
        .attr("class","vis")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", "translate(" + margin.left  + "," + margin.top + ")");

    var x = d3.scaleBand()
          .range([0, width])
          .padding(0.1);
var y = d3.scaleLinear()
          .range([height, 0]);


    y.domain([0, getMaxY(newest,'value')])
    x.domain(newest.map(function(d) { return d.name; }));

    svg.selectAll(".bar")
      .data(newest)
    .enter().append("rect")
      .attr("class", "bar")
      .attr("x", function(d) { return x(d.name); })
      .attr("width", x.bandwidth())
      .attr("y", function(d) { return y(d.value); })
      .attr("height", function(d) { return height - y(d.value); })
      .attr("fill", '#003768')
      .on("mouseover", function(d,i) {
                tip      
                    .transition()   
                    .duration(200)
                    .style("opacity", 1);    
                tip .html(d3.format(format)(d.value) +" " + label)  
                    .style("left", (d3.event.pageX) + "px")   
                    .style("top", (d3.event.pageY - 28) + "px");  
                })          
        .on("mouseout", function(d) {   
                tip.transition()    
                    .duration(500)   
                    .style("opacity", 0); 
            })

  // add the x Axis
  svg.append("g")
      .attr("transform", "translate(0," + height + ")")
      .call(d3.axisBottom(x));

  // add the y Axis
  svg.append("g")
      .call(d3.axisLeft(y).tickFormat(d3.format(format))
      .tickValues([getMaxY(newest,'value')]));

*/

  }



  function makeStackedBarChart(dataset,divs,value,format,transform,year,title,description,source){



    //hidecheck(divs,[])

    divs = divs.replace("#","")


    if (transform != undefined){
    code = []
    transform.forEach(d => code.push(d.category))
    code = [...new Set(code)]

    names = []
    transform.forEach(d => names.push(d.name))
    names = [...new Set(names)]

    //code = []
    //value.forEach(d => code.push(d.code))

    
    dataset = dataset.filter(d => d.year == 2019 )[0]

    newdata = []
    newvalue = []

    code.forEach(function(d){
      temp = {'name':d,'code':d}
      newvalue.push(temp)
    })

    value = newvalue

    names.forEach(function(d){

      
      let uniq = Object.assign({},dataset)
      vals = transform.filter(b => b.name == d)
      vals.forEach(function(y){
        uniq[y.category] = uniq[y.code]
      })
      uniq["domain"] = d
      newdata.push(uniq)
    })

    newdata.map(function(d){

      keys = Object.keys(d)

      filtered = keys
        .filter(key => code.includes(key))
        .reduce((obj, key) => {
          obj[key] = d[key];
          return obj;
        }, {});

      values = Object.values(filtered)
      sums = sum(values)

      code.forEach(function(t,i){
        d[t] = values[i]/sums
      })

    return d

    })


    var year   = [...new Set(newdata.map(d => d.state))]
    var states = [...new Set(newdata.map(d => d.domain))]

  

    use = 'domain'

    categories = states


    }else{

    domain = findDomain(year)

    code = []
    value.forEach(d => code.push(d.code))

    dataset.map(function(d){

      keys = Object.keys(d)

      filtered = keys
        .filter(key => code.includes(key))
        .reduce((obj, key) => {
          obj[key] = d[key];
          return obj;
        }, {});

      values = Object.values(filtered)
      sums = sum(values)

      code.forEach(function(t,i){
        d[t] = values[i]/sums
      })

    return d

    })


    if (format.combine != undefined){
      value = []
      combine = format.combine

      Object.keys(combine).forEach(function(d){
        value.push({'name':d,'code':d})
        dataset.forEach(function(b){
          val = 0
          combine[d].forEach(f => val = val + b[f])
          b[d] = val
        })
      })

      code = Object.keys(combine)


    }
    

    dataset.forEach((d,i) => d['Year'] = years[i])
    dataset = dataset.filter(d => domain.includes(d.Year))

    var year   = [...new Set(dataset.map(d => d.state))]
    var states = [...new Set(dataset.map(d => d.Year))]

    use = 'Year'

    categories = states

    }

    var keys = code

  
    /*var div = d3.select(divs)

    svg = div.append("svg")
        .attr("class","vis")
        .attr("width", width)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", "translate(0,0)");


    var y = d3.scaleBand()
    .range([margin.top, height + margin.top + margin.bottom-10])
    .padding(0.1)
    .paddingOuter(0.2)
    .paddingInner(0.2)

    var x = d3.scaleLinear()
      .range([margin.left, width - margin.right])

    var yAxis = svg.append("g")
      .attr("transform", `translate(${margin.left},0)`)
      .attr("class", "y-axis")

    var xAxis = svg.append("g")
      .attr("transform", `translate(0,${margin.top})`)
      .attr("class", "x-axis")


    var z = d3.scaleLinear()
      .range(["#15534C","#1A5D51","#216755","#297159","#337B5C","#3D855E","#498F60","#569861","#64A261","#73AC61","#83B561","#94BE61","#A6C760","#B9D060","#CDD861","#E2E062"])
      .domain(d3.ticks(0, keys.length, 16));

    */

    if (transform != undefined){
      update(newdata,18, 0,value)
    }else{
      update(dataset,18, 0,value)
    }
    

    function update(ds,input, speed, value) {

      var data = ds

      data.forEach(function(d) {
        d.total = d3.sum(keys, k => +d[k])
        return d
      })



      ////////////////HIGHCHARTS////////////////

      



      series = []

      value.forEach(function(d){
        vals = []
        data.forEach(r => vals.push(r[d.code]))
            if (format.suffix == "%"){
        vals = vals.map(function(x) { return x * 100; })
            decimal = 1
          }else{
            decimal = 0
          }
        s = {'name': d.name, 'data': vals}
        series.push(s)
      })

      Highcharts.wrap(Highcharts.Chart.prototype, 'contextMenu', function(proceed) {
        proceed.apply(this, Array.prototype.slice.call(arguments, 1));

        // Correct for chart position
        var pos = Highcharts.offset(this.container);
        var defaultPadding = 5 * 2; // default from menuStyle option: https://api.highcharts.com/highcharts/navigation.menuStyle
        this.exportContextMenu.style.top = (pos.top ) + 'px';
        this.exportContextMenu.style.left = (pos.left + this.chartWidth - this.exportMenuWidth) + 'px';
        this.exportContextMenu.style.width = this.exportMenuWidth + 'px';

        // Move it to the body
        Highcharts.doc.body.appendChild(this.exportContextMenu);
      });

      if (title == 'Racial Composition'){
        palette = ['#73B2FF','#55FF00','#FF0000','#FFAA00','#895A44']
      }else{
        if (title == 'Household Income Distribution'){
          palette = ['#deebf7','#c6dbef','#9ecae1','#6baed6','#4292c6','#2171b5','#08519c','#08306b']
        }else{
        palette = ['#073863', '#A9AD00', '#A41D00', '#FF6D00', '#B45F04', '#1055CC', '#F5BD06', '#FFF263', '#6AF9C4','#EE9B00','#94D2BD']
      }
      }
      

      Highcharts.setOptions({
        colors: palette,
        lang: {
          thousandsSep: ','
        }
      })


      Highcharts.chart(divs, {
        
        exporting:{
          menuItemDefinitions:{"printChart": {}, "separator": {}, "downloadPNG": {}, "downloadJPEG": {}, "downloadPDF": {}, "downloadSVG": {}}
        },

        chart: {
          type: 'bar'
        },
        title: {
          text: title,
          align: 'left',
          verticalAlign:'top'
        },
        
          subtitle: {
          text: description,
          align: 'left',
          verticalAlign:'top'
        },
        
        xAxis: {
          categories: categories,
          
        },

        tooltip: {
            valueDecimals: decimal,
            valuePrefix: format.prefix,
            valueSuffix: format.suffix
          },
        
        credits:{
          text: source
        },
        
        yAxis: {
          gridLineWidth: 0,
          min: 0,
          labels: {
            enabled: false
          },
          title: {
            text: undefined
          }
        },
        legend: {
          reversed: true,
          itemStyle: {"color": "#333333", "cursor": "pointer", "fontSize": "10px", "fontWeight": "normal", "textOverflow": "ellipsis"}
        },
        plotOptions: {
          bar:{
            borderWidth: 0
          },
          series: {
            stacking: 'normal'
          }
        },
        series:series
      }, function(chart) {
          var arr = chart.options.exporting.buttons.contextButton.menuItems;
          var index = arr.indexOf("viewData");
          if (index !== -1) arr.splice(index, 1);
          var index = arr.indexOf("viewFullscreen");
          if (index !== -1) arr.splice(index, 1);
      });

      //////////

      /*

      x.domain([0, d3.max(data, d => d.total)]).nice();

      svg.selectAll(".x-axis").transition().duration(speed)
        .call(d3.axisTop(x).ticks(null, "s").tickValues([]))
        .call(g => g.select(".domain").remove())

      data.sort((a, b) => states.indexOf(a[use]) - states.indexOf(b[use]))

      y.domain(data.map(d => d[use]));

      svg.selectAll(".y-axis").transition().duration(speed)
        .call(d3.axisLeft(y).tickSizeOuter(0))

      var group = svg.selectAll("g.layer")
        .data(d3.stack().keys(keys)(data), d => d.key, (d,i) => i)
        .attr('id', d => d.data[use])

      group.exit().remove()

      group.enter().insert("g", ".y-axis").append("g")
      
        .classed("layer", true)
        .attr("fill", d => z(keys.indexOf(d.key)));

      var bars = svg.selectAll("g.layer").selectAll("rect")
        .data(d => d, e => e.data[use])

      bars.exit().remove()

      function roundUsing(func, number, prec) {
      var tempnumber = number * Math.pow(10, prec);
      tempnumber = func(tempnumber);
      return tempnumber / Math.pow(10, prec);
  }

      function getKeyByValue(object, value) {
        return Object.keys(object).find(key => roundUsing(Math.ceil,parseFloat(object[key]),10) == roundUsing(Math.ceil,value,10));
      }

      bars.enter().append("rect")
        .attr("height", y.bandwidth())
        .attr('id', d => d.data[use])
        .on("mouseover", function(d,i) {
                tip      
                    .transition()   
                    .duration(200)
                    .style("opacity", 1);    
                tip .html("<b>"+ value.filter(p => p.code == getKeyByValue(d.data,d[1]-d[0]))[0].name + '</b>: ' + d3.format(format)(d[1]-d[0]) )  
                    .style("left", (d3.event.pageX) + "px")   
                    .style("top", (d3.event.pageY - 28) + "px");  
                })          
        .on("mouseout", function(d) {   
                tip.transition()    
                    .duration(500)   
                    .style("opacity", 0); 
            })
        .merge(bars)
        
      .transition().duration(speed)
        .attr("y", d => y(d.data[use]))
        .attr("x", d => x(d[0]))
        .attr("width", d => x(d[1]) - x(d[0]))
    
    */
    }
    }
  //charttypes = [makeLineChart,makeLineChart,makeStackedBarChart,makeLineChart,makeLineChart,makeLineChart]
  function assignData(data,manifest,fetchIndex){

       
      charts = manifest.divs

      //("county" in temp1)

      data.forEach(function(d,i){
        d.slice(1,d.length).forEach(function(h,o){
          var dict = new Object();
          d[0].forEach(function(b,l){
            dict[b] = d[o+1][l]
          })
          data[i][o+1] = dict
        })
      })

      newdata = []
      fetchIndex.forEach(function(d,i){
        newdata[i] = Object.assign({},d,data[i])
      })

      

      acs = JSON.parse(JSON.stringify(newdata.filter(r => r["source"] == "ACS")))

      acs2 = JSON.parse(JSON.stringify(newdata.filter(r => r["source"] == "ACS")))
      g1 = JSON.parse(JSON.stringify(newdata.filter(r => r["source"] == "G1")))


      chart_data = acs.filter(r => r["use"] == "charts")

      county_charts = chart_data.filter(r => r["geo"] == "county")
      state_charts = chart_data.filter(r => r["geo"] == "state")


      counties = []
      county_charts.forEach(function(d){
        delete d.geo
        delete d.use
        delete d.year
        delete d.source
        values = Object.values(d)
        counties.push(values)
      })

      states = []
      state_charts.forEach(function(d,i){
        delete d.geo
        delete d.use
        delete d.year
        delete d.source
        values = Object.values(d)
        values = values.slice(1,values.length)
        values = values[0]
        values['county'] = "999"
        values['year'] = years[i]
        states.push(values)
      })





     var geos = new Object();
      counties[0].slice(1,counties[0].length).map(function(x){
        geos[x['county']] = []
      })


      yearindex = 0
      newdata.forEach(function(d,i){
        if(d.geo == "county"){

          for (object in geos){

          yeardata = data[i].filter(r => r['county'] == object)[0]
          if (yeardata != undefined){
            yeardata['year'] = d.includes[yearindex]
          }
          geos[object].push(yeardata)
        }
        yearindex = yearindex + 1
        }

      })



      geos['999'] = states


      for (object in geos){
        geos[object].forEach(function(d,i){
          g1.forEach(function(gs){
            obj2 = Object.keys(gs).reduce(function (filtered, key){ 
              if (gs[key].county == parseInt(object) && gs[key].year == d.year) filtered[key] = gs[key];
              return filtered;
            },
            {});
            let merged = {...d, ...Object.values(obj2)[0]}
            geos[object][i] = merged
          })
        })
      }


      dataset = geos['999']

  

      option = manifest.topic.population

      charts.forEach(function(d,i){

        selector = d +"source"
        document.querySelector(selector).innerHTML = option[i].source

        text = "#source" + (i+1);

        document.querySelector(text).style.display = 'block'

        //dataset,divs,value,format,transform,year

        eval(manifest.chartfunctions.filter(d => d.type == option[i].type)[0].function)(dataset,d,option[i].variables,option[i].format,option[i].transform,option[i].year,option[i].title,option[i].description,option[i].source)

        //makeLineChart(dataset,d,variables[i])
      })



      let i = charts.length;
      while (i < 6) {
        text = "#source" + (i+1);
        document.querySelector(text).style.display = 'none'
        i++;
      }


    function updateGraph(fips,vars,div,topicselect){


      div.forEach(function(d){
      current = document.querySelector(d)
      const newItem = document.createElement('div');
      divs = d.replace('#','')
      newItem.id= divs

      current.parentElement.replaceChild(newItem,current)
      })

    //Remove existing charts

        /*document.querySelectorAll('.temp').forEach(function(area){
          area.remove()
        })

        document.querySelectorAll('.chartarea svg').forEach(function(area){
          area.remove()
        })*/
    
        data = geos[fips]

        option = eval('manifest.topic.' + topicselect)

       // l = 0

        charts.forEach(function(d,i){


        if(option[i] != undefined){
          
          /*selector = d +"source"
          document.querySelector(selector).innerHTML = option[i].source

          text = "#source" + (i+1);
          document.querySelector(text).style.display = 'block'
          */

          eval(manifest.chartfunctions.filter(d => d.type == option[i].type)[0].function)(data,d,option[i].variables,option[i].format,option[i].transform,option[i].year,option[i].title,option[i].description,option[i].source)

          //l++
        }


       



      })

        /* let i = l;
      while (i < 6) {
        text = "#source" + (i+1);
        document.querySelector(text).style.display = 'none'
        i++;
      }*/


        }


      
 topic_areas = {'population':[{'label':'Population','variable':'B01001_001E','format':",.0f"},{'label':'Median Household Income','variable':'B19013_001E','format':"$,.0f"},{'label':'Family Poverty Rate','variable':'family_poverty','format':",.1%"},{'label':'Tenure (% Owner Occupied)','variable':'tenure','format':",.1%"}],'housing': [{'label':'Median Listing Price','variable':'mlp','format':",.0f"},{'label':'Median Rent','variable':'medianrent','format':"$,.0f"},{'label':'Housing Starts','variable':'housingstarts','format':",.0f"}],'housingafford':[{'label':'Cost Burdened Homeowners','variable':'ownerburden_pct','format':",.1%"},{'label':'Cost Burdened Renters','variable':'renterburden_pct','format':",.1%"},{'label':'Home Value Affordable to Median Household','variable':'affordablehome','format':"$,.0f"}],'jobs':[{'label':'Unemployment Rate','variable':'unemployment','format':",.1%"},{'label':'Median Salary','variable':'mediansalary','format':"$,.0f"}]}
      
function mapData(json){



      columns = Object.keys(geos)
      columns = columns.map(d => geos[d][9]['NAME'])
      columns - columns.sort()
      
      indicators = topic_areas['population']

     


      var table = d3.select('#table').append("table");
          var thead = table.append("thead");
          var tbody = table.append("tbody");

      lab = ['Indicator']
      
      first = thead.append("tr")
      first
        .selectAll("th")
        .data(lab)
        .enter()
        .append("th")
        .text(x => x);

      selects = []
      for(i=0;i<3;i++){

        select = first.append("th")
              .append("select")
              .style('background','white !important')
              .attr('id','select-' + String(i))

        selects.push('select-' + String(i))

        select
        .selectAll("option")
        .data(columns)
        .enter()
        .append("option")
        .attr("value", function(d){
          return d;
        })
        .text(function(d){
          return d;
        })

      }

      latest = []
      for(i=0;i<Object.keys(geos).length;i++){
        latest.push(geos[Object.keys(geos)[i]][9])
      }

      latest.forEach(function(d){
        d['family_poverty'] = d.B17013_002E / d.B17013_001E;

        d['tenure_households'] = parseFloat(d.B25003_002E) + parseFloat(d.B25003_003E);

        d['tenure'] = (d.B25003_002E / d.tenure_households)

        d['ownerburden_pct'] = (d.owners_costburdened / d.costburden_owner) + .0002
        d['renterburden_pct'] = (d.renters_costburdened / d.costburden_renter) + .0002
      }) 

 

      selects.forEach(function(select){
        item = document.getElementById(select)

        item.addEventListener('change', function(){
          topic_option = document.querySelector('#topic').value
          updateTable(0,topic_option)
        })


      })


      function updateTable(initial, area){


        indicators = topic_areas[area]

     
      selection = []
      selects.forEach(function(select){
        selection.push(document.getElementById(select).value)
      })
     
      key = []
      indicators.forEach(function(value){
        temp = new Object();
        selection.forEach(function(column){
        temp[column] = d3.format(value.format)(latest.filter(d => d.NAME == column)[0][value.variable])
      })
      temp['label'] = value.label
      key.push(temp)
      })


      columns = ['label'].concat(selection)

      
      if (initial == 1){
    
      tbody.selectAll("tr")
        .data(key)
        .enter()
        .append("tr")
        .selectAll("td")
        .data(function(row) {
          return columns.map(function(column) {
            return {
              column: column,
              value: row[column]
            };
          });
        })
        .enter()
        .append("td")
        .text(function(d) { return d.value; })
        
      }else{
       tbody.selectAll("tr").remove();

        tbody.selectAll("tr")
        .data(key)
        .enter()
        .append("tr")
        .selectAll("td")
        .data(function(row) {
          return columns.map(function(column) {
            return {
              column: column,
              value: row[column]
            };
          });
        })
        .enter()
        .append("td")
        .text(function(d) { return d.value; })
      }
           
      }
      updateTable(1,'population')






      foo = json[0]
      //Create a new object reorienting the shapefile using the geography name as the key
      var nest = d3.nest()
      .key(function(d){
        return d.properties.NAMELSAD;
      })
      .entries(foo.features)

      nest = nest.sort((a, b) => (a.key > b.key) ? 1 : -1)

      nest.unshift({
          "key": "Indiana"
      })

      topic.addEventListener('change', (event) => {
        
        //Relabel Spans
        label = eval(event.target.options[event.target.selectedIndex].value)
        //reLabel(span,label)

        topic_option = selectResize('#topic',0)

        updateTable(0,topic_option)

        option = selectResize('#geography',1,1)
        if(option === 'Indiana'){
          countyfip = "999"
        }else{

          index = foo.features.findIndex(data => data.properties.NAMELSAD === option)
          value = foo.features[index]
          
          ////NEED TO ADD IN INDIANA LOGIC
          countyfip = value.properties.COUNTYFP

        }
        

        

        charts = ['#chart1','#chart2','#chart3','#chart4','#chart5','#chart6']
        variables = ["B01001_001E","B17010_003E",["B19001_002E","B19001_003E","B19001_004E","B19001_005E","B19001_006E","B19001_007E","B19001_008E","B19001_009E","B19001_010E","B19001_011E","B19001_012E","B19001_013E","B19001_014E","B19001_015E","B19001_016E","B19001_017E"],"B01001_001E","B01003_001E","B17010_003E"]

        updateGraph(countyfip,variables,charts,topic_option)

        });

      $('.nav-link').on('click', function(){
          $('.nav-link').removeClass('selected');
          $(this).addClass('selected');

          topic_option = $(this).attr("value")

          updateTable(0,topic_option)

        option = selectResize('#geography',1,1)
        if(option === 'Indiana'){
          countyfip = "999"
        }else{

          index = foo.features.findIndex(data => data.properties.NAMELSAD === option)
          value = foo.features[index]
          
          ////NEED TO ADD IN INDIANA LOGIC
          countyfip = value.properties.COUNTYFP

        }

        

        

        charts = ['#chart1','#chart2','#chart3','#chart4','#chart5','#chart6']
        variables = ["B01001_001E","B17010_003E",["B19001_002E","B19001_003E","B19001_004E","B19001_005E","B19001_006E","B19001_007E","B19001_008E","B19001_009E","B19001_010E","B19001_011E","B19001_012E","B19001_013E","B19001_014E","B19001_015E","B19001_016E","B19001_017E"],"B01001_001E","B01003_001E","B17010_003E"]

        updateGraph(countyfip,variables,charts,topic_option)
          
      });





       topic.addEventListener('change', (event) => {
        
        //Relabel Spans
        label = eval(event.target.options[event.target.selectedIndex].value)
        //reLabel(span,label)

        topic_option = selectResize('#topic',0)


        });

      //Build Geography Selector Change Logic
      const geographies = document.querySelector('#geography')

      geographies.addEventListener('change', (event) => {

        //Resize box
        option = selectResize('#geography',0)



        topic_option = document.querySelector('.selected').getAttribute('value')

        if(option === 'Indiana'){

          window.exportloc = "https://hraadvisors.github.io/Indiana_092221/reports/Indiana_State_Report.pdf"
          countyfip = "999"

          map.flyTo({
            center: [-86.158017, 39.897451],
            zoom: 5.75
            });
        }else{
          //Zoom in on map

        window.exportloc = "https://hraadvisors.github.io/Indiana_092221/reports/" + option.replace(" County","_County") +"_Report.pdf"
        index = foo.features.findIndex(data => data.properties.NAMELSAD === option)
        bounds = turf.bbox(foo.features[index])

        value = foo.features[index]

        map.fitBounds([
        bounds.slice(0,2), // southwestern corner of the bounds
        bounds.slice(2,4) // northeastern corner of the bounds
        ]);

        countyfip = value.properties.COUNTYFP

        }
  
        


         
        map.setFilter('indiana-highlighted', ['in', 'COUNTYFP',countyfip]);
        
        charts = ['#chart1','#chart2','#chart3','#chart4','#chart5','#chart6']
        variables = ["B01001_001E","B17010_003E",["B19001_002E","B19001_003E","B19001_004E","B19001_005E","B19001_006E","B19001_007E","B19001_008E","B19001_009E","B19001_010E","B19001_011E","B19001_012E","B19001_013E","B19001_014E","B19001_015E","B19001_016E","B19001_017E"],"B01001_001E","B01003_001E","B17010_003E"]
        
        //Update Charts
        updateGraph(countyfip,variables,charts,topic_option)


        });

      //Initial Resize for Geographies
      selectResize('#geography',1)

      geography
      .selectAll("option")
      .data(nest)
      .enter()
      .append("option")
      .attr("value", function(d){
        return d.key;
      })
      .text(function(d){
        return d.key;
      })




      mapboxgl.accessToken = 'pk.eyJ1Ijoia3BjbHluZSIsImEiOiJjanN3MzlpY2EwZGpjM3lsaGNhb3NqY3JmIn0._sGjIhmL5Xt08WIMWRsSsg';
      var map = new mapboxgl.Map({
        container: 'map'
        , style: 'mapbox://styles/mapbox/light-v10'
        , center: [-86.158017, 39.897451]
        , zoom: 5.75
        , pitch: 0
        , bearing: 0
        , maxPitch: 85
        , maxZoom: 11
        , minZoom: 5
      });

      map.addControl(new LegendControl({
        collapsed: true,
        toggler: true,
        layers:['population','income','owner','nhpd','multifamily','broadband','dot-fake']
      }), 'top-left');   

      map.scrollZoom.disable();
      map.addControl(new mapboxgl.NavigationControl());
      map.dragRotate.disable();

      //Heat Map - B19013_001E
      tractsgeo = json[1]
      nhpd = json[2]
      fakedots = json[3] 
  
      tractspop = data[21]
      tractsgeo.features.forEach(function(feature){
        pop = {"population": parseInt(tractspop.filter(d => (d.tract == feature.properties.TRACTCE) && (d.county == feature.properties.COUNTYFP))[0].B01001_001E), 
        "mhi": parseInt(tractspop.filter(d => (d.tract == feature.properties.TRACTCE) && (d.county == feature.properties.COUNTYFP))[0].B19013_001E),
        "owner": parseInt(tractspop.filter(d => (d.tract == feature.properties.TRACTCE) && (d.county == feature.properties.COUNTYFP))[0].B25003_002E)/(parseInt(tractspop.filter(d => (d.tract == feature.properties.TRACTCE) && (d.county == feature.properties.COUNTYFP))[0].B25003_002E) + parseInt(tractspop.filter(d => (d.tract == feature.properties.TRACTCE) && (d.county == feature.properties.COUNTYFP))[0].B25003_003E)) * 100,
        "multifamily": (parseInt(tractspop.filter(d => (d.tract == feature.properties.TRACTCE) && (d.county == feature.properties.COUNTYFP))[0].B25024_006E)+parseInt(tractspop.filter(d => (d.tract == feature.properties.TRACTCE) && (d.county == feature.properties.COUNTYFP))[0].B25024_007E) + parseInt(tractspop.filter(d => (d.tract == feature.properties.TRACTCE) && (d.county == feature.properties.COUNTYFP))[0].B25024_008E) + parseInt(tractspop.filter(d => (d.tract == feature.properties.TRACTCE) && (d.county == feature.properties.COUNTYFP))[0].B25024_009E))/(parseInt(tractspop.filter(d => (d.tract == feature.properties.TRACTCE) && (d.county == feature.properties.COUNTYFP))[0].B25024_006E)+parseInt(tractspop.filter(d => (d.tract == feature.properties.TRACTCE) && (d.county == feature.properties.COUNTYFP))[0].B25024_007E) + parseInt(tractspop.filter(d => (d.tract == feature.properties.TRACTCE) && (d.county == feature.properties.COUNTYFP))[0].B25024_008E) + parseInt(tractspop.filter(d => (d.tract == feature.properties.TRACTCE) && (d.county == feature.properties.COUNTYFP))[0].B25024_009E) + parseInt(tractspop.filter(d => (d.tract == feature.properties.TRACTCE) && (d.county == feature.properties.COUNTYFP))[0].B25024_002E) + parseInt(tractspop.filter(d => (d.tract == feature.properties.TRACTCE) && (d.county == feature.properties.COUNTYFP))[0].B25024_003E) + parseInt(tractspop.filter(d => (d.tract == feature.properties.TRACTCE) && (d.county == feature.properties.COUNTYFP))[0].B25024_004E) + parseInt(tractspop.filter(d => (d.tract == feature.properties.TRACTCE) && (d.county == feature.properties.COUNTYFP))[0].B25024_005E) + parseInt(tractspop.filter(d => (d.tract == feature.properties.TRACTCE) && (d.county == feature.properties.COUNTYFP))[0].B25024_010E) + parseInt(tractspop.filter(d => (d.tract == feature.properties.TRACTCE) && (d.county == feature.properties.COUNTYFP))[0].B25024_011E)) * 100,
        "broadband": parseInt(tractspop.filter(d => (d.tract == feature.properties.TRACTCE) && (d.county == feature.properties.COUNTYFP))[0].B28002_007E) / parseInt(tractspop.filter(d => (d.tract == feature.properties.TRACTCE) && (d.county == feature.properties.COUNTYFP))[0].B28002_001E) * 100
         }
        feature.properties = Object.assign({},feature.properties,pop)

      })
      //

  

      map.on('load', function () {


        //Add geojson file as data source
        map.addSource('indiana', {
          'type': 'geojson',
          'data': foo
          });

        map.addSource('dotmap', {
          'type': 'raster',
          'tiles': [
          'https://dz829stppcdeh.cloudfront.net/Tiles/{z}/{x}/{y}.png'
          ],
          'tileSize': 256
          });

        map.addSource('tracts', {
          'type': 'geojson',
          'data': tractsgeo
          });

        map.addSource('nhpd', {
          'type': 'geojson',
          'data': nhpd
          });
        //Add fill layer to map 

        map.addSource('ethnicity', {
        'type': 'geojson',
        'data': fakedots
        });

        map.addLayer({
          'id': 'dot-fake',
          'type': 'circle',
          'source': 'ethnicity',
          'layout': {
            'visibility': 'none'
            },
          'metadata': {
            name: 'Racial Composition',
            labels: {
              '#73B2FF': 'White',
              '#55FF00': 'Black',
              '#FF0000': 'Hispanic',
              '#FFAA00': 'Asian',
              '#895A44': 'Other',
            }
          },
          'paint': {
          // Make circles larger as the user zooms from z12 to z22.
          'circle-radius': {
          'base': 1.75,
          'stops': [
          [12, 2],
          [22, 180]
          ]
          },
          // Color circles by ethnicity, using a `match` expression.
          'circle-color': [
          'match',
          ['get', 'Race'],
          'white',
          '#73B2FF',
          'black',
          '#55FF00',
          'hispanic',
          '#FF0000',
          'asian',
          '#FFAA00',
          /* other */ '#895A44'
          ]
          }
          });
        //'#73B2FF','#55FF00','#FF0000','#FFAA00','#895A44'



        map.addLayer(
          {
          'id': 'indiana-highlighted',
          'type': 'line',
          'source': 'indiana',
          'paint': {
          'line-width': 4,
          'line-color': '#B8C11C'
          //'fill-outline-color': '#B8C11C',
          //'fill-color': 'rgba(0,55,104,0)',
          //'fill-opacity': 0
          },
          'filter': ['in', 'COUNTYFP', '']
          });

        map.addLayer({
          'id': 'indiana-stroke',
          'type': 'line',
          'source': 'indiana',
          'paint': {
            'line-color': 'rgba(0, 55, 104, 1)',
            'line-width': 1
          }
        }
        , 'indiana-highlighted'
        )


        map.addLayer({
          'id': 'indiana',
          'type': 'fill',
          'source': 'indiana',
          'paint': {
            'fill-color': 'rgba(0,55,104,0)',
          }
        }, 'road-primary')

        

        map.addLayer(
          {
          'id': 'dotdensity-map',
          'type': 'raster',
          'layout': {
            'visibility': 'none'
            },
          'source': 'dotmap'
          },
          'road-primary',
          );

        map.on('click', 'indiana', function (e) {

            $('#geography option:contains(' + e.features[0].properties.NAMELSAD + ')').prop({selected: true});

            if ("createEvent" in document) {
                var evt = document.createEvent("HTMLEvents");
                evt.initEvent("change", false, true);
                geographies.dispatchEvent(evt);
            }
            else
                geographies.fireEvent("onchange");

            var bbox = [
              [e.point.x - 1, e.point.y - 1],
              [e.point.x + 1, e.point.y + 1]
              ];
              var features = map.queryRenderedFeatures(bbox, {
              layers: ['indiana']
              });
               
              // Run through the selected features and set a filter
              // to match features with unique FIPS codes to activate
              // the `counties-highlighted` layer.
              var filter = features.reduce(
              function (memo, feature) {
              memo.push(feature.properties.COUNTYFP);
              return memo;
              },
              ['in', 'COUNTYFP']
              );
               
              map.setFilter('indiana-highlighted', filter);

          });

        map.on('mouseenter', 'indiana', function () {
          map.getCanvas().style.cursor = 'pointer';
          });
           
          // Change the cursor back to a pointer
          // when it leaves the states layer.
          map.on('mouseleave', 'indiana', function () {
          map.getCanvas().style.cursor = '';
          });

        map.addLayer({
          'id': 'nhpd',
          'type': 'circle',
          'source': 'nhpd',
          'metadata': {
            name: 'Subsidized Housing Units',
            labels: {
              '#F84C4C': 'Subsidized Buildings'
            }
          },
          'layout': {
            'visibility': 'none'
            },
          'paint': {
            'circle-radius': 2,
            'circle-color': '#F84C4C' // red color
            }
        }, 'road-primary')

        map.on('click', 'nhpd', function (e) {
        var coordinates = e.features[0].geometry.coordinates.slice();
        var description = e.features[0].properties.PropertyAddress;
         
        // Ensure that if the map is zoomed out such that multiple
        // copies of the feature are visible, the popup appears
        // over the copy being pointed to.
        while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
        coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
        }
         
        new mapboxgl.Popup()
        .setLngLat(coordinates)
        .setHTML(description)
        .addTo(map);
        });
         
        // Change the cursor to a pointer when the mouse is over the places layer.
        map.on('mouseenter', 'buildings', function () {
        map.getCanvas().style.cursor = 'pointer';
        });
         
        // Change it back to a pointer when it leaves.
        map.on('mouseleave', 'buildings', function () {
        map.getCanvas().style.cursor = '';
        });

        ///Population Change Pop-up
        /*map.on('mousemove', 'population', (e) => {
                  var description = String(d3.format(",.0f")(e.features[0].properties.population))
                  const popup = document.getElementsByClassName('mapboxgl-popup');
                  if ( popup.length ) {
                      popup[0].remove();
                  }
                  new mapboxgl.Popup()
                  .setLngLat(e.lngLat)
                  .setHTML(description)
                  .addTo(map);

              });
       

          // When the mouse leaves the state-fill layer, update the feature state of the
          // previously hovered feature.
          map.on('mouseleave', 'population', () => {
               const popup = document.getElementsByClassName('mapboxgl-popup');
                if ( popup.length ) {
                    popup[0].remove();
                }
          });

        //['population','income','owner','multifamily','broadband']

        ///Broadband Pop-up
          map.on('mouseenter', 'broadband', function (e) {
          map.getCanvas().style.cursor = 'pointer';
          var coordinates = e.features[0].geometry.coordinates.slice();

          var description = String(d3.format(".0%")(e.features[0].properties.broadband))

          while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
          coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
          }
           
          new mapboxgl.Popup()
          .setLngLat(coordinates)
          .setHTML("Population: " + description)
          .addTo(map);
          });


        ///Income Pop-up
          map.on('mouseenter', 'income', function (e) {
          map.getCanvas().style.cursor = 'pointer';
          var coordinates = e.features[0].geometry.coordinates.slice();

          var description = String(d3.format("$,.0f")(e.features[0].properties.mhi))

          while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
          coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
          }
           
          new mapboxgl.Popup()
          .setLngLat(coordinates)
          .setHTML("Median Household Income: " + description)
          .addTo(map);
          });


        ///Tenure Pop-up
          map.on('mouseenter', 'owner', function (e) {
          map.getCanvas().style.cursor = 'pointer';
          var coordinates = e.features[0].geometry.coordinates.slice();

          var description = String(d3.format(".0%")(e.features[0].properties.owner))

          while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
          coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
          }
           
          new mapboxgl.Popup()
          .setLngLat(coordinates)
          .setHTML("% Owner Occupied: " + description)
          .addTo(map);
          });

          ///Broadband Pop-up
          map.on('mouseenter', 'multifamily', function (e) {
          map.getCanvas().style.cursor = 'pointer';
          var coordinates = e.features[0].geometry.coordinates.slice();

          var description = String(d3.format(".0%")(e.features[0].properties.multifamily))

          while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
          coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
          }
           
          new mapboxgl.Popup()
          .setLngLat(coordinates)
          .setHTML("% Multifamily: " + description)
          .addTo(map);
          });*/





        minpop = getMinY(tractsgeo.features,'properties.population')
        maxpop = getMaxY(tractsgeo.features,'properties.population')
        map.addLayer({
          'id': 'population',
          'source': 'tracts',
          'type': 'fill',
          'metadata': {
            name: 'Population Growth'
          },
          'layout': {
            'visibility': 'none'
            },
          'paint': {
              'fill-color': [
                  'interpolate',
                  ['linear'],
                  ['get', 'population'],
                  minpop,'white',
                  maxpop,'red'
                  ],
              'fill-opacity': 0.75
          }
        },'road-primary')

     
        minincome = 0
        maxincome = getMaxY(tractsgeo.features,'properties.mhi')

        map.addLayer({
          'id': 'income',
          'source': 'tracts',
          'type': 'fill',
          'layout': {
            'visibility': 'none'
            },
          'paint': {
              'fill-color': [
                  'interpolate',
                  ['linear'],
                  ['get', 'mhi'],
                  minincome,'white',
                  maxincome,'red'
                  ],
              'fill-opacity': 0.75
          }
        }, 'road-primary')

        minowner = 0
        maxowner = 100

        map.addLayer({
          'id': 'owner',
          'source': 'tracts',
          'type': 'fill',
          'metadata': {
            name: 'Tenure (% Owner Occupied)',
            unit: '%'
          },
          'layout': {
            'visibility': 'none'
            },
          'paint': {
              'fill-color': [
                  'interpolate',
                  ['linear'],
                  ['get', 'owner'],
                  minowner,'white',
                  maxowner,'red'
                  ],
              'fill-opacity': 0.75
          }
        },'road-primary')

        minowner = 0
        maxowner = 100

        map.addLayer({
          'id': 'broadband',
          'source': 'tracts',
          'type': 'fill',
          'metadata': {
            name: 'Broadband Access',
            unit: '%'
          },
          'layout': {
            'visibility': 'none'
            },
          'paint': {
              'fill-color': [
                  'interpolate',
                  ['linear'],
                  ['get', 'broadband'],
                  minowner,'white',
                  maxowner,'red',
                  ],
              'fill-opacity': 0.75
          }
        },'road-primary')


        minmultifamily = 0
        maxmultifamily = 100

        map.addLayer({
          'id': 'multifamily',
          'source': 'tracts',
          'type': 'fill',
          'metadata': {
            name: 'Multifamily Housing Units',
            unit: '%'
          },
          'layout': {
            'visibility': 'none'
            },
          'paint': {
              'fill-color': [
                  'interpolate',
                  ['linear'],
                  ['get', 'multifamily'],
                  minmultifamily,'white',
                  maxmultifamily,'red'
                  ],
              'fill-opacity': 0.75
          }
        },'road-primary')

        //Add seperate stroke layer



      })

  

    map.once('idle', function(){
      legend_labels = document.querySelectorAll("#map > div.mapboxgl-control-container > div.mapboxgl-ctrl-bottom-left > div.mapboxgl-ctrl.mapboxgl-ctrl-legend > details.mapboxgl-ctrl-legend-pane.mapboxgl-ctrl-legend-pane--income > div > p > span"); 
      legend_labels.forEach(d => d.innerText = d3.format(",")(d.innerText));

    })
    }




    
    var files = ["gis/counties.geojson", "gis/tracts3.geojson", "gis/nhpd.geojson", "gis/dots.geojson"];
      var promises = [];

      files.forEach(function(url) {
          promises.push(fetch(url))
      });

      Promise.all(promises)
        .then(function (responses) {
          // Get a JSON object from each of the responses and merge into one object
          return Promise.all(responses.map(function (response) {

            return response.json();
          }));
        })
        .then(function (data) {
          // Assign data
          mapData(data)
        })
        .catch(function (error) {
          // if there's an error, log it
          console.log(error);
        });

      
      
      

  }
  
  
  function collectData(fips,manifest){

    /*
    //variable,div
    fetches = Array()
    fetchIndex = []
    vars = []
    for (let [key, value] of Object.entries(manifest.topic)){
      d = value.filter(d => d.dataset == 'ACS')
      for (let [key, value] of Object.entries(d)){
        value.variables.forEach(d => vars.push(d.code))
      }
    }
    let uniqueVars = [...new Set(vars)]

    manifest.sources.forEach(function(x){
      vars = []
      state = '18'
      county = '*'

      for (let [key, value] of Object.entries(manifest.topic)){
        d = value.filter(d => d.dataset == x.name)
        for (let [key, value] of Object.entries(d)){
          value.variables.forEach(d => vars.push(d.code))
        }}

      let uniqueVars = [...new Set(vars)]
      variables = uniqueVars.join()
      
      x.endpoints.forEach(function(endpoint,i){
      
      years.forEach(function(year){
        newurl = endpoint.url
        m = newurl.split("{}").length - 1;
        for (t=0; t<m; t++){
        newurl = newurl.replace("{}",eval(endpoint.sub[t]))
        }
       
      fetches.push(fetch(newurl))
      fetchIndex.push({"geo":manifest.geographies[i],"year":year, 'source': x.name, 'use':'charts'})
      })



      })      
  
  
    })


    */
    
    fetches = Array()
    fetchIndex = []
    allyears = []
    for (i=2010; i <= 2019; i++){
      allyears.push(i)
    }

    allyears.forEach(function(year){
      manifest.sources.forEach(function(x){
        vars = []
        ys = []
        state = '18'
        county = '*'

        for (let [key, value] of Object.entries(manifest.topic)){
          d = value.filter(d => d.dataset == x.name && findDomain(d.year).includes(year))
          d.forEach(function(b){
            ys.push(findDomain(b.year))
          })
          //ys.push(findDomain(d.year))
          for (let [key, value] of Object.entries(d)){
            value.variables.forEach(d => vars.push(d.code))
          }}

        let uniqueVars = [...new Set(vars)]
        variables = uniqueVars.join()

        uniqueys = [...new Set(ys.flat())]


        x.endpoints.forEach(function(endpoint,i){
           newurl = endpoint.url
            m = newurl.split("{}").length - 1;
            for (t=0; t<m; t++){
            newurl = newurl.replace("{}",eval(endpoint.sub[t]))
            }
          
          if(findDomain(d.year).includes(year)){

            fetches.push(fetch(newurl))
            fetchIndex.push({"geo":manifest.geographies[i],"year":year, 'source': x.name, 'use':'charts','includes':uniqueys})
    
          }
          
          
          })

        })

    })

    

    fetches.push(fetch("https://api.census.gov/data/2019/acs/acs5?get=NAME,B01001_001E,B19013_001E,B25003_002E,B25003_003E,B25024_002E,B25024_003E,B25024_004E,B25024_005E,B25024_006E,B25024_007E,B25024_008E,B25024_009E,B25024_010E,B25024_011E,B28002_001E,B28002_007E&for=tract:*&in=state:18&key=dd33b0475c26275920fe5c32a030d1a3310e899f"))
    fetchIndex.push({"geo":'tracts',"year":2019, 'source': 'ACS', 'use':'maps'})




    ////ENDTEST

    /*vars = []
    temp1.sources.forEach(function(d){
      list = temp1.topic.filter(d =>   )
      })*/
    
    //Concatenate the variables into a comma seperated string for use in the API call
    
    
    //Since the API has a seperate endpoint for each year, we need to create an array of promises to pull them all
    /*
    fetches = Array()
    years.forEach(year => fetches.push(fetch('https://api.census.gov/data/' + String(year) + '/acs/acs5?get=NAME,'+variables+'&for=county:'+ fips +'&in=state:18&key=dd33b0475c26275920fe5c32a030d1a3310e899f')))*/

    //When all of the promises have resolved assign the data to their appropriate charts
    Promise.all(fetches)
    .then(function (responses) {
      // Get a JSON object from each of the responses and merge into one object
      return Promise.all(responses.map(function (response) {
        return response.text()
      }));
    })
    .then(function (data) {
      data.forEach(function(d,i){if(d.charAt(0) === "["){
        data[i] = JSON.parse(d)
      }else{
        data[i] = Papa.parse(d).data
      }})

      // Assign data
      assignData(data,manifest,fetchIndex)
    })
    .catch(function (error) {
      // if there's an error, log it
      console.log(error);
    });

  }


  //Make Initial Charts
  
  fetch('manifest.json')
    .then(response => response.json())
    .then(function(json){
      charts = ['#chart1','#chart2','#chart3','#chart4','#chart5','#chart6']




    //variables = ["B01001_001E","B01003_001E","B17010_003E","B01001_001E","B01003_001E","B17010_003E"]
      variables = ["B01001_001E","B17010_003E",["B19001_002E","B19001_003E","B19001_004E","B19001_005E","B19001_006E","B19001_007E","B19001_008E","B19001_009E","B19001_010E","B19001_011E","B19001_012E","B19001_013E","B19001_014E","B19001_015E","B19001_016E","B19001_017E"],"B01001_001E","B01003_001E","B17010_003E"]
      collectData("*",json)

    });


  

  //Define Method to Update Charts - Remove Existing and Replace (Should update to be dynamic)





});



</script>
</html>