
<!DOCTYPE html>
<html data-wf-page="601c049ad82b2e1c184dbcae" data-wf-site="601c049a7d7f2b0e4f241841">
<head>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="style.css">
<link href="css/normalize.css" rel="stylesheet" type="text/css"> 
<link href="css/webflow.css" rel="stylesheet" type="text/css">
  <link href="css/miami-dda-office-report.webflow.css" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&display=swap" rel="stylesheet">
    <link href='css/dda.css' rel='stylesheet' />
<script src="https://d3js.org/d3.v4.js"></script>
<script src="https://d3js.org/d3-geo-projection.v1.min.js"></script>
<script src="https://d3js.org/d3-array.v1.min.js"></script>
<script src="https://d3js.org/d3-format.v2.min.js"></script>
<script src="https://d3js.org/d3-geo.v1.min.js"></script>
<script src="https://clynekp.github.io/d3-tip.min.js"></script>
<script src="https://d3js.org/d3-scale.v3.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3-annotation/1.12.1/d3-annotation.min.js"></script>
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.5.1/mapbox-gl-geocoder.min.js"></script>
<link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.5.1/mapbox-gl-geocoder.css" type="text/css" />
<script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.auto.min.js"></script>
<script src="deckgl.min.js"></script>
<script src="https://api.mapbox.com/mapbox-gl-js/v2.1.1/mapbox-gl.js"></script>
<link href="https://api.mapbox.com/mapbox-gl-js/v2.1.1/mapbox-gl.css" rel="stylesheet" />

<title>Miami DDA Office Report</title>
<script src="https://ajax.googleapis.com/ajax/libs/webfont/1.6.26/webfont.js" type="text/javascript"></script>
<script type="text/javascript">WebFont.load({  google: {    families: ["Varela Round:400","Cabin:regular,500,500italic,600,600italic,700"]  }});</script>
  <script type="text/javascript">WebFont.load({  google: {    families: ["Montserrat:100,100italic,200,200italic,300,300italic,400,400italic,500,500italic,600,600italic,700,700italic,800,800italic,900,900italic"]  }});</script>
<!-- [if lt IE 9]><script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.min.js" type="text/javascript"></script><![endif] -->
<script type="text/javascript">!function(o,c){var n=c.documentElement,t=" w-mod-";n.className+=t+"js",("ontouchstart"in o||o.DocumentTouch&&c instanceof DocumentTouch)&&(n.className+=t+"touch")}(window,document);</script>
<style>
div.tooltip2 { 
    position: absolute;     
    text-align: center;               
    padding: 10px;       
    font: 12px sans-serif;    
    background: #fff;
    border: 2px solid #000;   
    border-radius: 5px;     
    pointer-events: none;
    -moz-border-radius:5px;
    color: black
    z-index: 10;     
}

body{
  margin: 0px auto;

}

*,
*::before,
*::after {
  box-sizing: border-box;
}

*:focus { outline: none; }

:root {
  --select-border: #777;
  --select-focus: blue;
  --select-arrow: var(--select-border);
}

select {
  // A reset of styles, including removing the default dropdown arrow
  appearance: none;
  background-color: transparent;
  border: none;
  padding: 0 1em 0 0;
  margin: 0;
  width: 100%;
  font-family: inherit;
  font-size: inherit;
  cursor: inherit;
  line-height: inherit;

  // Stack above custom arrow
  z-index: 1;

  // Remove dropdown arrow in IE10 & IE11
  // @link https://www.filamentgroup.com/lab/select-css.html
  &::-ms-expand {
    display: none;
  }

  // Remove focus outline, will add on alternate element
  outline: none;
}

.select {
  display: grid;
  grid-template-areas: "select";
  align-items: center;
  position: relative;

  select,
  &::after {
    grid-area: select;
  }

  min-width: 15ch;
  max-width: 30ch;

  border: 1px solid var(--select-border);
  border-radius: 0.25em;
  padding: 0.25em 0.5em;

  font-size: 1.25rem;
  cursor: pointer;
  line-height: 1.1;

  // Optional styles
  // remove for transparency
  background-color: #fff;
  background-image: linear-gradient(to top, #f9f9f9, #fff 33%);

  // Custom arrow
  &:not(.select--multiple)::after {
    content: "";
    justify-self: end;
    width: 0.8em;
    height: 0.5em;
    background-color: var(--select-arrow);
    clip-path: polygon(100% 0%, 0 0%, 50% 100%);
  }
}

// Interim solution until :focus-within has better support
select:focus + .focus {
  position: absolute;
  top: -1px;
  left: -1px;
  right: -1px;
  bottom: -1px;
  border: 2px solid var(--select-focus);
  border-radius: inherit;
}

select[multiple] {
  padding-right: 0;

  /*
   * Safari will not reveal an option
   * unless the select height has room to 
   * show all of it
   * Firefox and Chrome allow showing 
   * a partial option
   */
  height: 6rem;

  option {
    white-space: normal;

    // Only affects Chrome
    outline-color: var(--select-focus);
  }

  /* 
   * Experimental - styling of selected options
   * in the multiselect
   * Not supported crossbrowser
   */
  //   &:not(:disabled) option {
  //     border-radius: 12px;
  //     transition: 120ms all ease-in;

  //     &:checked {
  //       background: linear-gradient(hsl(242, 61%, 76%), hsl(242, 61%, 71%));
  //       padding-left: 0.5em;
  //       color: black !important;
  //     }
  //   }
}

.select--disabled {
  cursor: not-allowed;
  background-color: #eee;
  background-image: linear-gradient(to top, #ddd, #eee 33%);
}

label {
  font-size: 1.125rem;
  font-weight: 500;
}

.select + label {
  margin-top: 2rem;
}



.line {
  fill: none;
  stroke: #FFFFFF;
  stroke-width: 2px;
}

.selected{
  stroke: #EF5285;
}

.tooltip {
  position: absolute;
  top: 100px;
  left: 100px;
  -moz-border-radius:5px;
  border-radius: 5px;
  border: 2px solid #000;
  background: #fff;
  opacity: .9;
  color: black;
  padding: 10px;
  width: 300px;
  font-size: 12px;
  z-index: 10;
}

.tooltip .title {
  font-size: 13px;
}

.tooltip .name {
  font-weight:bold;
}

h1{
  text-align: left;
}

p{
  z-index:500;
}

.tick line{
  visibility:hidden;
}

.axis text{ 
  font: 14px Nunito;
  font-weight: bold;
  fill: #b1b1b1;}

  .axis path{ 
  stroke: #b1b1b1;}

#container{
  position: relative;
}

#sections{
    width: auto;
    position: relative;
    margin: 0px auto;
    margin-left: 60vw;
    margin-right: 10vw;    
}



#sections > div{
    padding: 10px;
    margin-bottom: 80vh;
    opacity: .5;
}

#sections p{
  background: rgba(255,255,255,.5);
  padding:2em;
  text-align: center
}
#sections > div:last-child{
  margin-bottom: 30px;
}
#sections > div.graph-scroll-active{
  opacity: 1;
}

#graph{
  width: 100%;
  position: -webkit-sticky;
  position: sticky;
  top: 0px;
}

.map {
  height: 75vh;
  width: 100%;
  position: -webkit-sticky;
  position: sticky;
  top: 100px;
}
#map2{

    width: 100%;
}



#map3 {
  height: 100%;
  width: 100%;
  position: -webkit-sticky;
  position: sticky;
  top: 100px;
}

  #menu{
    margin:10px;
  }

.container-2 p{
  background: rgb(255 255 255 / 88%) !important;
}

/*.container-2 #sections{
  margin-left: 30% !important
}
*/

@media screen and (max-width: 925px)  {
  #graph{
    width: 100%;
    margin-left: 0px;
    float: none;
  }

   #menu {
        background: white;
        font-family: 'Nunito', sans-serif;
        font-size: 15px;
        position: absolute;
        z-index: 1;
        top: 20px;
        left: 20px;
        right: 20px;
        width: 10vw;
        display: inline-block;
        color: #fff;
        box-shadow: 1.5px 1.5px 2px rgba(0, 0, 0, 0.2);
        -moz-box-shadow: 1.5px 1.5px 2px rgba(0, 0, 0, 0.2);
        -webkit-box-shadow: 1.5px 1.5px 2px rgba(0, 0, 0, 0.2)
      }

  #sections{
    width: auto;
    position: relative;
    margin: 0px auto;
  }

  #sections > div{
    background: rgba(255,255,255,.5);
    padding: 10px;
    border-top: 1px solid;
    border-bottom: 1px solid;
    margin-bottom: 80vh;
  }



  pre{
    overflow: hidden;
  }

  h1{
    margin: 10px;
  }
}

  .on {
        background: white url("../style/check1.svg") no-repeat right;
        background-origin: content-box;
        background-size: 18px 18px;
        display: block;
        margin: 0px;
        position: relative;
        z-index:200;
        width: 10vw;
        padding: 10px;
        color: black;
        border-bottom: 1px solid #8D9192;
    }
.bordertop{border-top: 1px solid #8D9192;}
    .on:hover {
        background: #51b3c9 url("../style/check1hover.svg") no-repeat right;
        background-origin: content-box;
        background-size: 18px 18px;
        color: white;
    }
    .off {
        background: white url("../style/check3.svg") no-repeat right;
        background-origin: content-box;
        background-size: 18px 18px;
        color: black;
        display: block;
        margin: 0;
        padding: 0;
        padding: 10px;
        border-bottom: 1px solid #8D9192;
    }
    .off:hover {
        background: #51b3c9 url("../style/check3hover.svg") no-repeat right;
        background-origin: content-box;
        background-size: 18px 18px;
        color: white;
    }
    .legend {
        padding: 10px;
        background: #fff;
        color: #C7354D;
        vertical-align:middle;
    }
    .row {
        display: table-row;
    }
    .noborder {
        border-bottom: 0px solid white;
    }



.mono{
  font-family: monospace;
}



</style>
<style type="text/css">
      .mapboxgl-ctrl-logo{
        display:none !important;
      }
      .mapboxgl-ctrl-bottom-right{
        display:none !important;
      }
      .mapboxgl-ctrl-bottom-left{
        display:none !important;
      }

      .css-9emwa5{
        display:none !important;
      }
      .deck-tooltip {
        font-family: Helvetica, Arial, sans-serif;
        padding: 6px !important;
        margin: 8px;
        max-width: 300px;
        font-size: 10px;
      }
    </style>
</head>
<body>
  <div id="tooltip"></div>
  <div class="section cc-store-home-wrap">
    <div class="intro-header">
      <div class="intro-content cc-homepage">
        <div class="intro-text">
          <div class="heading-jumbo">DOWNTOWN MIAMI</div>
          <div class="paragraph-bigger cc-bigger-white-light"><span class="text-span">ANNUAL OFFICE MARKET OVERVIEW</span><br></div>
        </div>
      </div>
    </div>
    <div class="container">
      <div class="motto-wrap">
        <div class="label cc-light">INTRODUCTION</div>
        <div class="heading-jumbo-small">While office markets across the country continue to feel the impact of the COVID-19 pandemic, early indicators suggest greater resilience in the Downtown Miami market. Asking rates not only remain stable, but have increased for Class A office spaces, while vacancy has only risen slightly compared to other markets. More importantly, the flurry of activity in the last few months of 2020 is a testament to Miami’s rising position as an attractive, world-class location for businesses and corporations, especially new-to-market players. <br><br>Downtown Miami is arguably even better situated – its thriving restaurant scene, top-quality hotels, transit access, and upcoming state-of-the-art office buildings, will continue to make it a desirable market for tenants looking to relocate or expand in Miami, as well as young talent seeking job opportunities.<br></div>
      </div>
      <div class="divider"></div>
      <div class="home-content-wrap">
        <div data-duration-in="300" data-duration-out="100" class="w-tabs">
          <div class="tabs-menu w-tab-menu">
            <a data-w-tab="Tab 1" class="tab-link-copy w-inline-block w-tab-link w--current">
              <div>OFFICE  REPORT</div>
            </a>
            <a data-w-tab="Tab 2" class="tab-link w-inline-block w-tab-link">
              <div>DISTRICT DASHBOARD</div>
            </a>
          </div>
          <div class="w-tab-content">
            <div data-w-tab="Tab 1" class="tab-pane-tab-1 w-tab-pane w--tab-active">
              <div class="container-14 w-container">
                <div class="icon"><img src="images/Office.svg" loading="lazy" width="75" alt=""></div>
                <h2 class="heading-2">OFFICE MARKET</h2>
                  <div id='container' class='container-2'>
                    <div id='map' class="map">
                      <!--<div id='menu' class='mobilehide'>
                        <div id='classabutton' class='on bordertop'>Office</div>
                        <div id='otherbutton' class='on'>Residential</div>
                        <div id='condobutton' class='on'>Transit</div>
                    </div> -->
                    </div>

                    <div id='sections'>
                      <div>
                             <p>Downtown Miami is host to a unique array of neighborhoods including the Central Business District, Brickell, and Arts & Entertainment District.
                        </p>
                      </div>
                      <div>
                        <p>The DDA Area has over 23 million square feet of office inventory.
                        </p>
                      </div>
                      <div>
                              <p>There is currently 1.5M SF of office development in the pipeline, including 830 Brickell, a standalone Class A-plus office tower adding 640,000 SF in the heart of Brickell.
                        </p>
                      </div>
                      <div>
                        <p> When workers return to the office, they’ll be heading to some of the most recent office stock in the country. Over the last 10 years, <b class="text-span-10">more than a quarter</b> of Miami’s office inventory has either been <b class="text-span-10" style="color:#c5c531">recently developed</b> or has undergone <b class="text-span-10" style="color:#F77E08">major renovation</b>.
                        </p>
                       </div> 
                      <div>
                        <p> The office market is expected to continue to grow, with over 4 Million SF of new proposed office space in the next five years in developments like One Bayfront Plaza and MiamiCentral Phase 2.
                        </p>
                      </div>
                      <div>
                        <p> Downtown's extensive public transportation network including Metrorail, MetroMover, and Brightline connect downtown to Greater Miami and South Florida, bringing in workers and visitors.
                        </p>
                      </div>
                      <div>
                        <p>Miami is well suited to meet the post-COVID demand for flexible office space, with coworking facilities representing 4.5% of all leased office inventory.</p>   
                      </div>
                      <div>
                      </div>
                    </div>


                  </div>
                <!--<div class="div-block-47">
                  <div>[VACANCY CHART SCROLL]</div>
                </div> -->
              </div>
              <div class="container-15 w-container">
                <h1 class="heading-9">Who&#x27;s Here</h1>
                <div class="w-row"> 
                  <div class="w-col w-col-8" id="wrapper">
                    <div class="outer1" id="emp">    
                        <div id="chart" class="inner1"></div>
                      </div>
                  </div> 
                  <div class="column-14 w-col w-col-4"> 
                    <p class="paragraph-14">Downtown Miami’s diverse economy is reflected in the variety of its top employers including law, professional services, and tech companies. Many domestic and international firms are establishing regional offices in Miami and existing businesses are expanding to take advantage of a growing economy and trained workforce.</p> 
                  </div> 
                </div> 
              </div> 
              <div class="container-15 w-container"> 
                <h1 class="heading-9">Who&#x27;s Coming</h1> 
                <div class="w-row"> 
                  <div class="w-col w-col-8" id="wrapper">
                    <div class="outer2" id="emp">    
                      <div id="chart2" class="inner2"></div>
                    </div>
                  </div> 
                  <div class="column-15 w-col w-col-4"> 
                    <p class="paragraph-14">Recent relocations from firms like Shiftpixy and Blackstone reflect Miami as a strong hub for financial services, as well as an emerging destination for tech companies. New-to-market tenants, typically comprising 8% of lease deals, now make up 57%. </p> 
                  </div> 
                </div> 
              </div>
              <div class="container-15 w-container">
                <div class="divider2"></div>
                <div class="icon"><img src="images/Employment.png" loading="lazy" width="75" alt=""></div>
                <h1 class="heading-2">TALENT</h1>
                <h2 class="heading-7">Dynamic Talent Pool</h2>
                <p class="paragraph-14">Miami-Dade County is one of the most dynamic employment markets in the nation with a year-over-year employment growth averaging 3.76% in the last three years. Approximately 85,000 employees work in Downtown Miami which represents 6.6% of the county’s workforce.</p>
                <div class="w-layout-grid grid-4">
                  <div class="div-block-17">
                    <h1 class="heading-6-copy">MIAMI DDA JOB GROWTH BETWEEN 2010-2020:<br></h1>
                    <p class="paragraph-9">18%</p>
                  </div>
                  <div class="div-block-17">
                    <p class="heading-6-copy">TOP 3 INDUSTRIES MAKE UP <span class="text-span-10">57% </span>OF TOTAL DDA JOBS:<br></p>
                    <ul role="list" class="list">
                      <li class="list-item"><span class="text-span-11">Professional Services</span> (22%)</li>
                      <li class="list-item-2"><span class="text-span-11">Government</span> (19%)</li>
                      <li class="list-item-3"><span class="text-span-11">Finance &amp; Insurance</span> (15%)</li>
                    </ul>
                  </div>
                </div>
                <div id='container' class='container-1'>
                    <div id='graph'><svg id="bubble" style="width:100%; height:60vh; padding-top:5vh"></svg>
                      <!--<div id='menu' class='mobilehide'>
                        <div id='classabutton' class='on bordertop'>Office</div>
                        <div id='otherbutton' class='on'>Residential</div>
                        <div id='condobutton' class='on'>Transit</div>
                    </div> -->
                    </div>

                    <div id='sections'>
                      <div>
                        <p>[Industry statistics]</p>
                      </div>
                      <div>
                        <p>[Industry statistics]</p>
                      </div>
                      <div>
                        <p>[Industry statistics]</p>
                      </div>
                      <div>
                      </div>
                    </div>


                  </div>
                <div class="div-block-41">
                  <div class="div-block-49">
                    <h2 class="heading-7">6th Largest College Town</h2>
                    <p class="paragraph-11">Miami currently has a student population of 275K, making Miami the nation’s 6th largest college town, with schools like the University of Miami, Florida International University, and Florida Atlantic producing a growing pipeline of talent.</p>
                  </div>
                  <div class="div-block-7"><svg id="collegetowns" width="100%" height="100%"></div>


                  <p class="paragraph-11">Education rates are increasing in Miami with 40K more secondary degree holders in 2019 than in 2010. As of 2019, Miami has a student population of 275K, making it the nation’s 6th largest college town with schools like the University of Miami, Florida International University, and Florida Atlantic producing a growing pipeline of talent. Miami talent likes to stay in Miami. As of 2019 65% of alumni from Miami schools stay in Miami after graduation. Miami also attracts a large share of graduates from throughout the state.</p>

                  <div class="w-row">
                    <div class="w-col w-col-6 w-col-stack">
                      <div class="div-block-6">
                        <svg id="educhart" width="100%" height="80%"></svg>
                        <div class="range-wrap" style="margin-left:30px; margin-right:30px;  ">
                          <input id="slide" type="range" class="range" min="2010" max="2019" value="2010">
                          <output class="bubble" style="left: calc(0% + 8px);top: 28px;"></output>
                        </div>
                      </div>
                    </div>
                    <div class="column-5 w-col w-col-6 w-col-stack">
                      <p class="paragraph-12">TODAY:</p>
                      <div class="w-layout-grid grid-5">
                        <p id="w-node-f6d3147c-8b49-46a2-3972-bc2f39c29b0d-f458ecee" class="paragraph-9-copy">18%</p>
                        <p id="w-node-ec71e429-1526-5c75-ef54-1316a15c38a6-f458ecee" class="paragraph-17">STUDENT POPULATION</p>
                        <p id="w-node-_6cecf1c7-0eef-3e8c-a026-9d8510453c5b-f458ecee" class="paragraph-9-copy">75%</p>
                        <p id="w-node-_0fa72819-0b30-0023-db27-bdbca2171f47-f458ecee" class="paragraph-18">OF POPULATION THAT SPEAKS A LANGUAGE OTHER THAN ENGLISH</p>
                      </div>
                      <p class="paragraph-13">BETWEEN 2010-2019:</p>
                      <div class="w-layout-grid grid-5">
                        <p class="paragraph-9-copy">40K+</p>
                        <p id="w-node-_0a126a8a-bf7a-ba9c-fa9c-8fbfdcbdb6d9-f458ecee" class="paragraph-17">BACHELOR &amp; ABOVE DEGREE HOLDERS</p>
                        <p class="paragraph-9-copy">39%+</p>
                        <p class="paragraph-18">GROWTH IN BACHELOR &amp; ABOVE DEGREE HOLDERS</p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="container-15 w-container">
                <div class="div-block-7-copy">
                    <div id='container' class='container-3'>
                    <div class="map">
                                      <h1 class="heading-7">Everyone is Coming to Miami</h1>
                <p class="paragraph-11">Recent trends show an influx of national talent into Miami.<br></p>
                    <div id='map3'>
                      <!--<div id='menu' class='mobilehide'>
                        <div id='classabutton' class='on bordertop'>Office</div>
                        <div id='otherbutton' class='on'>Residential</div>
                        <div id='condobutton' class='on'>Transit</div>
                    </div> -->
                    </div></div>

                    <div id='sections'>
                      <div>
                        <p>Data on permanent and temporary relocations from the United States Postal Services shows growing inter-city relocations post-COVID.
                        </p>
                      </div>
                      <div>
                        <p>Permanent relocations from people originally living outside Florida grew 51% year-over-year in 2020. 60% of permanent newcomers from outside of Florida came from New York, Massachusetts, and Pennsylvania, with the majority from NY (53%). 
                        </p>
                      </div>
                      <div>
                        <p>CA, IL, and DC also saw a substantial increase in outflow to Miami.
                        </p>
                      </div>
                      <div>
                      </div>
                    </div>


                  </div>
                </div>
                <h1 class="heading-7">Growing Buzz</h1>
                <div class="div-block-7"><div class='sk-ww-twitter-collection' data-embed-id='55161'></div><script src='https://www.sociablekit.com/app/embed/twitter-collections/widget.js' async defer></script></div>
                <p class="paragraph-11">As COVID has upended traditional ideas of the workplace and industries become less tied to specific geographies, many have been looking to relocate to areas with a higher quality of life and lower regulatory environment.</p>
                <div class="div-block-41-copy-copy">
                  <div class="text-block-9-copy">“Companies used to come to Miami for tax purposes. For the first time, employees are making the decision – employees are saying, let’s go to Miami.”<br>‍<br><span class="text-span-7">– Danet Linares, Blanca Commercial Real Estate</span></div>
                  <div class="text-block-9-copy">“South Florida and Miami have a lot of fundamentals going for it. We’ve experienced 5years of growth in the last few months. People are either looking to relocatedivisions, or establish satellite offices in Miami. What remains to be seen isthe scale of the migration.”<br>‍<br><span class="text-span-8">– Justin Oates, Cain International</span></div>
                </div>
                <div class="div-block-41-copy">
                  <div class="text-block-9">“There is a significant need for coworking and flex space looking ahead, maybe even more so than previously as the way people use the office continues to evolve.” <br><br><span class="text-span-8">– Justin Oates, Cain International</span></div>
                  <div class="text-block-9">“We are singing people up like crazy… People are looking to get our of their homes, and they want spaces where they can meet with clients.” <br><br><span class="text-span-7">– Yolaine Gil, Pipeline Workspaces</span></div>
                </div>
              </div>
            </div>
            <div data-w-tab="Tab 2" class="w-tab-pane">
              <div id="District-Profiles" class="section-4">
                <div class="div-block-36">
                  <div class="icon"><img src="images/District.png" loading="lazy" width="61" alt=""></div>
                  <h2 class="section-heading-copy-copy">DISTRICT DASHBOARD</h2>
                  <p class="paragraph-21">Downtown Miami is host to a unique array of neighborhoods that each have their own character. Pieced together, the Miami DDA continues to lead the way as the largest downtown office market within Miami-Dade County and the state of Florida in terms of rentable square footage, and Class A rental rates.</p>
                  <div class="div-block-25">
                    <a href="#" class="button-13 w-button" id="MiamiButton"><strong class="bold-text-10">MIAMI-DADE</strong></a>
                    <a href="#" class="button-12 w-button" id="GDButton"><strong class="bold-text-11">GREATER DOWNTOWN</strong></a>
                    <a href="#" class="button-12 w-button" id="DDAButton"><strong class="bold-text-12">DDA</strong></a>
                    <a href="#" class="button-12 w-button" id="CBDButton"><strong class="bold-text-13">CBD</strong></a>
                    <a href="#" class="button-12 w-button" id="AEButton"><strong class="bold-text-14">A&amp;E</strong></a>
                    <a href="#" class="button-12 w-button" id="BrickellButton"><strong class="bold-text-15">BRICKELL</strong></a>
                  </div>
                  <div class="w-layout-grid grid-2">
                    <div class="div-block-43">
                      <div class="div-block-21">
                        <div><img src="images/Business_1Business.png" loading="lazy" width="129" alt="" class="image-4"></div>
                        <div class="div-block-22">
                          <div><strong class="bold-text-16">Businesses</strong></div>
                          <div class="div-block-35" id="businesses"></div>
                        </div>
                      </div>
                    </div>
                    <div class="div-block-43">
                      <div class="div-block-21">
                        <div><img src="images/Population_1Population.png" loading="lazy" width="129" alt="" class="image-5"></div>
                        <div class="div-block-22">
                          <div><strong class="bold-text-17">Population</strong></div>
                            <div class="div-block-34" id="population"></div>
                          
                        </div>
                      </div>
                    </div>
                    <div class="div-block-43">
                      <div class="div-block-21">
                        <div><img src="images/Employee_1Employee.png" loading="lazy" width="129" alt="" class="image-6"></div>
                        <div class="div-block-22">
                          <div><strong class="bold-text-18">Employees</strong></div>
                          <div class="div-block-33" id="employees"></div>
                        </div>
                      </div>
                    </div>
                    <div class="div-block-43" id="map2">
                     
                    </div>
                  </div>
                  <div class="div-block-43" id="conditions">
                    <!-- <div class="div-block-12" id="conditions"></div> -->
                  </div>
                  <div class="div-block-43">
                    <div class="w-layout-grid grid-3">
                      <div class="div-block-52">
                        <div  class="dropdown w-dropdown">
                          <div style="color:#FFF">Metric: </div>
                          <div id="metric" class="select">
                          </div>
                        </div>
                        <br>
                        <br>
                        <div class="dropdown w-dropdown">
                          <!--<div style="color:#FFF">Geography: </div>
                          <div id="geography" class="select">
                          </div> -->
                        </div>
                      </div>
                      <div id="rentvis"></div>

                  </div>
                  
                </div>
                <div class="div-block-5" id="dashmap"><iframe id="iframe" width=100% height = 100% src="carti.html" frameborder="0" allowfullscreen scrolling="no"></iframe></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
<script src="test/d3v4+jetpack.js"></script>
<script src="test/graph-scroll.js"></script>
 <script src="https://d3e54v103j8qbb.cloudfront.net/js/jquery-3.5.1.min.dc5e7f18c8.js?site=6041a54707ac14648370b006" type="text/javascript" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/waypoints/4.0.1/jquery.waypoints.js" integrity="sha512-ZKNVEa7gi0Dz4Rq9jXcySgcPiK+5f01CqW+ZoKLLKr9VMXuCsw3RjWiv8ZpIOa0hxO79np7Ec8DDWALM0bDOaQ==" crossorigin="anonymous"></script>
    <script src="webflow.js" type="text/javascript"></script>
    <script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
<script>





var oldWidth = 0
function render(){


///// Bubble Chart

var bubblesvg = d3.select("#bubble"),
margin = {top: 35, left: 35, bottom: 0, right: 15},
element = bubblesvg.node();
bwidth = element.getBoundingClientRect().width - margin.left - margin.right,
bheight = element.getBoundingClientRect().height - margin.top - margin.bottom;


function bubbleChart() {
  // Constants for sizing

  // tooltip for mouseover functionality
  var tooltip = floatingTooltip('gates_tooltip', 240);

  // Locations to move bubbles towards, depending
  // on which view mode is selected.
  var center = { x: bwidth, y: bheight / 2 };



  // @v4 strength to apply to the position forces
  var forceStrength = 0.03;

  // These will be set in create_nodes and create_vis
  var svg = null;
  var bubbles = null;
  var nodes = [];

  // Charge function that is called for each node.
  // As part of the ManyBody force.
  // This is what creates the repulsion between nodes.
  //
  // Charge is proportional to the diameter of the
  // circle (which is stored in the radius attribute
  // of the circle's associated data.
  //
  // This is done to allow for accurate collision
  // detection with nodes of different sizes.
  //
  // Charge is negative because we want nodes to repel.
  // @v4 Before the charge was a stand-alone attribute
  //  of the force layout. Now we can use it as a separate force!
  function charge(d) {
    return -Math.pow(d.radius, 2.0) * forceStrength;
  }

  // Here we create a force layout and
  // @v4 We create a force simulation now and
  //  add forces to it.
  var simulation = d3.forceSimulation()
    .velocityDecay(0.2)
    .force('x', d3.forceX().strength(forceStrength).x(center.x))
    .force('y', d3.forceY().strength(forceStrength).y(center.y))
    .force('charge', d3.forceManyBody().strength(charge))
    .force('collide', d3.forceCollide(d => d.radius + 2).strength(1))
    .on('tick', ticked);

  // @v4 Force starts up automatically,
  //  which we don't want as there aren't any nodes yet.
  simulation.stop();

  // Nice looking colors - no reason to buck the trend
  // @v4 scales now have a flattened naming scheme
  var fillColor = d3.scaleOrdinal()
    .domain(["Government","Professional, Scientific, and Technical Services","Health Care and Social Assistance","Accommodation and Food Services","Finance and Insurance","Transportation and Warehousing","Administrative and Support and Waste Management and Remediation Services","Educational Services","Retail Trade","Other Services (except Public Administration)","Real Estate and Rental and Leasing","Wholesale Trade","Arts, Entertainment, and Recreation","Construction","Information","Management of Companies and Enterprises","Manufacturing","Agriculture, Forestry, Fishing and Hunting","Unclassified Industry","Utilities","Mining, Quarrying, and Oil and Gas Extraction"])
    .range(["#771155", "#AA4488", "#CC99BB", "#114477", "#4477AA", "#77AADD", "#117777", "#44AAAA", "#77CCCC", "#117744", "#44AA77", "#88CCAA", "#777711", "#AAAA44", "#DDDD77", "#774411", "#AA7744", "#DDAA77", "#771122", "#AA4455", "#DD7788"]);


  /*
   * This data manipulation function takes the raw data from
   * the CSV file and converts it into an array of node objects.
   * Each node will store data and visualization values to visualize
   * a bubble.
   *
   * rawData is expected to be an array of data objects, read in from
   * one of d3's loading functions like d3.csv.
   *
   * This function returns the new node array, with a node in that
   * array for each element in the rawData input.
   */
  function createNodes(rawData) {
    // Use the max total_amount in the data as the max in the scale's domain
    // note we have to ensure the total_amount is a number.
    var maxAmount = d3.max(rawData, function (d) { return +d.jobs; });

    // Sizes bubbles based on area.
    // @v4: new flattened scale names.
    var radiusScale = d3.scalePow()
      .exponent(0.5)
      .range([2, 60])
      .domain([0, maxAmount]);

    // Use map() to convert raw data into node data.
    // Checkout http://learnjsdata.com/ for more on
    // working with data.
    var myNodes = rawData.map(function (d) {
      return {
        id: d.id,
        name: d.industry,
        radius: radiusScale(+d.jobs),
        value: +d.jobs,
        group: d.group,
        x: Math.random() * bwidth*2,
        y: Math.random() * bheight
      };
    });

    // sort them to prevent occlusion of smaller nodes.
    myNodes.sort(function (a, b) { return b.value - a.value; });

    return myNodes;
  }

  /*
   * Main entry point to the bubble chart. This function is returned
   * by the parent closure. It prepares the rawData for visualization
   * and adds an svg element to the provided selector and starts the
   * visualization creation process.
   *
   * selector is expected to be a DOM element or CSS selector that
   * points to the parent element of the bubble chart. Inside this
   * element, the code will add the SVG continer for the visualization.
   *
   * rawData is expected to be an array of data objects as provided by
   * a d3 loading function like d3.csv.
   */
  var chart = function chart(selector, rawData ) {
    // convert raw data into nodes data
    nodes = createNodes(rawData);

    // Create a SVG element inside the provided selector
    // with desired size.


    // Bind nodes data to what will become DOM elements to represent them.
    bubbles = bubblesvg.selectAll('.bubble')
      .data(nodes, function (d) { return d.id; });

    // Create new circle elements each with class `bubble`.
    // There will be one circle.bubble for each object in the nodes array.
    // Initially, their radius (r attribute) will be 0.
    // @v4 Selections are immutable, so lets capture the
    //  enter selection to apply our transtition to below.
    var bubblesE = bubbles.enter().append('circle')
      .classed('bubble', true)
      .attr('r', 0)
      .attr('fill', function (d) { return fillColor(d.group); })
      .attr('stroke', function (d) { return d3.rgb(fillColor(d.group)).darker(); })
      .attr('stroke-width', 2)
      .on('mouseover', showDetail)
      .on('mouseout', hideDetail);

    // @v4 Merge the original empty selection and the enter selection
    bubbles = bubbles.merge(bubblesE);

    // Fancy transition to make bubbles appear, ending with the
    // correct radius
    bubbles.transition()
      .duration(2000)
      .attr('r', function (d) { return d.radius; });

    // Set the simulation's nodes to our newly created nodes array.
    // @v4 Once we set the nodes, the simulation will start running automatically!
    simulation.nodes(nodes);

    // Set initial layout to single group.
    groupBubbles();
  };

  /*
   * Callback function that is called after every tick of the
   * force simulation.
   * Here we do the acutal repositioning of the SVG circles
   * based on the current x and y values of their bound node data.
   * These x and y values are modified by the force simulation.
   */
  function ticked() {
    bubbles
      //.attr('cx', function (d) { return d.x; })
      .attr('cx', d => d.x)
      .attr('cy', function (d) { return d.y; });
  }

  /*
   * Provides a x value for each node to be used with the split by year
   * x force.
   */


  /*
   * Sets visualization in "single group mode".
   * The year labels are hidden and the force layout
   * tick function is set to move all nodes to the
   * center of the visualization.
   */
  function groupBubbles() {


    // @v4 Reset the 'x' force to draw the bubbles to the center.
    simulation.force('x', d3.forceX().strength(forceStrength).x(center.x));

    // @v4 We can reset the alpha value and restart the simulation
    simulation.alpha(1).restart();
  }


  /*
   * Sets visualization in "split by year mode".
   * The year labels are shown and the force layout
   * tick function is set to move nodes to the
   * yearCenter of their data's year.
   */


  /*
   * Hides Year title displays.
   */


  /*
   * Function called on mouseover to display the
   * details of a bubble in the tooltip.
   */
  function showDetail(d) {
    // change outline to indicate hover state.
    d3.select(this).attr('stroke', 'black');

    var content = '<span class="name">Industry: </span><span class="value">' +
                  d.name +
                  '</span><br/>' +
                  '<span class="name">Jobs: </span><span class="value">' +
                  addCommas(d.value) +
                  '</span><br/>' 
                ;

    tooltip.showTooltip(content, d3.event);
  }

  /*
   * Hides tooltip
   */
  function hideDetail(d) {
    // reset outline
    d3.select(this)
      .attr('stroke', d3.rgb(fillColor(d.group)).darker());

    tooltip.hideTooltip();
  }

  /*
   * Externally accessible function (this is attached to the
   * returned chart function). Allows the visualization to toggle
   * between "single group" and "split by year" modes.
   *
   * displayName is expected to be a string and either 'year' or 'all'.
   */
  chart.toggleDisplay = function (displayName) {
    if (displayName === 'year') {
      splitBubbles();
    } else {
      groupBubbles();
    }
  };


  // return the chart function from closure.
  return chart;
}

/*
 * Below is the initialization code as well as some helper functions
 * to create a new bubble chart instance, load the data, and display it.
 */

var myBubbleChart = bubbleChart();

/*
 * Function called once data is loaded from CSV.
 * Calls bubble chart function to display inside #vis div.
 */
function display(error, data ) {
  if (error) {
    console.log(error);
  }
  myBubbleChart('#bubble', data);
}

/*
 * Sets up the layout buttons to allow for toggling between view modes.
 */
function setupButtons() {
  d3.select('#toolbar')
    .selectAll('.button')
    .on('click', function () {
      // Remove active class from all buttons
      d3.selectAll('.button').classed('active', false);
      // Find the button just clicked
      var button = d3.select(this);

      // Set it as the active button
      button.classed('active', true);

      // Get the id of the button
      var buttonId = button.attr('id');

      // Toggle the bubble chart based on
      // the currently clicked button.
      myBubbleChart.toggleDisplay(buttonId);
    });
}

/*
 * Helper function to convert a number into a string
 * and add commas to it to improve presentation.
 */
function addCommas(nStr) {
  nStr += '';
  var x = nStr.split('.');
  var x1 = x[0];
  var x2 = x.length > 1 ? '.' + x[1] : '';
  var rgx = /(\d+)(\d{3})/;
  while (rgx.test(x1)) {
    x1 = x1.replace(rgx, '$1' + ',' + '$2');
  }

  return x1 + x2;
}


d3.csv("industries.csv", function(error, data) {
      if (error) throw error;
display(null,data)
    });


// setup the buttons.
setupButtons();


/*
 * Creates tooltip with provided id that
 * floats on top of visualization.
 * Most styling is expected to come from CSS
 * so check out bubble_chart.css for more details.
 */
function floatingTooltip(tooltipId, bwidth) {
  // Local variable to hold tooltip div for
  // manipulation in other functions.
  var tt = d3.select('body')
    .append('div')
    .attr('class', 'tooltip')
    .attr('id', tooltipId)
    .style('pointer-events', 'none');

  // Set a width if it is provided.
  if (bwidth) {
    tt.style('width', bwidth);
  }

  // Initially it is hidden.
  hideTooltip();

  /*
   * Display tooltip with provided content.
   *
   * content is expected to be HTML string.
   *
   * event is d3.event for positioning.
   */
  function showTooltip(content, event) {
    tt.style('opacity', 1.0)
      .html(content);

    updatePosition(event);
  }

  /*
   * Hide the tooltip div.
   */
  function hideTooltip() {
    tt.style('opacity', 0.0);
  }

  /*
   * Figure out where to place the tooltip
   * based on d3 mouse event.
   */
  function updatePosition(event) {
    var xOffset = 20;
    var yOffset = 10;

    var ttw = tt.style('width');
    var tth = tt.style('height');

    var wscrY = window.scrollY;
    var wscrX = window.scrollX;

    var curX = (document.all) ? event.clientX + wscrX : event.pageX;
    var curY = (document.all) ? event.clientY + wscrY : event.pageY;
    var ttleft = ((curX - wscrX + xOffset * 2 + ttw) > window.innerWidth) ?
                 curX - ttw - xOffset * 2 : curX + xOffset;

    if (ttleft < wscrX + xOffset) {
      ttleft = wscrX + xOffset;
    }

    var tttop = ((curY - wscrY + yOffset * 2 + tth) > window.innerHeight) ?
                curY - tth - yOffset * 2 : curY + yOffset;

    if (tttop < wscrY + yOffset) {
      tttop = curY + yOffset;
    }

    tt
      .style('top', tttop + 'px')
      .style('left', ttleft + 'px' );
  }

  return {
    showTooltip: showTooltip,
    hideTooltip: hideTooltip,
    updatePosition: updatePosition
  };
}

/*
d3.csv("data.csv", function(d){
  return{
    name: d.name,
    long: +d.long,
    lat: +d.lat,
    status: d.status,
    category: d.category,
    category2: d.category2,
    essential: d.essential_flag,
    chain: d.chain_flag,
    corridor: d.corridor,
    id: +d.id,
    sidewalk: +d.sidewalk_width,
    histogram_column: +d.histogram_column,
    image: d.image
  };
}, function(error, rows){
if (error) throw error;


occs = JSON.parse(JSON.stringify(rows));

rows.forEach(function(d) { 
    d.total = Math.random() * 10;
    d.x = Math.random() * 900;
    d.y = Math.random() * 800
  });

occs.forEach(function(d) { 
    d.total = Math.random() * 10;
    d.x = (bwidth/4)*3 
    d.y = bheight/2
  });



var defs = bubblesvg.append('defs');
var filter = defs.append('filter').attr('id','gooey');
filter.append('feGaussianBlur')
  .attr('in','SourceGraphic')
  .attr('stdDeviation', "10")
  .attr('result','blur');
filter.append('feColorMatrix')
  .attr("class", "blurValues")
  .attr('in','blur')
  .attr('mode','matrix')
  .attr('values', '1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 0 -6')
  .attr('result','gooey');
filter.append("feBlend")
  .attr("in", "SourceGraphic")
  .attr("in2", "gooey")
  .attr("operator", "atop");

var center = { x: bwidth / 2, y: bheight / 2 };

var forceStrength = 0.03;

function charge(d) {
    return -Math.pow(d.radius, 2.0) * forceStrength;
  }

var simulation = d3.forceSimulation()
    .velocityDecay(0.2)
    .force('x', d3.forceX().strength(forceStrength).x(center.x))
    .force('y', d3.forceY().strength(forceStrength).y(center.y))
    .force('charge', d3.forceManyBody().strength(charge))
    .on('tick', ticked);

simulation.stop();

function groupBubbles() {
    // @v4 Reset the 'x' force to draw the bubbles to the center.
    simulation.force('x', d3.forceX().strength(forceStrength).x(center.x));

    // @v4 We can reset the alpha value and restart the simulation
    simulation.alpha(1).restart();
  }

function createNodes(rawData) {
    // Use the max total_amount in the data as the max in the scale's domain
    // note we have to ensure the total_amount is a number.
    var maxAmount = d3.max(rawData, function (d) { return +d.total; });

    // Sizes bubbles based on area.
    // @v4: new flattened scale names.
    var radiusScale = d3.scalePow()
      .exponent(0.5)
      .range([2, 85])
      .domain([0, maxAmount]);

    // Use map() to convert raw data into node data.
    // Checkout http://learnjsdata.com/ for more on
    // working with data.
    var myNodes = rawData.map(function (d) {
      return {
        id: d.id,
        radius: radiusScale(+d.total),
        value: +d.total,
        name: d.name,
        org: d.corridor,
        group: d.category,
        x: Math.random() * 900,
        y: Math.random() * 800
      };
    });

    // sort them to prevent occlusion of smaller nodes.
    myNodes.sort(function (a, b) { return b.value - a.value; });

    return myNodes;
  }

  nodes = createNodes(rows);

var circleGroup = bubblesvg.append("g")
  .style("filter", "url(#gooey)");


bubbles = circleGroup.selectAll('.bubble')
      .data(nodes, function (d) { return d.id; });

var bubblesE = bubbles.enter().append('circle')
      .classed('bubble', true)
      .attr('r', 0)
      .attr('fill', function (d) { return categoryColors[d.category][0]; })
      .attr('stroke', function (d) { return d3.rgb(categoryColors[d.category][0]).darker(); })
      .attr('stroke-width', 2)
      .on('mouseover', showDetail)
      .on('mouseout', hideDetail);

 bubbles = bubbles.merge(bubblesE);

bubbles.transition()
      .duration(2000)
      .attr('r', function (d) { return d.radius; });

simulation.nodes(nodes);

/*var occcircles = bubblesvg
      .selectAll("OccCircles")
      .data(occs)
      .enter()
      .append("circle")
      .filter(function (d) { return d.status === "Occupied"; })
      .each(function (d, i){
              var $this = d3.select(this)
              
              $this
              .attr("r", function(d){ return d.radius})
              .attr("class", "circle")
              .attr("id", function(d){ return "Circle" + String(d.id)})
              .attr("stroke", "#003E7A")
              .attr("stroke-width", 0)
              .attr("fill-opacity", 1)
              .style("fill", function(d){ return categoryColors[d.category][0]})}) */











  var r = 40



////DASHBOARD CHARTS
// Parse the month variable

var vis = d3.select("#rentvis")


var cmargin = {top: window.innerHeight*.04, right: window.innerWidth*.07, bottom: window.innerHeight*.04, left: window.innerWidth*.05};

cwidth = (window.innerWidth*.8) - cmargin.left - cmargin.right,
cheight = (window.innerHeight*.4) - cmargin.top - cmargin.bottom;

var parseMonth = d3.timeParse("%b");
var formatMonth = d3.timeFormat("%b");

var formatYear = d3.timeFormat("%Y");
var parseYear = d3.timeParse("%Y");




// Create the svg canvas in the "graph" div
var vis = d3.select("#rentvis")
        .append("svg")
        .style("width", cwidth + cmargin.left + cmargin.right + "px")
        .style("height", cheight + cmargin.top + cmargin.bottom + "px")
        .attr("width", cwidth + cmargin.left + cmargin.right)
        .attr("height", cheight + cmargin.top + cmargin.bottom)
        .append("g")
        .attr("transform","translate(" + cmargin.left + "," + cmargin.top + ")")
        .attr("class", "svg");

var formats = {'Rent':d3.format("($.0f"),'Absorption':d3.format("(.1s"),'Vacancy':d3.format(".0%")}
var labels = {'Rent':"Gross Rent PSF",'Absorption':"Absorption",'Vacancy':"Vacancy Rate"}
const colors = {'Miami':'#00b5cc','NY':'#eb529d','SF':'#eb529d','Chicago':'#eb529d'}



// Import the CSV data
d3.csv("https://docs.google.com/spreadsheets/d/1LMADV7lzfx1rC6AzkrUp8uwe5XuXR8sd3KDeashPmB8/gviz/tq?tqx=out:csv&gid=285225202", function(error, data) {
  if (error) throw error;

  
   // Format the data
  data.forEach(function(d) {
      d.Quarter = d.Quarter;
      d.Value = +d.Value;
      d.Metric = d.Metric;
      d.Geography = d.Geography;
      //d.Year = formatYear(parseYear(+d.Year));
  });



  // Set the ranges
var x = d3.scalePoint().domain(data.map(function(d){ return d.Quarter; })).range([0, cwidth]);
var y = d3.scaleLinear().range([cheight, 0]);


// Define the line
var valueLine = d3.line()
    .x(function(d) { return x(d.Quarter); })
    .y(function(d) { return y(+d.Value); })
    .curve(d3.curveMonotoneX)


  var nest = d3.nest()
        .key(function(d){
            return d.Metric;
        })
        .rollup(function(leaves){
            var max = d3.max(leaves, function(d){
                return d.Value
            })
            var min = d3.min(leaves, function(d){
                return d.Value
            })
            var year = d3.nest().key(function(d){
                return d.Geography
            })
            .entries(leaves);
            return {min:min, max:max, year:year};
            })
      .entries(data)

  // Scale the range of the data
  //x.domain(d3.extent(data, function(d) { return d.Quarter; }));
  y.domain([d3.min(data, function(d) { return d.Value; }), d3.max(data, function(d) { return d.Value; })]);
  // Set up the x axis
  var xaxis = vis.append("g")
       .attr("transform", "translate(0," + cheight + ")")
       .attr("class", "x axis")
       .call(d3.axisBottom(x)
          .tickValues(x.domain().filter(function(d,i){ return !(i%4)}))
          );



  // Create 1st dropdown
    var fruitMenu = d3.select("#metric")

    fruitMenu
        .append("select")
        .attr("id","standard-select")
        .selectAll("option")
        .data(nest)
        .enter()
        .append("option")
        .attr("value", function(d){
            return d.key;
        })
        .text(function(d){
            return d.key;
        })


    // Create 2nd dropdown
 /*   var yearMenu = d3.select("#geography")

    yearMenu
        .data(nest)
        .append("select")
        .attr("id","standard-select")
        .selectAll("option")
        .data(function(d) { return d.value.year; })
        .enter()
        .append("option")
        .attr("value", function(d){
            return d.key;
        })
        .text(function(d){
            return d.key;
        })*/

 var tip = d3.select("body").append("div") 
    .attr("class", "tooltip2")
    .style("position","absolute")       
    .style("opacity", 0);
  
    // Function to create the initial graph
    var initialGraph = function(fruit){

        // Filter the data to include only fruit of interest
        var selectFruit = nest.filter(function(d){
                return d.key == fruit;
              })

        var selectFruitGroups = vis.selectAll(".fruitGroups")
            .data(selectFruit, function(d){
              return d ? d.key : this.key;
            })
            .enter()
            .append("g")
            .attr("class", "fruitGroups")
            .each(function(d){
                y.domain([d3.min([d.value.min,0]), d.value.max])
            });

        var initialPath = selectFruitGroups.selectAll(".line")
            .data(function(d) { return d.value.year; })
            .enter()
            .append("path")

        initialPath
            .attr("d", function(d){
                return valueLine(d.values)
            })
            .attr("class", "line")

        selectFruit[0].value.year.forEach(function(item,index){
          console.log(item.values)
          selectFruitGroups.append("g").selectAll(".circle" + item.key)
        .data(item.values)
        .enter()
        .append("circle")
        .attr("r", 10)
        .attr("cx", function(dd){return x(dd.Quarter)})
        .attr("cy", function(dd){return y(dd.Value)})
        .attr("class","circle" + item.key)
        .style('opacity', 1e-6) //1e-6
        .on("mouseover", function(d) {    
            tip      
                .transition()   
                .duration(200)
                .style("opacity", 1);    
            tip .html(d.Geography + "<br/>"  + d.Value)  
                .style("left", (d3.event.pageX) + "px")   
                .style("top", (d3.event.pageY - 28) + "px");  
            })          
        .on("mouseout", function(d) {   
            tip.transition()    
                .duration(500)   
                .style("opacity", 0); 
        });


        vis.append("text")
          .text(item.key)
          .attr("class",item.key+"_label")
          .attr("x",x(d3.max(x.domain())) + 10)
          .attr("y",y(item.values[item.values.length-1 ].Value))
          .attr("opacity",1)
          .attr("font-family", "Nunito")
          .style("fill", colors[item.key])
          .attr("font-weight",700)
          .attr("font-size", "20")
          
      vis.append("text")
          .text(formats["Rent"](item.values[item.values.length-1 ].Value))
          .attr("class",item.key+"_label2")
          .attr("x",x(d3.max(x.domain())) + 10)
          .attr("y",y(item.values[item.values.length-1 ].Value)+20)
          .attr("opacity",1)
          .attr("font-family", "Nunito")
          .style("fill", colors[item.key])
          .attr("font-weight",700)
          .attr("font-size", "17")      


        }

          


        )



          // Add the Y Axis
           var yaxis = vis.append("g")
               .attr("class", "y axis")
               .call(d3.axisLeft(y)
                  .ticks(5)
                  .tickFormat(formats["Rent"])
                  .tickSizeInner(0)
                  .tickPadding(6)
                  .tickSize(0, 0));
          
          // Add a label to the y axis
          vis.append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", 0 - 60)
                .attr("x", 0 - (cheight / 2))
                .attr("dy", "1em")
                .style("text-anchor", "middle")
                .text("Gross Rent PSF")
                .attr("class", "y axis label")
                .attr("id", "clabel")
                .attr("font-family", "Nunito")
                .style("fill", "#fff")
                .attr("font-weight",700)
                .attr("font-size", "17") ;

    }

    // Create initial graph
    initialGraph("Rent")



    // Update the data
    var updateGraph = function(fruit){

        // Filter the data to include only fruit of interest
        var selectFruit = nest.filter(function(d){
                return d.key == fruit;
              })

        // Select all of the grouped elements and update the data
        var selectFruitGroups = vis.selectAll(".fruitGroups")
            .data(selectFruit)
            .each(function(d){
                y.domain([d3.min([d.value.min,0]), d.value.max])
            });

            // Select all the lines and transition to new positions
            selectFruitGroups.selectAll("path.line")
               .data(function(d) { return d.value.year; }, 
                    function(d){ return d.key; })
               .transition()
                  .duration(1000)
                  .attr("d", function(d){
                    return valueLine(d.values)
                  })

            selectFruit[0].value.year.forEach(function(item,index){
              selectFruitGroups.selectAll("circle.circle" + item.key)
            .data(item.values)
            .transition()
            .duration(1000)
            .attr("cx", function(dd){return x(dd.Quarter)})
            .attr("cy", function(dd){return y(dd.Value)})

            d3.select("."+item.key+"_label")
            .transition()
            .duration(1500)
            .attr("y",y(item.values[item.values.length-1 ].Value))

          d3.select("."+item.key+"_label2")
            .transition()
            .duration(1500)
            .text(formats[fruit](item.values[item.values.length-1 ].Value))
            .attr("y",y(item.values[item.values.length-1 ].Value)+20)
            })

        // Update the Y-axis
            d3.select(".y")
                    .transition()
                    .duration(1500)
                    .call(d3.axisLeft(y)
                      .ticks(5)
                      .tickFormat(formats[fruit])
                      .tickSizeInner(0)
                      .tickPadding(6)
                      .tickSize(0, 0));
            
            d3.select("#clabel")
              .text(labels[fruit])

           




    }


    // Run update function when dropdown selection changes
    fruitMenu.on('change', function(){

        // Find which fruit was selected from the dropdown
        var selectedFruit = d3.select(this)
            .select("select")
            .property("value")

        // Run update function with the selected fruit
        updateGraph(selectedFruit)


    });


    // Change color of selected line when year dropdown changes
    yearMenu.on('change', function(){

        // Find which year was selected
        var selectedYear = d3.select(this)
            .select("select")
            .property("value")

        // Change the class of the matching line to "selected"
        var selLine = vis.selectAll(".line")
              // de-select all the lines
              .classed("selected", false)
              .filter(function(d) {
                  return d.key === selectedYear
              })
              // Set class to selected for matching line
              .classed("selected", true)
              .raise()
    })


})




















//Read Data, convert numerical categories into floats
//Create the initial visualisation

/*
d3.csv("https://docs.google.com/spreadsheets/d/1LMADV7lzfx1rC6AzkrUp8uwe5XuXR8sd3KDeashPmB8/gviz/tq?tqx=out:csv&gid=1356831804", function(d){
  return{
    location: d.location,
    class: d.class,
    year: +d.year,
    period: d.period,
    rent: +d.rent,
    vacancy: +d.vacancy,
    absorption: d.absorption,
  };
}, function(error, rows){
if (error) throw error;

  //  setTimeout(drawInitial(), 100)
//})


rows =  rows.filter(f => f.year >= 2015)

const colors = {'Miami':['#00b5cc'],'NY':['#eb529d'],'SF':['#eb529d'],'Chicago':['#eb529d']}

nested = d3.nest().key(function(d){return d.location}).entries(rows)
nestkeys = nested.map(function(d){return d.key;})



var vis = d3.select("#rentvis")
var cmargin = {top: 200, right: 50, bottom: 200, left: 60};
element = vis.node();
cwidth = element.getBoundingClientRect().width - cmargin.left - cmargin.right,
cheight = element.getBoundingClientRect().height - cmargin.top - cmargin.bottom;

rentsvg = d3
  .select("#rentvis")
    .attr("width", cwidth + cmargin.left + cmargin.right - 20)
    .attr("height", cheight + cmargin.top + cmargin.bottom)

    const rentchart = rentsvg
    .append("g")
    .attr("transform", `translate(${cmargin.left},${cmargin.top})`);

const rentgrp = rentchart
  .append("g")
  .attr("transform", `translate(-${cmargin.left},0)`);


rentgrp.append("text")
    .text("Gross Rent PSF")
    .attr("class","charttitle")
    .attr("x",-30)
    .attr("y",-30)
    .attr("transform", `translate(${cmargin.left},0)`)
    .attr("opacity",1)
    .attr("font-family", "Nunito")
    .attr("font-weight",700)
    .attr("font-size", "25")

// Create scales
const RentyScale = d3
  .scaleLinear()
  .range([height, 0])
  .domain([0, d3.max(rows, d => d.rent + 5)]);
const RentxScale = d3
  .scalePoint()
  .range([3, width-40])
  .domain(rows.map(function(d){ return d.period; }));

const Rentline = d3
  .line()
  .x(d => RentxScale(d.period))
  .y(d => RentyScale(d.rent))
  .curve(d3.curveBasis);


nestkeys.forEach(function(d){

    data =  rows.filter(f => f.location == d)
    


    path = rentgrp
      .append("path")
      .attr("class",d + "_rentpath")
      .attr("d", Rentline(data))
      .attr("transform", `translate(${cmargin.left},0)`)
      .attr("fill", "none")
      .attr("stroke", colors[d][0])
      .attr("stroke-linejoin", "round")
      .attr("stroke-linecap", "round")
      .attr("stroke-width", 5)

    pathLength = path.node().getTotalLength();

    path
  .attr("stroke-dashoffset", pathLength)
  .attr("stroke-dasharray", pathLength)


rentgrp.append("text")
    .text(d)
    .attr("class",d+"_rentlabel")
    .attr("x",RentxScale(d3.max(RentxScale.domain())) + 10)
    .attr("y",RentyScale(data[data.length-1 ].rent))
    .attr("transform", `translate(${cmargin.left},0)`)
    .attr("opacity",0)
    .attr("font-family", "Nunito")
    .style("fill", colors[d][0])
    .attr("font-weight",700)
    .attr("font-size", "20")

rentgrp.append("text")
    .text(d3.format("($.0f")(data[data.length-1 ].rent))
    .attr("class",d+"_rentlabelrent")
    .attr("x",RentxScale(d3.max(RentxScale.domain())) + 10)
    .attr("y",RentyScale(data[data.length-1 ].rent)+20)
    .attr("transform", `translate(${cmargin.left},0)`)
    .attr("opacity",0)
    .attr("font-family", "Nunito")
    .style("fill", colors[d][0])
    .attr("font-weight",700)
    .attr("font-size", "17")


})


// Add the X Axis
rentchart
  .append("g")
  .attr("class", "axis")
  .attr("transform", `translate(0,${cheight})`)
  .call(d3.axisBottom(RentxScale).tickSizeOuter(0)
.tickValues(RentxScale.domain().filter(function(d,i){ return !(i%4)})))
  .style('fill-opacity', d => d === 0 ? 0.0 : 1.0);
// Add the Y Axis
rentchart
  .append("g")
  .attr("class", "axis")
  .attr("transform", `translate(0, 0)`)
  .call(d3.axisLeft(RentyScale).tickSizeOuter(0)
    .tickFormat(d3.format("($.0f")));



/////VACANCY
vacancysvg = d3
  .select("#vacancyvis")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)

    const vacancychart = vacancysvg
    .append("g")
    .attr("transform", `translate(${margin.left},${margin.top})`);

const vacancygrp = vacancychart
  .append("g")
  .attr("transform", `translate(-${margin.left},0)`);

vacancygrp.append("text")
    .text("Vacancy Rate")
    .attr("class","charttitle")
    .attr("x",-30)
    .attr("y",-30)
    .attr("transform", `translate(${margin.left},0)`)
    .attr("opacity",1)
    .attr("font-family", "Nunito")
    .attr("font-weight",700)
    .attr("font-size", "25")

// Create scales
const vacancyyScale = d3
  .scaleLinear()
  .range([height, 0])
  .domain([0, d3.max(rows, d => d.vacancy + .02)]);
const vacancyxScale = d3
  .scalePoint()
  .range([3, width-40])
  .domain(rows.map(function(d){ return d.period; }));

const vacancyline = d3
  .line()
  .x(d => vacancyxScale(d.period))
  .y(d => vacancyyScale(d.vacancy))
  .curve(d3.curveBasis);

nestkeys.forEach(function(d){

    data =  rows.filter(f => f.location == d)
    
    path = vacancygrp
      .append("path")
      .attr("class",d + "_vacancypath")
      .attr("d", vacancyline(data))
      .attr("transform", `translate(${margin.left},0)`)
      .attr("fill", "none")
      .attr("stroke", colors[d][0])
      .attr("stroke-linejoin", "round")
      .attr("stroke-linecap", "round")
      .attr("stroke-width", 5)

    pathLength = path.node().getTotalLength();

    path
  .attr("stroke-dashoffset", pathLength)
  .attr("stroke-dasharray", pathLength)

  vacancygrp.append("text")
    .text(d)
    .attr("class",d+"_vacancylabel")
    .attr("x",vacancyxScale(d3.max(vacancyxScale.domain())) + 5)
    .attr("y",vacancyyScale(data[data.length-1 ].vacancy))
    .attr("transform", `translate(${margin.left},0)`)
    .attr("font-family", "Nunito")
    .style("fill", colors[d][0])
    .attr("font-weight",700)
    .attr("font-size", "20")
    .attr("opacity",0)

    vacancygrp.append("text")
    .text(d3.format(".0%")(data[data.length-1 ].vacancy))
    .attr("class",d+"_vacancylabelvacancy")
    .attr("x",vacancyxScale(d3.max(vacancyxScale.domain())) + 10)
    .attr("y",vacancyyScale(data[data.length-1 ].vacancy)+20)
    .attr("transform", `translate(${margin.left},0)`)
    .attr("opacity",0)
    .attr("font-family", "Nunito")
    .style("fill", colors[d][0])
    .attr("font-weight",700)
    .attr("font-size", "17")
    .attr("opacity",0)


})

// Add the X Axis
vacancychart
  .append("g")
    .attr("class", "axis")
  .attr("transform", `translate(0,${height})`)
  .call(d3.axisBottom(vacancyxScale)
.tickValues(vacancyxScale.domain().filter(function(d,i){ return !(i%4)})));
// Add the Y Axis
vacancychart
  .append("g")
    .attr("class", "axis")
  .attr("transform", `translate(0, 0)`)
  .call(d3.axisLeft(vacancyyScale)
    .tickFormat(d3.format(".0%")));



//////Absorption
absvg = d3
  .select("#absorbvis")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)

    const abchart = absvg
    .append("g")
    .attr("transform", `translate(${margin.left},${margin.top})`);

const abgrp = abchart
  .append("g")
  .attr("transform", `translate(-${margin.left},0)`);

abgrp.append("text")
    .text("Net Absorption")
    .attr("class","charttitle")
    .attr("x",-30)
    .attr("y",-30)
    .attr("transform", `translate(${margin.left},0)`)
    .attr("opacity",1)
    .attr("font-family", "Nunito")
    .attr("font-weight",700)
    .attr("font-size", "25")

// Create scales
const abyScale = d3
  .scaleLinear()
  .range([height, 0])
  .domain([d3.min(rows, d => +d.absorption + .02), d3.max(rows, d => +d.absorption + .02)]);
const abxScale = d3
  .scalePoint()
  .range([3, width-40])
  .domain(rows.map(function(d){ return d.period; }));

const abline = d3
  .line()
  .x(d => abxScale(d.period))
  .y(d => abyScale(+d.absorption))
  .curve(d3.curveBasis);

nestkeys.forEach(function(d){

    data =  rows.filter(f => f.location == d)
    
  
    path = abgrp
      .append("path")
      .attr("class",d + "_abpath")
      .attr("d", abline(data))
      .attr("transform", `translate(${margin.left},0)`)
      .attr("fill", "none")
      .attr("stroke", colors[d][0])
      .attr("stroke-linejoin", "round")
      .attr("stroke-linecap", "round")
      .attr("stroke-width", 5)

    pathLength = path.node().getTotalLength();

    path
  .attr("stroke-dashoffset", pathLength)
  .attr("stroke-dasharray", pathLength)

  abgrp.append("text")
    .text(d)
    .attr("class",d+"_ablabel")
    .attr("x",abxScale(d3.max(abxScale.domain())) + 5)
    .attr("y",abyScale(+data[data.length-1 ].absorption))
    .attr("transform", `translate(${margin.left},0)`)
    .attr("opacity",0)
    .attr("font-family", "Nunito")
    .style("fill", colors[d][0])
    .attr("font-weight",700)
    .attr("font-size", "20")

  abgrp.append("text")
    .text(d3.format("(.0f")(data[data.length-1 ].absorption))
    .attr("class",d+"_ablabelab")
    .attr("x",abxScale(d3.max(abxScale.domain())) + 10)
    .attr("y",abyScale(data[data.length-1 ].absorption)+20)
    .attr("transform", `translate(${margin.left},0)`)
    .attr("opacity",0)
    .attr("font-family", "Nunito")
    .style("fill", colors[d][0])
    .attr("font-weight",700)
    .attr("font-size", "17")


})

// Add the X Axis
abchart
  .append("g")
    .attr("class", "axis")
  .attr("transform", `translate(0,${height})`)
  .call(d3.axisBottom(abxScale)
.tickValues(abxScale.domain().filter(function(d,i){ return !(i%4)})));
// Add the Y Axis
abchart
  .append("g")
    .attr("class", "axis")
  .attr("transform", `translate(0, 0)`)
  .call(d3.axisLeft(abyScale));


d3.selectAll(".tick")
    .filter(function (d) { return d === 0;  })
    .remove();



////Annotations
const annotations = [
        {
          note: { 
            title: "COVID-19", 
            lineType: "none", 
            align: "middle",
            wrap: 150 //custom text wrapping
          },
          subject: {
            height: height,
            width: RentxScale(RentxScale.domain()[43]) - RentxScale(RentxScale.domain()[41])
          },
          type: d3.annotationCalloutRect,
          y: 1,
          disable: ["connector"], // doesn't draw the connector
          //can pass "subject" "note" and "connector" as valid options
          dx: (RentxScale(RentxScale.domain()[43]) - RentxScale(RentxScale.domain()[41]))/2,
          data: { x: RentxScale.domain()[41]}
        }]


const type = d3.annotationCustomType(
        d3.annotationBadge, 
        {"subject":{"radius": 10 }}
      )

const makeAnnotations = d3.annotation()
        .type(type)
        .accessors({ 
          x: function(d){ return RentxScale(d.x)},
          y: function(d){ return RentyScale(d.y) }
        })
        .annotations(annotations)

      rentchart
        .append("g")
        .attr("class", "annotation-group")
        .call(makeAnnotations)



const vacannotations = [
        {
          note: { 
            title: "COVID-19", 
            lineType: "none", 
            align: "middle",
            wrap: 150 //custom text wrapping
          },
          subject: {
            height: height,
            width: vacancyxScale(vacancyxScale.domain()[43]) - vacancyxScale(vacancyxScale.domain()[41])
          },
          type: d3.annotationCalloutRect,
          y: 1,
          disable: ["connector"], // doesn't draw the connector
          //can pass "subject" "note" and "connector" as valid options
          dx: (vacancyxScale(vacancyxScale.domain()[43]) - vacancyxScale(vacancyxScale.domain()[41]))/2,
          data: { x: vacancyxScale.domain()[41]}
        }]


const makevacAnnotations = d3.annotation()
        .type(type)
        .accessors({ 
          x: function(d){ return vacancyxScale(d.x)},
          y: function(d){ return vacancyScale(d.y) }
        })
        .annotations(vacannotations)

      vacancychart
        .append("g")
        .attr("class", "annotation-group")
        .call(makevacAnnotations)

const abannotations = [
        {
          note: { 
            title: "COVID-19", 
            lineType: "none", 
            align: "middle",
            wrap: 150 //custom text wrapping
          },
          subject: {
            height: height,
            width: abxScale(abxScale.domain()[43]) - abxScale(abxScale.domain()[41])
          },
          type: d3.annotationCalloutRect,
          y: 1,
          disable: ["connector"], // doesn't draw the connector
          //can pass "subject" "note" and "connector" as valid options
          dx: (abxScale(abxScale.domain()[43]) - abxScale(abxScale.domain()[41]))/2,
          data: { x: abxScale.domain()[41]}
        }]


const makeabAnnotations = d3.annotation()
        .type(type)
        .accessors({ 
          x: function(d){ return abxScale(d.x)},
          y: function(d){ return abScale(d.y) }
        })
        .annotations(abannotations)

      abchart
        .append("g")
        .attr("class", "annotation-group")
        .call(makeabAnnotations)
*/
// Tooltip

/*
var bisect = d3.bisector(function(d) { return d.period; }).left;

var tooltip = d3.select(".tab04_content.w-tab-content").append("div")
    .attr("class", "tooltip")
    .style("display", "none");

var focus = rentgrp.append("g")
            .attr("class", "focus")
            .style("display", "none");

focus.append("circle")
    .attr("r", 5);

var tooltipDate = tooltip.append("div")
    .attr("class", "tooltip-date");

var tooltipLikes = tooltip.append("div");
tooltipLikes.append("span")
    .attr("class", "tooltip-title")
    .text("Gross Rent PSF: ");

var tooltipLikesValue = tooltipLikes.append("span")
    .attr("class", "tooltip-likes");

rentchart.append("rect")
    .attr("class", "ttoverlay")
    .attr("width", width)
    .attr("height", height)
    .on("mouseover", function() { focus.style("display", null); tooltip.style("display", null);  })
    .on("mouseout", function() { focus.style("display", "none"); tooltip.style("display", "none"); })
    .on("mousemove", mousemove);

function mousemove() {
    var xPos = d3.mouse(this)[0];
    var domain = RentxScale.domain();
    var range = RentxScale.range();
    var rangePoints = d3.range(range[0], range[1], RentxScale.step());

    var x0 = domain[d3.bisect(rangePoints, xPos) ];
        i = bisect(rows, x0, 0),
        d0 = rows[i - 1],
        d1 = rows[i],
        d = x0 - d0.period > d1.period - x0 ? d1 : d0;
    focus.attr("transform", "translate(" + (RentxScale(d.period) + margin.left) + "," + RentyScale(d.rent) + ")");
    tooltip.attr("style", "left:" + (RentxScale(d.period) + 64) + "px;top:" + RentyScale(d.rent) + "px;");
    tooltip.select(".tooltip-date").text(d.period);
    tooltip.select(".tooltip-likes").text(d3.format("($.2f")(d.rent));

}


});
*/



function draw1(){

}
function draw2(){

/*
  function transitionGoo(duration) {
      d3.selectAll(".blurValues")
        .transition().duration(duration)
        .attrTween("values", function() {
          return d3.interpolateString("1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 18 -6", 
                          "1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 0 -6"); 
        }); 
    }

  simulation.stop()

  transitionGoo(3000)

  d3.selectAll('.circle')
       .transition()
      .ease(d3.easeSin)
      .duration(5000)
            .attr("cx", function(d) { return d3.select("#Circle" + String(d.id)).attr("cx"); })
            .attr("cy", function(d) { return d3.select("#Circle" + String(d.id)).attr("cy"); });

  
d3.select(".Miami_rentpath")
    .transition()
  .ease(d3.easeSin)
  .duration(5000)
  .attr("stroke-dashoffset", 0);

d3.select(".Miami_rentlabel")
    .transition()
    .delay(4000)
  .duration(500)
  .attr("opacity", 1);

d3.select(".Miami_rentlabelrent")
    .transition()
    .delay(4000)
  .duration(500)
  .attr("opacity", 1);

*/
}

function draw3(){
/*
d3.select(".NY_rentpath")
    .transition()
  .ease(d3.easeSin)
  .duration(5000)
  .attr("stroke-dashoffset", 0);

d3.select(".Chicago_rentpath")
    .transition()
  .ease(d3.easeSin)
  .duration(5000)
  .attr("stroke-dashoffset", 0);

d3.select(".SF_rentpath")
    .transition()
  .ease(d3.easeSin)
  .duration(5000)
  .attr("stroke-dashoffset", 0);

d3.select(".NY_rentlabel")
    .transition()
      .transition()
    .delay(4000)
  .duration(500)
  .attr("opacity", 1);

d3.select(".SF_rentlabel")
    .transition()
      .transition()
    .delay(4000)
  .duration(500)
  .attr("opacity", 1);

d3.select(".Chicago_rentlabel")
    .transition()
      .transition()
    .delay(4000)
  .duration(500)
  .attr("opacity", 1);

d3.select(".NY_rentlabelrent")
    .transition()
      .transition()
    .delay(4000)
  .duration(500)
  .attr("opacity", 1);

d3.select(".SF_rentlabelrent")
    .transition()
      .transition()
    .delay(4000)
  .duration(500)
  .attr("opacity", 1);

d3.select(".Chicago_rentlabelrent")
    .transition()
      .transition()
    .delay(4000)
  .duration(500)
  .attr("opacity", 1);
*/

}

function draw4(){
/*
document.getElementById('vacancy').click();

d3.select(".Miami_vacancypath")
    .transition()
  .ease(d3.easeSin)
  .duration(5000)
  .attr("stroke-dashoffset", 0);

d3.select(".Miami_vacancylabel")
    .transition()
    .delay(4000)
  .duration(500)
  .attr("opacity", 1);

d3.select(".Miami_vacancylabelvacancy")
    .transition()
    .delay(4000)
  .duration(500)
  .attr("opacity", 1);
*/
}



function draw5(){
 
 /*
d3.select(".NY_vacancypath")
    .transition()
  .ease(d3.easeSin)
  .duration(5000)
  .attr("stroke-dashoffset", 0);

d3.select(".Chicago_vacancypath")
    .transition()
  .ease(d3.easeSin)
  .duration(5000)
  .attr("stroke-dashoffset", 0);

d3.select(".SF_vacancypath")
    .transition()
  .ease(d3.easeSin)
  .duration(5000)
  .attr("stroke-dashoffset", 0);


d3.select(".NY_vacancylabel")
    .transition()
    .delay(4000)
  .duration(500)
  .attr("opacity", 1);
d3.select(".Chicago_vacancylabel")
    .transition()
    .delay(4000)
  .duration(500)
  .attr("opacity", 1);

d3.select(".SF_vacancylabel")
    .transition()
    .delay(4000)
  .duration(500)
  .attr("opacity", 1);

d3.select(".NY_vacancylabelvacancy")
    .transition()
    .delay(4000)
  .duration(500)
  .attr("opacity", 1);
d3.select(".Chicago_vacancylabelvacancy")
    .transition()
    .delay(4000)
  .duration(500)
  .attr("opacity", 1);

d3.select(".SF_vacancylabelvacancy")
    .transition()
    .delay(4000)
  .duration(500)
  .attr("opacity", 1);
*/
}

function draw6(){

/*
document.getElementById('absorption').click();

d3.select(".Miami_abpath")
    .transition()
  .ease(d3.easeSin)
  .duration(5000)
  .attr("stroke-dashoffset", 0);

d3.select(".Miami_ablabel")
    .transition()
    .delay(4000)
  .duration(500)
  .attr("opacity", 1);

d3.select(".Miami_ablabelab")
    .transition()
    .delay(4000)
  .duration(500)
  .attr("opacity", 1);*/

}

function draw7(){
  return
}    

      let functions = [
        draw1,
    draw2,
    draw3,
    draw4,
    draw5, 
    draw6,
    draw7]


  var gs = d3.graphScroll()
      .container(d3.select('.container-1'))
      .graph(d3.selectAll('container-1 #graph'))
      .eventId('uniqueId1')  // namespace for scroll and resize events
      .sections(d3.selectAll('.container-1 #sections > div'))
      // .offset(innerWidth < 900 ? innerHeight - 30 : 200)
      .on('active', function(i){
        functions[i]()
      })



//MAP

mapboxgl.accessToken = 'pk.eyJ1Ijoia3BjbHluZSIsImEiOiJjanN3MzlpY2EwZGpjM3lsaGNhb3NqY3JmIn0._sGjIhmL5Xt08WIMWRsSsg';
        var bounds = [
[-80.24975, 25.73521]
, [-80.13341, 25.83169]
];
r
        const w = 255 * 0.65;

        const defaultMaxPitch = 89.9;

        var map = new mapboxgl.Map({
            container: 'map'
            , style: 'mapbox://styles/kpclyne/ckm2x7n0u1cr018nzpjesupiy'
            , center: [-80.188965, 25.776679]
            , zoom: 13
            , pitch: 0
            , bearing: 0
            , maxPitch: 85,
        }); 

     

        map.scrollZoom.disable();

        /*map.addControl(new MapboxGeocoder({
            accessToken: mapboxgl.accessToken
            , mapboxgl: mapboxgl
        }));*/

        var bins = 20;
        var maxHeight = 290;
        var binWidth = maxHeight / bins;

        map.on('load', function () {
            map.addSource('office', {
          // GeoJSON Data source used in vector tiles, documented at
          // https://gist.github.com/ryanbaumann/a7d970386ce59d11c16278b90dde094d
          'type': 'geojson',
          'data':'gis/office3.geojson'

          });

          map.addSource('underconstruction', {
          // GeoJSON Data source used in vector tiles, documented at
          // https://gist.github.com/ryanbaumann/a7d970386ce59d11c16278b90dde094d
          'type': 'geojson',
          'data':'gis/830Brickell.geojson'
          });

          map.addSource('proposed', {
          // GeoJSON Data source used in vector tiles, documented at
          // https://gist.github.com/ryanbaumann/a7d970386ce59d11c16278b90dde094d
          'type': 'geojson',
          'data':'gis/proposed2.geojson'
          });
           
          for (var i = 0; i < bins; i++) {
          map.addLayer({
          'id': 'office-extrude' + i,
          'type': 'fill-extrusion',
          'source': 'office',
          'filter': 
          ['all',
          ['>', 'height', i*binWidth],
          ['<=', 'height', (i + 1) * binWidth]],
          'paint': {
          // See the Mapbox Style Specification for details on data expressions.
          // https://docs.mapbox.com/mapbox-gl-js/style-spec/#expressions
           
          // Get the fill-extrusion-color from the source 'color' property.
          'fill-extrusion-color': "#314CCD",
           
          // Get fill-extrusion-height from the source 'height' property.
          'fill-extrusion-height': 0,
           
          // Get fill-extrusion-base from the source 'base_height' property.
          'fill-extrusion-base': ['get', 'minHeight'],
          //Set the 
          'fill-extrusion-height-transition':{
                    duration: 2000,
                    delay: 3000
                },
          // Make extrusions slightly opaque for see through indoor walls.
          'fill-extrusion-opacity': 0
          }
          });}

                  for (var i = 0; i < bins; i++) {
          map.addLayer({
          'id': 'proposed-developments' + i,
          'type': 'fill-extrusion',
          'source': 'proposed',
          'filter': 
          ['all',
          ['>', 'Proposed_parcels_Height', i*binWidth],
          ['<=', 'Proposed_parcels_Height', (i + 1) * binWidth]],
          'paint': {
          'fill-extrusion-color': "#314CCD",
          'fill-extrusion-height': 0,
          'fill-extrusion-base': ['get', 'minHeight'],
          'fill-extrusion-height-transition':{
                    duration: 2000,
                    delay: 200
                },
          'fill-extrusion-opacity': 0
          }
          });}
        
        map.addLayer({
          'id': 'under-construction',
          'type': 'fill-extrusion',
          'source': 'underconstruction',
          'paint': {
          'fill-extrusion-color': "#314CCD",
          'fill-extrusion-height': 0,
          'fill-extrusion-base': ['get', 'minheight'],
          'fill-extrusion-height-transition':{
                    duration: 2000,
                    delay: 2000
                },
          'fill-extrusion-color-transition':{
                    duration: 2000
                },
          'fill-extrusion-opacity': .9
          }
        });

        map.addLayer({
          'id': 'proposed-developments',
          'type': 'fill-extrusion',
          'source': 'proposed',
          'paint': {
          'fill-extrusion-color': "#314CCD",
          'fill-extrusion-height': 0,
          'fill-extrusion-base': 0,
          'fill-extrusion-height-transition':{
                    duration: 2000,
                    delay: 2000
                },
          'fill-extrusion-color-transition':{
                    duration: 2000
                },
          'fill-extrusion-opacity': .9
          }
        })

    }); 
        
/*
        // set functions for layer toggle buttons
        map.on('load', function () {
            var classatoggle = document.getElementById('classabutton');
            classatoggle.addEventListener('click', function () {
                if (classatoggle.className === 'on bordertop') {
                    classatoggle.setAttribute('class', 'off');
                    map.setLayoutProperty('office', 'visibility', 'none');
                    map.setLayoutProperty('office', 'visibility', 'none');
                    classatoggle.className = 'off bordertop';
                }
                else {
                    classatoggle.setAttribute('class', 'on bordertop');
                    map.setLayoutProperty('office', 'visibility', 'visible');
                    map.setLayoutProperty('office', 'visibility', 'visible');
                    classatoggle.className = 'on bordertop';
                }
            });
        });
        map.on('load', function () {
            var othertoggle = document.getElementById('otherbutton');
            othertoggle.addEventListener('click', function () {
                if (othertoggle.className === 'on') {
                    othertoggle.setAttribute('class', 'off');
                    map.setLayoutProperty('resi', 'visibility', 'none');
                    map.setLayoutProperty('resi', 'visibility', 'none');
                    othertoggle.className = 'off';
                }
                else {
                    othertoggle.setAttribute('class', 'on bordertop');
                    map.setLayoutProperty('resi', 'visibility', 'visible');
                    map.setLayoutProperty('resi', 'visibility', 'visible');
                    othertoggle.className = 'on';
                }
            });
        });
        map.on('load', function () {
            var condotoggle = document.getElementById('condobutton');
            condotoggle.addEventListener('click', function () {
                if (condotoggle.className === 'on') {
                    condotoggle.setAttribute('class', 'off');
                    map.setLayoutProperty('metrorail', 'visibility', 'none');
                    map.setLayoutProperty('metrorail', 'visibility', 'none');
                    condotoggle.className = 'off';
                }
                else {
                    condotoggle.setAttribute('class', 'on bordertop');
                    map.setLayoutProperty('metrorail', 'visibility', 'visible');
                    map.setLayoutProperty('metrorail', 'visibility', 'visible');
                    condotoggle.className = 'on';
                }
            });
        });


    
        // callouts on click
        map.on('load', function () {
            map.on('click', 'office', function (e) {
                new mapboxgl.Popup().setLngLat(e.lngLat).setHTML('<div class="marker-title">' + e.features[0].properties.name + '</div><!--<div style = "padding-top:5px;"> Type: <b>' + e.features[0].properties.type + '</b></div>-->').setMaxWidth("700px").addTo(map);
            });
            map.on('mouseenter', 'office', function () {
                map.getCanvas().style.cursor = 'pointer';
            });
            map.on('mouseleave', 'office', function () {
                map.getCanvas().style.cursor = '';
            });
        });
        map.on('load', function () {
            map.on('click', 'resi', function (e) {
                new mapboxgl.Popup().setLngLat(e.lngLat).setHTML('<div class="marker-title">' + e.features[0].properties.name + '</div>').setMaxWidth("700px").addTo(map);
            });
            map.on('mouseenter', 'resi', function () {
                map.getCanvas().style.cursor = 'pointer';
            });
            map.on('mouseleave', 'resi', function () {
                map.getCanvas().style.cursor = '';
            });
        });
        map.on('load', function () {
            map.on('click', 'metro', function (e) {
                new mapboxgl.Popup().setLngLat(e.lngLat).setHTML('<div class="marker-title">' + e.features[0].properties.Name + '</div><div style = "padding-top:5px;"> Stories: <b>' + e.features[0].properties.stories + '</b></div><div> Units: <b>' + e.features[0].properties.units + '</b></div><div> Property Mgmt Co: <b>' + e.features[0].properties.info + '</b></div>').setMaxWidth("700px").addTo(map);
            });
            map.on('mouseenter', 'metro', function () {
                map.getCanvas().style.cursor = 'pointer';
            });
            map.on('mouseleave', 'metro', function () {
                map.getCanvas().style.cursor = '';
            });
        });
        map.on('load', function () {
            map.on('click', 'rental', function (e) {
                new mapboxgl.Popup().setLngLat(e.lngLat).setHTML('<div class="marker-title">' + e.features[0].properties.Name + '</div><div style = "padding-top:5px;"> Stories: <b>' + e.features[0].properties.stories + '</b></div><div> Units: <b>' + e.features[0].properties.units + '</b></div><div> <b><a href="' + e.features[0].properties.info + '" target="_blank">Website</a> </b></div>').setMaxWidth("700px").addTo(map);
            });
            map.on('mouseenter', 'rental', function () {
                map.getCanvas().style.cursor = 'pointer';
            });
            map.on('mouseleave', 'rental', function () {
                map.getCanvas().style.cursor = '';
            });
        });
        map.on('load', function () {
            map.on('click', 'hotels', function (e) {
                new mapboxgl.Popup().setLngLat(e.lngLat).setHTML('<div class="marker-title">' + e.features[0].properties.Name + '</div><div style = "padding-top:5px;"> Hotel Meeting Space: <b>' + e.features[0].properties.Hotel_Meet + '</b></div><div> Hotel Rooms: <b>' + e.features[0].properties.Hotel_Room + '</b></div><div>' + e.features[0].properties.website + '</div>').setMaxWidth("700px").addTo(map);
            });
            map.on('mouseenter', 'hotels', function () {
                map.getCanvas().style.cursor = 'pointer';
            });
            map.on('mouseleave', 'hotels', function () {
                map.getCanvas().style.cursor = '';
            });
        });
        map.on('load', function () {
            map.on('click', 'shopping', function (e) {
                new mapboxgl.Popup().setLngLat(e.lngLat).setHTML('<div class="marker-title">' + e.features[0].properties.Name + '</div><div style = "padding-top:5px;">' + e.features[0].properties.website + '</div>').setMaxWidth("700px").addTo(map);
            });
            map.on('mouseenter', 'shopping', function () {
                map.getCanvas().style.cursor = 'pointer';
            });
            map.on('mouseleave', 'shopping', function () {
                map.getCanvas().style.cursor = '';
            });
        });
        // station names on hover
        var popup = new mapboxgl.Popup({
            closeButton: false
            , closeOnClick: false
        });
        map.on('mouseenter', 'metromover-stops', function (e) {
            // Change the cursor style as a UI indicator.
            map.getCanvas().style.cursor = 'pointer';
            var coordinates = e.features[0].geometry.coordinates.slice();
            var description = e.features[0].properties.NAME;
            while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
            }
            popup.setLngLat(coordinates).setHTML('<i>' + description + '</i>').addTo(map);
        });
        map.on('mouseleave', 'metromover-stops', function () {
            map.getCanvas().style.cursor = '';
            popup.remove();
        });

        let hovered = [];
    window.addEventListener('mousemove', function(e) {
        e.point = new mapboxgl.Point(e.clientX, e.clientY);
        
        const features = map.queryRenderedFeatures(e.point, {layers: ['office']});
       

        for (const feature of hovered) {
            map.setFeatureState(feature, {
                'hover-r': r,
                'hover-g': r,
                'hover-b': r
            });
        }
        const seen = {};
        hovered = features;
        let i = 0;
        for (const feature of hovered) {
            if (seen[feature.id]) continue;

            seen[feature.id] = true;
            map.setFeatureState(feature, {
                'hover-r': i === 0 ? 255 : w,
                'hover-g': i === 1 ? 255 : w,
                'hover-b': i >= 2 ? 255 : w
            });
            i++;
        }
         });
  */

function drawmap1(){

}  

function drawmap2(){


map.flyTo({
center: [-80.190701, 25.758105],
zoom: 16.54,
pitch: 73.54,
speed: 0.5
})

for (var i = 0; i < bins; i++) {

map.setPaintProperty(
'office-extrude' + i,
'fill-extrusion-height',
binWidth * i
);
map.setPaintProperty(
'office-extrude' + i,
'fill-extrusion-opacity', 0.9);
}

}

function drawmap3(){


map.flyTo({
center: [-80.188060, 25.767957],
zoom: 15.72,
bearing: 59.20,
pitch: 77.00,
speed: 0.5
})

    map.setPaintProperty(
'under-construction',
'fill-extrusion-height',
220
); 

    map.setPaintProperty(
'under-construction',
'fill-extrusion-color', "#F2F234"
); 

} 

function drawmap4(){

for (var i = 0; i < bins; i++) {
map.setPaintProperty(
  'office-extrude' + i, 
  'fill-extrusion-color',
  [
'interpolate',
['exponential', 0.5],
['zoom'],
14.5,
['match', ['get', "new"], 'RENO', '#F77E08' , 'NEW', '#F2F234', '#314CCD'],
15.72,
['match', ['get', "new"], 'RENO', '#314CCD' , 'NEW', '#314CCD', '#314CCD']
] 
);


map.flyTo({
center: [-80.183022, 25.769622],
zoom: 14.25,
bearing: 87.20,
pitch: 80.00,
speed: 0.5
})


}

} 

function drawmap5(){


for (var i = 0; i < bins; i++) {

map.setPaintProperty(
'proposed-developments' + i,
'fill-extrusion-height',
binWidth * i
);
map.setPaintProperty(
'proposed-developments' + i,
'fill-extrusion-opacity', 0.9);

 map.setPaintProperty(
'proposed-developments' + i,
'fill-extrusion-color', "#00674C"
); 
}


}

function drawmap6(){
  
map.flyTo({
center: [-80.188965, 25.776679],
zoom: 13,
bearing: 0,
pitch: 0,
speed: 0.5
})


d3.json(
            'gis/transit3.geojson',
            function (err, data) {
                if (err) throw err;
     
                // save full coordinate list for later

                let newdata = JSON.parse(JSON.stringify(data));
                var coordinates = new Array()
                for (x = 0; x < newdata.features.length; x++){
                  coords = newdata.features[x].geometry.coordinates
                  coordinates.push(newdata.features[x].geometry.coordinates);
                  newdata.features[x].geometry.coordinates = [coords[0]];
                }
                
                // add it to the map
                map.addSource('trace', { type: 'geojson', data: newdata });
                map.addLayer({
                    'id': 'trace',
                    'type': 'line',
                    'source': 'trace',
                    'paint': {
                        'line-color': ['get','color'],
                        'line-opacity': 1,
                        'line-width': 3
                    }
                });

                // setup the viewport

                // on a regular basis, add more coordinates from the saved list and update the map
                var i = 0;
                var maxlength = coordinates[coordinates.reduce((maxI,el,i,arr) => (el.length>arr[maxI].length) ? i : maxI, 0)].length;
                var timer = window.setInterval(function () {
                    if (i < maxlength) {
                        for (t=0; t < coordinates.length; t++){
                          newdata.features[t].geometry.coordinates.push(
                            coordinates[t][i]
                          );
                        }
                         map.getSource('trace').setData(newdata);
                        i++;
                    } else {
                        window.clearInterval(timer);
                    }
                }, 50000);
            }
        );
  

} 

function drawmap7(){


  
} 

function drawmap8(){


  
} 
      let functions2 = [
        drawmap1,
    drawmap2,
    drawmap3,
    drawmap4,
    drawmap5, 
    drawmap6,
    drawmap7,
    drawmap8]

  var gs2 = d3.graphScroll()
      .container(d3.select('.container-2'))
      .graph(d3.selectAll('.container-2 #graph'))
      .eventId('uniqueId2')  // namespace for scroll and resize events
      .sections(d3.selectAll('.container-2 #sections > div'))
      .on('active', function(i){
        functions2[i]()
      })


/////USPS



var map3 = new mapboxgl.Map({
    container: 'map3'
    , style: 'mapbox://styles/mapbox/dark-v9'
    , center: [-85.712915, 41.105394]
    , zoom: 3.16
    , pitch: 0
    , bearing: 0
    , maxPitch: 85
    ,renderWorldCopies: 1

}); 
map3.scrollZoom.disable();

function rotateCamera(timestamp) {
// clamp the rotation between 0 -360 degrees
// Divide timestamp by 100 to slow rotation to ~10 degrees / sec
map.rotateTo((timestamp / 100) % 360, { duration: 0 });
// Request the next frame of the animation.
requestAnimationFrame(rotateCamera);
}


colorScale = d3.scaleOrdinal()
      .domain(['business', 'private'])
      .range([[102,194,165,50], [141,160,203,50]])


class ArcBrushingLayer extends deck.ArcLayer {
      getShaders() {
        // here comes our custom shader
        // we will use step function to create opacity gradient with colorA and color B
        // for more information see https://thebookofshaders.com/05/
        return Object.assign({}, super.getShaders(), {
          inject: {
            'vs:#decl': `
             uniform float coef;
            `,
            'vs:#main-end': `
            if (coef > 0.0) {
              vec4 pct = vec4(segmentRatio);
              pct.a = step(coef, segmentRatio);
              vec4 colorA = instanceTargetColors;
              vec4 colorB = vec4(instanceTargetColors.r, instanceTargetColors.g, instanceTargetColors.b, 0.0);
              vec4 color = mix(colorA, colorB, pct) / 255.;
              vColor = color;
            }
                        `,
                        'fs:#main-start': `
            if (vColor.a == 0.0) discard;
                        `
          }
        });
      }

      draw(opts) {
        const {coef} = this.props;
        // add uniforms
        const uniforms = Object.assign({}, opts.uniforms, { coef: coef });
        super.draw(Object.assign({}, opts, {uniforms}));
      }
    }


    class ArcBrushingLayer2 extends deck.ArcLayer {
      getShaders() {
        // here comes our custom shader
        // we will use step function to create opacity gradient with colorA and color B
        // for more information see https://thebookofshaders.com/05/
        return Object.assign({}, super.getShaders(), {
          inject: {
            'vs:#decl': `
             uniform float coef;
            `,
            'vs:#main-end': `
            if (coef > 0.0) {
              vec4 pct = vec4(segmentRatio);
              pct.a = step(coef, segmentRatio) - step(coef + 0.1, segmentRatio);
              vec4 colorA = instanceTargetColors;
              vec4 colorB = vec4(instanceTargetColors.r, instanceTargetColors.g, instanceTargetColors.b, 0.0);
              vec4 color = mix(colorA, colorB, pct) / 255.;
              vColor = color;
            }
                        `,
                        'fs:#main-start': `
            if (vColor.a == 0.0) discard;
                        `
          }
        });
      }

      draw(opts) {
        const {coef} = this.props;
        // add uniforms
        const uniforms = Object.assign({}, opts.uniforms, { coef: coef });
        super.draw(Object.assign({}, opts, {uniforms}));
      }
    }

 const arcsLayer = new deck.MapboxLayer({
       type: ArcBrushingLayer,
       id: `arcs`,
       data: "json/moves.json",
       opacity: 1,
       coef: 0.001,
       pickable: true,
       getSourcePosition: d => [d.longitude_source, d.latitude_source],
       getTargetPosition: d => [d.longitude_target, d.latitude_target],
       getSourceColor: d => colorScale(d.category),
       getTargetColor: d => colorScale(d.category),
       
    });

   map3.on('load', () => {

    var layers = map3.getStyle().layers;
    for (var i = 0; i < layers.length; i++) {
    if (layers[i].type === 'symbol' && layers[i].layout['text-field']) {
    // remove text labels
    map3.removeLayer(layers[i].id);
    }
    }
     map3.addLayer(arcsLayer);
      
  });


function drawusps1(){


}  

function drawusps2(){
    var coef = 0.001;
    const animationInterval = setInterval(()=> {
      coef += 0.005;
      if (coef >= 1.0) {
        clearInterval(animationInterval);
      }
      arcsLayer.setProps({coef});
    }, 1);
}

function drawusps3(){

} 

function drawusps4(){
}

function drawusps5(){

}

function drawusps6(){

} 

function drawusps7(){

} 

function drawusps8(){
  
} 

 let functions3 = [
    drawusps1,
    drawusps2,
    drawusps3,
    drawusps4,
    drawusps5, 
    drawusps6,
    drawusps7,
    drawusps8]

  var gs3 = d3.graphScroll()
      .container(d3.select('.container-3'))
      .graph(d3.selectAll('.container-3 #graph'))
      .eventId('uniqueId3')  // namespace for scroll and resize events
      .sections(d3.selectAll('.container-3 #sections > div'))
      .on('active', function(i){
        functions3[i]()
      })






}
render()
d3.select(window).on('resize', render)



</script>

<script>
  ////PROFILES MAP
//Profile Maps

var map2 = new mapboxgl.Map({
            container: 'map2'
            , style: 'mapbox://styles/kpclyne/cjy9ts3mh0y9j1do9uss5fz8o'
            , center: [-80.19393, 25.77054]
            , zoom: 6
            , minZoom: 2
            , maxZoom: 16
            ,interactive: false
        });
        map2.scrollZoom.disable();


 

map2.on('load', function () {
   
      map2.resize();
      map2.addSource('greaterdda', {
      'type': 'geojson',
      'data':
      'https://raw.githubusercontent.com/HRAAdvisors/HRAAdvisors.github.io/master/miami/gis/greaterdda.geojsonl.json'
      });
      map2.addLayer(
      {
      'id': 'greaterdda-fill',
      'type': 'fill',
      'source': 'greaterdda',
      'layout': {
        'visibility': 'none'
      },
      'paint': {
      'fill-color': '#f08',
      'fill-opacity': 0.4
      }
    })

      map2.addSource('brickell', {
      'type': 'geojson',
      'data':
      'https://raw.githubusercontent.com/HRAAdvisors/HRAAdvisors.github.io/master/miami/gis/brickell.geojsonl.json'
      });
      map2.addLayer(
      {
      'id': 'brickell-fill',
      'type': 'fill',
      'source': 'brickell',
      'layout': {
        'visibility': 'none'
      },
      'paint': {
      'fill-color': '#f08',
      'fill-opacity': 0.4
      }
    })

    map2.addSource('ae', {
      'type': 'geojson',
      'data':
      'https://raw.githubusercontent.com/HRAAdvisors/HRAAdvisors.github.io/master/miami/gis/ae.geojsonl.json'
      });
      map2.addLayer(
      {
      'id': 'ae-fill',
      'type': 'fill',
      'source': 'ae',
      'layout': {
        'visibility': 'none'
      },
      'paint': {
      'fill-color': '#f08',
      'fill-opacity': 0.4
      }
    })

    map2.addSource('cbd', {
      'type': 'geojson',
      'data':
      'https://raw.githubusercontent.com/HRAAdvisors/HRAAdvisors.github.io/master/miami/gis/cbd.geojsonl.json'
      });
      map2.addLayer(
      {
      'id': 'cbd-fill',
      'type': 'fill',
      'source': 'cbd',
      'layout': {
        'visibility': 'none'
      },
      'paint': {
      'fill-color': '#f08',
      'fill-opacity': 0.4
      }
    })

      map2.addSource('dda', {
      'type': 'geojson',
      'data':
      'https://raw.githubusercontent.com/HRAAdvisors/HRAAdvisors.github.io/master/miami/gis/miamidda.geojsonl.json'
      });
      map2.addLayer(
      {
      'id': 'dda-fill',
      'type': 'fill',
      'source': 'dda',
      'layout': {
        'visibility': 'none'
      },
      'paint': {
      'fill-color': '#f08',
      'fill-opacity': 0.4
      }
    })

    map2.addSource('miamidade', {
      'type': 'geojson',
      'data':
      'https://raw.githubusercontent.com/HRAAdvisors/HRAAdvisors.github.io/master/miami/gis/miamidade.geojsonl.json'
      });
      map2.addLayer(
      {
      'id': 'miamidade-fill',
      'type': 'fill',
      'source': 'miamidade',
      'layout': {},
      'paint': {
      'fill-color': '#f08',
      'fill-opacity': 0.4
      }
    })

    var toggleableLayerIds = [ 'miamidade-fill', 'greaterdda-fill','dda-fill','cbd-fill','ae-fill','brickell-fill' ]

    
    function moveMap(layer,bounds){
      for(var index in toggleableLayerIds) {
                var clickedLayer = toggleableLayerIds[index];
                map2.setLayoutProperty(clickedLayer, 'visibility', 'none');
              }

      map2.setLayoutProperty(layer, 'visibility', 'visible');

      map2.fitBounds(bounds);
    }

    var GDtoggle = document.getElementById('GDButton');
            GDtoggle.addEventListener('click', function (e) {
              moveMap('greaterdda-fill',[
      [-80.214268,
      25.7456244],
      [-80.1710619,
      25.8199841]
    ])   
            });
    var MiamiDadetoggle = document.getElementById('MiamiButton');
        MiamiDadetoggle.addEventListener('click', function (e) {
          moveMap('miamidade-fill',[
      [-80.8735842,
      25.1374249],
      [-80.118074,
      25.9794389]
    ])   
        });
    var DDAtoggle = document.getElementById('DDAButton');
        DDAtoggle.addEventListener('click', function (e) {
          moveMap('dda-fill',[
      [-80.2012045,
      25.7573506],
      [-80.1755337,
      25.8002]])   
        });
    var CBDtoggle = document.getElementById('CBDButton');
            CBDtoggle.addEventListener('click', function (e) {
              moveMap('cbd-fill',[
      [-80.2010044,
      25.7688479],
      [-80.1833007,
      25.782989]
    ])   
            });
    var AEtoggle = document.getElementById('AEButton');
            AEtoggle.addEventListener('click', function (e) {
              moveMap('ae-fill',[
      [-80.1961861,
      25.7827633],
      [-80.1755337,
      25.8002303]
    ])   
            });
    var Brickelltoggle = document.getElementById('BrickellButton');
            Brickelltoggle.addEventListener('click', function (e) {
              moveMap('brickell-fill',[
    [-80.1961369,
    25.7573506],
    [-80.1827413,
    25.7700894]
  ])   
            });

});


/*
////Retention Map
var map3 = new mapboxgl.Map({
            container: 'map3'
            , style: 'mapbox://styles/kpclyne/cklun3glz1uuy17mnm8butfl0'
            , center: [-80.971193, 34.032196]
            , zoom: 3
            , minZoom: 2
            , maxZoom: 16
            ,interactive: false
        });
        map3.scrollZoom.disable();

var popup = new mapboxgl.Popup({
closeButton: false,
closeOnClick: false
});
 
map3.on('mouseenter', 'merged', function (e) {
// Change the cursor style as a UI indicator.
map3.getCanvas().style.cursor = 'pointer';
 
var coordinates = e.features[0].geometry.coordinates.slice();
var description = e.features[0].properties.fullname;
var miamiret = e.features[0].properties.miami;
var fulldesc = '<strong>' + description + '</strong><p>' + String(d3.format(".0%")(miamiret*.01)) + '</p>'
// Ensure that if the map is zoomed out such that multiple
// copies of the feature are visible, the popup appears
// over the copy being pointed to.
while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
}
 
// Populate the popup and set its coordinates
// based on the feature found.
popup.setLngLat(coordinates).setHTML(fulldesc).addTo(map3);
});
 
map3.on('mouseleave', 'merged', function () {
map3.getCanvas().style.cursor = '';
popup.remove();
});
*/

//document.getElementById('info').innerHTML = "Share of schools’ alumni who move to Miami"

    ///TOP INDUSTRY TABLES

d3.csv("https://docs.google.com/spreadsheets/d/1LMADV7lzfx1rC6AzkrUp8uwe5XuXR8sd3KDeashPmB8/gviz/tq?tqx=out:csv&gid=2127750220", function(error, data1) {
      if (error) throw error;
      
      d3.csv("https://docs.google.com/spreadsheets/d/1LMADV7lzfx1rC6AzkrUp8uwe5XuXR8sd3KDeashPmB8/gviz/tq?tqx=out:csv&gid=1433347485", function(error, data2) {
      if (error) throw error;
        
      data = data1
      
      var growing = d3
        .select("#GrowingInds")
      
      var largest = d3
        .select("#LargestInds")
      
      
      
      var columns = d3.keys(data[0]);

      var table = d3.select('#top-industries').append("table");
      var thead = table.append("thead");
      var tbody = table.append("tbody");

      thead.append("tr")
        .selectAll("th")
        .data(columns)
        .enter()
        .append("th")
        .text(function(column) { return column; });

      tbody.selectAll("tr")
        .data(data)
        .enter()
        .append("tr")
        .selectAll("td")
        .data(function(row) {
          return columns.map(function(column) {
            return {
              column: column,
              value: row[column]
            };
          });
        })
        .enter()
        .append("td")
        .text(function(d) { return d.value; });
      
      growing
      .on('click', function(d){
        tbody.selectAll("tr")
        .data(data2)
        .selectAll("td")
        .data(function(row) {
          return columns.map(function(column) {
            return {
              column: column,
              value: row[column]
            };
          });
        })
        .text(function(d) {return d.value;});
        
      })
      
      largest
      .on('click', function(d){
        tbody.selectAll("tr")
        .data(data1)
        .selectAll("td")
        .data(function(row) {
          return columns.map(function(column) {
            return {
              column: column,
              value: row[column]
            };
          });
        })
        .text(function(d) {return d.value;});
        
      })
      
      
      
      
        
      });
    });


/// TOP OCCUPATION TABLE
d3.csv("https://docs.google.com/spreadsheets/d/1LMADV7lzfx1rC6AzkrUp8uwe5XuXR8sd3KDeashPmB8/gviz/tq?tqx=out:csv&gid=632495073", function(error, data1) {
      if (error) throw error;
      
      d3.csv("https://docs.google.com/spreadsheets/d/1LMADV7lzfx1rC6AzkrUp8uwe5XuXR8sd3KDeashPmB8/gviz/tq?tqx=out:csv&gid=791286037", function(error, data2) {
      if (error) throw error;
        
      data = data1
      
      var growing = d3
        .select("#GrowingOccs")
      
      var largest = d3
        .select("#LargestOccs")
      
      
      
      var columns = d3.keys(data[0]);

      var table = d3.select('#top-occupations').append("table");
      var thead = table.append("thead");
      var tbody = table.append("tbody");

      thead.append("tr")
        .selectAll("th")
        .data(columns)
        .enter()
        .append("th")
        .text(function(column) { return column; });

      tbody.selectAll("tr")
        .data(data)
        .enter()
        .append("tr")
        .selectAll("td")
        .data(function(row) {
          return columns.map(function(column) {
            return {
              column: column,
              value: row[column]
            };
          });
        })
        .enter()
        .append("td")
        .text(function(d) { return d.value; });
      
      growing
      .on('click', function(d){
        tbody.selectAll("tr")
        .data(data2)
        .selectAll("td")
        .data(function(row) {
          return columns.map(function(column) {
            return {
              column: column,
              value: row[column]
            };
          });
        })
        .text(function(d) {return d.value;});
        
      })
      
      largest
      .on('click', function(d){
        tbody.selectAll("tr")
        .data(data1)
        .selectAll("td")
        .data(function(row) {
          return columns.map(function(column) {
            return {
              column: column,
              value: row[column]
            };
          });
        })
        .text(function(d) {return d.value;});
        
      })
      
        
      });
    });

//////WHO'S HERE TILE SCROLLER

var scoll = 0
 function autoScrollUp(){
          $(".inner1").css({top:0}) // jump back
                     .animate({top:-$(".outer1").outerHeight()},80000,"linear", autoScrollUp);
          $(".inner2").css({top:0}) // jump back
                     .animate({top:-$(".outer2").outerHeight()},80000,"linear", autoScrollUp); // and animate
      }
      // fix hight of outer:
      //$('.outer').css({maxHeight: $('.inner').height()});
      // duplicate content of inner:
      $('.inner1').html($('.inner1').html() + $('.inner1').html());
      $('.inner2').html($('.inner2').html() + $('.inner2').html());


 autoScrollUp();

 $( ".outer" ).scroll(function() {
  $( ".inner" ).stop()
  $( ".inner" ).css({top:0})
});

$( ".inner" ).scroll(function() {
  $( ".inner" ).stop()
  $( ".inner" ).css({top:0})
});


empwidth = document.getElementById("emp").clientWidth



 var padding = 6, cols = 4, radius = ((empwidth/cols)/2) - padding*(1 + (1/(cols+1))), parameter = 'industry';

  var menu = [
            {id: 'size', name: 'Size'},
            {id: 'high', name: 'High ($)'},
            {id: 'low', name: 'Low ($)'},
            {id: 'open', name: 'Open ($)'},
            {id: 'netChange', name: 'Net Change ($)'},
            {id: 'percentChange', name: 'Percent Change (%)'},
          ];
      
 

/// HELPER FUNCTIONS
function translateSVG(x, y) {
  return 'translate('+x+','+y+')';
}

//// UI
function menuClick(d) {
  if(parameter === d.id)
    return;

  d3.select('#menu2').selectAll('div').classed('selected', false);
  d3.select(this).classed('selected', true);

  parameter = d.id;

  updateChart();
}

function selectThis(d) {
  d3.select(this).classed('selected', function() {return !d3.select(this).classed('selected');})
}

//// D3
function updateChart() {

  var nodes = d3.select('#chart')
    .selectAll('div.node')
    .sort(function(a, b) {return parameter === 'ranking' ? d3.ascending(a[parameter], b[parameter]) : d3.descending(a[parameter], b[parameter]);})
    .transition()
    .duration(1000)
    .style('left', function(d, i) {
      var col = i % cols;
      var x = 2 * col * (radius + padding);
      return x + 'px';
    })
    .style('top', function(d, i) {
      var row = Math.floor(i / cols);
      var y = row * (radius + padding);
      return y + 'px';
    });

  d3.select('#chart')
    .selectAll('div.node .value')
    .transition()
    .duration(0)
    .tween("text", function(d)
      {
        var x = d[parameter];
        if (!(parameter == 'open' || parameter == 'high')) x;
        var i = d3.interpolate(this.textContent, (x));
        return function(t) {
          this.textContent = (i(t));
      };
    });
}

function updateChart2() {

  var nodes = d3.select('#chart2')
    .selectAll('div.node')
    .sort(function(a, b) {return parameter === 'ranking' ? d3.ascending(a[parameter], b[parameter]) : d3.descending(a[parameter], b[parameter]);})
    .transition()
    .duration(1000)
    .style('left', function(d, i) {
      var col = i % cols;
      var x = 2 * col * (radius + padding);
      return x + 'px';
    })
    .style('top', function(d, i) {
      var row = Math.floor(i / cols);
      var y = row * (radius + padding);
      return y + 'px';
    });

  d3.select('#chart2')
    .selectAll('div.node .value')
    .transition()
    .duration(0)
    .tween("text", function(d)
      {
        var x = d[parameter];
        if (!(parameter == 'open' || parameter == 'high')) x;
        var i = d3.interpolate(this.textContent, (x));
        return function(t) {
          this.textContent = (i(t));
      };
    });
}

 // Menu
d3.select('#menu2')
  .selectAll('div')
  .data(menu)
  .enter()
  .append('div')
  .text(function(d) {return d.name;})
  .classed('selected', function(d, i) {return i==0;})
  .on('click', menuClick);


    d3.csv("https://docs.google.com/spreadsheets/d/1LMADV7lzfx1rC6AzkrUp8uwe5XuXR8sd3KDeashPmB8/gviz/tq?tqx=out:csv&gid=196727768", function(error, data1) {
      if (error) throw error;
    
    var nodes = d3.select('#chart')
                      .selectAll('div')
                      .data(data1)
                      .enter()
                      .append('div')
                      .attr('id', function(d) {return 'entity-'+d.size;})
                      .style('background-color', "#FFFFFF")
                      .classed('node', true)
                      .style('width', 2 * radius + 'px')
                      .style('height', radius + 'px')

                      .on('click', selectThis);

        nodes
          .append('div')
          .classed('name', true)
          .html(function(d) {return d.employer})
          .style('color', '#00B5CC')
          .style('width', 2 * radius + 'px')
          .style('height', 0.5 * radius + 'px')
          .style('padding-top', 0.25 * radius + 'px')
          .style('font-size', 23+'px')
          .style('font-weight', 700);

        nodes
          .append('div')
          .classed('value', true)
          .html(function(d) {return d[parameter]})
          .style('color', '#00B5CC')
          .style('width', 2 * radius + 'px')
          .style('height', 0.5 * radius + 'px')
          .style('font-size', 15+'px')
          .style('font-weight', 700);

        updateChart();
  });

    d3.csv("https://docs.google.com/spreadsheets/d/1LMADV7lzfx1rC6AzkrUp8uwe5XuXR8sd3KDeashPmB8/gviz/tq?tqx=out:csv&gid=1181381306", function(error, data1) {
      if (error) throw error;
    
    var nodes = d3.select('#chart2')
                      .selectAll('div')
                      .data(data1)
                      .enter()
                      .append('div')
                      .attr('id', function(d) {return 'entity-'+d.size;})
                      .style('background-color', "#FFFFFF")
                      .classed('node', true)
                      .style('width', 2 * radius + 'px')
                      .style('height', radius + 'px')

                      .on('click', selectThis);

        nodes
          .append('div')
          .classed('name', true)
          .html(function(d) {return d.employer})
          .style('color', '#00B5CC')
          .style('width', 2 * radius + 'px')
          .style('height', 0.5 * radius + 'px')
          .style('padding-top', 0.25 * radius + 'px')
          .style('font-size', 23+'px')
          .style('font-weight', 700);

        nodes
          .append('div')
          .classed('value', true)
          .html(function(d) {return d[parameter]})
          .style('color', '#00B5CC')
          .style('width', 2 * radius + 'px')
          .style('height', 0.5 * radius + 'px')
          .style('font-size', 15+'px')
          .style('font-weight', 700);

        updateChart2();
  });
 






///EDUCATIONAL ATTAINMENT SLIDER
d3.csv("https://docs.google.com/spreadsheets/d/1LMADV7lzfx1rC6AzkrUp8uwe5XuXR8sd3KDeashPmB8/gviz/tq?tqx=out:csv&gid=1283485067", function(error, csv) {
      if (error) throw error;

  var keys = csv.columns.slice(2);

  var year   = [...new Set(csv.map(d => d.Year))]
  var states = [...new Set(csv.map(d => d.Bucket))]


  var svg = d3.select("#educhart"),
    margin = {top: 35, left: 35, bottom: 0, right: 15},
    
    element = svg.node();
    width = element.getBoundingClientRect().width - margin.left - margin.right,
    height = element.getBoundingClientRect().height - margin.top - margin.bottom;

  var y = d3.scaleBand()
    .range([margin.top, height - margin.bottom])
    .padding(0.1)
    .paddingOuter(0.2)
    .paddingInner(0.2)

  var x = d3.scaleLinear()
    .range([margin.left, width - margin.right])

  var yAxis = svg.append("g")
    .attr("transform", `translate(${margin.left},0)`)
    .attr("class", "y-axis")

  var xAxis = svg.append("g")
    .attr("transform", `translate(0,${height})`)
    .attr("class", "x-axis")

  var z = d3.scaleOrdinal()
    .range(["#7F7F7F", "#9DC3E6", "#2E75B6","#002060"])
    .domain(keys);

  update(d3.select("#slide").property("value"), 0)

  function update(input, speed) {

    var data = csv.filter(f => f.Year == input)

    data.forEach(function(d) {
      d.total = d3.sum(keys, k => +d[k])
      return d
    })

    csv.forEach(function(d) {
      d.total = d3.sum(keys, k => +d[k])
      return d
    })

    const maxedu = csv.reduce(
      (max, i) => (i.total > max ? i.total : max),
      csv[0].total
    );

    x.domain([0, maxedu]).nice();

    svg.selectAll(".x-axis").transition().duration(speed)
      .call(d3.axisBottom(x).ticks(null, "s"))


    y.domain(data.map(d => d.Bucket));

    svg.selectAll(".y-axis").transition().duration(speed)
      .call(d3.axisLeft(y).tickSizeOuter(0))

    var group = svg.selectAll("g.layer")
      .data(d3.stack().keys(keys)(data), d => d.key)

    group.exit().remove()

    group.enter().insert("g", ".y-axis").append("g")
      .classed("layer", true)
      .attr("fill", d => z(d.key));

    var bars = svg.selectAll("g.layer").selectAll("rect")
      .data(d => d, e => e.data.Bucket);

    bars.exit().remove()

    bars.enter().append("rect")
      .attr("height", y.bandwidth())
      .merge(bars)
    .transition().duration(speed)
      .attr("y", d => y(d.data.Bucket))
      .attr("x", d => x(d[0]))
      .attr("width", d => x(d[1]) - x(d[0]))

    var text = svg.selectAll(".text")
      .data(data, d => d.Bucket);

    text.exit().remove()

    text.enter().append("text")
      .attr("class", "text")
      .attr("text-anchor", "start")
      .merge(text)
    .transition().duration(speed)
      .attr("y", d => y(d.Bucket) + y.bandwidth() / 2)
      .attr("x", d => x(d.total) + 5)
      .text(d => d.total)
  }


  var slide = d3.select("#slide")
    .on("change", function() {
      update(this.value, 750)
    })

});
  
const allRanges = document.querySelectorAll(".range-wrap");
allRanges.forEach(wrap => {
  const range = wrap.querySelector(".range");
  const bubble = wrap.querySelector(".bubble");

  range.addEventListener("input", () => {
    setBubble(range, bubble);
  });
  setBubble(range, bubble);
});

function setBubble(range, bubble) {
  const val = range.value;
  const min = range.min ? range.min : 0;
  const max = range.max ? range.max : 100;
  const newVal = Number(((val - min) * 100) / (max - min));
  bubble.innerHTML = val;

  // Sorta magic numbers based on size of the native UI thumb
  bubble.style.left = `calc(${newVal}% + (${8 - newVal * 0.15}px))`;
}



//////COLLEGE TOWNS

d3.csv("https://docs.google.com/spreadsheets/d/1LMADV7lzfx1rC6AzkrUp8uwe5XuXR8sd3KDeashPmB8/gviz/tq?tqx=out:csv&gid=1381261411", function(error, data) {
  if (error) throw error;

  // format the data
  data.forEach(function(d) {
    d.students = +d.students;
  });
  
  var svg = d3.select("#collegetowns")
  
  var margin = {top: 20, right: 20, bottom: 30, left: 60},
  element = svg.node();
  width = element.getBoundingClientRect().width - margin.left - margin.right,
  height = element.getBoundingClientRect().height - margin.top - margin.bottom;

// set the ranges
var x = d3.scaleBand()
          .range([margin.left, width-margin.right])
          .padding(0.1);
var y = d3.scaleLinear()
          .range([height-margin.bottom, margin.top]);
          
// append the svg object to the body of the page
// append a 'group' element to 'svg'
// moves the 'group' element to the top left margin

    svg
      .append("g")
      .attr("transform", 
          "translate(" + margin.left + "," + margin.top + ")");


  // Scale the range of the data in the domains
  x.domain(data.map(function(d) { return d.city; }));
  y.domain([0, d3.max(data, function(d) { return d.students; })]);

  // append the rectangles for the bar chart
  svg.selectAll(".bar")
      .data(data)
    .enter().append("rect")
      .attr("class", "bar")
      .attr("x", function(d) { return x(d.city); })
      .attr("width", x.bandwidth())
      .attr("y", function(d) { return y(d.students); })
      .attr("height", function(d) { return height - y(d.students); })
      .style ("fill", function(d) {
       if (d.city === "Miami") {return "#EB529D"}  // <== Add these
       else    { return "#A6CEE3" } 
      });

  // add the x Axis
  svg.append("g")
      .attr("transform", "translate(0," + height + ")")
      .call(d3.axisBottom(x));

  // add the y Axis
  svg.append("g")
      .attr("transform", "translate("+ margin.left + "," + margin.top + ")")
      .call(d3.axisLeft(y));

});




///////QUALITY
/*
d3.csv("https://docs.google.com/spreadsheets/d/1LMADV7lzfx1rC6AzkrUp8uwe5XuXR8sd3KDeashPmB8/gviz/tq?tqx=out:csv&gid=2061632967", function(error, data) {
  if (error) throw error;


  function wrap(text, width) {
        text.each(function() {
            var text = d3.select(this),
                    words = text.text().split(/\s+/).reverse(),
                    word,
                    line = [],
                    lineNumber = 0,
                    lineHeight = 1.1, // ems
                    y = text.attr("y"),
                    dy = parseFloat(text.attr("dy")),
                    tspan = text.text(null).append("tspan").attr("x", 0).attr("y", y).attr("dy", dy + "em");
            while (word = words.pop()) {
                line.push(word);
                tspan.text(line.join(" "));
                if (tspan.node().getComputedTextLength() > width) {
                    line.pop();
                    tspan.text(line.join(" "));
                    line = [word];
                    tspan = text.append("tspan").attr("x", 0).attr("y", y).attr("dy", ++lineNumber * lineHeight + dy + "em").text(word);
                }
            }
        });
    }

    var svg = d3.select("#quality")

    var margin = {top: 20, right: 20, bottom: 30, left: 60},
  element = svg.node();
  width = element.getBoundingClientRect().width - margin.left - margin.right,
  height = element.getBoundingClientRect().height - margin.top - margin.bottom;


  var x = d3.scale.ordinal()
            .rangeRoundBands([0, width], .1,.3);
    var y = d3.scale.linear()
            .rangeRound([height, 0]);
    var colorRange = d3.scale.category20();
    var color = d3.scale.ordinal()
            .range(["#BFBFBF","#0070C0","#EB529D"]);
    var xAxis = d3.svg.axis()
            .scale(x)
            .orient("bottom");
    var yAxis = d3.svg.axis()
            .scale(y)
            .orient("left")
            .tickFormat(d3.format(".2s"));


    svg.append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
    var divTooltip = d3.select("body").append("div").attr("class", "toolTip");
    color.domain(d3.keys(dataset[0]).filter(function(key) { return key !== "label"; }));
    dataset.forEach(function(d) {
        var y0 = 0;
        d.values = color.domain().map(function(name) { return {name: name, y0: y0, y1: y0 += +d[name]}; });
        d.total = d.values[d.values.length - 1].y1;
    });
    x.domain(dataset.map(function(d) { return d.label; }));
    y.domain([0, d3.max(dataset, function(d) { return d.total; })]);
   
   
    var bar = svg.selectAll(".label")
            .data(dataset)
            .enter().append("g")
            .attr("class", "g")
            .attr("transform", function(d) { return "translate(" + x(d.label) + ",0)"; });
 
            
    var bar_enter = bar.selectAll("rect")
    .data(function(d) { return d.values; })
    .enter();

bar_enter.append("rect")
    .attr("width", x.rangeBand())
    .attr("y", function(d) { return y(d.y1); })
    .attr("height", function(d) { return y(d.y0) - y(d.y1); })
    .style("fill", function(d) { return color(d.name); });

bar_enter.append("text")
    .text(function(d) { return d3.format(".1s")(d.y1-d.y0)+" SF"; })
    .attr("y", function(d) { return y(d.y1)+(y(d.y0) - y(d.y1))/2; })
    .attr("x", x.rangeBand()/2.2)
    .style("fill", '#ffffff')
    .style("font-size", '30px')
    .style("font-weight", '600');
  
bar_enter.append("text")
    .text(function(d) { return d.name })
    .attr("y", function(d) { return y(d.y1)+(y(d.y0) - y(d.y1))/2; })
    .attr("x", x.rangeBand()*1.01)
    .style("fill", function(d) { return color(d.name); })
    .style("font-size", '30px')
    .style("font-weight", '600');

  });

*/
////// DISTRICT PROFILES
d3.csv("https://docs.google.com/spreadsheets/d/1LMADV7lzfx1rC6AzkrUp8uwe5XuXR8sd3KDeashPmB8/gviz/tq?tqx=out:csv&gid=1939873973", function(error, data1) {
      if (error) throw error;
      
      d3.csv("https://docs.google.com/spreadsheets/d/1LMADV7lzfx1rC6AzkrUp8uwe5XuXR8sd3KDeashPmB8/gviz/tq?tqx=out:csv&gid=342967098", function(d){
  return{
    class: d.class,
    businesses: +d.businesses,
    population: +d.population,
    employees: +d.employees
  };
}, function(error, rows) {
      if (error) throw error;
        
      data = data1.filter(f => f.geo == 'miami')
      data.forEach(function(v){ delete v.geo });

      var button = d3
      .selectAll('.dbutton')

      var miami = d3
        .select("#MiamiButton")
      
      var gd = d3
        .select("#GDButton")

      var dda = d3
        .select("#DDAButton")
        
      var cbd = d3
        .select("#CBDButton")

      var ae = d3
        .select("#AEButton")

      var brickell = d3
        .select("#BrickellButton") 

      var businesses = d3.select("#businesses")
      .append("svg")
      .append("text")
        .text(d3.format("(,.2r")(rows[0].businesses))
        .attr("x", (window.innerWidth*0.15625)/2)
        .attr("y", (window.innerHeight*0.12388503468780972)/2)
        .attr("text-anchor","middle")
        .attr("class", "label")
        .style("font-weight", 700)
        .style('font-size',40)
        .style('fill','#FFFFFF')

    var population = d3.select("#population")
      .append("svg")
      .append("text")
        .text(d3.format("(,.2r")(rows[0].population))
        .attr("x", (window.innerWidth*0.15625)/2)
        .attr("y", (window.innerHeight*0.12388503468780972)/2)
        .attr("text-anchor","middle")
        .attr("class", "label")
        .style("font-weight", 700)
        .style('font-size',40)
        .style('fill','#FFFFFF')

    var employees = d3.select("#employees")
      .append("svg")
      .append("text")
        .text(d3.format("(,.2r")(rows[0].employees) )
        .attr("x", (window.innerWidth*0.15625)/2)
        .attr("y", (window.innerHeight*0.12388503468780972)/2)
        .attr("text-anchor","middle")
        .attr("class", "label")
        .style("font-weight", 700)
        .style('font-size',40)
        .style('fill','#FFFFFF') 
          
      
      
      var columns = d3.keys(data[0]);

      var table = d3.select('#conditions').append("table");
      var thead = table.append("thead");
      var tbody = table.append("tbody");

      thead.append("tr")
        .selectAll("th")
        .data(columns)
        .enter()
        .append("th")
        .text(function(column) { return column; });

      tbody.selectAll("tr")
        .data(data)
        .enter()
        .append("tr")
        .selectAll("td")
        .data(function(row) {
          return columns.map(function(column) {
            return {
              column: column,
              value: row[column]
            };
          });
        })
        .enter()
        .append("td")
        .text(function(d) { return d.value; })
        .style("color","#FFF");
      
      miami
      .on('click', function(d){

        newdata = data1.filter(f => f.geo == 'miami')
        newdata.forEach(function(v){ delete v.geo });

        button
        .style("color","#FFFFFF")
        .style("background-color", "#D3D3D3")
        
        miami
        .style("background-color", "#FFFFFF")
        .style("color","#242358")
        
        businesses
          .text(d3.format("(,.2r")(rows[0].businesses))
        population
          .text(d3.format("(,.2r")(rows[0].population))
        employees
          .text(d3.format("(,.2r")(rows[0].employees))



        tbody.selectAll("tr")
        .data(newdata)
        .selectAll("td")
        .data(function(row) {
          return columns.map(function(column) {
            return {
              column: column,
              value: row[column]
            };
          });
        })
        .text(function(d) {return d.value;});
        
      })
      
      gd
      .on('click', function(d){

        var newdata = data1.filter(f => f.geo == 'gd')
        newdata.forEach(function(v){ delete v.geo });

        button
        .style("color","#FFFFFF")
        .style("background-color", "#D3D3D3")
        
        gd
        .style("background-color", "#FFFFFF")
        .style("color","#242358")
        
        businesses
          .text(d3.format("(,.2r")(rows[1].businesses))
        population
          .text(d3.format("(,.2r")(rows[1].population))
        employees
          .text(d3.format("(,.2r")(rows[1].employees))


        tbody.selectAll("tr")
        .data(newdata)
        .selectAll("td")
        .data(function(row) {
          return columns.map(function(column) {
            return {
              column: column,
              value: row[column]
            };
          });
        })
        .text(function(d) {return d.value;});
        
      })

      dda
      .on('click', function(d){

        var newdata = data1.filter(f => f.geo == 'dda')
        newdata.forEach(function(v){ delete v.geo });

        button
        .style("color","#FFFFFF")
        .style("background-color", "#D3D3D3")
        
        dda
        .style("background-color", "#FFFFFF")
        .style("color","#242358")
        
        businesses
          .text(d3.format("(,.2r")(rows[2].businesses))
        population
          .text(d3.format("(,.2r")(rows[2].population))
        employees
          .text(d3.format("(,.2r")(rows[2].employees))


        tbody.selectAll("tr")
        .data(newdata)
        .selectAll("td")
        .data(function(row) {
          return columns.map(function(column) {
            return {
              column: column,
              value: row[column]
            };
          });
        })
        .text(function(d) {return d.value;});
        
      })

      cbd
      .on('click', function(d){

        var newdata = data1.filter(f => f.geo == 'cbd')
        newdata.forEach(function(v){ delete v.geo });

        button
        .style("color","#FFFFFF")
        .style("background-color", "#D3D3D3")
        
        cbd
        .style("background-color", "#FFFFFF")
        .style("color","#242358")

        businesses
          .text(d3.format("(,.2r")(rows[3].businesses))
        population
          .text(d3.format("(,.2r")(rows[3].population))
        employees
          .text(d3.format("(,.2r")(rows[3].employees))


        tbody.selectAll("tr")
        .data(newdata)
        .selectAll("td")
        .data(function(row) {
          return columns.map(function(column) {
            return {
              column: column,
              value: row[column]
            };
          });
        })
        .text(function(d) {return d.value;});
        
      })

      ae
      .on('click', function(d){

        var newdata = data1.filter(f => f.geo == 'ae')
        newdata.forEach(function(v){ delete v.geo });

        button
        .style("color","#FFFFFF")
        .style("background-color", "#D3D3D3")
        
        ae
        .style("background-color", "#FFFFFF")
        .style("color","#242358")
        
        businesses
          .text(d3.format("(,.2r")(rows[4].businesses))
        population
          .text(d3.format("(,.2r")(rows[4].population))
        employees
          .text(d3.format("(,.2r")(rows[4].employees))


        tbody.selectAll("tr")
        .data(newdata)
        .selectAll("td")
        .data(function(row) {
          return columns.map(function(column) {
            return {
              column: column,
              value: row[column]
            };
          });
        })
        .text(function(d) {return d.value;});
        
      })

      brickell
      .on('click', function(d){

        var newdata = data1.filter(f => f.geo == 'brickell')
        newdata.forEach(function(v){ delete v.geo });

        button
        .style("color","#FFFFFF")
        .style("background-color", "#D3D3D3")
        
        brickell
        .style("background-color", "#FFFFFF")
        .style("font-color","#242358")
        
        businesses
          .text(d3.format("(,.2r")(rows[5].businesses))
        population
          .text(d3.format("(,.2r")(rows[5].population))
        employees
          .text(d3.format("(,.2r")(rows[5].employees))


        tbody.selectAll("tr")
        .data(newdata)
        .selectAll("td")
        .data(function(row) {
          return columns.map(function(column) {
            return {
              column: column,
              value: row[column]
            };
          });
        })
        .text(function(d) {return d.value;});
        
      })
      
        
      });
    });

range = document.querySelector(".range");
bubble = document.querySelector(".bubble");

max = parseInt(range.max)
min = parseInt(range.min)

window.step = 0

$('.div-block-6').waypoint(function(direction){

if (window.step == 0){
(async () => {
  for(let i = min; i < max+1; i++) {
    await new Promise(resolve => setTimeout(() => {
      range.value = i
      range.dispatchEvent(new Event('change'));
      setBubble(range, bubble);
      resolve();
    }, 500));
    if (i == max+1){
      window.step =1
    }
  }
})();
}

},{
 //bottom-in-view will ensure event is thrown when the element's bottom crosses
 //bottom of viewport.
 offset: 'bottom-in-view'
});

</script>

