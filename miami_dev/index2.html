
<!DOCTYPE html>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="style.css">
<link href="css/normalize.css" rel="stylesheet" type="text/css"> 
<link href="css/webflow.css" rel="stylesheet" type="text/css">
<script src="https://d3js.org/d3.v4.js"></script>
<script src="https://d3js.org/d3-geo-projection.v1.min.js"></script>
<script src="https://d3js.org/d3-array.v1.min.js"></script>
<script src="https://d3js.org/d3-format.v2.min.js"></script>
<script src="https://d3js.org/d3-geo.v1.min.js"></script>
<script src="https://clynekp.github.io/d3-tip.min.js"></script>
<script src="https://d3js.org/d3-scale.v3.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3-annotation/1.12.1/d3-annotation.min.js"></script>

<title>Miami DDA Office Report</title>

<script type="text/javascript">WebFont.load({  google: {    families: ["Varela Round:400","Cabin:regular,500,500italic,600,600italic,700"]  }});</script>
<!-- [if lt IE 9]><script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.min.js" type="text/javascript"></script><![endif] -->
<script type="text/javascript">!function(o,c){var n=c.documentElement,t=" w-mod-";n.className+=t+"js",("ontouchstart"in o||o.DocumentTouch&&c instanceof DocumentTouch)&&(n.className+=t+"touch")}(window,document);</script>
<style>

body{
  margin: 0px auto;
  font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
}

h1{
  margin: 50px;
}

h1{
  text-align: center;
}

p{
  z-index:500;
  text-align: center
}
#container{
  position: relative;
}

#sections{
    width: auto;
    position: relative;
    margin: 0px auto;
    margin-left: 50%;
    margin-right: 25%;    
}



#sections > div{
    padding: 10px;
    margin-bottom: 80vh;
    opacity: .5;
}

#sections p{
  background: rgba(255,255,255,.5);
  padding:2em;
}
#sections > div:last-child{
  margin-bottom: 30px;
}
#sections > div.graph-scroll-active{
  opacity: 1;
}

#graph{
  width: 100%;
  position: -webkit-sticky;
  position: sticky;
  top: 0px;
}

@media (max-width: 925px)  {
  #graph{
    width: 100%;
    margin-left: 0px;
    float: none;
  }

  #sections{
    width: auto;
    position: relative;
    margin: 0px auto;
  }

  #sections > div{
    background: rgba(255,255,255,.5);
    padding: 10px;
    border-top: 1px solid;
    border-bottom: 1px solid;
    margin-bottom: 80vh;
  }

  pre{
    overflow: hidden;
  }

  h1{
    margin: 10px;
  }
}


circle{
  fill: steelblue;
}

.mono{
  font-family: monospace;
}

svg{
  background-color: #eee;
}

</style>
<br>
<br>
<div id='container' class='container-1'>
  <div id='graph' class ="tab04">
    <div class="tab04_container">
              <div data-duration-in="300" data-duration-out="100" data-easing="ease-out" class="tab04_tabs w-tabs">
                <div class="tab04_menu w-tab-menu">
                  <a data-w-tab="Tab 1" class="tab04_tab w-inline-block w-tab-link w--current" id="both" style="display:inherit !important">
                    <img src="images/rent.svg" alt="" class="tab04_icon">
                    <div class="tab04_title">Rents</div>
                  </a>
                  <a data-w-tab="Tab 3" class="tab04_tab w-inline-block w-tab-link" id="vacancy" style="display:inherit !important"><img src="images/vacancy.svg" alt="" class="tab04_icon">
                    <div class="tab04_title">Vacancy</div>
                  </a>
                  <a data-w-tab="Tab 4" class="tab04_tab w-inline-block w-tab-link" id="absorption" style="display:inherit !important"><img src="images/absorption.svg" alt="" class="tab04_icon">
                    <div class="tab04_title">Absorption</div>
                  </a>
                </div>
                <div class="tab04_content w-tab-content" id="contentpane">
                  <svg data-w-tab="Tab 1" class="tab04_pane w-tab-pane w--tab-active" id="rentvis"></svg>
                  <svg data-w-tab="Tab 3" class="tab04_pane w-tab-pane" id="vacancyvis"></svg>
                  <svg data-w-tab="Tab 4" class="tab04_pane w-tab-pane" id= "absorbvis"></svg>
                </div>
              </div>
            </div>
  </div>
  <div id='sections'>
    <div>
    </div>

    <div>
     <p>Rents have remained stable in Downtown Miami despite slower absorption and higher vacancy.</p>
    </div>


    <div>
      <p>Class A office rents have buoyed the overall figure, demonstrating continuing demand for high-caliber workplaces compared to other major markets which saw sharp decreases following the beginning of the COVID-19 pandemic.</p>
    </div>

    <div>
      <p>Downtown Miami's vacancy rate has increased as a result of COVID, reversing a recent downward trend.</p>
    </div>

    <div>
      <p>However, the overal vacancy impact on Downtown Miami has been limited compared to other major markets.</p>
    </div>

    <div>
      <p>While early 2020 saw weak absorption, a recent uptick in lease deals in Q4 are quickly reversing those trends. Developers and brokers are seeing increasing new-to-market activity and expect to see that reflected in vacancy and absorption data by mid-year 2021.
      </p>
    </div>
        <div>

    </div>

  </div>

</div>

<h1>
  
</h1>

<div id='container' class='container-2'>
  <div id='graph'></div>

  <div id='sections'>
    <div>
     
    </div>

    <div>
      
    </div>

    <div>
     
   </div>

    <div>
    
  </div>


</div>



<script src="test/d3v4+jetpack.js"></script>
<script src="test/graph-scroll.js"></script>
<script>

var oldWidth = 0
function render(){
  if (oldWidth == innerWidth) return
  oldWidth = innerWidth

  var width = height = d3.select('#rentvis').node().offsetWidth
  var r = 40


  if (innerWidth <= 925){
    width = innerWidth
    height = innerHeight*.7
  }

  // return console.log(width, height)

let dataset, svg
let salarySizeScale, salaryXScale, categoryColorScale
let simulation, nodes
let categoryLegend, salaryLegend


//Read Data, convert numerical categories into floats
//Create the initial visualisation


d3.csv("https://docs.google.com/spreadsheets/d/1LMADV7lzfx1rC6AzkrUp8uwe5XuXR8sd3KDeashPmB8/gviz/tq?tqx=out:csv&gid=1356831804", function(d){
  return{
    location: d.location,
    class: d.class,
    year: d.year,
    rent: +d.rent,
    vacancy: +d.vacancy,
    absorption: d.absorption,
  };
}, function(error, rows){
if (error) throw error;

  //  setTimeout(drawInitial(), 100)
//})


nested = d3.nest().key(function(d){return d.location}).entries(rows)
nestkeys = nested.map(function(d){return d.key;})



var vis = d3.select("#rentvis")
var margin = {top: 20, right: 20, bottom: 95, left: 60};
element = vis.node();
width = element.getBoundingClientRect().width - margin.left - margin.right,
height = element.getBoundingClientRect().height - margin.top - margin.bottom;

rentsvg = d3
  .select("#rentvis")
    .attr("width", width + margin.left + margin.right - 20)
    .attr("height", height + margin.top + margin.bottom)

    const rentchart = rentsvg
    .append("g")
    .attr("transform", `translate(${margin.left},0)`);

const rentgrp = rentchart
  .append("g")
  .attr("transform", `translate(-${margin.left},-${margin.top})`);

// Create scales
const RentyScale = d3
  .scaleLinear()
  .range([height, 0])
  .domain([0, d3.max(rows, d => d.rent + 5)]);
const RentxScale = d3
  .scalePoint()
  .range([0, width-40])
  .domain(rows.map(function(d){ return d.year; }));

const Rentline = d3
  .line()
  .x(d => RentxScale(d.year))
  .y(d => RentyScale(d.rent));


nestkeys.forEach(function(d){

    data =  rows.filter(f => f.location == d)
    
    path = rentgrp
      .append("path")
      .attr("class",d + "_rentpath")
      .attr("d", Rentline(data))
      .attr("transform", `translate(${margin.left},0)`)
      .attr("fill", "none")
      .attr("stroke", "steelblue")
      .attr("stroke-linejoin", "round")
      .attr("stroke-linecap", "round")
      .attr("stroke-width", 1.5)

    pathLength = path.node().getTotalLength();

    path
  .attr("stroke-dashoffset", pathLength)
  .attr("stroke-dasharray", pathLength)


rentgrp.append("text")
    .text(d)
    .attr("class",d+"_rentlabel")
    .attr("x",RentxScale(d3.max(RentxScale.domain())) + 5)
    .attr("y",RentyScale(data[data.length-1 ].rent))
    .attr("transform", `translate(${margin.left},0)`)
    .attr("opacity",0)


})


// Add the X Axis
rentchart
  .append("g")
  .attr("transform", `translate(0,${height})`)
  .call(d3.axisBottom(RentxScale)
.tickValues(RentxScale.domain().filter(function(d,i){ return !(i%4)})));
// Add the Y Axis
rentchart
  .append("g")
  .attr("transform", `translate(0, 0)`)
  .call(d3.axisLeft(RentyScale).tickFormat(d3.format("($.0f")));



/////VACANCY
vacancysvg = d3
  .select("#vacancyvis")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)

    const vacancychart = vacancysvg
    .append("g")
    .attr("transform", `translate(${margin.left},0)`);

const vacancygrp = vacancychart
  .append("g")
  .attr("transform", `translate(-${margin.left},-${margin.top})`);

// Create scales
const vacancyyScale = d3
  .scaleLinear()
  .range([height, 0])
  .domain([0, d3.max(rows, d => d.vacancy + .02)]);
const vacancyxScale = d3
  .scalePoint()
  .range([0, width-40])
  .domain(rows.map(function(d){ return d.year; }));

const vacancyline = d3
  .line()
  .x(d => vacancyxScale(d.year))
  .y(d => vacancyyScale(d.vacancy));

nestkeys.forEach(function(d){

    data =  rows.filter(f => f.location == d)
    
    path = vacancygrp
      .append("path")
      .attr("class",d + "_vacancypath")
      .attr("d", vacancyline(data))
      .attr("transform", `translate(${margin.left},0)`)
      .attr("fill", "none")
      .attr("stroke", "steelblue")
      .attr("stroke-linejoin", "round")
      .attr("stroke-linecap", "round")
      .attr("stroke-width", 1.5)

    pathLength = path.node().getTotalLength();

    path
  .attr("stroke-dashoffset", pathLength)
  .attr("stroke-dasharray", pathLength)

  vacancygrp.append("text")
    .text(d)
    .attr("class",d+"_vacancylabel")
    .attr("x",vacancyxScale(d3.max(vacancyxScale.domain())) + 5)
    .attr("y",vacancyyScale(data[data.length-1 ].vacancy))
    .attr("transform", `translate(${margin.left},0)`)
    .attr("opacity",0)


})

// Add the X Axis
vacancychart
  .append("g")
  .attr("transform", `translate(0,${height})`)
  .call(d3.axisBottom(vacancyxScale)
.tickValues(vacancyxScale.domain().filter(function(d,i){ return !(i%4)})));
// Add the Y Axis
vacancychart
  .append("g")
  .attr("transform", `translate(0, 0)`)
  .call(d3.axisLeft(vacancyyScale)
    .tickFormat(d3.format(".0%")));



//////Absorption
absvg = d3
  .select("#absorbvis")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)

    const abchart = absvg
    .append("g")
    .attr("transform", `translate(${margin.left},0)`);

const abgrp = abchart
  .append("g")
  .attr("transform", `translate(-${margin.left},-${margin.top})`);

// Create scales
const abyScale = d3
  .scaleLinear()
  .range([height, 0])
  .domain([d3.min(rows, d => +d.absorption + .02), d3.max(rows, d => +d.absorption + .02)]);
const abxScale = d3
  .scalePoint()
  .range([0, width-40])
  .domain(rows.map(function(d){ return d.year; }));

const abline = d3
  .line()
  .x(d => abxScale(d.year))
  .y(d => abyScale(+d.absorption));

nestkeys.forEach(function(d){

    data =  rows.filter(f => f.location == d)
    
    console.log(data)
    path = abgrp
      .append("path")
      .attr("class",d + "_abpath")
      .attr("d", abline(data))
      .attr("transform", `translate(${margin.left},0)`)
      .attr("fill", "none")
      .attr("stroke", "steelblue")
      .attr("stroke-linejoin", "round")
      .attr("stroke-linecap", "round")
      .attr("stroke-width", 1.5)

    pathLength = path.node().getTotalLength();

    path
  .attr("stroke-dashoffset", pathLength)
  .attr("stroke-dasharray", pathLength)

  abgrp.append("text")
    .text(d)
    .attr("class",d+"_ablabel")
    .attr("x",abxScale(d3.max(abxScale.domain())) + 5)
    .attr("y",abyScale(+data[data.length-1 ].absorption))
    .attr("transform", `translate(${margin.left},0)`)
    .attr("opacity",0)


})

// Add the X Axis
abchart
  .append("g")
  .attr("transform", `translate(0,${height})`)
  .call(d3.axisBottom(abxScale)
.tickValues(abxScale.domain().filter(function(d,i){ return !(i%4)})));
// Add the Y Axis
abchart
  .append("g")
  .attr("transform", `translate(0, 0)`)
  .call(d3.axisLeft(abyScale));


////Annotations
const annotations = [
        {
          note: { 
            title: "COVID-19", 
            lineType: "none", 
            align: "middle",
            wrap: 150 //custom text wrapping
          },
          subject: {
            height: height,
            width: RentxScale(RentxScale.domain()[43]) - RentxScale(RentxScale.domain()[41])
          },
          type: d3.annotationCalloutRect,
          y: 1,
          disable: ["connector"], // doesn't draw the connector
          //can pass "subject" "note" and "connector" as valid options
          dx: (RentxScale(RentxScale.domain()[43]) - RentxScale(RentxScale.domain()[41]))/2,
          data: { x: RentxScale.domain()[41]}
        }]


const type = d3.annotationCustomType(
        d3.annotationBadge, 
        {"subject":{"radius": 10 }}
      )

const makeAnnotations = d3.annotation()
        .type(type)
        .accessors({ 
          x: function(d){ return RentxScale(d.x)},
          y: function(d){ return RentyScale(d.y) }
        })
        .annotations(annotations)

      rentchart
        .append("g")
        .attr("class", "annotation-group")
        .call(makeAnnotations)



const vacannotations = [
        {
          note: { 
            title: "COVID-19", 
            lineType: "none", 
            align: "middle",
            wrap: 150 //custom text wrapping
          },
          subject: {
            height: height,
            width: vacancyxScale(vacancyxScale.domain()[43]) - vacancyxScale(vacancyxScale.domain()[41])
          },
          type: d3.annotationCalloutRect,
          y: 1,
          disable: ["connector"], // doesn't draw the connector
          //can pass "subject" "note" and "connector" as valid options
          dx: (vacancyxScale(vacancyxScale.domain()[43]) - vacancyxScale(vacancyxScale.domain()[41]))/2,
          data: { x: vacancyxScale.domain()[41]}
        }]


const makevacAnnotations = d3.annotation()
        .type(type)
        .accessors({ 
          x: function(d){ return vacancyxScale(d.x)},
          y: function(d){ return vacancyScale(d.y) }
        })
        .annotations(vacannotations)

      vacancychart
        .append("g")
        .attr("class", "annotation-group")
        .call(makevacAnnotations)

const abannotations = [
        {
          note: { 
            title: "COVID-19", 
            lineType: "none", 
            align: "middle",
            wrap: 150 //custom text wrapping
          },
          subject: {
            height: height,
            width: abxScale(abxScale.domain()[43]) - abxScale(abxScale.domain()[41])
          },
          type: d3.annotationCalloutRect,
          y: 1,
          disable: ["connector"], // doesn't draw the connector
          //can pass "subject" "note" and "connector" as valid options
          dx: (abxScale(abxScale.domain()[43]) - abxScale(abxScale.domain()[41]))/2,
          data: { x: abxScale.domain()[41]}
        }]


const makeabAnnotations = d3.annotation()
        .type(type)
        .accessors({ 
          x: function(d){ return abxScale(d.x)},
          y: function(d){ return abScale(d.y) }
        })
        .annotations(abannotations)

      abchart
        .append("g")
        .attr("class", "annotation-group")
        .call(makeabAnnotations)

// Tooltip

var bisect = d3.bisector(function(d) { return d.year; }).left;

var tooltip = d3.select(".tab04_content.w-tab-content").append("div")
    .attr("class", "tooltip")
    .style("display", "none");

var focus = rentgrp.append("g")
            .attr("class", "focus")
            .style("display", "none");

focus.append("circle")
    .attr("r", 5);

var tooltipDate = tooltip.append("div")
    .attr("class", "tooltip-date");

var tooltipLikes = tooltip.append("div");
tooltipLikes.append("span")
    .attr("class", "tooltip-title")
    .text("Gross Rent PSF: ");

var tooltipLikesValue = tooltipLikes.append("span")
    .attr("class", "tooltip-likes");

rentchart.append("rect")
    .attr("class", "ttoverlay")
    .attr("width", width)
    .attr("height", height)
    .on("mouseover", function() { focus.style("display", null); tooltip.style("display", null);  })
    .on("mouseout", function() { focus.style("display", "none"); tooltip.style("display", "none"); })
    .on("mousemove", mousemove);

function mousemove() {
    var xPos = d3.mouse(this)[0];
    var domain = RentxScale.domain();
    var range = RentxScale.range();
    var rangePoints = d3.range(range[0], range[1], RentxScale.step());

    var x0 = domain[d3.bisect(rangePoints, xPos) ];
        i = bisect(rows, x0, 0),
        d0 = rows[i - 1],
        d1 = rows[i],
        d = x0 - d0.year > d1.year - x0 ? d1 : d0;
    focus.attr("transform", "translate(" + (RentxScale(d.year) + margin.left) + "," + RentyScale(d.rent) + ")");
    tooltip.attr("style", "left:" + (RentxScale(d.year) + 64) + "px;top:" + RentyScale(d.rent) + "px;");
    tooltip.select(".tooltip-date").text(d.year);
    tooltip.select(".tooltip-likes").text(d3.format("($.2f")(d.rent));

}

});




function draw1(){

}
function draw2(){
d3.select(".Miami_rentpath")
    .transition()
  .ease(d3.easeSin)
  .duration(5000)
  .attr("stroke-dashoffset", 0);

d3.select(".Miami_rentlabel")
    .transition()
    .delay(6000)
  .duration(500)
  .attr("opacity", 1);



}

function draw3(){

d3.select(".NY_rentpath")
    .transition()
  .ease(d3.easeSin)
  .duration(5000)
  .attr("stroke-dashoffset", 0);

d3.select(".Chicago_rentpath")
    .transition()
  .ease(d3.easeSin)
  .duration(5000)
  .attr("stroke-dashoffset", 0);

d3.select(".SF_rentpath")
    .transition()
  .ease(d3.easeSin)
  .duration(5000)
  .attr("stroke-dashoffset", 0);

d3.select(".NY_rentlabel")
    .transition()
      .transition()
    .delay(6000)
  .duration(500)
  .attr("opacity", 1);

d3.select(".SF_rentlabel")
    .transition()
      .transition()
    .delay(6000)
  .duration(500)
  .attr("opacity", 1);

d3.select(".Chicago_rentlabel")
    .transition()
      .transition()
    .delay(6000)
  .duration(500)
  .attr("opacity", 1);



}

function draw4(){

document.getElementById('vacancy').click();

d3.select(".Miami_vacancypath")
    .transition()
  .ease(d3.easeSin)
  .duration(5000)
  .attr("stroke-dashoffset", 0);

d3.select(".Miami_vacancylabel")
    .transition()
    .delay(6000)
  .duration(500)
  .attr("opacity", 1);

}



function draw5(){
 
d3.select(".NY_vacancypath")
    .transition()
  .ease(d3.easeSin)
  .duration(5000)
  .attr("stroke-dashoffset", 0);

d3.select(".Chicago_vacancypath")
    .transition()
  .ease(d3.easeSin)
  .duration(5000)
  .attr("stroke-dashoffset", 0);

d3.select(".SF_vacancypath")
    .transition()
  .ease(d3.easeSin)
  .duration(5000)
  .attr("stroke-dashoffset", 0);


d3.select(".NY_vacancylabel")
    .transition()
    .delay(6000)
  .duration(500)
  .attr("opacity", 1);
d3.select(".Chicago_vacancylabel")
    .transition()
    .delay(6000)
  .duration(500)
  .attr("opacity", 1);

d3.select(".SF_vacancylabel")
    .transition()
    .delay(6000)
  .duration(500)
  .attr("opacity", 1);

}

function draw6(){
document.getElementById('absorption').click();

d3.select(".Miami_abpath")
    .transition()
  .ease(d3.easeSin)
  .duration(5000)
  .attr("stroke-dashoffset", 0);

d3.select(".Miami_ablabel")
    .transition()
    .delay(6000)
  .duration(500)
  .attr("opacity", 1);

}

      

      let functions = [
        draw1,
    draw2,
    draw3,
    draw4,
    draw5, 
    draw6]

  var gs = d3.graphScroll()
      .container(d3.select('.container-1'))
      .graph(d3.selectAll('container-1 #graph'))
      .eventId('uniqueId1')  // namespace for scroll and resize events
      .sections(d3.selectAll('.container-1 #sections > div'))
      // .offset(innerWidth < 900 ? innerHeight - 30 : 200)
      .on('active', function(i){
        functions[i]()
      })

      /*
  var svg2 = d3.select('.container-2 #graph').html('')
    .append('svg')
      .attrs({width: width, height: height})

  var path = svg2.append('path')

  var gs2 = d3.graphScroll()
      .container(d3.select('.container-2'))
      .graph(d3.selectAll('.container-2 #graph'))
      .eventId('uniqueId2')  // namespace for scroll and resize events
      .sections(d3.selectAll('.container-2 #sections > div'))
      .on('active', function(i){
        var h = height
        var w = width
        var dArray = [
          [[w/4, h/4], [w*3/4, h/4],  [w*3/4, h*3/4], [w/4, h*3/4]],
          [[0, 0],     [w*3/4, h/4],  [w*3/4, h*3/4], [w/4, h*3/4]],
          [[w/2, h/2], [w, h/4],      [w, h],         [w/4, h]],
          [[w/2, h/2], [w, h/4],      [w, h],         [w/4, h]],
          [[w/2, h/2], [w, h/2],      [0, 0],         [w/4, h/2]],
          [[w/2, h/2], [0, h/4],      [0, h/2],         [w/4, 0]],
        ].map(function(d){ return 'M' + d.join(' L ') })


        path.transition().duration(1000)
            .attr('d', dArray[i])
            .style('fill', colors[i])
      })

    */
}
render()
d3.select(window).on('resize', render)


</script>
    <script src="https://d3e54v103j8qbb.cloudfront.net/js/jquery-3.5.1.min.dc5e7f18c8.js?site=6041a54707ac14648370b006" type="text/javascript" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <script src="webflow.js" type="text/javascript"></script>