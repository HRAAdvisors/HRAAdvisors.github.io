
<!DOCTYPE html>
<html data-wf-page="601c049ad82b2e1c184dbcae" data-wf-site="601c049a7d7f2b0e4f241841">
<head>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="style.css">
<link href="css/normalize.css" rel="stylesheet" type="text/css"> 
<link href="css/webflow.css" rel="stylesheet" type="text/css">
  <link href="css/miami-dda-office-report.webflow.css" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&display=swap" rel="stylesheet">
    <link href='css/dda.css' rel='stylesheet' />
<script src="https://d3js.org/d3.v4.js"></script>
<script src="https://d3js.org/d3-geo-projection.v1.min.js"></script>
<script src="https://d3js.org/d3-array.v1.min.js"></script>
<script src="https://d3js.org/d3-format.v2.min.js"></script>
<script src="https://d3js.org/d3-geo.v1.min.js"></script>
<script src="https://clynekp.github.io/d3-tip.min.js"></script>
<script src="https://d3js.org/d3-scale.v3.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.25.6/d3-legend.min.js" integrity="sha512-wNH6xsp2n8CfB91nrBtfc4sfLwYPBMjSWVUwQOp60AYYXH6i8yCwuKFZ4rgK2i6pQek/b+bSyR7b01/922IBzQ==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3-annotation/1.12.1/d3-annotation.min.js"></script>
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.5.1/mapbox-gl-geocoder.min.js"></script>
<link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.5.1/mapbox-gl-geocoder.css" type="text/css" />
<script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.auto.min.js"></script>
<script src="deckgl.min.js"></script>
<script src="https://api.mapbox.com/mapbox-gl-js/v2.1.1/mapbox-gl.js"></script>
<link href="https://api.mapbox.com/mapbox-gl-js/v2.1.1/mapbox-gl.css" rel="stylesheet" />

<title>Miami DDA Office Report</title>
<script src="https://ajax.googleapis.com/ajax/libs/webfont/1.6.26/webfont.js" type="text/javascript"></script>
<script type="text/javascript">WebFont.load({  google: {    families: ["Varela Round:400","Cabin:regular,500,500italic,600,600italic,700"]  }});</script>
  <script type="text/javascript">WebFont.load({  google: {    families: ["Montserrat:100,100italic,200,200italic,300,300italic,400,400italic,500,500italic,600,600italic,700,700italic,800,800italic,900,900italic"]  }});</script>
<!-- [if lt IE 9]><script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.min.js" type="text/javascript"></script><![endif] -->
<script type="text/javascript">!function(o,c){var n=c.documentElement,t=" w-mod-";n.className+=t+"js",("ontouchstart"in o||o.DocumentTouch&&c instanceof DocumentTouch)&&(n.className+=t+"touch")}(window,document);</script>
<style>
div.tooltip2 { 
    position: absolute;     
    text-align: center;               
    padding: 10px;       
    font: 12px sans-serif;    
    background: #fff;
    border: 2px solid #000;   
    border-radius: 5px;     
    pointer-events: none;
    -moz-border-radius:5px;
    color: black
    z-index: 10;     
}

body{
  margin: 0px auto;

}

*,
*::before,
*::after {
  box-sizing: border-box;
}

*:focus { outline: none; }

:root {
  --select-border: #777;
  --select-focus: blue;
  --select-arrow: var(--select-border);
}

select {
  // A reset of styles, including removing the default dropdown arrow
  appearance: none;
  background-color: transparent;
  border: none;
  padding: 0 1em 0 0;
  margin: 0;
  width: 100%;
  font-family: inherit;
  font-size: inherit;
  cursor: inherit;
  line-height: inherit;

  // Stack above custom arrow
  z-index: 1;

  // Remove dropdown arrow in IE10 & IE11
  // @link https://www.filamentgroup.com/lab/select-css.html
  &::-ms-expand {
    display: none;
  }

  // Remove focus outline, will add on alternate element
  outline: none;
}

.select {
  display: grid;
  grid-template-areas: "select";
  align-items: center;
  position: relative;

  select,
  &::after {
    grid-area: select;
  }

  min-width: 15ch;
  max-width: 30ch;

  border: 1px solid var(--select-border);
  border-radius: 0.25em;
  padding: 0.25em 0.5em;

  font-size: 1.25rem;
  cursor: pointer;
  line-height: 1.1;

  // Optional styles
  // remove for transparency
  background-color: #fff;
  background-image: linear-gradient(to top, #f9f9f9, #fff 33%);

  // Custom arrow
  &:not(.select--multiple)::after {
    content: "";
    justify-self: end;
    width: 0.8em;
    height: 0.5em;
    background-color: var(--select-arrow);
    clip-path: polygon(100% 0%, 0 0%, 50% 100%);
  }
}

// Interim solution until :focus-within has better support
select:focus + .focus {
  position: absolute;
  top: -1px;
  left: -1px;
  right: -1px;
  bottom: -1px;
  border: 2px solid var(--select-focus);
  border-radius: inherit;
}

select[multiple] {
  padding-right: 0;

  /*
   * Safari will not reveal an option
   * unless the select height has room to 
   * show all of it
   * Firefox and Chrome allow showing 
   * a partial option
   */
  height: 6rem;

  option {
    white-space: normal;

    // Only affects Chrome
    outline-color: var(--select-focus);
  }

  /* 
   * Experimental - styling of selected options
   * in the multiselect
   * Not supported crossbrowser
   */
  //   &:not(:disabled) option {
  //     border-radius: 12px;
  //     transition: 120ms all ease-in;

  //     &:checked {
  //       background: linear-gradient(hsl(242, 61%, 76%), hsl(242, 61%, 71%));
  //       padding-left: 0.5em;
  //       color: black !important;
  //     }
  //   }
}

.select--disabled {
  cursor: not-allowed;
  background-color: #eee;
  background-image: linear-gradient(to top, #ddd, #eee 33%);
}

label {
  font-size: 1.125rem;
  font-weight: 500;
}

.select + label {
  margin-top: 2rem;
}

.grid-content{
  background-color: rgb(243 242 242) !important
}
p{
  z-index:500;
}

.line {
  fill: none;
  stroke: #FFFFFF;
  stroke-width: 2px;
}

.selected{
  stroke: #EF5285;
}

.tooltip {
  position: absolute;
  top: 100px;
  left: 100px;
  -moz-border-radius:5px;
  border-radius: 5px;
  border: 2px solid #000;
  background: #fff;
  opacity: .9;
  color: black;
  padding: 10px;
  width: 300px;
  font-size: 12px;
  z-index: 10;
}

.tooltip .title {
  font-size: 13px;
}

.tooltip .name {
  font-weight:bold;
}

h1{
  text-align: left;
}

p{
  z-index:500;
}

.tick line{
  visibility:hidden;
}

.axis text{ 
  font: 14px Nunito;
  font-weight: bold;
  fill: #b1b1b1;}

  .axis path{ 
  stroke: #b1b1b1;}

#container{
  position: relative;
}

#sections{
    width: auto;
    position: relative;
    margin: 0px auto;
    margin-left: 60vw;
    margin-right: 10vw;    
}



#sections > div{
    padding: 10px;
    margin-bottom: 80vh;
    opacity: .5;
}

#sections p{
  background: rgba(255,255,255,.5);
  padding:2em;
  text-align: center
}
#sections > div:last-child{
  margin-bottom: 30px;
}
#sections > div.graph-scroll-active{
  opacity: 1;
}

#graph{
  width: 100%;
  position: -webkit-sticky;
  position: sticky;
  top: 0px;
}

.map {
  height: 85vh;
  width: 100%;
  position: -webkit-sticky;
  position: sticky;
  top: 100px;
}
#map2{

    width: 100%;
}

.clabelsswatch{
  stroke-width: 3;
}


.clabelslabel{
  fill: #B1B1B1;
}

#map3 {
  height: 100%;
  width: 100%;
  position: -webkit-sticky;
  position: sticky;
  top: 100px;
}

  #menu{
    margin:10px;
  }

.container-2 p{
  background: rgb(255 255 255 / 88%) !important;
}

/*.container-2 #sections{
  margin-left: 30% !important
}
*/

@media screen and (max-width: 925px)  {

.grid-3 {

    grid-template-columns: 1fr;
}
  .div-block-43{
    font-size: 7px;
  }

  .div-block-43 td{
    padding: 0px;
  }

  .histaxis{
    font-size: 7px;
  }
  .list{
    text-align: left;
  }
  #graph{
    width: 100%;
    margin-left: 0px;
    float: none;
  }

   #menu {
        background: white;
        font-family: 'Nunito', sans-serif;
        font-size: 15px;
        position: absolute;
        z-index: 1;
        top: 20px;
        left: 20px;
        right: 20px;
        width: 10vw;
        display: inline-block;
        color: #fff;
        box-shadow: 1.5px 1.5px 2px rgba(0, 0, 0, 0.2);
        -moz-box-shadow: 1.5px 1.5px 2px rgba(0, 0, 0, 0.2);
        -webkit-box-shadow: 1.5px 1.5px 2px rgba(0, 0, 0, 0.2)
      }

  #sections{
    width: auto;
    position: relative;
    margin: 0px auto;
  }

  #sections > div{
    padding: 10px;
    margin-bottom: 80vh;
  }



  pre{
    overflow: hidden;
  }

  h1{
    margin: 10px;
  }
}

  .on {
        background: white url("../style/check1.svg") no-repeat right;
        background-origin: content-box;
        background-size: 18px 18px;
        display: block;
        margin: 0px;
        position: relative;
        z-index:200;
        width: 10vw;
        padding: 10px;
        color: black;
        border-bottom: 1px solid #8D9192;
    }
.bordertop{border-top: 1px solid #8D9192;}
    .on:hover {
        background: #51b3c9 url("../style/check1hover.svg") no-repeat right;
        background-origin: content-box;
        background-size: 18px 18px;
        color: white;
    }
    .off {
        background: white url("../style/check3.svg") no-repeat right;
        background-origin: content-box;
        background-size: 18px 18px;
        color: black;
        display: block;
        margin: 0;
        padding: 0;
        padding: 10px;
        border-bottom: 1px solid #8D9192;
    }
    .off:hover {
        background: #51b3c9 url("../style/check3hover.svg") no-repeat right;
        background-origin: content-box;
        background-size: 18px 18px;
        color: white;
    }
    .legend {
        padding: 10px;
        background: #fff;
        color: #C7354D;
        vertical-align:middle;
    }
    .row {
        display: table-row;
    }
    .noborder {
        border-bottom: 0px solid white;
    }

    html {
  scroll-behavior: smooth;
}



.mono{
  font-family: monospace;
}

@media print {
    #print{
      display: block !important;
      width: 97%;
    }

    #body {
        display: none;
    }


}


</style>
<style type="text/css">
      .mapboxgl-ctrl-logo{
        display:none !important;
      }
      .mapboxgl-ctrl-bottom-right{
        display:none !important;
      }
      .mapboxgl-ctrl-bottom-left{
        display:none !important;
      }

      .css-9emwa5{
        display:none !important;
      }
      .deck-tooltip {
        font-family: Helvetica, Arial, sans-serif;
        padding: 6px !important;
        margin: 8px;
        max-width: 300px;
        font-size: 10px;
      }
    </style>
</head>
<body>
  <img id="print" style="display:none" src="https://raw.githubusercontent.com/HRAAdvisors/HRAAdvisors.github.io/master/miami_development/office/Slide1.PNG" frameborder="0" allowfullscreen scrolling="no"></img>
<img id="print" style="display:none" src="https://raw.githubusercontent.com/HRAAdvisors/HRAAdvisors.github.io/master/miami_development/office/Slide2.PNG" frameborder="0" allowfullscreen scrolling="no"></img>
  <div id="body">
  <div style="height:5.2em">
  <iframe id="iframe" width=100% src="header.html" frameborder="0" allowfullscreen scrolling="no"></iframe></div>
  <div id="tooltip"></div>
  <div class="section cc-store-home-wrap">
    <div class="intro-header">
      <div class="intro-content cc-homepage">
        <div class="intro-text">
          <div class="heading-jumbo">DOWNTOWN MIAMI</div>
          <div class="paragraph-bigger cc-bigger-white-light"><span class="text-span">ANNUAL OFFICE MARKET OVERVIEW</span><br></div>
        </div>
      </div>
    </div>
    <div class="container">
      <div class="motto-wrap">
        <div class="label cc-light">INTRODUCTION</div>
        <div class="heading-jumbo-small">Miami has become a magnet for companies and talent across the U.S. While office markets across the country continue to feel the devastating impacts of COVID-19, the Downtown Miami market has especially shown greater resilience. Asking rents have not only remained stable but have even increased for Class A office spaces, demonstrating growing demand from corporations and businesses looking for quality workspaces. In the coming months, Downtown Miami can expect to see a greater number of signed leases as the immense market activity experienced in 2020 Q4 sets in.<br><br>With its thriving restaurant scene, top quality hotels, transit access, unbeatable weather, and upcoming state-of-the art office buildings, Downtown Miami continues to rise as an attractive, world-class market for tenants looking to relocate or expand, as well as a beautiful and desirable place of work for young talent seeking job opportunities.<br></div>
      </div>
      <div class="divider"></div>
      <div class="home-content-wrap">
        <div data-duration-in="300" data-duration-out="100" class="w-tabs">
          <div class="tabs-menu w-tab-menu">
            <a data-w-tab="Tab 1" class="tab-link-copy w-inline-block w-tab-link w--current">
              <div>OFFICE  REPORT</div>
            </a>
            <a href="#top" data-w-tab="Tab 2" class="tab-link w-inline-block w-tab-link">
              <div>DISTRICT DASHBOARD</div>
            </a>
          </div>
          <div class="w-tab-content">
            <div data-w-tab="Tab 1" class="tab-pane-tab-1 w-tab-pane w--tab-active">
              <div class="container-14 w-container">
                <div id="ddashboard" class="icon"><img src="images/Office.svg" loading="lazy" width="75" alt=""></div>
                <h2 class="heading-2">OFFICE MARKET</h2>
                  <div id='container' class='container-2'>
                    <div id='map' class="map">
                       <p class="paragraph-22" style="margin-bottom: 0px;padding: 10px 20px;font-size: 11px;line-height: 14px;font-style: italic;text-align: right;     position: absolute;bottom: 2vh;right: 4vw;">Source: Costar.</p>
                      <!--<div id='menu' class='mobilehide'>
                        <div id='classabutton' class='on bordertop'>Office</div>
                        <div id='otherbutton' class='on'>Residential</div>
                        <div id='condobutton' class='on'>Transit</div>
                    </div> -->
                    </div>
                  <div>
                </div>

                    <div id='sections'>
                      <div>
                             <p>Downtown Miami is host to a unique array of neighborhoods including the <b class="text-span-10" style="color:#FFBEE8">Central Business District</b>, <b class="text-span-10" style="color:#9FA4EE">Brickell</b>, and <b class="text-span-10" style="color:#FFD37F">Arts & Entertainment District</b>.
                        </p>
                      </div>
                      <div>
                        <p>The DDA Area has over <b>23 million</b> SF of office inventory.
                        </p>
                      </div>
                      <div>
                              <p>There is currently <b>1.5 million SF</b> of office development in the pipeline, including <b class="text-span-10" style="color:#CF60B6">830 Brickell</b>, a standalone Class A-plus office tower adding 640,000 SF in the heart of Brickell.
                        </p>
                      </div>
                      <div>
                        <p> Workers returning to the office are heading to some of the most recent office stock in the country. Over the last 10 years, <b class="text-span-10">more than a quarter</b> of downtown Miami’s office inventory has either been <b class="text-span-10" style="color:#CF60B6">recently developed</b> or has undergone <b class="text-span-10" style="color:#F77E08">major renovation</b>.
                        </p>
                       </div> 
                      <div>
                        <p> The office market is expected to continue to grow, with over <b>4 million SF</b> of <b class="text-span-10" style="color:#146251">new proposed</b> office space in the next five years in developments like One Bayfront Plaza and MiamiCentral Phase 2.
                        </p>
                      </div>
                      <div>
                        <p> Downtown's extensive public transportation network is the only true mass-transit system in the state of Florida, and one of only two in the Southeast.<br><br> <b class="text-span-10" style="color:#2D892A">Metrorail</b>, <b class="text-span-10" style="color:#00C7FE">MetroMover</b>, and <b class="text-span-10" style="color:#F7E73B">Brightline</b> connect downtown to Greater Miami and South Florida, bringing in workers and visitors.
                        </p>
                      </div>
                      <div>
                        <p>Downtown Miami is well suited to meet the post-COVID demand for flexible office space, with coworking facilities representing <b>5%</b> of all leased office inventory.</p>   
                      </div>
                      <div>
                      </div>
                    </div>


                  </div>
                <!--<div class="div-block-47">
                  <div>[VACANCY CHART SCROLL]</div>
                </div> -->
              </div>
              <div class="container-15 w-container">
                <h1 class="heading-9">Who&#x27;s Here</h1>
               
                <div class="w-row"> 
                  <div class="w-col w-col-8" id="wrapper">
                    <div class="outer1" id="emp">    
                        <div id="chart" class="inner1"></div>
                      </div>
                  </div> 
                  <div class="column-14 w-col w-col-4">
                   <div  class="dropdown w-dropdown" style="padding-bottom:3%; padding-top:6%">
                          <div style="color:#000">Filter: </div>
                          <div id="industries" class="select">
                          </div>
                        </div>
                        <br> 
                    <p class="paragraph-14">Downtown Miami has a diverse economy driven by <b>law</b>, <b>professional services</b>, and <b>tech</b> companies. Many domestic and international firms have established regional offices in Miami, while existing businesses are continuing to expand and benefit from the City’s growing economy and trained workforce.</p> 
                  </div> 
                </div> 
              </div> 
              <div class="container-15 w-container"> 
                <h1 class="heading-9">Who&#x27;s Coming</h1> 
                <div class="w-row"> 
                  <div class="w-col w-col-8" id="wrapper">
                    <div class="outer2" id="emp">    
                      <div id="chart2" class="inner2"></div>
                    </div>
                  </div> 
                  <div class="column-15 w-col w-col-4"> 
                    <p class="paragraph-14">With recent relocations from firms like Shiftpixy and Blackstone, Downtown Miami continues to be a strong hub for financial services, as well as an emerging destination for tech companies. <b>New-to-market tenants</b>, which typically comprise close to 10% of lease deals, now remarkably make up just under <b>60%</b>.</p> 
                  </div> 
                </div> 
              </div>
              <div class="container-15 w-container">
                <div class="divider2"></div>
                <div class="icon"><img src="images/Employment.png" loading="lazy" width="75" alt=""></div>
                <h1 class="heading-2">TALENT</h1>
                <h2 class="heading-7">Dynamic Talent Pool</h2>
                <p class="paragraph-14">Miami-Dade County is one of the most dynamic employment markets in the nation. In the last three years, employment has averaged 3.76% growth rate year-over-year. Miami Downtown alone supports approximately 85,000 employees, 7% of the county’s workforce. A growing talent base is one of the strongest draws for businesses looking to relocate or start up in Miami.</p>
                <div class="w-layout-grid grid-4">
                  <div class="div-block-17" style="display:inherit;">
                    <h1 class="heading-6-copy">MIAMI DDA JOB GROWTH BETWEEN 2010-2020:<br></h1>
                    <p class="paragraph-9">18%</p>
                  </div>
                  <div class="div-block-17">
                    <p class="heading-6-copy">TOP 3 INDUSTRIES MAKE UP <span class="text-span-10">57% </span>OF TOTAL DDA JOBS:<br></p>
                    <ul role="list" class="list">
                      <li class="list-item"><span class="text-span-11">Professional Services</span> (22%)</li>
                      <ul role="list" class="list">
                        <li class="list-item">Law, Consulting, Accounting</li>
                      </ul>
                      <li class="list-item-2"><span class="text-span-11">Government</span> (19%)</li>
                      <ul role="list" class="list">
                        <li class="list-item">Public Schools, Hospitals</li>
                      </ul>
                      <li class="list-item-3"><span class="text-span-11">Finance &amp; Insurance</span> (15%)</li>
                      <ul role="list" class="list">
                        <li class="list-item">Commercial Banking, Securities Brokerage</li>
                      </ul>
                    </ul>
                  </div>
                </div>
                <div id='container' class='container-1'>
                    <div id='graph'><p class="paragraph-22" style="margin-bottom: 0px;padding: 10px 20px;font-size: 11px;line-height: 14px;font-style: italic;text-align: right;     position: absolute;bottom: 2vh;right: 4vw;">Source: EMSI.</p><svg id="bubble" style="width:100%; height:85vh; padding-top:5vh"></svg>
                    </div>

                    <div id='sections'>
                      <div>
                      </div>
                      <div>
                        <p>Between 2010-2018, Miami DDA jobs grew <b>18%</b>.<br><br>The close to 85,000 employees work in Downtown Miami represent 7% of the county’s workforce.</p>
                      </div>
                      <div>
                        <p>The three largest industries within the DDA are <b class="text-span-10" style="color:#AA4588">Professional Services</b>, <b class="text-span-10" style="color:#770D55">Government</b>, and <b class="text-span-10" style="color:#4577AA">Finance & Insurance</b>, which make up close to 60% of total jobs.</p>
                      </div>
                      <div>
                        <p>Looking more closely into occupations within Professional Services and Finance industries reveals trends in Miami's changing workforce.<p>
                      </div>
                       <div>
                        <p>Managerial roles across sectors such as Finance, Marketing, and Sales, as well as marketing positions have grown significantly over the last ten years.<br><br> Tech occupations are also on the rise. Between 2010 and 2019, <b class="text-span-10" style="color:#AA4588">Computer and Information Systems Managers</b>, <b class="text-span-10" style="color:#DDDD77">Computer User Support Specialists</b>, and <b class="text-span-10" style="color:#77AADD">Software Developers</b> were some of the fastest growing occupations, growing 105-175%. 
</p>
                      </div>
                                          <div>
                      </div>
                                        
                    </div>


                  </div>
                
                <div class="div-block-41">
                  <div class="div-block-49">
                    <h2 class="heading-7">6th Largest College Town</h2>
                    <p class="paragraph-14">Miami’s large and growing talent pool can be contributed to the strength of its educational institutions. Miami currently has a student population of 300K, making Miami the nation’s 6th largest college town. In terms of students per capita, Miami is on par with New York, Chicago, and Philadelphia. Schools such as the <a style="display:contents !important" href="https://welcome.miami.edu/">University of Miami</a>, <a href="https://www.fiu.edu/" style="display:contents !important">Florida International University</a>, and <a href="https://www.fau.edu/" style="display:contents !important">Florida Atlantic</a> produce a big pipeline of diverse talent for the Miami workforce.</p>
                    <br>
                    <h4>Students per Capita</h4>
                  </div>
                  <div class="div-block-7">
                    <svg id="collegetowns" width="100%" height="100%"></div>
                    <p class="paragraph-22" style="margin-bottom: 0px;padding: 10px 20px;font-size: 11px;line-height: 14px;font-style: italic;text-align: right;">Source: EMSI.</p>
                  <h2 class="heading-7">A Growing Diverse Talent Base</h2>
                  <p class="paragraph-11">Miami celebrates a highly racially and ethnically diverse talent base – 58% of Miami's population is foreign-born (vs. 14% nationwide) and 75% speak a language in addition than English. This workforce is also becoming increasingly educated – Miami added 40,000 more bachelor’s and graduate degree holders, a 39% increase between 2010-2019. Moreover, 25% of the Latinx population over 25 years of age hold a bachelor's degree in Miami (vs. 3% nationwide).</p>

                  <div class="w-row">
                    <div class="w-col w-col-6 w-col-stack">
                      <div class="div-block-6">
                        <svg id="educhart" width="100%" height="80%"></svg>
                        <div class="range-wrap" style="margin-left:30px; margin-right:30px;  ">
                          <input id="slide" type="range" class="range" min="2010" max="2019" value="2010">
                          <output class="bubble" style="left: calc(0% + 8px);top: 28px;"></output>
                        </div>
                      </div>
                    </div>
                    <div class="column-5 w-col w-col-6 w-col-stack">
                      <p class="paragraph-13">BETWEEN 2010-2019:</p>
                      <div class="w-layout-grid grid-5">
                        <p class="paragraph-9-copy">40K new</p>
                        <p id="w-node-_0a126a8a-bf7a-ba9c-fa9c-8fbfdcbdb6d9-f458ecee" class="paragraph-17">BACHELOR &amp; ABOVE DEGREE HOLDERS</p>
                        <p class="paragraph-9-copy">39%</p>
                        <p class="paragraph-18">GROWTH IN BACHELOR &amp; ABOVE DEGREE HOLDERS</p>
                      </div>
                      <svg id='edulegend' height='20vh'></svg>
                    </div>
                  </div>
                  <div>
                    <p class="paragraph-22" style="margin-bottom: 0px;padding: 10px 20px;font-size: 11px;line-height: 14px;font-style: italic;text-align: right;">Source: American Community Survey.</p>
                  </div>
                </div>
              </div>
              <div class="container-15 w-container">
                <h1 class="heading-7">Everyone is Coming to Miami</h1>
                <p class="paragraph-11">With the rise of remote work due to COVID-19, people have increasingly chosen to relocate to Miami given the high quality of life it offers. With its great restaurant scene, bustling arts scene, good weather, growing job market – and just steps away from the beach – moving to Miami, and Downtown especially, is an easy decision for many. This not only continues to demonstrate Miami’s value as a desirable place to live and work, but in turn drives more companies and businesses to set roots here. Miami has always been one of the most welcoming cities for migrating newcomers, yet it still saw a big jump in the number of people relocating to the City during 2020. <br></p>
                <div class="div-block-7-copy">
                    <div id='container' class='container-3'>
                    <div class="map">
                                      
                    <div id='map3'><iframe id="uspsiframe" width=100% height = 100% src="usps.html" frameborder="0" allowfullscreen scrolling="no"></iframe>
                      <p class="paragraph-22" style="margin-bottom: 0px;padding: 10px 20px;font-size: 11px;line-height: 14px;font-style: italic;text-align: right;     position: absolute;bottom: 2vh;right: 2vw; background-color:#ffffff75">Source: USPS.</p>
                      <!--<div id='menu' class='mobilehide'>
                        <div id='classabutton' class='on bordertop'>Office</div>
                        <div id='otherbutton' class='on'>Residential</div>
                        <div id='condobutton' class='on'>Transit</div>
                    </div> -->
                    </div></div>

                    <div id='sections'>
                      <div>
                      </div>
                      <div>
                        <p>According to data from the United States Postal Services, the number of permanent relocations to Miami by people originally living out-of-state grew 51% in 2020 compared to 2019.
                        </p>
                      </div>
                      <div>
                        <p>Most of this movement has been driven from the Northeast, with <b>53%</b> of permanent newcomers coming from New York City. <br><br>L.A., San Francisco, Chicago, Boston, and Philadelphia also saw a substantial increase in permanent moves to Miami. 
                        </p>
                      </div>
                      <div>
                      </div>
                    </div>


                  </div>
                  <p class="paragraph-11">Miami has also experienced a great number of temporary movers. Temporary relocations grew <b>511%</b> overall. Close to 2,000 people temporarily changed their mailing address to Miami during this past year of remote work, 84% of whom came from New York. While we have yet to see the effects of this play out, trends from google searches and twitter continue to indicate that many are moving to Miami.<br></p>
                </div>
                <h1 class="heading-7">Growing Buzz</h1>
                <div class="div-block-7"><div class='sk-ww-twitter-collection' data-embed-id='55161'></div><script src='https://www.sociablekit.com/app/embed/twitter-collections/widget.js' async defer></script></div>
                <p class="paragraph-11">COVID-19 upended many traditional ideas of the workplace. Workers are looking to move to areas with great opportunities and higher quality of life, while companies are now looking to startup, relocate or expand into areas with a strong talent pool, low regulatory environment, and quality office product –Miami hits that sweet spot, with Downtown leading the way.</p>
                <div class="div-block-41-copy-copy">
                  <div class="text-block-9-copy">“Companies used to come to Miami for tax purposes. For the first time, employees are making the decision – employees are saying, let’s go to Miami.”<br>‍<br><span class="text-span-7">– Danet Linares, Blanca Commercial Real Estate</span></div>
                  <div class="text-block-9-copy">“South Florida and Miami have a lot of fundamentals going for it. We’ve experienced 5 years of growth in the last few months. People are either looking to relocatedivisions, or establish satellite offices in Miami. What remains to be seen isthe scale of the migration.”<br>‍<br><span class="text-span-8">– Justin Oates, Cain International</span></div>
                </div>
                <div class="div-block-41-copy">
                  <div class="text-block-9-copy">“We are high conviction, thematic investors focused on investing in growing markets with strong demographic tailwinds and talent pipelines, such as Miami. 2 & 3 MiamiCentral are extremely high-quality assets in a prime location with access to mass transit, and we are pleased to acquire them on behalf of our investors.” <br><br><span class="text-span-8">– David Levine, Blackstone Real Estate*</span></div>
                  <div class="text-block-9-copy">“We are singing people up like crazy… People are looking to get our of their homes, and they want spaces where they can meet with clients.” <br><br><span class="text-span-7">– Yolaine Gil, Pipeline Workspaces</span></div>
                </div>
                 <p class="paragraph-22" style="margin-bottom: 0px;padding: 10px 20px;font-size: 11px;line-height: 14px;font-style: italic;text-align: right;">Source: HR&amp;A Interviews. *Miami Herald.</p>
              </div>
            </div>
            <div data-w-tab="Tab 2" class="w-tab-pane">
              <div id="District-Profiles" class="section-4">
                <div class="div-block-36">
                  <div class="icon"><img src="images/District.png" loading="lazy" width="61" alt=""></div>
                  <h2 class="section-heading-copy-copy">DISTRICT DASHBOARD</h2>
                  <p class="paragraph-21">Downtown Miami is host to a unique array of neighborhoods that each have their own character. Pieced together, the Miami DDA continues to lead the way as the largest downtown office market within Miami-Dade County and the state of Florida in terms of rentable square footage, and Class A rental rates.</p>
                  <div class="div-block-25">
                    <a href="#" class="button-13 w-button dbutton" id="MiamiButton"><strong class="bold-text-10">MIAMI-DADE</strong></a>
                    <a href="#" class="button-12 w-button dbutton" id="GDButton"><strong class="bold-text-11">GREATER DOWNTOWN</strong></a>
                    <a href="#" class="button-12 w-button dbutton" id="DDAButton"><strong class="bold-text-12">DDA</strong></a>
                    <a href="#" class="button-12 w-button dbutton" id="CBDButton"><strong class="bold-text-13">CBD</strong></a>
                    <a href="#" class="button-12 w-button dbutton" id="AEButton"><strong class="bold-text-14">A&amp;E</strong></a>
                    <a href="#" class="button-12 w-button dbutton" id="BrickellButton"><strong class="bold-text-15">BRICKELL</strong></a>
                  </div>
                  <div class="w-layout-grid grid-2">
                    <div class="div-block-43">
                      <div class="div-block-21">
                        <div><img src="images/Business_1Business.png" loading="lazy" width="129" alt="" class="image-4"></div>
                        <div class="div-block-22">
                          <div><strong class="bold-text-16">Businesses</strong></div>
                          <div class="div-block-35" id="businesses" style="font-size: 40px;
    font-weight: 700;"></div>
                        </div>
                      </div>
                    </div>
                    <div class="div-block-43">
                      <div class="div-block-21">
                        <div><img src="images/Population_1Population.png" loading="lazy" width="129" alt="" class="image-5"></div>
                        <div class="div-block-22">
                          <div><strong class="bold-text-17">Population</strong></div>
                            <div class="div-block-34" id="population" style="font-size: 40px;
    font-weight: 700;"></div>
                          
                        </div>
                      </div>
                    </div>
                    <div class="div-block-43">
                      <div class="div-block-21">
                        <div><img src="images/Employee_1Employee.png" loading="lazy" width="129" alt="" class="image-6"></div>
                        <div class="div-block-22">
                          <div><strong class="bold-text-18">Jobs</strong></div>
                          <div class="div-block-33" id="employees" style="font-size: 40px;
    font-weight: 700;"></div>
                        </div>
                      </div>
                    </div>
                    <!--<div class="div-block-43" id="map2"> -->
                     
                    </div>
                    <p class="paragraph-22" style="margin-bottom: 0px;padding: 10px 20px;font-size: 11px;line-height: 14px;font-style: italic;text-align: right; color:white; ">Source: ESRI.</p>
                  </div>

                  <div class="div-block-43" id="conditions">
                     <p class="paragraph-22" style="margin-bottom: 0px;padding: 10px 20px;font-size: 11px;line-height: 14px;font-style: italic;text-align: right; color:white; ">Source: Costar.</p>
                    <!-- <div class="div-block-12" id="conditions"></div> -->
                  </div>
                  <div class="div-block-43">
                    <h2 class="heading-7" style="color:white !important">2010 - 2020 Market Metrics</h2>
                    <div class="w-layout-grid grid-3">
                      <div class="div-block-52" style="width:14vw !important">
                        <div  class="dropdown w-dropdown">
                          <div style="color:#FFF">Metric: </div>
                          <div id="metric" class="select">
                          </div>
                        </div>
                        <svg id="linelegend" height='25vh'></svg>
                        <div class="dropdown w-dropdown">
                          <!--<div style="color:#FFF">Geography: </div>
                          <div id="geography" class="select">
                          </div> -->
                        </div>
                      </div>
                      <div id="rentvis"></div>

                  </div>
                  <p class="paragraph-22" style="margin-bottom: 0px;padding: 10px 20px;font-size: 11px;line-height: 14px;font-style: italic;text-align: right; color:white; ">Source: Costar.</p>
                </div>
                <div class="div-block-5" id="dashmap"><iframe id="iframe" width=100% height = 100% src="working/map2.html" frameborder="0" allowfullscreen scrolling="no"></iframe></div>
              </div>
            </div>
            <p class="paragraph-11-copy" style="display: block;
    margin-top: 20px;
    margin-bottom: 0px;
    padding-top: 0px;
    padding-right: 20px;
    padding-left: 20px;
    color: #000;
    font-size: 12px;
    font-style: normal;
    text-align: center;">This report is prepared by <a href="#https://www.hraadvisors.com/" target="_blank" class="link-4-copy" style="display:contents !important">HR&amp;A Advisors</a> on behalf of the Miami DDA.</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<script src="test/d3v4+jetpack.js"></script>
<script src="test/graph-scroll.js"></script>
 <script src="https://d3e54v103j8qbb.cloudfront.net/js/jquery-3.5.1.min.dc5e7f18c8.js?site=6041a54707ac14648370b006" type="text/javascript" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/waypoints/4.0.1/jquery.waypoints.js" integrity="sha512-ZKNVEa7gi0Dz4Rq9jXcySgcPiK+5f01CqW+ZoKLLKr9VMXuCsw3RjWiv8ZpIOa0hxO79np7Ec8DDWALM0bDOaQ==" crossorigin="anonymous"></script>
    <script src="webflow.js" type="text/javascript"></script>
    <script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
    <script src="simple_statistics.js"></script>
<script>

  $("a[href='#top']").click(function() {
  $('html, body').animate({
    scrollTop: ($('#ddashboard').offset().top)
},500);
});

docwidth = document.body.offsetWidth

if (docwidth <= 600){
  size = 'mobile'
}else if(docwidth <= 900){
  size = 'tablet'
}else{
  size = 'regular'
}


window.step = 0

window.dropdown = 0

var oldWidth = 0
function render(){


///// Bubble Chart

var bubblesvg = d3.select("#bubble")

if (size != 'regular'){
  margin = {top: 35, left: 5, bottom: 0, right: 5}
} else{
  margin = {top: 35, left: 35, bottom: 0, right: 15}
}


element = bubblesvg.node();
bwidth = element.getBoundingClientRect().width - margin.left - margin.right,
bheight = element.getBoundingClientRect().height - margin.top - margin.bottom;


if (size != 'regular'){
  histXScale = d3.scaleLinear().domain([1,15]).range([bwidth-((bwidth/2.15)), bwidth + (bwidth/2)]).nice()
  histYScale = d3.scaleLinear().domain([7, 1]).range([bheight*.3,bheight*.6])}else{
  histXScale = d3.scaleLinear().domain([1,15]).range([bwidth-((bwidth/6)*2.5), bwidth + (bwidth/6)]).nice()
  histYScale = d3.scaleLinear().domain([7, 1]).range([bheight*.25,bheight*.75])
}



pct = d3.scaleLinear().domain([1,15]).range([-0.5,3])

var defs = bubblesvg.append('defs');
var filter = defs.append('filter').attr('id','gooey');
filter.append('feGaussianBlur')
  .attr('in','SourceGraphic')
  .attr('stdDeviation', "10")
  .attr('result','blur');
filter.append('feColorMatrix')
  .attr("class", "blurValues")
  .attr('in','blur')
  .attr('mode','matrix')
  .attr('values', '1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 0 -6')
  .attr('result','gooey');
filter.append("feBlend")
  .attr("in", "SourceGraphic")
  .attr("in2", "gooey")
  .attr("operator", "atop");

let xAxis = d3.axisBottom(histXScale).tickFormat(function(d) { return d3.format(".0%")(pct(Math.ceil(d/.25)*.25)); });


bubblesvg.append('g')
        .attr('class', 'histaxis')
        .attr('transform', `translate(${-bwidth/1.95}, ${histYScale(0)})`)
        .call(xAxis)
        .style('opacity',0)


if (size != 'regular'){
bubblesvg.append("text")
                .attr("y", histYScale(0)+ 30)
                .attr("x", bwidth/2)
                .attr("dy", "1em")
                .style("text-anchor", "middle")
                .text("Employment Growth (2010-2020)")
                .attr("class", "histlabel")
                .attr("font-family", "Nunito")
                .style("fill", "#000")
                .attr("font-weight",700)
                .attr("font-size", "13")
                .style('opacity',0)
}else{
  bubblesvg.append("text")
                .attr("y", histYScale(0)+ 30)
                .attr("x", bwidth-((bwidth/6)*3.75))
                .attr("dy", "1em")
                .style("text-anchor", "middle")
                .text("Employment Growth (2010-2020)")
                .attr("class", "histlabel")
                .attr("font-family", "Nunito")
                .style("fill", "#000")
                .attr("font-weight",700)
                .attr("font-size", "13")
                .style('opacity',0)
}

bubblesvg.append("text")
                .attr("y", histYScale.domain()[1] + 15)
                .attr("x", bwidth/2)
                .attr("dy", "1em")
                .attr('id','bubblelabel')
                .style("text-anchor", "middle")
                .text("Miami Industries")
                .attr("class", "histlabel")
                .attr("font-family", "Nunito")
                .style("fill", "#000")
                .attr("font-weight",700)
                .attr("font-size", "17")
                .style('opacity',1)

function bubbleChart() {


function draw1(){

if(window.step === 7){
  d3.selectAll('#inds')
.transition(2000)
.attr('r',function(d){ return d.radius})

d3.selectAll('#occs')
.transition(2000)
.attr('r',function(d){ return d.radius})

simulation
    .force('collide', d3.forceCollide(d => d.radius + 2).strength(1))

simulation2
    .force('collide', d3.forceCollide(d => d.radius + 2).strength(1))

}

simulation.restart()

window.step = 6

}
function draw2(){


  if(window.step === 8){
    d3
    .selectAll("#inds")
    .transition("recolor")
    .duration(500)
    .style('fill', function (d) { return fillColor(d.group); })
    .style("opacity", 1)


  }

d3.selectAll('#inds')
.transition(2000)
.attr('r',function(d){ return d.radius2})

d3.selectAll('#occs')
.transition(2000)
.attr('r',function(d){ return d.radius2})

simulation
    .force('collide', d3.forceCollide(d => d.radius2 + 2).strength(1))

simulation2
    .force('collide', d3.forceCollide(d => d.radius2 + 2).strength(1))

groupBubbles()

window.step = 7

}

function draw3(){

  if(window.step === 9){

    d3.selectAll('#occs')
      .transition()
      .duration(1000)
      .style('opacity',0)
      .on('mouseover',null)
      .on('mouseout',null)

      d3
      .selectAll("#inds")
      .transition().duration(500)
      .style('fill', function (d) { return fillColor(d.group); })
      .style("opacity", 1)
      .attr("fill-opacity","1")
      .attr('r',function(d){ return d.radius2})


      bubbles = bubbles.data(graphNodes, function(d) { return d.id;});
        //  EXIT
      bubbles.exit().remove();
      //  ENTER
      var newNode = bubbles.enter().append("circle")
        .classed('bubble', true)
        .attr("id",function(d){ return "bubble_" + String(d.id)})
        .attr("id","inds")
        .attr('r',function(d){ return d.radius2})
        .style('opacity', .2)
        .style('fill', '#808080')
        .attr('stroke', function (d) { return d3.rgb(fillColor(d.group)).darker(); })
        .attr('stroke-width', 2)
        .on('mouseover', showDetail)
        .on('mouseout', hideDetail);

        newNode.append("title")
          .text(function(d) { return "group: " + d.group + "\n" + "id: " + d.id; });
      //  ENTER + UPDATE
      bubbles = bubbles.merge(newNode);

      simulation.nodes(graphNodes)

      simulation
        .force('collide', d3.forceCollide(d => d.radius2 + 2).strength(1))

    simulation.restart()

    groupBubbles()

    }

  d3
  .selectAll("#inds")
  .filter(function (d) { return d.group != 'Finance and Insurance' && d.group != 'Professional, Scientific, and Technical Services' && d.group != 'Government'})
  .each(function (d, i){
        var $this = d3.select(this)
        $this
        .transition().duration(2000)
        .style('opacity', .2)
        .style('fill', '#808080')



      })

    simulation2.stop()

    window.step = 8


}

function draw4(){


  if(window.step === 10){

  transitionGoo(0)
 d3.select('.histlabel')
 .transition()
 .duration(2000)
 .style('opacity',0)

 d3.select('.histaxis')
 .transition()
 .duration(2000)
 .style('opacity',0)

 d3.selectAll('#inds')
  .transition()
  .duration(1000)
  .style('opacity',1)

  simulation2.restart()

  d3
  .selectAll("#occs")
  .attr('fill', function (d) { return fillColor(d.group); })
  .attr('stroke', function (d) { return d3.rgb(fillColor(d.group)).darker(); })
  .attr('stroke-width', 2)
  .style("opacity",1)
  .attr('r',function(d){ return d.radius2})

  simulation2
        .force('collide', d3.forceCollide(d => d.radius2 + 2).strength(1))

  

  groupBubbles()

  }


d3.selectAll(".blabel")
.transition(1000)
.style("opacity",0)

graphNodes.forEach(function(d,i) {
  if (d.group != 'Finance and Insurance' && d.group != 'Professional, Scientific, and Technical Services'){
    r = nodes.findIndex(p => p.id === d.id)
    nodes.splice(r, 1)
  }
})


bubbles = bubbles.data(nodes, function(d){return d.id;})
bubbles.exit().remove()
simulation.nodes(nodes)
simulation.tick()





  function transitionGoo(duration) {
      d3.selectAll(".blurValues")
        .transition().duration(duration)
        .attrTween("values", function() {
          return d3.interpolateString("1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 18 -6", 
                          "1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 0 -6"); 
        }); 
    }
  simulation.stop()
  transitionGoo(3000)

  d3.selectAll('#inds')
  .transition()
  .duration(1000)
  .attr('stroke-width', 0)
  .style('fill','steelblue')
  .attr("cx", center.x)
  .attr("cy", center.y)
  .attr('r',125)
  .transition()
  .duration(4000)
  .attr("fill-opacity","0")
  .attr('stroke-width', 1)

  d3.selectAll('#occs')
  .transition()
  .duration(1000)
  .delay(1000)
  .style('opacity',1)


  d3.selectAll('#occs')
  .on('mouseover', showDetail2)
  .on('mouseout', hideDetail);

  d3.select('#bubblelabel')
  .transition()
  .delay(2000)
  .duration(1000)
  .text('Professional Services and Finance Occupations')

  window.step = 9


}



function draw5(){



if (size != 'regular'){
d3.selectAll('#occs')
 .filter(function (d) { return d.group === 'Market Research Analysts and Marketing Specialists' || d.group === 'Computer and Information Systems Managers' || d.group === 'Computer User Support Specialists' || d.group === 'Software Developers and Software Quality Assurance Analysts and Testers' || d.group === 'Marketing Managers' })
  .transition()
  .duration(2000)
  .attr('cx', d => histXScale(d.col))
  .attr('cy', d => histYScale(d.row))
  .attr('r',5)
  .attr('stroke-width',2)
  .attr('stroke',"#000000")
  .style('opacity',1)

    d3
  .selectAll("#occs")
  .filter(function (d) { return d.group != 'Market Research Analysts and Marketing Specialists' && d.group != 'Computer and Information Systems Managers' && d.group != 'Computer User Support Specialists' && d.group != 'Software Developers and Software Quality Assurance Analysts and Testers' && d.group != 'Marketing Managers' })
  .each(function (d, i){
        var $this = d3.select(this)
        $this
          .transition()
         .duration(2000)
           .attr('cx', d => histXScale(d.col))
          .attr('cy', d => histYScale(d.row))
          .attr('r',5)
        .style('opacity', .3)
        
      })
}else{
d3.selectAll('#occs')
 .filter(function (d) { return d.group === 'Market Research Analysts and Marketing Specialists' || d.group === 'Computer and Information Systems Managers' || d.group === 'Computer User Support Specialists' || d.group === 'Software Developers and Software Quality Assurance Analysts and Testers' || d.group === 'Marketing Managers' })
  .transition()
  .duration(2000)
  .attr('cx', d => histXScale(d.col))
  .attr('cy', d => histYScale(d.row))
  .attr('r',20)
  .attr('stroke-width',2)
  .attr('stroke',"#000000")
  .style('opacity',1)

  d3
  .selectAll("#occs")
  .filter(function (d) { return d.group != 'Market Research Analysts and Marketing Specialists' && d.group != 'Computer and Information Systems Managers' && d.group != 'Computer User Support Specialists' && d.group != 'Software Developers and Software Quality Assurance Analysts and Testers' && d.group != 'Marketing Managers' })
  .each(function (d, i){
        var $this = d3.select(this)
        $this
          .transition()
         .duration(2000)
           .attr('cx', d => histXScale(d.col))
          .attr('cy', d => histYScale(d.row))
          .attr('r',20)
        .style('opacity', .3)
        


      })

}

 d3.select('.histlabel')
 .transition()
 .duration(2000)
 .style('opacity',1)

 d3.select('.histaxis')
 .transition()
 .duration(2000)
 .style('opacity',1)

 d3.selectAll('#inds')
  .transition()
  .duration(1000)
  .style('opacity',0)



window.step = 10
}

function draw6(){
}

function draw7(){
}

      let functions = [
        draw1,
    draw2,
    draw3,
    draw4,
    draw5,
    draw6,
    draw7]


  var gs = d3.graphScroll()
      .container(d3.select('.container-1'))
      .graph(d3.selectAll('container-1 #graph'))
      .eventId('uniqueId1')  // namespace for scroll and resize events
      .sections(d3.selectAll('.container-1 #sections > div'))
      // .offset(innerWidth < 900 ? innerHeight - 30 : 200)
      .on('active', function(i){
        functions[i]()
      })

  // Constants for sizing

  // tooltip for mouseover functionality
  var tooltip = floatingTooltip('gates_tooltip', 240);

  // Locations to move bubbles towards, depending
  // on which view mode is selected.
  var center = { x: bwidth, y: (bheight / 2) };



  // @v4 strength to apply to the position forces
  var forceStrength = 0.03;

  // These will be set in create_nodes and create_vis
  var svg = null;
  var bubbles = null;
  var nodes = [];

  // Charge function that is called for each node.
  // As part of the ManyBody force.
  // This is what creates the repulsion between nodes.
  //
  // Charge is proportional to the diameter of the
  // circle (which is stored in the radius attribute
  // of the circle's associated data.
  //
  // This is done to allow for accurate collision
  // detection with nodes of different sizes.
  //
  // Charge is negative because we want nodes to repel.
  // @v4 Before the charge was a stand-alone attribute
  //  of the force layout. Now we can use it as a separate force!
  function charge(d) {
    return -Math.pow(d.radius, 2.0) * forceStrength;
  }

  // Here we create a force layout and
  // @v4 We create a force simulation now and
  //  add forces to it.
  var simulation = d3.forceSimulation()
    .velocityDecay(0.2)
    .force('x', d3.forceX().strength(forceStrength).x(center.x))
    .force('y', d3.forceY().strength(forceStrength).y(center.y))
    .force('charge', d3.forceManyBody().strength(charge))
    .force('collide', d3.forceCollide(d => d.radius + 2).strength(1))
    .on('tick', ticked);

  // @v4 Force starts up automatically,
  //  which we don't want as there aren't any nodes yet.
  simulation.stop();

  var simulation2 = d3.forceSimulation()
  .velocityDecay(0.2)
  .force('x', d3.forceX().strength(forceStrength).x(center.x))
  .force('y', d3.forceY().strength(forceStrength).y(center.y))
  .force('charge', d3.forceManyBody().strength(charge))
  .force('collide', d3.forceCollide(d => d.radius + 2).strength(1))
  .on('tick', ticked);

// @v4 Force starts up automatically,
//  which we don't want as there aren't any nodes yet.
simulation2.stop();

  // Nice looking colors - no reason to buck the trend
  // @v4 scales now have a flattened naming scheme
  var fillColor = d3.scaleOrdinal()
    .domain(["Government","Professional, Scientific, and Technical Services","Health Care and Social Assistance","Accommodation and Food Services","Finance and Insurance","Transportation and Warehousing","Administrative and Support and Waste Management and Remediation Services","Educational Services","Retail Trade","Other Services (except Public Administration)","Real Estate and Rental and Leasing","Wholesale Trade","Arts, Entertainment, and Recreation","Construction","Information","Management of Companies and Enterprises","Manufacturing","Agriculture, Forestry, Fishing and Hunting","Unclassified Industry","Utilities","Mining, Quarrying, and Oil and Gas Extraction"])
    .range(["#771155", "#AA4488", "#CC99BB", "#114477", "#4477AA", "#77AADD", "#117777", "#44AAAA", "#77CCCC", "#117744", "#44AA77", "#88CCAA", "#777711", "#AAAA44", "#DDDD77", "#774411", "#AA7744", "#DDAA77", "#771122", "#AA4455", "#DD7788"]);


  /*
   * This data manipulation function takes the raw data from
   * the CSV file and converts it into an array of node objects.
   * Each node will store data and visualization values to visualize
   * a bubble.
   *
   * rawData is expected to be an array of data objects, read in from
   * one of d3's loading functions like d3.csv.
   *
   * This function returns the new node array, with a node in that
   * array for each element in the rawData input.
   */
  function createNodes(rawData) {
    // Use the max total_amount in the data as the max in the scale's domain
    // note we have to ensure the total_amount is a number.
    var maxAmount = 16297
    //d3.max(rawData, function (d) { return +d.jobs10; });

    // Sizes bubbles based on area.
    // @v4: new flattened scale names.
    
    if (size === 'regular'){
      var radiusScale = d3.scalePow()
      .exponent(0.5)
      .range([2, 60])
      .domain([0, maxAmount]);
    }else{
      var radiusScale = d3.scalePow()
      .exponent(0.5)
      .range([2, 40])
      .domain([0, maxAmount]);
    }



    // Use map() to convert raw data into node data.
    // Checkout http://learnjsdata.com/ for more on
    // working with data.
    var myNodes = rawData.map(function (d) {
      return {
        id: d.id,
        name: d.industry,
        radius: radiusScale(+d.jobs10),
        radius2: radiusScale(+d.jobs20),
        value10: +d.jobs10,
        value20: +d.jobs20,
        group: d.group,
        growth: +d.growth,
        col: +d.bin_column,
        row: +d.bin_row,
        x: Math.random() * bwidth*2,
        y: Math.random() * bheight
      };
    });

    // sort them to prevent occlusion of smaller nodes.
    myNodes.sort(function (a, b) { return b.value10 - a.value10; });

    return myNodes;
  }



  /*
   * Main entry point to the bubble chart. This function is returned
   * by the parent closure. It prepares the rawData for visualization
   * and adds an svg element to the provided selector and starts the
   * visualization creation process.
   *
   * selector is expected to be a DOM element or CSS selector that
   * points to the parent element of the bubble chart. Inside this
   * element, the code will add the SVG continer for the visualization.
   *
   * rawData is expected to be an array of data objects as provided by
   * a d3 loading function like d3.csv.
   */
  var chart = function chart(selector, rawData ) {

    industries = JSON.parse(JSON.stringify(rawData)).filter(f => f.industry == 'Industry')
    occupation = JSON.parse(JSON.stringify(rawData)).filter(f => f.industry == 'Occupation')
    // convert raw data into nodes data
    nodes = createNodes(industries);
    nodes2 = createNodes(occupation);
    graphNodes = createNodes(industries);



    // Create a SVG element inside the provided selector
    // with desired size.

    var circleGroup = bubblesvg.append("g")
    .style("filter", "url(#gooey)");

    // Bind nodes data to what will become DOM elements to represent them.
    bubbles = circleGroup.selectAll('.bubble')
      .data(nodes, function (d) { return d.id; });

     bubbles2 = circleGroup.selectAll('.bubble')
      .data(nodes2, function (d) { return d.id; });

    // Create new circle elements each with class `bubble`.
    // There will be one circle.bubble for each object in the nodes array.
    // Initially, their radius (r attribute) will be 0.
    // @v4 Selections are immutable, so lets capture the
    //  enter selection to apply our transtition to below.
    var bubblesE = bubbles.enter().append('circle')
      .classed('bubble', true)
      .attr("id",function(d){ return "bubble_" + String(d.id)})
      .attr("id","inds")
      .attr('r', 0)
      .attr('fill', function (d) { return fillColor(d.group); })
      .attr('stroke', function (d) { return d3.rgb(fillColor(d.group)).darker(); })
      .attr('stroke-width', 2)
      .on('mouseover', showDetail)
      .on('mouseout', hideDetail);

    var bubblesE2 = bubbles2.enter().append('circle')
      .classed('bubble', true)
      .attr("id",function(d){ return "bubble2_" + String(d.id)})
      .attr("id","occs")
      .attr('r', 0)
      .attr('fill', function (d) { return fillColor(d.group); })
      .attr('stroke', function (d) { return d3.rgb(fillColor(d.group)).darker(); })
      .attr('stroke-width', 2)
      .style("opacity",0)

    // @v4 Merge the original empty selection and the enter selection
    bubbles = bubbles.merge(bubblesE);
    bubbles2 = bubbles2.merge(bubblesE2);

    // Fancy transition to make bubbles appear, ending with the
    // correct radius
    bubbles.transition()
      .duration(2000)
      .attr('r', function (d) { return d.radius; });

    bubbles2.transition()
      .duration(2000)
      .attr('r', function (d) { return d.radius; });

    // Set the simulation's nodes to our newly created nodes array.
    // @v4 Once we set the nodes, the simulation will start running automatically!
    simulation.nodes(nodes);
    simulation2.nodes(nodes2);

    // Set initial layout to single group.
    groupBubbles();
  };

  /*
   * Callback function that is called after every tick of the
   * force simulation.
   * Here we do the acutal repositioning of the SVG circles
   * based on the current x and y values of their bound node data.
   * These x and y values are modified by the force simulation.
   */
  function ticked() {
    bubbles
      //.attr('cx', function (d) { return d.x; })
      .attr('cx', d => d.x)
      .attr('cy', function (d) { return d.y; });
    bubbles2
      //.attr('cx', function (d) { return d.x; })
      .attr('cx', d => d.x)
      .attr('cy', function (d) { return d.y; });
  }

  /*
   * Provides a x value for each node to be used with the split by year
   * x force.
   */


  /*
   * Sets visualization in "single group mode".
   * The year labels are hidden and the force layout
   * tick function is set to move all nodes to the
   * center of the visualization.
   */
  function groupBubbles() {


    // @v4 Reset the 'x' force to draw the bubbles to the center.
    simulation.force('x', d3.forceX().strength(forceStrength).x(center.x));

    // @v4 We can reset the alpha value and restart the simulation
    simulation.alpha(1).restart();

    simulation2.force('x', d3.forceX().strength(forceStrength).x(center.x));

    // @v4 We can reset the alpha value and restart the simulation
    simulation2.alpha(1).restart();
  }


  /*
   * Sets visualization in "split by year mode".
   * The year labels are shown and the force layout
   * tick function is set to move nodes to the
   * yearCenter of their data's year.
   */


  /*
   * Hides Year title displays.
   */


  /*
   * Function called on mouseover to display the
   * details of a bubble in the tooltip.
   */
  function showDetail(d) {
    // change outline to indicate hover state.
    d3.select(this).attr('stroke', 'black');

    var content = '<span class="name">'+ d.name + ': </span><span class="value">' +
                  d.group +
                  '</span><br/>' +
                  '<span class="name">Jobs: </span><span class="value">' +
                  addCommas(d.value10) +
                  '</span><br/>' 
                ;

    tooltip.showTooltip(content, d3.event);
  }

  function showDetail2(d) {
    // change outline to indicate hover state.
    d3.select(this).attr('stroke', 'black');

    var content = '<span class="name">'+ d.name + ': </span><span class="value">' +
                  d.group +
                  '</span><br/>' 
                ;

    tooltip.showTooltip(content, d3.event);
  }

  /*
   * Hides tooltip
   */
  function hideDetail(d) {
    // reset outline
    d3.select(this)
      .attr('stroke', d3.rgb(fillColor(d.group)).darker());

    tooltip.hideTooltip();
  }

  /*
   * Externally accessible function (this is attached to the
   * returned chart function). Allows the visualization to toggle
   * between "single group" and "split by year" modes.
   *
   * displayName is expected to be a string and either 'year' or 'all'.
   */
  chart.toggleDisplay = function (displayName) {
    if (displayName === 'year') {
      splitBubbles();
    } else {
      groupBubbles();
    }
  };


  // return the chart function from closure.
  return chart;
}

/*
 * Below is the initialization code as well as some helper functions
 * to create a new bubble chart instance, load the data, and display it.
 */

var myBubbleChart = bubbleChart();

/*
 * Function called once data is loaded from CSV.
 * Calls bubble chart function to display inside #vis div.
 */
function display(error, data ) {
  if (error) {
    console.log(error);
  }
  myBubbleChart('#bubble', data);
}

/*
 * Sets up the layout buttons to allow for toggling between view modes.
 */


/*
 * Helper function to convert a number into a string
 * and add commas to it to improve presentation.
 */
function addCommas(nStr) {
  nStr += '';
  var x = nStr.split('.');
  var x1 = x[0];
  var x2 = x.length > 1 ? '.' + x[1] : '';
  var rgx = /(\d+)(\d{3})/;
  while (rgx.test(x1)) {
    x1 = x1.replace(rgx, '$1' + ',' + '$2');
  }

  return x1 + x2;
}


d3.csv("industries.csv", function(error, data) {
      if (error) throw error;
display(null,data)
    });



/*
 * Creates tooltip with provided id that
 * floats on top of visualization.
 * Most styling is expected to come from CSS
 * so check out bubble_chart.css for more details.
 */
function floatingTooltip(tooltipId, bwidth) {
  // Local variable to hold tooltip div for
  // manipulation in other functions.
  var tt = d3.select('body')
    .append('div')
    .attr('class', 'tooltip')
    .attr('id', tooltipId)
    .style('pointer-events', 'none');

  // Set a width if it is provided.
  if (bwidth) {
    tt.style('width', bwidth);
  }

  // Initially it is hidden.
  hideTooltip();

  /*
   * Display tooltip with provided content.
   *
   * content is expected to be HTML string.
   *
   * event is d3.event for positioning.
   */
  function showTooltip(content, event) {
    tt.style('opacity', 1.0)
      .html(content);

    updatePosition(event);
  }

  /*
   * Hide the tooltip div.
   */
  function hideTooltip() {
    tt.style('opacity', 0.0);
  }

  /*
   * Figure out where to place the tooltip
   * based on d3 mouse event.
   */
  function updatePosition(event) {
    var xOffset = 20;
    var yOffset = 10;

    var ttw = tt.style('width');
    var tth = tt.style('height');

    var wscrY = window.scrollY;
    var wscrX = window.scrollX;

    var curX = (document.all) ? event.clientX + wscrX : event.pageX;
    var curY = (document.all) ? event.clientY + wscrY : event.pageY;
    var ttleft = ((curX - wscrX + xOffset * 2 + ttw) > window.innerWidth) ?
                 curX - ttw - xOffset * 2 : curX + xOffset;

    if (ttleft < wscrX + xOffset) {
      ttleft = wscrX + xOffset;
    }

    var tttop = ((curY - wscrY + yOffset * 2 + tth) > window.innerHeight) ?
                curY - tth - yOffset * 2 : curY + yOffset;

    if (tttop < wscrY + yOffset) {
      tttop = curY + yOffset;
    }

    tt
      .style('top', tttop + 'px')
      .style('left', ttleft + 'px' );
  }

  return {
    showTooltip: showTooltip,
    hideTooltip: hideTooltip,
    updatePosition: updatePosition
  };
}




  var r = 40



////DASHBOARD CHARTS
// Parse the month variable

var vis = d3.select("#rentvis")


var cmargin = {top: window.innerHeight*.04, right: window.innerWidth*.02, bottom: window.innerHeight*.07, left: window.innerWidth*.05};

cwidth = (window.innerWidth*.8) - cmargin.left - cmargin.right,
cheight = (window.innerHeight*.4) - cmargin.top - cmargin.bottom;

var parseMonth = d3.timeParse("%b");
var formatMonth = d3.timeFormat("%b");

var formatYear = d3.timeFormat("%Y");
var parseYear = d3.timeParse("%Y");





// Create the svg canvas in the "graph" div
var vis = d3.select("#rentvis")
        .append("svg")
        .style("width", cwidth + cmargin.left + cmargin.right + "px")
        .style("height", cheight + cmargin.top + cmargin.bottom + "px")
        .attr("width", cwidth + cmargin.left + cmargin.right)
        .attr("height", cheight + cmargin.top + cmargin.bottom)
        .append("g")
        .attr("transform","translate(" + cmargin.left + "," + cmargin.top + ")")
        .attr("class", "svg");

var formats = {'Rent':d3.format("($.0f"),'Absorption':d3.format("(.1s"),'Vacancy':d3.format(".0%")}
var labels = {'Rent':"Gross Rent PSF",'Absorption':"Absorption",'Vacancy':"Vacancy Rate"}
const colors = {'Miami':'#00b5cc','NY':'#eb529d','SF':'#eb529d','Chicago':'#eb529d'}
const longname = {'Miami':'Miami','NY':'New York','SF':'San Francisco','Chicago':'Chicago'}


var ordinal = d3.scaleOrdinal()
  .domain(["Miami", "New York", "San Francisco", "Chicago"])
  .range([ "#EB529D", "rgb(56, 106, 197)", "rgb(93, 199, 76)", "rgb(223, 199, 31)", "rgb(234, 118, 47)"]);


var linelegend = d3.select("#linelegend")
linelegend.append("g")
  .attr("class", "legendOrdinal")
  .attr("transform", `translate(10,40)`);

var legendOrdinal = d3.legendColor()
  //d3 symbol creates a path-string, for example
  //"M0,-8.059274488676564L9.306048591020996,
  //8.059274488676564 -9.306048591020996,8.059274488676564Z"
  .shape("path",d3.symbol().type(d3.symbolCircle)())
  .labelAlign("start")
  .shapePadding(20)
  .classPrefix('clabels')
  //use cellFilter to hide the "e" cell
  .scale(ordinal);

linelegend.select(".legendOrdinal")
  .call(legendOrdinal);



// Import the CSV data
d3.csv("https://docs.google.com/spreadsheets/d/1LMADV7lzfx1rC6AzkrUp8uwe5XuXR8sd3KDeashPmB8/gviz/tq?tqx=out:csv&gid=285225202", function(error, data) {
  if (error) throw error;

  
   // Format the data
  data.forEach(function(d) {
      d.Quarter = d.Quarter;
      d.Value = +d.Value;
      d.Metric = d.Metric;
      d.Geography = d.Geography;
      //d.Year = formatYear(parseYear(+d.Year));
  });



  // Set the ranges
var x = d3.scalePoint().domain(data.map(function(d){ return d.Quarter; })).range([0, cwidth]);
var y = d3.scaleLinear().range([cheight, 0]);


// Define the line
var valueLine = d3.line()
    .x(function(d) { return x(d.Quarter); })
    .y(function(d) { return y(+d.Value); })
    .curve(d3.curveMonotoneX)


  var nest = d3.nest()
        .key(function(d){
            return d.Metric;
        })
        .rollup(function(leaves){
            var max = d3.max(leaves, function(d){
                return d.Value
            })
            var min = d3.min(leaves, function(d){
                return d.Value
            })
            var year = d3.nest().key(function(d){
                return d.Geography
            })
            .entries(leaves);
            return {min:min, max:max, year:year};
            })
      .entries(data)

  // Scale the range of the data
  //x.domain(d3.extent(data, function(d) { return d.Quarter; }));
  y.domain([d3.min(data, function(d) { return d.Value; }), d3.max(data, function(d) { return d.Value; })]);
  // Set up the x axis
  var xaxis = vis.append("g")
       .attr("transform", "translate(0," + cheight + ")")
       .attr("class", "x axis")
       .call(d3.axisBottom(x)
          .tickValues(x.domain().filter(function(d,i){ return !(i%4)}))
          );



  // Create 1st dropdown
    var fruitMenu = d3.select("#metric")

    fruitMenu
        .append("select")
        .attr("id","standard-select")
        .selectAll("option")
        .data(nest)
        .enter()
        .append("option")
        .attr("value", function(d){
            return d.key;
        })
        .text(function(d){
            return d.key;
        })


    // Create 2nd dropdown
 /*   var yearMenu = d3.select("#geography")

    yearMenu
        .data(nest)
        .append("select")
        .attr("id","standard-select")
        .selectAll("option")
        .data(function(d) { return d.value.year; })
        .enter()
        .append("option")
        .attr("value", function(d){
            return d.key;
        })
        .text(function(d){
            return d.key;
        })*/

 var tip = d3.select("body").append("div") 
    .attr("class", "tooltip2")
    .style("position","absolute")       
    .style("opacity", 0);
  
    // Function to create the initial graph
    var initialGraph = function(fruit){

        // Filter the data to include only fruit of interest
        var selectFruit = nest.filter(function(d){
                return d.key == fruit;
              })

        var selectFruitGroups = vis.selectAll(".fruitGroups")
            .data(selectFruit, function(d){
              return d ? d.key : this.key;
            })
            .enter()
            .append("g")
            .attr("class", "fruitGroups")
            .each(function(d){
                y.domain([d3.min([d.value.min,0]), d.value.max])
            });

        var initialPath = selectFruitGroups.selectAll(".line")
            .data(function(d) { return d.value.year; })
            .enter()
            .append("path")

        initialPath
            .attr("d", function(d){
                return valueLine(d.values)
            })
            .style('stroke',function(d){ return ordinal(longname[d.key])})
            .attr("class", "line")

        selectFruit[0].value.year.forEach(function(item,index){
          selectFruitGroups.append("g").selectAll(".circle" + item.key)
        .data(item.values)
        .enter()
        .append("circle")
        .attr("r", 10)
        .attr("cx", function(dd){return x(dd.Quarter)})
        .attr("cy", function(dd){return y(dd.Value)})
        .attr("class","circle" + item.key)
        .style('opacity', 1e-6) //1e-6
        .on("mouseover", function(d) {    
            tip      
                .transition()   
                .duration(200)
                .style("opacity", 1);    
            tip .html("<b>"+ d.Geography +'</b>: '+ d.Quarter + "<br/>"  + formats[d.Metric](d.Value))  
                .style("left", (d3.event.pageX) + "px")   
                .style("top", (d3.event.pageY - 28) + "px");  
            })          
        .on("mouseout", function(d) {   
            tip.transition()    
                .duration(500)   
                .style("opacity", 0); 
        });

        /*
        vis.append("text")
          .text(longname[item.key])
          .attr("class",item.key+"_label")
          .attr("x",x(d3.max(x.domain())) + 10)
          .attr("y",y(item.values[item.values.length-1 ].Value))
          .attr("opacity",1)
          .attr("font-family", "Nunito")
          .style("fill", colors[item.key])
          .attr("font-weight",700)
          .attr("font-size", "20")
          
      vis.append("text")
          .text(formats["Rent"](item.values[item.values.length-1 ].Value))
          .attr("class",item.key+"_label2")
          .attr("x",x(d3.max(x.domain())) + 10)
          .attr("y",y(item.values[item.values.length-1 ].Value)+20)
          .attr("opacity",1)
          .attr("font-family", "Nunito")
          .style("fill", colors[item.key])
          .attr("font-weight",700)
          .attr("font-size", "17")      */


        }

          


        )



          // Add the Y Axis
           var yaxis = vis.append("g")
               .attr("class", "y axis")
               .call(d3.axisLeft(y)
                  .ticks(5)
                  .tickFormat(formats["Rent"])
                  .tickSizeInner(0)
                  .tickPadding(6)
                  .tickSize(0, 0));
          
          // Add a label to the y axis
          vis.append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", 0 - 60)
                .attr("x", 0 - (cheight / 2))
                .attr("dy", "1em")
                .style("text-anchor", "middle")
                .text("Gross Rent PSF")
                .attr("class", "y axis label")
                .attr("id", "clabel")
                .attr("font-family", "Nunito")
                .style("fill", "#fff")
                .attr("font-weight",700)
                .attr("font-size", "17") ;

    }

    // Create initial graph
    initialGraph("Rent")



    // Update the data
    var updateGraph = function(fruit){

        // Filter the data to include only fruit of interest
        var selectFruit = nest.filter(function(d){
                return d.key == fruit;
              })

        // Select all of the grouped elements and update the data
        var selectFruitGroups = vis.selectAll(".fruitGroups")
            .data(selectFruit)
            .each(function(d){
                y.domain([d3.min([d.value.min,0]), d.value.max])
            });

            // Select all the lines and transition to new positions
            selectFruitGroups.selectAll("path.line")
               .data(function(d) { return d.value.year; }, 
                    function(d){ return d.key; })
               .transition()
                  .duration(1000)
                  .attr("d", function(d){
                    return valueLine(d.values)
                  })

            selectFruit[0].value.year.forEach(function(item,index){
            selectFruitGroups.selectAll("circle.circle" + item.key)
            .data(item.values)
            .transition()
            .duration(1000)
            .attr("cx", function(dd){return x(dd.Quarter)})
            .attr("cy", function(dd){return y(dd.Value)})
            
            /*
            d3.select("."+item.key+"_label")
            .transition()
            .duration(1500)
            .attr("y",y(item.values[item.values.length-1 ].Value))

          d3.select("."+item.key+"_label2")
            .transition()
            .duration(1500)
            .text(formats[fruit](item.values[item.values.length-1 ].Value))
            .attr("y",y(item.values[item.values.length-1 ].Value)+20) */

            })
        // Update the Y-axis
            d3.select(".y")
                    .transition()
                    .duration(1500)
                    .call(d3.axisLeft(y)
                      .ticks(5)
                      .tickFormat(formats[fruit])
                      .tickSizeInner(0)
                      .tickPadding(6)
                      .tickSize(0, 0));
            
            d3.select("#clabel")
              .text(labels[fruit])

           




    }


    // Run update function when dropdown selection changes
    fruitMenu.on('change', function(){

        // Find which fruit was selected from the dropdown
        var selectedFruit = d3.select(this)
            .select("select")
            .property("value")

        // Run update function with the selected fruit
        updateGraph(selectedFruit)


    });


    // Change color of selected line when year dropdown changes
    /*
    yearMenu.on('change', function(){

        // Find which year was selected
        var selectedYear = d3.select(this)
            .select("select")
            .property("value")

        // Change the class of the matching line to "selected"
        var selLine = vis.selectAll(".line")
              // de-select all the lines
              .classed("selected", false)
              .filter(function(d) {
                  return d.key === selectedYear
              })
              // Set class to selected for matching line
              .classed("selected", true)
              .raise()
    })*/


})




















//Read Data, convert numerical categories into floats
//Create the initial visualisation

/*
d3.csv("https://docs.google.com/spreadsheets/d/1LMADV7lzfx1rC6AzkrUp8uwe5XuXR8sd3KDeashPmB8/gviz/tq?tqx=out:csv&gid=1356831804", function(d){
  return{
    location: d.location,
    class: d.class,
    year: +d.year,
    period: d.period,
    rent: +d.rent,
    vacancy: +d.vacancy,
    absorption: d.absorption,
  };
}, function(error, rows){
if (error) throw error;

  //  setTimeout(drawInitial(), 100)
//})


rows =  rows.filter(f => f.year >= 2015)

const colors = {'Miami':['#00b5cc'],'NY':['#eb529d'],'SF':['#eb529d'],'Chicago':['#eb529d']}

nested = d3.nest().key(function(d){return d.location}).entries(rows)
nestkeys = nested.map(function(d){return d.key;})



var vis = d3.select("#rentvis")
var cmargin = {top: 200, right: 50, bottom: 200, left: 60};
element = vis.node();
cwidth = element.getBoundingClientRect().width - cmargin.left - cmargin.right,
cheight = element.getBoundingClientRect().height - cmargin.top - cmargin.bottom;

rentsvg = d3
  .select("#rentvis")
    .attr("width", cwidth + cmargin.left + cmargin.right - 20)
    .attr("height", cheight + cmargin.top + cmargin.bottom)

    const rentchart = rentsvg
    .append("g")
    .attr("transform", `translate(${cmargin.left},${cmargin.top})`);

const rentgrp = rentchart
  .append("g")
  .attr("transform", `translate(-${cmargin.left},0)`);


rentgrp.append("text")
    .text("Gross Rent PSF")
    .attr("class","charttitle")
    .attr("x",-30)
    .attr("y",-30)
    .attr("transform", `translate(${cmargin.left},0)`)
    .attr("opacity",1)
    .attr("font-family", "Nunito")
    .attr("font-weight",700)
    .attr("font-size", "25")

// Create scales
const RentyScale = d3
  .scaleLinear()
  .range([height, 0])
  .domain([0, d3.max(rows, d => d.rent + 5)]);
const RentxScale = d3
  .scalePoint()
  .range([3, width-40])
  .domain(rows.map(function(d){ return d.period; }));

const Rentline = d3
  .line()
  .x(d => RentxScale(d.period))
  .y(d => RentyScale(d.rent))
  .curve(d3.curveBasis);


nestkeys.forEach(function(d){

    data =  rows.filter(f => f.location == d)
    


    path = rentgrp
      .append("path")
      .attr("class",d + "_rentpath")
      .attr("d", Rentline(data))
      .attr("transform", `translate(${cmargin.left},0)`)
      .attr("fill", "none")
      .attr("stroke", colors[d][0])
      .attr("stroke-linejoin", "round")
      .attr("stroke-linecap", "round")
      .attr("stroke-width", 5)

    pathLength = path.node().getTotalLength();

    path
  .attr("stroke-dashoffset", pathLength)
  .attr("stroke-dasharray", pathLength)


rentgrp.append("text")
    .text(d)
    .attr("class",d+"_rentlabel")
    .attr("x",RentxScale(d3.max(RentxScale.domain())) + 10)
    .attr("y",RentyScale(data[data.length-1 ].rent))
    .attr("transform", `translate(${cmargin.left},0)`)
    .attr("opacity",0)
    .attr("font-family", "Nunito")
    .style("fill", colors[d][0])
    .attr("font-weight",700)
    .attr("font-size", "20")

rentgrp.append("text")
    .text(d3.format("($.0f")(data[data.length-1 ].rent))
    .attr("class",d+"_rentlabelrent")
    .attr("x",RentxScale(d3.max(RentxScale.domain())) + 10)
    .attr("y",RentyScale(data[data.length-1 ].rent)+20)
    .attr("transform", `translate(${cmargin.left},0)`)
    .attr("opacity",0)
    .attr("font-family", "Nunito")
    .style("fill", colors[d][0])
    .attr("font-weight",700)
    .attr("font-size", "17")


})


// Add the X Axis
rentchart
  .append("g")
  .attr("class", "axis")
  .attr("transform", `translate(0,${cheight})`)
  .call(d3.axisBottom(RentxScale).tickSizeOuter(0)
.tickValues(RentxScale.domain().filter(function(d,i){ return !(i%4)})))
  .style('fill-opacity', d => d === 0 ? 0.0 : 1.0);
// Add the Y Axis
rentchart
  .append("g")
  .attr("class", "axis")
  .attr("transform", `translate(0, 0)`)
  .call(d3.axisLeft(RentyScale).tickSizeOuter(0)
    .tickFormat(d3.format("($.0f")));



/////VACANCY
vacancysvg = d3
  .select("#vacancyvis")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)

    const vacancychart = vacancysvg
    .append("g")
    .attr("transform", `translate(${margin.left},${margin.top})`);

const vacancygrp = vacancychart
  .append("g")
  .attr("transform", `translate(-${margin.left},0)`);

vacancygrp.append("text")
    .text("Vacancy Rate")
    .attr("class","charttitle")
    .attr("x",-30)
    .attr("y",-30)
    .attr("transform", `translate(${margin.left},0)`)
    .attr("opacity",1)
    .attr("font-family", "Nunito")
    .attr("font-weight",700)
    .attr("font-size", "25")

// Create scales
const vacancyyScale = d3
  .scaleLinear()
  .range([height, 0])
  .domain([0, d3.max(rows, d => d.vacancy + .02)]);
const vacancyxScale = d3
  .scalePoint()
  .range([3, width-40])
  .domain(rows.map(function(d){ return d.period; }));

const vacancyline = d3
  .line()
  .x(d => vacancyxScale(d.period))
  .y(d => vacancyyScale(d.vacancy))
  .curve(d3.curveBasis);

nestkeys.forEach(function(d){

    data =  rows.filter(f => f.location == d)
    
    path = vacancygrp
      .append("path")
      .attr("class",d + "_vacancypath")
      .attr("d", vacancyline(data))
      .attr("transform", `translate(${margin.left},0)`)
      .attr("fill", "none")
      .attr("stroke", colors[d][0])
      .attr("stroke-linejoin", "round")
      .attr("stroke-linecap", "round")
      .attr("stroke-width", 5)

    pathLength = path.node().getTotalLength();

    path
  .attr("stroke-dashoffset", pathLength)
  .attr("stroke-dasharray", pathLength)

  vacancygrp.append("text")
    .text(d)
    .attr("class",d+"_vacancylabel")
    .attr("x",vacancyxScale(d3.max(vacancyxScale.domain())) + 5)
    .attr("y",vacancyyScale(data[data.length-1 ].vacancy))
    .attr("transform", `translate(${margin.left},0)`)
    .attr("font-family", "Nunito")
    .style("fill", colors[d][0])
    .attr("font-weight",700)
    .attr("font-size", "20")
    .attr("opacity",0)

    vacancygrp.append("text")
    .text(d3.format(".0%")(data[data.length-1 ].vacancy))
    .attr("class",d+"_vacancylabelvacancy")
    .attr("x",vacancyxScale(d3.max(vacancyxScale.domain())) + 10)
    .attr("y",vacancyyScale(data[data.length-1 ].vacancy)+20)
    .attr("transform", `translate(${margin.left},0)`)
    .attr("opacity",0)
    .attr("font-family", "Nunito")
    .style("fill", colors[d][0])
    .attr("font-weight",700)
    .attr("font-size", "17")
    .attr("opacity",0)


})

// Add the X Axis
vacancychart
  .append("g")
    .attr("class", "axis")
  .attr("transform", `translate(0,${height})`)
  .call(d3.axisBottom(vacancyxScale)
.tickValues(vacancyxScale.domain().filter(function(d,i){ return !(i%4)})));
// Add the Y Axis
vacancychart
  .append("g")
    .attr("class", "axis")
  .attr("transform", `translate(0, 0)`)
  .call(d3.axisLeft(vacancyyScale)
    .tickFormat(d3.format(".0%")));



//////Absorption
absvg = d3
  .select("#absorbvis")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)

    const abchart = absvg
    .append("g")
    .attr("transform", `translate(${margin.left},${margin.top})`);

const abgrp = abchart
  .append("g")
  .attr("transform", `translate(-${margin.left},0)`);

abgrp.append("text")
    .text("Net Absorption")
    .attr("class","charttitle")
    .attr("x",-30)
    .attr("y",-30)
    .attr("transform", `translate(${margin.left},0)`)
    .attr("opacity",1)
    .attr("font-family", "Nunito")
    .attr("font-weight",700)
    .attr("font-size", "25")

// Create scales
const abyScale = d3
  .scaleLinear()
  .range([height, 0])
  .domain([d3.min(rows, d => +d.absorption + .02), d3.max(rows, d => +d.absorption + .02)]);
const abxScale = d3
  .scalePoint()
  .range([3, width-40])
  .domain(rows.map(function(d){ return d.period; }));

const abline = d3
  .line()
  .x(d => abxScale(d.period))
  .y(d => abyScale(+d.absorption))
  .curve(d3.curveBasis);

nestkeys.forEach(function(d){

    data =  rows.filter(f => f.location == d)
    
  
    path = abgrp
      .append("path")
      .attr("class",d + "_abpath")
      .attr("d", abline(data))
      .attr("transform", `translate(${margin.left},0)`)
      .attr("fill", "none")
      .attr("stroke", colors[d][0])
      .attr("stroke-linejoin", "round")
      .attr("stroke-linecap", "round")
      .attr("stroke-width", 5)

    pathLength = path.node().getTotalLength();

    path
  .attr("stroke-dashoffset", pathLength)
  .attr("stroke-dasharray", pathLength)

  abgrp.append("text")
    .text(d)
    .attr("class",d+"_ablabel")
    .attr("x",abxScale(d3.max(abxScale.domain())) + 5)
    .attr("y",abyScale(+data[data.length-1 ].absorption))
    .attr("transform", `translate(${margin.left},0)`)
    .attr("opacity",0)
    .attr("font-family", "Nunito")
    .style("fill", colors[d][0])
    .attr("font-weight",700)
    .attr("font-size", "20")

  abgrp.append("text")
    .text(d3.format("(.0f")(data[data.length-1 ].absorption))
    .attr("class",d+"_ablabelab")
    .attr("x",abxScale(d3.max(abxScale.domain())) + 10)
    .attr("y",abyScale(data[data.length-1 ].absorption)+20)
    .attr("transform", `translate(${margin.left},0)`)
    .attr("opacity",0)
    .attr("font-family", "Nunito")
    .style("fill", colors[d][0])
    .attr("font-weight",700)
    .attr("font-size", "17")


})

// Add the X Axis
abchart
  .append("g")
    .attr("class", "axis")
  .attr("transform", `translate(0,${height})`)
  .call(d3.axisBottom(abxScale)
.tickValues(abxScale.domain().filter(function(d,i){ return !(i%4)})));
// Add the Y Axis
abchart
  .append("g")
    .attr("class", "axis")
  .attr("transform", `translate(0, 0)`)
  .call(d3.axisLeft(abyScale));


d3.selectAll(".tick")
    .filter(function (d) { return d === 0;  })
    .remove();



////Annotations
const annotations = [
        {
          note: { 
            title: "COVID-19", 
            lineType: "none", 
            align: "middle",
            wrap: 150 //custom text wrapping
          },
          subject: {
            height: height,
            width: RentxScale(RentxScale.domain()[43]) - RentxScale(RentxScale.domain()[41])
          },
          type: d3.annotationCalloutRect,
          y: 1,
          disable: ["connector"], // doesn't draw the connector
          //can pass "subject" "note" and "connector" as valid options
          dx: (RentxScale(RentxScale.domain()[43]) - RentxScale(RentxScale.domain()[41]))/2,
          data: { x: RentxScale.domain()[41]}
        }]


const type = d3.annotationCustomType(
        d3.annotationBadge, 
        {"subject":{"radius": 10 }}
      )

const makeAnnotations = d3.annotation()
        .type(type)
        .accessors({ 
          x: function(d){ return RentxScale(d.x)},
          y: function(d){ return RentyScale(d.y) }
        })
        .annotations(annotations)

      rentchart
        .append("g")
        .attr("class", "annotation-group")
        .call(makeAnnotations)



const vacannotations = [
        {
          note: { 
            title: "COVID-19", 
            lineType: "none", 
            align: "middle",
            wrap: 150 //custom text wrapping
          },
          subject: {
            height: height,
            width: vacancyxScale(vacancyxScale.domain()[43]) - vacancyxScale(vacancyxScale.domain()[41])
          },
          type: d3.annotationCalloutRect,
          y: 1,
          disable: ["connector"], // doesn't draw the connector
          //can pass "subject" "note" and "connector" as valid options
          dx: (vacancyxScale(vacancyxScale.domain()[43]) - vacancyxScale(vacancyxScale.domain()[41]))/2,
          data: { x: vacancyxScale.domain()[41]}
        }]


const makevacAnnotations = d3.annotation()
        .type(type)
        .accessors({ 
          x: function(d){ return vacancyxScale(d.x)},
          y: function(d){ return vacancyScale(d.y) }
        })
        .annotations(vacannotations)

      vacancychart
        .append("g")
        .attr("class", "annotation-group")
        .call(makevacAnnotations)

const abannotations = [
        {
          note: { 
            title: "COVID-19", 
            lineType: "none", 
            align: "middle",
            wrap: 150 //custom text wrapping
          },
          subject: {
            height: height,
            width: abxScale(abxScale.domain()[43]) - abxScale(abxScale.domain()[41])
          },
          type: d3.annotationCalloutRect,
          y: 1,
          disable: ["connector"], // doesn't draw the connector
          //can pass "subject" "note" and "connector" as valid options
          dx: (abxScale(abxScale.domain()[43]) - abxScale(abxScale.domain()[41]))/2,
          data: { x: abxScale.domain()[41]}
        }]


const makeabAnnotations = d3.annotation()
        .type(type)
        .accessors({ 
          x: function(d){ return abxScale(d.x)},
          y: function(d){ return abScale(d.y) }
        })
        .annotations(abannotations)

      abchart
        .append("g")
        .attr("class", "annotation-group")
        .call(makeabAnnotations)
*/
// Tooltip

/*
var bisect = d3.bisector(function(d) { return d.period; }).left;

var tooltip = d3.select(".tab04_content.w-tab-content").append("div")
    .attr("class", "tooltip")
    .style("display", "none");

var focus = rentgrp.append("g")
            .attr("class", "focus")
            .style("display", "none");

focus.append("circle")
    .attr("r", 5);

var tooltipDate = tooltip.append("div")
    .attr("class", "tooltip-date");

var tooltipLikes = tooltip.append("div");
tooltipLikes.append("span")
    .attr("class", "tooltip-title")
    .text("Gross Rent PSF: ");

var tooltipLikesValue = tooltipLikes.append("span")
    .attr("class", "tooltip-likes");

rentchart.append("rect")
    .attr("class", "ttoverlay")
    .attr("width", width)
    .attr("height", height)
    .on("mouseover", function() { focus.style("display", null); tooltip.style("display", null);  })
    .on("mouseout", function() { focus.style("display", "none"); tooltip.style("display", "none"); })
    .on("mousemove", mousemove);

function mousemove() {
    var xPos = d3.mouse(this)[0];
    var domain = RentxScale.domain();
    var range = RentxScale.range();
    var rangePoints = d3.range(range[0], range[1], RentxScale.step());

    var x0 = domain[d3.bisect(rangePoints, xPos) ];
        i = bisect(rows, x0, 0),
        d0 = rows[i - 1],
        d1 = rows[i],
        d = x0 - d0.period > d1.period - x0 ? d1 : d0;
    focus.attr("transform", "translate(" + (RentxScale(d.period) + margin.left) + "," + RentyScale(d.rent) + ")");
    tooltip.attr("style", "left:" + (RentxScale(d.period) + 64) + "px;top:" + RentyScale(d.rent) + "px;");
    tooltip.select(".tooltip-date").text(d.period);
    tooltip.select(".tooltip-likes").text(d3.format("($.2f")(d.rent));

}


});
*/





//MAP
window.step = 0
mapboxgl.accessToken = 'pk.eyJ1Ijoia3BjbHluZSIsImEiOiJjanN3MzlpY2EwZGpjM3lsaGNhb3NqY3JmIn0._sGjIhmL5Xt08WIMWRsSsg';
        var bounds = [
[-80.24975, 25.73521]
, [-80.13341, 25.83169]
];
r
        const w = 255 * 0.65;

        const defaultMaxPitch = 89.9;

        var map = new mapboxgl.Map({
            container: 'map'
            , style: 'mapbox://styles/kpclyne/ckm2x7n0u1cr018nzpjesupiy'
            , center: [-80.188965, 25.776679]
            , zoom: 13
            , pitch: 0
            , bearing: 0
            , maxPitch: 85,
        }); 

     

        map.scrollZoom.disable();

        /*map.addControl(new MapboxGeocoder({
            accessToken: mapboxgl.accessToken
            , mapboxgl: mapboxgl
        }));*/

        var bins = 20;
        var maxHeight = 290;
        var binWidth = maxHeight / bins;

        map.on('load', function () {
            map.addSource('office', {
          // GeoJSON Data source used in vector tiles, documented at
          // https://gist.github.com/ryanbaumann/a7d970386ce59d11c16278b90dde094d
          'type': 'geojson',
          'data':'gis/office3.geojson'

          });

          map.addSource('subdistricts', {
          // GeoJSON Data source used in vector tiles, documented at
          // https://gist.github.com/ryanbaumann/a7d970386ce59d11c16278b90dde094d
          'type': 'geojson',
          'data':'working/subdistrict2.geojson'

          });

          map.addSource('underconstruction', {
          // GeoJSON Data source used in vector tiles, documented at
          // https://gist.github.com/ryanbaumann/a7d970386ce59d11c16278b90dde094d
          'type': 'geojson',
          'data':'gis/830Brickell.geojson'
          });

          map.addSource('proposed', {
          // GeoJSON Data source used in vector tiles, documented at
          // https://gist.github.com/ryanbaumann/a7d970386ce59d11c16278b90dde094d
          'type': 'geojson',
          'data':'gis/proposed2.geojson'
          });

          map.addLayer({
          'id': 'subdistricts',
          'type': 'fill',
          'source': 'subdistricts',
          'paint': {
          'fill-color': ['get', 'color'],
          'fill-color-transition':{
                    duration: 2000
                },
          'fill-opacity': 0.6
        }
        })
           
          for (var i = 0; i < bins; i++) {
          map.addLayer({
          'id': 'office-extrude' + i,
          'type': 'fill-extrusion',
          'source': 'office',
          'filter': 
          ['all',
          ['>', 'height', i*binWidth],
          ['<=', 'height', (i + 1) * binWidth]],
          'paint': {
          // See the Mapbox Style Specification for details on data expressions.
          // https://docs.mapbox.com/mapbox-gl-js/style-spec/#expressions
           
          // Get the fill-extrusion-color from the source 'color' property.
          'fill-extrusion-color': "#314CCD",
           
          // Get fill-extrusion-height from the source 'height' property.
          'fill-extrusion-height': 0,
           
          // Get fill-extrusion-base from the source 'base_height' property.
          'fill-extrusion-base': ['get', 'minHeight'],
          //Set the 
          'fill-extrusion-height-transition':{
                    duration: 2000,
                    delay: 3000
                },
          // Make extrusions slightly opaque for see through indoor walls.
          'fill-extrusion-opacity': 0
          }
          });}

                  for (var i = 0; i < bins; i++) {
          map.addLayer({
          'id': 'proposed-developments' + i,
          'type': 'fill-extrusion',
          'source': 'proposed',
          'filter': 
          ['all',
          ['>', 'Proposed_parcels_Height', i*binWidth],
          ['<=', 'Proposed_parcels_Height', (i + 1) * binWidth]],
          'paint': {
          'fill-extrusion-color': "#314CCD",
          'fill-extrusion-height': 0,
          'fill-extrusion-base': ['get', 'minHeight'],
          'fill-extrusion-height-transition':{
                    duration: 2000,
                    delay: 200
                },
          'fill-extrusion-opacity': 0
          }
          });}
        
        map.addLayer({
          'id': 'under-construction',
          'type': 'fill-extrusion',
          'source': 'underconstruction',
          'paint': {
          'fill-extrusion-color': "#314CCD",
          'fill-extrusion-height': 0,
          'fill-extrusion-base': ['get', 'minheight'],
          'fill-extrusion-height-transition':{
                    duration: 2000,
                    delay: 2000
                },
          'fill-extrusion-color-transition':{
                    duration: 2000
                },
          'fill-extrusion-opacity': .9
          }
        });

        map.addLayer({
          'id': 'proposed-developments',
          'type': 'fill-extrusion',
          'source': 'proposed',
          'paint': {
          'fill-extrusion-color': "#314CCD",
          'fill-extrusion-height': 0,
          'fill-extrusion-base': 0,
          'fill-extrusion-height-transition':{
                    duration: 2000,
                    delay: 2000
                },
          'fill-extrusion-color-transition':{
                    duration: 2000
                },
          'fill-extrusion-opacity': .9
          }
        })

    }); 
        
function drawmap1(){

if (window.step ===1){

map.flyTo({
center: [-80.188965, 25.776679],
zoom: 13,
pitch: 0,
bearing: 0,
speed: 0.5
})

  for (var i = 0; i < bins; i++) {

map.setPaintProperty(
'office-extrude' + i,
'fill-extrusion-height',
0
);
map.setPaintProperty(
'office-extrude' + i,
'fill-extrusion-opacity', 0);
}


}


}  

function drawmap2(){

   if (window.step === 2){

    map.setPaintProperty(
  'under-construction',
  'fill-extrusion-height',
  0
  ); 


  map.setPaintProperty('under-construction','fill-extrusion-height-transition',{
                    duration: 2000,
                    delay: 0
                })
   }


map.flyTo({
center: [-80.190701, 25.758105],
zoom: 16.54,
pitch: 73.54,
bearing: 0,
speed: 0.5
})

for (var i = 0; i < bins; i++) {

map.setPaintProperty(
'office-extrude' + i,
'fill-extrusion-height',
binWidth * i
);
map.setPaintProperty(
'office-extrude' + i,
'fill-extrusion-opacity', 0.9);
}

window.step = 1

}

function drawmap3(){


map.flyTo({
center: [-80.188060, 25.767957],
zoom: 15.72,
bearing: 59.20,
pitch: 77.00,
speed: 0.5
})

    map.setPaintProperty(
'under-construction',
'fill-extrusion-height',
220
); 

    map.setPaintProperty(
'under-construction',
'fill-extrusion-color', "#CF60B6"
); 

window.step = 2

} 

function drawmap4(){

  if (window.step === 4){

    for (var i = 0; i < bins; i++) {

map.setPaintProperty(
'proposed-developments' + i,
'fill-extrusion-height',
0
);
map.setPaintProperty(
'proposed-developments' + i,
'fill-extrusion-opacity', 1);

 map.setPaintProperty(
'proposed-developments' + i,
'fill-extrusion-color', "#00674C"
); 
}

}

for (var i = 0; i < bins; i++) {
map.setPaintProperty(
  'office-extrude' + i, 
  'fill-extrusion-color',
  [
'interpolate',
['exponential', 0.5],
['zoom'],
14.5,
['match', ['get', "new"], 'RENO', '#F77E08' , 'NEW', '#CF60B6', '#314CCD'],
15.72,
['match', ['get', "new"], 'RENO', '#314CCD' , 'NEW', '#314CCD', '#314CCD']
] 
);


map.flyTo({
center: [-80.183022, 25.769622],
zoom: 14.25,
bearing: 87.20,
pitch: 80.00,
speed: 0.5
})


}

window.step = 3

} 

function drawmap5(){

window.n = 0

  if (window.step === 5){
    map.flyTo({
    center: [-80.183022, 25.769622],
    zoom: 14.25,
    bearing: 87.20,
    pitch: 80.00,
    speed: 0.5
    })

    map.setPaintProperty('trace','line-opacity',0)

    window.n = 1
  }


for (var i = 0; i < bins; i++) {

map.setPaintProperty(
'proposed-developments' + i,
'fill-extrusion-height',
binWidth * i
);
map.setPaintProperty(
'proposed-developments' + i,
'fill-extrusion-opacity', 0.9);

 map.setPaintProperty(
'proposed-developments' + i,
'fill-extrusion-color', "#00674C"
); 
}

window.step = 4

}

function drawmap6(){

if (window.n = 1){
  map.setPaintProperty('trace','line-opacity',1)
}

map.flyTo({
center: [-80.188965, 25.776679],
zoom: 13,
bearing: 0,
pitch: 0,
speed: 0.5
})


d3.json(
            'gis/transit3.geojson',
            function (err, data) {
                if (err) throw err;
     
                // save full coordinate list for later

                let newdata = JSON.parse(JSON.stringify(data));
                var coordinates = new Array()
                for (x = 0; x < newdata.features.length; x++){
                  coords = newdata.features[x].geometry.coordinates
                  coordinates.push(newdata.features[x].geometry.coordinates);
                  newdata.features[x].geometry.coordinates = [coords[0]];
                }
                
                // add it to the map
                map.addSource('trace', { type: 'geojson', data: newdata });
                map.addLayer({
                    'id': 'trace',
                    'type': 'line',
                    'source': 'trace',
                    'paint': {
                        'line-color': ['get','color'],
                        'line-opacity': 1,
                        'line-width': 3
                    }
                });

                // setup the viewport

                // on a regular basis, add more coordinates from the saved list and update the map
                var i = 0;
                var maxlength = coordinates[coordinates.reduce((maxI,el,i,arr) => (el.length>arr[maxI].length) ? i : maxI, 0)].length;
                var timer = window.setInterval(function () {
                    if (i < maxlength) {
                        for (t=0; t < coordinates.length; t++){
                          newdata.features[t].geometry.coordinates.push(
                            coordinates[t][i]
                          );
                        }
                         map.getSource('trace').setData(newdata);
                        i++;
                    } else {
                        window.clearInterval(timer);
                    }
                }, 50000);
            }
        );
  
window.step = 5



          //////WHO'S HERE TILE SCROLLER

          empwidth = document.getElementById("emp").clientWidth

          if(empwidth <= 600){
            cols = 2
          } else if(empwidth <= 960){
            cols = 3
          }else{
            cols = 4
          }

           var padding = 6, radius = ((empwidth/cols)/2) - padding*(1 + (1/(cols+1))), parameter = 'size', indfilter = 'All Industries';


          images = {'Consumer Goods': 'consumergoods.svg','Coworking': 'coworking.svg','Education': 'education.svg','Finance': 'finance.svg','FinTech': 'fintech.svg','Healthcare': 'healthcare.svg','Insurance': 'insurance.svg','Law': 'law.svg','Manufacturing': 'manufacturing.svg','Marketing': 'marketing.svg','Media + Entertainment': 'media.svg','Professional Services': 'professionalservices.svg','Real Estate': 'realestate.svg','Services': 'services.svg','Technology': 'technology.svg','Tourism': 'tourism.svg','Venture Capital': 'venturecapital.svg'}      
           

          /// HELPER FUNCTIONS
          function translateSVG(x, y) {
            return 'translate('+x+','+y+')';
          }



          function selectThis(d) {
            d3.select(this).classed('selected', function() {return !d3.select(this).classed('selected');})
          }

          //// D3
          function updateChart(k) {


            if(k === 'All Industries'){
              var nodes = d3.select('#chart')
              .selectAll('div.node')
              .sort(function(a, b) {return parameter === 'ranking' ? d3.ascending(a[parameter], b[parameter]) : d3.descending(a[parameter], b[parameter]);})
              .transition()
              .duration(1000)
              .style('left', function(d, i) {
                var col = i % cols;
                var x = 2 * col * (radius + padding);
                return x + 'px';
              })
              .style('opacity',1)
              .style('top', function(d, i) {
                var row = Math.floor(i / cols);
                var y = row * (radius + padding);
                return y + 'px';
              });
            } else {
              
            d3.select('#chart')
              .selectAll('div.node')
              .filter(f => f['industry'] === k)
              .sort(function(a, b) {return parameter === 'ranking' ? d3.descending(a['employer'], b['employer']) : d3.ascending(a['employer'], b['employer']);})
              .transition()
              .duration(1000)
              .style('left', function(d, i) {
                var col = i % cols;
                var x = 2 * col * (radius + padding);
                return x + 'px';
              })
              .style('opacity',1)
              .style('top', function(d, i) {
                var row = Math.floor(i / cols);
                var y = row * (radius + padding);
                return y + 'px';
              });

            d3.select('#chart')
              .selectAll('div.node')
              .filter(f => f['industry'] != k)
              .transition()
              .duration(1000)
              .style('opacity', 0)

            }

            d3.select('#chart')
              .selectAll('div.node .value')
              .transition()
              .duration(0)
              .tween("text", function(d)
                {
                  var x = d[parameter];
                  if (!(parameter == 'open' || parameter == 'high')) x;
                  var i = d3.interpolate(this.textContent, (x));
                  return function(t) {
                    this.textContent = (i(t));
                };
              });

              if(k === 'All Industries'){
              var nodes = d3.select('#chart2')
              .selectAll('div.node')
              .sort(function(a, b) {return parameter === 'ranking' ? d3.ascending(a[parameter], b[parameter]) : d3.descending(a[parameter], b[parameter]);})
              .transition()
              .duration(1000)
              .style('left', function(d, i) {
                var col = i % cols;
                var x = 2 * col * (radius + padding);
                return x + 'px';
              })
              .style('opacity',1)
              .style('top', function(d, i) {
                var row = Math.floor(i / cols);
                var y = row * (radius + padding);
                return y + 'px';
              });
            } else {
              
            d3.select('#chart2')
              .selectAll('div.node')
              .filter(f => f['industry'] === k)
              .sort(function(a, b) {return parameter === 'ranking' ? d3.descending(a['industry'], b['industry']) : d3.ascending(a['industry'], b['industry']);})
              .transition()
              .duration(1000)
              .style('left', function(d, i) {
                var col = i % cols;
                var x = 2 * col * (radius + padding);
                return x + 'px';
              })
              .style('opacity',1)
              .style('top', function(d, i) {
                var row = Math.floor(i / cols);
                var y = row * (radius + padding);
                return y + 'px';
              });

            d3.select('#chart2')
              .selectAll('div.node')
              .filter(f => f['industry'] != k)
              .transition()
              .duration(1000)
              .style('opacity', 0)

            }

            d3.select('#chart2')
              .selectAll('div.node .value')
              .transition()
              .duration(0)
              .tween("text", function(d)
                {
                  var x = d[parameter];
                  if (!(parameter == 'open' || parameter == 'high')) x;
                  var i = d3.interpolate(this.textContent, (x));
                  return function(t) {
                    this.textContent = (i(t));
                };
              });
          }

          function updateChart2() {

            var nodes = d3.select('#chart2')
              .selectAll('div.node')
              .sort(function(a, b) {return parameter === 'ranking' ? d3.ascending(a[parameter], b[parameter]) : d3.descending(a[parameter], b[parameter]);})
              .transition()
              .duration(1000)
              .style('left', function(d, i) {
                var col = i % cols;
                var x = 2 * col * (radius + padding);
                return x + 'px';
              })
              .style('top', function(d, i) {
                var row = Math.floor(i / cols);
                var y = row * (radius + padding);
                return y + 'px';
              });

            d3.select('#chart2')
              .selectAll('div.node .value')
              .transition()
              .duration(0)
              .tween("text", function(d)
                {
                  var x = d[parameter];
                  if (!(parameter == 'open' || parameter == 'high')) x;
                  var i = d3.interpolate(this.textContent, (x));
                  return function(t) {
                    this.textContent = (i(t));
                };
              });
          }

           // Menu


              fontScale = d3.scaleLinear().domain([.75,60]).range([20*cols/4,15*cols/4])
              centerScale = d3.scaleLinear().domain([.75,60]).range([.2,.05])
              marginScale = d3.scaleLinear().domain([0,6]).range([0,2])

              d3.csv("https://docs.google.com/spreadsheets/d/1LMADV7lzfx1rC6AzkrUp8uwe5XuXR8sd3KDeashPmB8/gviz/tq?tqx=out:csv&gid=196727768", function(error, data1) {
                if (error) throw error;

                 // Create 2nd dropdown

              var indsnest = d3.nest()
                  .key(function(d){
                      return d.industry;
                  })
                  .rollup(function(leaves){
                      var inds = d3.nest().key(function(d){
                          return d.industry
                      })
                      .entries(leaves);
                      return {inds:inds};
                      })
                .entries(data1)

              

              indsnest.sort(function(a, b) {return parameter === 'ranking' ? d3.descending(a['key'], b['key']) : d3.ascending(a['key'], b['key']);})

              indsnest.unshift({key:'All Industries'})
            

              if (window.dropdown === 0){
              var indsMenu = d3.select("#industries")

              indsMenu
                  .append("select")
                  .attr("id","standard-select")
                  .selectAll("option")
                  .data(indsnest)
                  .enter()
                  .append("option")
                  .attr("value", function(d){
                      return d.key;
                  })
                  .text(function(d){
                      return d.key;
                  })
                  }

              indsMenu.on('change', function(){

                  // Find which fruit was selected from the dropdown
                  var indfilter = d3.select(this)
                      .select("select")
                      .property("value")
                  // Run update function with the selected fruit
                  updateChart(indfilter);


              });
                  
              
              window.dropdown = 1
              
              var nodes = d3.select('#chart')
                                .selectAll('div')
                                .data(data1)
                                .enter()
                                .append('div')
                                .attr('id', function(d) {return 'entity-'+d.size;})
                                .style('background-color', "#FFFFFF")
                                .classed('node', true)
                                .style('width', 2 * radius + 'px')
                                .style('height', radius + 'px')

                                .on('click', selectThis);

                  nodes
                    .append('div')
                    .classed('name', true)
                    .html(function(d) {return d.employer})
                    .style('color', '#00B5CC')
                    .style('width', 2 * radius + 'px')
                    .style('height', 0.5 * radius + 'px')
                    .style('padding', 0.1 * radius + 'px')
                    .style('line-height', '150%')
                    .style('padding-top',function(d){return centerScale(d.employer.length) * radius + 'px'})
                    .style('font-size', function(d){return fontScale(d.employer.length*((d.employer.split(" ").length - 1)+1)*.25) +'px'})
                    .style('font-weight', 700);

                      
                  nodes
                    .append('div')
                    .classed('value', true)
                     .html(function(d) {return '<center><img width ="' + .3 * radius + 'px" src="images/tiles/' + images[d.industry] + '" style="margin-top:'+marginScale((d.employer.split(" ").length - 1)) + '%"></center>'})
                    .style('color', '#00B5CC')
                    .style('width', 2 * radius + 'px')
                    .style('height', 0.5 * radius + 'px')
                    .style('font-size', 15+'px')
                    .style('font-weight', 700)
                    .style('padding-top', 0);

                  updateChart(indfilter);
            });

              d3.csv("https://docs.google.com/spreadsheets/d/1LMADV7lzfx1rC6AzkrUp8uwe5XuXR8sd3KDeashPmB8/gviz/tq?tqx=out:csv&gid=1181381306", function(error, data1) {
                if (error) throw error;
              

              var nodes = d3.select('#chart2')
                                .selectAll('div')
                                .data(data1)
                                .enter()
                                .append('div')
                                .attr('id', function(d) {return 'entity-'+d.size;})
                                .style('background-color', "#FFFFFF")
                                .classed('node', true)
                                .style('width', 2 * radius + 'px')
                                .style('height', radius + 'px')

                                .on('click', selectThis);

                  nodes
                    .append('div')
                    .classed('name', true)
                    .html(function(d) {return d.employer})
                    .style('color', '#00B5CC')
                    .style('width', 2 * radius + 'px')
                    .style('height', 0.5 * radius + 'px')
                    .style('line-height', '150%')
                          .style('padding', 0.1 * radius + 'px')
                    .style('padding-top',function(d){return centerScale(d.employer.length) * radius + 'px'})
                    .style('font-size', function(d){return fontScale(d.employer.length*((d.employer.split(" ").length - 1)+1)*.25) +'px'})
                    .style('font-weight', 700);

                      
                  nodes
                    .append('div')
                    .classed('value', true)
                     .html(function(d) {return '<center><img width ="' + .3 * radius + 'px" src="images/tiles/' + images[d.industry] + '" style="margin-top:'+marginScale((d.employer.split(" ").length - 1)) + '%"></center>'})
                    .style('color', '#00B5CC')
                    .style('width', 2 * radius + 'px')
                    .style('height', 0.5 * radius + 'px')
                    .style('font-size', 15+'px')
                    .style('font-weight', 700)
                    .style('padding-top', 0);


                  updateChart2();
            });
           
        



} 

function drawmap7(){
} 

function drawmap8(){

} 
      let functions2 = [
        drawmap1,
    drawmap2,
    drawmap3,
    drawmap4,
    drawmap5, 
    drawmap6,
    drawmap7,
    drawmap8]

  var gs2 = d3.graphScroll()
      .container(d3.select('.container-2'))
      .graph(d3.selectAll('.container-2 #graph'))
      .eventId('uniqueId2')  // namespace for scroll and resize events
      .sections(d3.selectAll('.container-2 #sections > div'))
      .on('active', function(i){
        functions2[i]()
      })


/////USPS





function drawusps1(){

  if(size != 'regular'){
    document.getElementById('uspsiframe').setAttribute('style','transform:scale(0.35); -webkit-transform-origin-x: left; width:305%; position: absolute !important')
  }

}  

function drawusps2(){
  document.getElementById('uspsiframe').contentWindow.document.getElementById('button').click()

  window.step=11
}

function drawusps3(){
document.getElementById('uspsiframe').contentWindow.document.getElementById('button2').click()

window.step=12

//arcsLayer.setProps({getSourceColor: '#FFFFFF'})
} 

function drawusps4(){
/*
 map3.flyTo({
center: [-79.217804, 37.127725
],
zoom: 4.23,
bearing: -74.09,
pitch: 60,
speed: 0.5
}) */

}

function drawusps5(){

}

function drawusps6(){

} 

function drawusps7(){

} 

function drawusps8(){
  
} 

 let functions3 = [
    drawusps1,
    drawusps2,
    drawusps3,
    drawusps4,
    drawusps5, 
    drawusps6,
    drawusps7,
    drawusps8]

  var gs3 = d3.graphScroll()
      .container(d3.select('.container-3'))
      .graph(d3.selectAll('.container-3 #graph'))
      .eventId('uniqueId3')  // namespace for scroll and resize events
      .sections(d3.selectAll('.container-3 #sections > div'))
      .on('active', function(i){
        functions3[i]()
      })






}
render()
d3.select(window).on('resize', render)



</script>

<script>




///EDUCATIONAL ATTAINMENT SLIDER
d3.csv("https://docs.google.com/spreadsheets/d/1LMADV7lzfx1rC6AzkrUp8uwe5XuXR8sd3KDeashPmB8/gviz/tq?tqx=out:csv&gid=1283485067", function(error, csv) {
      if (error) throw error;

  var keys = csv.columns.slice(2);

  var year   = [...new Set(csv.map(d => d.Year))]
  var states = [...new Set(csv.map(d => d.Bucket))]


  var svg = d3.select("#educhart")

  if(size != 'regular'){
     margin = {top: 35, left: 35, bottom: 0, right: 5}
   }else{
     margin = {top: 35, left: 35, bottom: 0, right: 15}
   }

    
    element = svg.node();
    width = element.getBoundingClientRect().width - margin.left - margin.right,
    height = element.getBoundingClientRect().height - margin.top - margin.bottom;

  var y = d3.scaleBand()
    .range([margin.top, height - margin.bottom])
    .padding(0.1)
    .paddingOuter(0.2)
    .paddingInner(0.2)

   
    svg
    .append("text")
                .attr("y", 10)
                .attr("x", (width/2) + (margin.left - margin.right))
                .attr("dy", "1em")
                .style("text-anchor", "middle")
                .text("Miami Educational Attainment")
                .attr("class", "edulabel")
                .attr("font-family", "Nunito")
                .style("fill", "#000")
                .attr("font-weight",700)
                .attr("font-size", "17")
                .style('opacity',1)


  var x = d3.scaleLinear()
    .range([margin.left, width - margin.right])

  var yAxis = svg.append("g")
    .attr("transform", `translate(${margin.left},0)`)
    .attr("class", "y-axis")

  var xAxis = svg.append("g")
    .attr("transform", `translate(0,${height})`)
    .attr("class", "x-axis")

  var z = d3.scaleOrdinal()
    .range(["#7F7F7F", "#9DC3E6", "#2E75B6","#002060"])
    .domain(keys);

var edulegend = d3.select("#edulegend")
    edulegend.append("g")
      .attr("class", "legendOrdinal")
      .attr("transform", `translate(10,5)`);

    var legendOrdinal = d3.legendColor()
      //d3 symbol creates a path-string, for example
      //"M0,-8.059274488676564L9.306048591020996,
      //8.059274488676564 -9.306048591020996,8.059274488676564Z"
      .shapePadding(10)
      //use cellFilter to hide the "e" cell
      .cellFilter(function(d){ return d.label !== "e" })
      .scale(z);

    edulegend.select(".legendOrdinal")
      .call(legendOrdinal);

  update(d3.select("#slide").property("value"), 0)

  function update(input, speed) {

    var data = csv.filter(f => f.Year == input)

    data.forEach(function(d) {
      d.total = d3.sum(keys, k => +d[k])
      return d
    })

    csv.forEach(function(d) {
      d.total = d3.sum(keys, k => +d[k])
      return d
    })

    const maxedu = csv.reduce(
      (max, i) => (i.total > max ? i.total : max),
      csv[0].total
    );

    x.domain([0, maxedu]).nice();

if(size != 'regular'){
    svg.selectAll(".x-axis").transition().duration(speed)
      .call(d3.axisBottom(x).ticks(null, "s"))
            .selectAll("text")
      .style("text-anchor", "end")
      .attr("dx", "-.8em")
      .attr("dy", ".15em")
      .attr("transform", "rotate(-65)" );
}else{
      svg.selectAll(".x-axis").transition().duration(speed)
      .call(d3.axisBottom(x).ticks(null, "s"))
}

    y.domain(data.map(d => d.Bucket));

    svg.selectAll(".y-axis").transition().duration(speed)
      .call(d3.axisLeft(y).tickSizeOuter(0))

    var group = svg.selectAll("g.layer")
      .data(d3.stack().keys(keys)(data), d => d.key)

    group.exit().remove()

    group.enter().insert("g", ".y-axis").append("g")
      .classed("layer", true)
      .attr("fill", d => z(d.key));

    var bars = svg.selectAll("g.layer").selectAll("rect")
      .data(d => d, e => e.data.Bucket);

    bars.exit().remove()

    bars.enter().append("rect")
      .attr("height", y.bandwidth())
      .merge(bars)
    .transition().duration(speed)
      .attr("y", d => y(d.data.Bucket))
      .attr("x", d => x(d[0]))
      .attr("width", d => x(d[1]) - x(d[0]))

    /*
    var text = svg.selectAll(".text")
      .data(data, d => d.Bucket);

    text.exit().remove()

    text.enter().append("text")
      .attr("class", "text")
      .attr("text-anchor", "start")
      .merge(text)
    .transition().duration(speed)
      .attr("y", d => y(d.Bucket) + y.bandwidth() / 2)
      .attr("x", d => x(d.total) + 5)
      .text(d => d.total)*/
  }


  var slide = d3.select("#slide")
    .on("change", function() {
      update(this.value, 750)
    })

});
  
const allRanges = document.querySelectorAll(".range-wrap");
allRanges.forEach(wrap => {
  const range = wrap.querySelector(".range");
  const bubble = wrap.querySelector(".bubble");

  range.addEventListener("input", () => {
    setBubble(range, bubble);
  });
  setBubble(range, bubble);
});

function setBubble(range, bubble) {
  const val = range.value;
  const min = range.min ? range.min : 0;
  const max = range.max ? range.max : 100;
  const newVal = Number(((val - min) * 100) / (max - min));
  bubble.innerHTML = val;

  // Sorta magic numbers based on size of the native UI thumb
  bubble.style.left = `calc(${newVal}% + (${8 - newVal * 0.15}px))`;
}



//////COLLEGE TOWNS

d3.csv("https://docs.google.com/spreadsheets/d/1LMADV7lzfx1rC6AzkrUp8uwe5XuXR8sd3KDeashPmB8/gviz/tq?tqx=out:csv&gid=1381261411", function(error, data) {
  if (error) throw error;

  // format the data
  data.forEach(function(d) {
    d.students = +d.students;
  });
  
  var svg = d3.select("#collegetowns")
  
  if (size != 'regular'){
var margin = {top: 20, right: 5, bottom: 65, left: 55}
  }else{
var margin = {top: 20, right: 20, bottom: 30, left: 60}
  }
  
  element = svg.node();
  width = element.getBoundingClientRect().width - margin.left - margin.right,
  height = element.getBoundingClientRect().height - margin.top - margin.bottom;

// set the ranges
var x = d3.scaleBand()
          .range([margin.left, width-margin.right])
          .padding(0.1);
var ey = d3.scaleLinear()
          .range([height, margin.top]);
          
// append the svg object to the body of the page
// append a 'group' element to 'svg'
// moves the 'group' element to the top left margin

    svg
      .append("g")
      .attr("transform", 
          "translate(" + margin.left + "," + margin.top + ")");


  // Scale the range of the data in the domains
  x.domain(data.map(function(d) { return d.city; }));
  ey.domain([0, d3.max(data, function(d) { return d.students; })]);

  // append the rectangles for the bar chart
  svg.selectAll(".bar")
      .data(data)
    .enter().append("rect")
      .attr("class", "bar")
      .attr("x", function(d) { return x(d.city); })
      .attr("width", x.bandwidth())
      .attr("y", function(d) { return ey(d.students); })
      .attr("height", function(d) { return height - ey(d.students); })
      .style ("fill", function(d) {
       if (d.city === "Miami") {return "#EB529D"}  // <== Add these
       else    { return "#A6CEE3" } 
      });

  // add the x Axis
if (size != 'regular'){
  svg.append("g")
      .attr("transform", "translate(0," + height + ")")
      .call(d3.axisBottom(x))
      .selectAll("text")
      .style("text-anchor", "end")
      .attr("dx", "-.8em")
      .attr("dy", ".15em")
      .attr("transform", "rotate(-65)" );
}else{
  svg.append("g")
      .attr("transform", "translate(0," + height + ")")
      .call(d3.axisBottom(x))

}

  // add the y Axis
  svg.append("g")
      .attr("transform", "translate("+ margin.left + ",0)")
      .call(d3.axisLeft(ey));

});




///////QUALITY
/*
d3.csv("https://docs.google.com/spreadsheets/d/1LMADV7lzfx1rC6AzkrUp8uwe5XuXR8sd3KDeashPmB8/gviz/tq?tqx=out:csv&gid=2061632967", function(error, data) {
  if (error) throw error;


  function wrap(text, width) {
        text.each(function() {
            var text = d3.select(this),
                    words = text.text().split(/\s+/).reverse(),
                    word,
                    line = [],
                    lineNumber = 0,
                    lineHeight = 1.1, // ems
                    y = text.attr("y"),
                    dy = parseFloat(text.attr("dy")),
                    tspan = text.text(null).append("tspan").attr("x", 0).attr("y", y).attr("dy", dy + "em");
            while (word = words.pop()) {
                line.push(word);
                tspan.text(line.join(" "));
                if (tspan.node().getComputedTextLength() > width) {
                    line.pop();
                    tspan.text(line.join(" "));
                    line = [word];
                    tspan = text.append("tspan").attr("x", 0).attr("y", y).attr("dy", ++lineNumber * lineHeight + dy + "em").text(word);
                }
            }
        });
    }

    var svg = d3.select("#quality")

    var margin = {top: 20, right: 20, bottom: 30, left: 60},
  element = svg.node();
  width = element.getBoundingClientRect().width - margin.left - margin.right,
  height = element.getBoundingClientRect().height - margin.top - margin.bottom;


  var x = d3.scale.ordinal()
            .rangeRoundBands([0, width], .1,.3);
    var y = d3.scale.linear()
            .rangeRound([height, 0]);
    var colorRange = d3.scale.category20();
    var color = d3.scale.ordinal()
            .range(["#BFBFBF","#0070C0","#EB529D"]);
    var xAxis = d3.svg.axis()
            .scale(x)
            .orient("bottom");
    var yAxis = d3.svg.axis()
            .scale(y)
            .orient("left")
            .tickFormat(d3.format(".2s"));


    svg.append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
    var divTooltip = d3.select("body").append("div").attr("class", "toolTip");
    color.domain(d3.keys(dataset[0]).filter(function(key) { return key !== "label"; }));
    dataset.forEach(function(d) {
        var y0 = 0;
        d.values = color.domain().map(function(name) { return {name: name, y0: y0, y1: y0 += +d[name]}; });
        d.total = d.values[d.values.length - 1].y1;
    });
    x.domain(dataset.map(function(d) { return d.label; }));
    y.domain([0, d3.max(dataset, function(d) { return d.total; })]);
   
   
    var bar = svg.selectAll(".label")
            .data(dataset)
            .enter().append("g")
            .attr("class", "g")
            .attr("transform", function(d) { return "translate(" + x(d.label) + ",0)"; });
 
            
    var bar_enter = bar.selectAll("rect")
    .data(function(d) { return d.values; })
    .enter();

bar_enter.append("rect")
    .attr("width", x.rangeBand())
    .attr("y", function(d) { return y(d.y1); })
    .attr("height", function(d) { return y(d.y0) - y(d.y1); })
    .style("fill", function(d) { return color(d.name); });

bar_enter.append("text")
    .text(function(d) { return d3.format(".1s")(d.y1-d.y0)+" SF"; })
    .attr("y", function(d) { return y(d.y1)+(y(d.y0) - y(d.y1))/2; })
    .attr("x", x.rangeBand()/2.2)
    .style("fill", '#ffffff')
    .style("font-size", '30px')
    .style("font-weight", '600');
  
bar_enter.append("text")
    .text(function(d) { return d.name })
    .attr("y", function(d) { return y(d.y1)+(y(d.y0) - y(d.y1))/2; })
    .attr("x", x.rangeBand()*1.01)
    .style("fill", function(d) { return color(d.name); })
    .style("font-size", '30px')
    .style("font-weight", '600');

  });

*/
////// DISTRICT PROFILES
d3.csv("https://docs.google.com/spreadsheets/d/1LMADV7lzfx1rC6AzkrUp8uwe5XuXR8sd3KDeashPmB8/gviz/tq?tqx=out:csv&gid=1939873973", function(error, data1) {
      if (error) throw error;
      
      d3.csv("https://docs.google.com/spreadsheets/d/1LMADV7lzfx1rC6AzkrUp8uwe5XuXR8sd3KDeashPmB8/gviz/tq?tqx=out:csv&gid=342967098", function(d){
  return{
    class: d.class,
    businesses: +d.businesses,
    population: +d.population,
    employees: +d.employees
  };
}, function(error, rows) {
      if (error) throw error;
      
      if(size === 'mobile'){
        data1 = data1.filter(f => f.device == 'mobile')
        data1.forEach(function(v){ delete v.device });
      }else{
        data1 = data1.filter(f => f.device == 'desktop')
        data1.forEach(function(v){ delete v.device });
      }
      
      data1 = data1.filter(f => f.device == 'mobile')
      data1.forEach(function(v){ delete v.device });
   
      data = JSON.parse(JSON.stringify(data1)).filter(f => f.geo == 'miami')
      data.forEach(function(v){ delete v.geo });

      var button = d3
      .selectAll('.dbutton')

      var miami = d3
        .select("#MiamiButton")
      
      var gd = d3
        .select("#GDButton")

      var dda = d3
        .select("#DDAButton")
        
      var cbd = d3
        .select("#CBDButton")

      var ae = d3
        .select("#AEButton")

      var brickell = d3
        .select("#BrickellButton") 


     

      var businesses = document.getElementById("businesses")
      businesses.innerText = d3.format("(,.2r")(rows[0].businesses)
       

    var population = document.getElementById("population")
population.innerText = d3.format("(,.2r")(rows[0].population)

    var employees = document.getElementById("employees")
employees.innerText = d3.format("(,.2r")(rows[0].employees)
          
      
      
      var columns = d3.keys(data[0]);

      var table = d3.select('#conditions').append("table");
      var thead = table.append("thead");
      var tbody = table.append("tbody");

      thead.append("tr")
        .selectAll("th")
        .data(columns)
        .enter()
        .append("th")
        .text(function(column) { return column; });

      tbody.selectAll("tr")
        .data(data)
        .enter()
        .append("tr")
        .selectAll("td")
        .data(function(row) {
          return columns.map(function(column) {
            return {
              column: column,
              value: row[column]
            };
          });
        })
        .enter()
        .append("td")
        .text(function(d) { return d.value; })
        .style("color","#FFF");
      
      miami
      .on('click', function(d){

        newdata = JSON.parse(JSON.stringify(data1)).filter(f => f.geo == 'miami')
        newdata.forEach(function(v){ delete v.geo });

        button
        .style("color","#242358")
        .style("background-color", "#3B3C75")
        
        miami
        .style("background-color", "#FFFFFF")
        .style("color","#242358")
        
        businesses.innerText = d3.format("(,.2r")(rows[0].businesses)
        population.innerText = d3.format("(,.2r")(rows[0].population)
        employees.innerText = d3.format("(,.2r")(rows[0].employees)



        tbody.selectAll("tr")
        .data(newdata)
        .selectAll("td")
        .data(function(row) {
          return columns.map(function(column) {
            return {
              column: column,
              value: row[column]
            };
          });
        })
        .text(function(d) {return d.value;});
        
      })
      
      gd
      .on('click', function(d){

        var newdata = JSON.parse(JSON.stringify(data1)).filter(f => f.geo == 'gd')
        newdata.forEach(function(v){ delete v.geo });

        button
        .style("color","#242358")
        .style("background-color", "#3B3C75")
        
        gd
        .style("background-color", "#FFFFFF")
        .style("color","#242358")
        
        businesses.innerText = d3.format("(,.2r")(rows[1].businesses)
        population.innerText = d3.format("(,.2r")(rows[1].population)
        employees.innerText = d3.format("(,.2r")(rows[1].employees)


        tbody.selectAll("tr")
        .data(newdata)
        .selectAll("td")
        .data(function(row) {
          return columns.map(function(column) {
            return {
              column: column,
              value: row[column]
            };
          });
        })
        .text(function(d) {return d.value;});
        
      })

      dda
      .on('click', function(d){

        var newdata = JSON.parse(JSON.stringify(data1)).filter(f => f.geo == 'dda')
        newdata.forEach(function(v){ delete v.geo });

        button
        .style("color","#242358")
        .style("background-color", "#3B3C75")
        
        dda
        .style("background-color", "#FFFFFF")
        .style("color","#242358")
        
        businesses.innerText = d3.format("(,.2r")(rows[2].businesses)
        population.innerText = d3.format("(,.2r")(rows[2].population)
        employees.innerText = d3.format("(,.2r")(rows[2].employees)


        tbody.selectAll("tr")
        .data(newdata)
        .selectAll("td")
        .data(function(row) {
          return columns.map(function(column) {
            return {
              column: column,
              value: row[column]
            };
          });
        })
        .text(function(d) {return d.value;});
        
      })

      cbd
      .on('click', function(d){

        var newdata = JSON.parse(JSON.stringify(data1)).filter(f => f.geo == 'cbd')
        newdata.forEach(function(v){ delete v.geo });

        button
        .style("color","#242358")
        .style("background-color", "#3B3C75")
        
        cbd
        .style("background-color", "#FFFFFF")
        .style("color","#242358")

        businesses.innerText = d3.format("(,.2r")(rows[3].businesses)
        population.innerText = d3.format("(,.2r")(rows[3].population)
        employees.innerText = d3.format("(,.2r")(rows[3].employees)


        tbody.selectAll("tr")
        .data(newdata)
        .selectAll("td")
        .data(function(row) {
          return columns.map(function(column) {
            return {
              column: column,
              value: row[column]
            };
          });
        })
        .text(function(d) {return d.value;});
        
      })

      ae
      .on('click', function(d){

        var newdata = JSON.parse(JSON.stringify(data1)).filter(f => f.geo == 'ae')
        newdata.forEach(function(v){ delete v.geo });

        button
        .style("color","#242358")
        .style("background-color", "#3B3C75")
        
        ae
        .style("background-color", "#FFFFFF")
        .style("color","#242358")
        
        businesses.innerText = d3.format("(,.2r")(rows[4].businesses)
        population.innerText = d3.format("(,.2r")(rows[4].population)
        employees.innerText = d3.format("(,.2r")(rows[4].employees)


        tbody.selectAll("tr")
        .data(newdata)
        .selectAll("td")
        .data(function(row) {
          return columns.map(function(column) {
            return {
              column: column,
              value: row[column]
            };
          });
        })
        .text(function(d) {return d.value;});
        
      })

      brickell
      .on('click', function(d){

        var newdata = JSON.parse(JSON.stringify(data1)).filter(f => f.geo == 'brickell')
        newdata.forEach(function(v){ delete v.geo });

        button
        .style("color","#242358")
        .style("background-color", "#3B3C75")
        
        brickell
        .style("background-color", "#FFFFFF")
        .style("font-color","#242358")
        
        businesses.innerText = d3.format("(,.2r")(rows[5].businesses)
        population.innerText = d3.format("(,.2r")(rows[5].population)
        employees.innerText = d3.format("(,.2r")(rows[5].employees)


        tbody.selectAll("tr")
        .data(newdata)
        .selectAll("td")
        .data(function(row) {
          return columns.map(function(column) {
            return {
              column: column,
              value: row[column]
            };
          });
        })
        .text(function(d) {return d.value;});
        
      })
      
        
      });
    });

range = document.querySelector(".range");
bubble = document.querySelector(".bubble");

max = parseInt(range.max)
min = parseInt(range.min)


$('.div-block-6').waypoint(function(direction){

if (window.step == 0){
(async () => {
  for(let i = min; i < max+1; i++) {
    await new Promise(resolve => setTimeout(() => {
      range.value = i
      range.dispatchEvent(new Event('change'));
      setBubble(range, bubble);
      resolve();
    }, 500));
    if (i == max+1){
      window.step =1
    }
  }
})();
}

},{
 //bottom-in-view will ensure event is thrown when the element's bottom crosses
 //bottom of viewport.
 offset: 'bottom-in-view'
});

</script>

